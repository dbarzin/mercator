import{I as p,g as R,b as G,i as dt,c as ct,P as I,C as F,d as ut,s as gt,R as O,e as ft,f as rt,h as pt,E as ot,j as S,k as yt,O as q,G as mt,a as xt,l as vt,S as Et,m as bt,n as St,V as at,o as wt,M as X,p as Ct,q as Lt}from"./ModelXmlSerializer-B1iToIRA.js";class lt{constructor(t){this.first=null,this.destroyed=!1,this.dragHandler=null,this.dropHandler=null,this.x=0,this.y=0,this.width=0,this.height=0,this.defaultOpacity=20,this.enabled=!0,this.div=null,this.sharedDiv=null,this.currentX=0,this.currentY=0,this.fadeOut=!1,this.graph=t,this.graph.addMouseListener(this),this.forceRubberbandHandler=(e,s)=>{const n=s.getProperty("eventName"),i=s.getProperty("event");if(n===p.MOUSE_DOWN&&this.isForceRubberbandEvent(i)){const o=R(this.graph.container),a=G(this.graph.container);a.x-=o.x,a.y-=o.y,this.start(i.getX()+a.x,i.getY()+a.y),i.consume(!1)}},this.graph.addListener(p.FIRE_MOUSE_EVENT,this.forceRubberbandHandler),this.panHandler=()=>{this.repaint()},this.graph.addListener(p.PAN,this.panHandler),this.gestureHandler=(e,s)=>{this.first&&this.reset()},this.graph.addListener(p.GESTURE,this.gestureHandler)}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}isForceRubberbandEvent(t){return dt(t.getEvent())}mouseDown(t,e){if(!e.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&!e.getState()&&!ct(e.getEvent())){const s=R(this.graph.container),n=G(this.graph.container);n.x-=s.x,n.y-=s.y,this.start(e.getX()+n.x,e.getY()+n.y),e.consume(!1)}}start(t,e){this.first=new I(t,e);const{container:s}=this.graph;function n(i){const o=new pt(i),a=rt(s,o.getX(),o.getY());return o.graphX=a.x,o.graphY=a.y,o}this.dragHandler=i=>{this.mouseMove(this.graph,n(i))},this.dropHandler=i=>{this.mouseUp(this.graph,n(i))},F.IS_FF&&p.addGestureListeners(document,null,this.dragHandler,this.dropHandler)}mouseMove(t,e){if(!e.isConsumed()&&this.first){const s=G(this.graph.container),n=R(this.graph.container);s.x-=n.x,s.y-=n.y;const i=e.getX()+s.x,o=e.getY()+s.y,a=this.first.x-i,d=this.first.y-o,h=this.graph.getEventTolerance();(this.div||Math.abs(a)>h||Math.abs(d)>h)&&(this.div||(this.div=this.createShape()),ut(),this.update(i,o),e.consume())}}createShape(){this.sharedDiv||(this.sharedDiv=document.createElement("div"),this.sharedDiv.className="mxRubberband",gt(this.sharedDiv,this.defaultOpacity)),this.graph.container.appendChild(this.sharedDiv);const t=this.sharedDiv;return F.IS_SVG&&this.fadeOut&&(this.sharedDiv=null),t}isActive(t,e){return this.div&&this.div.style.display!=="none"}mouseUp(t,e){const s=this.isActive();this.reset(),s&&(this.execute(e.getEvent()),e.consume())}execute(t){const e=new O(this.x,this.y,this.width,this.height);this.graph.selectRegion(e,t)}reset(){if(this.div)if(F.IS_SVG&&this.fadeOut){const t=this.div;ft(t.style,"transition","all 0.2s linear"),t.style.pointerEvents="none",t.style.opacity=String(0),window.setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},200)}else this.div.parentNode&&this.div.parentNode.removeChild(this.div);p.removeGestureListeners(document,null,this.dragHandler,this.dropHandler),this.dragHandler=null,this.dropHandler=null,this.currentX=0,this.currentY=0,this.first=null,this.div=null}update(t,e){this.currentX=t,this.currentY=e,this.repaint()}repaint(){if(this.div&&this.first){const t=this.currentX-this.graph.getPanDx(),e=this.currentY-this.graph.getPanDy();this.x=Math.min(this.first.x,t),this.y=Math.min(this.first.y,e),this.width=Math.max(this.first.x,t)-this.x,this.height=Math.max(this.first.y,e)-this.y;const s=0,n=0;this.div.style.left=`${this.x+s}px`,this.div.style.top=`${this.y+n}px`,this.div.style.width=`${Math.max(1,this.width)}px`,this.div.style.height=`${Math.max(1,this.height)}px`}}onDestroy(){this.destroyed||(this.destroyed=!0,this.graph.removeMouseListener(this),this.graph.removeListener(this.forceRubberbandHandler),this.graph.removeListener(this.panHandler),this.reset(),this.sharedDiv&&(this.sharedDiv=null))}}lt.pluginId="RubberBandHandler";class Dt extends ot{constructor(t=100){super(),this.size=100,this.history=[],this.indexOfNextAdd=0,this.size=t,this.clear()}isEmpty(){return this.history.length==0}clear(){this.history=[],this.indexOfNextAdd=0,this.fireEvent(new S(p.CLEAR))}canUndo(){return this.indexOfNextAdd>0}undo(){for(;this.indexOfNextAdd>0;){const t=this.history[--this.indexOfNextAdd];if(t.undo(),t.isSignificant()){this.fireEvent(new S(p.UNDO,{edit:t}));break}}}canRedo(){return this.indexOfNextAdd<this.history.length}redo(){const t=this.history.length;for(;this.indexOfNextAdd<t;){const e=this.history[this.indexOfNextAdd++];if(e.redo(),e.isSignificant()){this.fireEvent(new S(p.REDO,{edit:e}));break}}}undoableEditHappened(t){this.trim(),this.size>0&&this.size==this.history.length&&this.history.shift(),this.history.push(t),this.indexOfNextAdd=this.history.length,this.fireEvent(new S(p.ADD,{edit:t}))}trim(){if(this.history.length>this.indexOfNextAdd){const t=this.history.splice(this.indexOfNextAdd,this.history.length-this.indexOfNextAdd);for(let e=0;e<t.length;e+=1)t[e].die()}}}class Mt{constructor(t){this.useBoundingBox=!0,this.parent=null,this.graph=t}moveCell(t,e,s){}resizeCell(t,e,s){}execute(t){}getGraph(){return this.graph}getConstraint(t,e,s,n){return this.graph.getCurrentCellStyle(e)[t]}traverse({vertex:t,directed:e,func:s,edge:n,visited:i}){if(s!=null&&t!=null&&(e=e??!0,i=i||new Map,!i.get(t))){i.set(t,!0);const o=s(t,n);if(o==null||o){const a=t.getEdgeCount();if(a>0)for(let d=0;d<a;d+=1){const h=t.getEdgeAt(d),c=h.getTerminal(!0)===t;if(!e||c){const u=this.graph.view.getVisibleTerminal(h,!c);this.traverse({vertex:u,directed:e,func:s,edge:h,visited:i})}}}}}isAncestor(t,e,s){if(!s)return e.getParent()===t;if(e===t)return!1;for(;e!=null&&e!==t;)e=e.getParent();return e===t}isVertexMovable(t){return this.graph.isCellMovable(t)}isVertexIgnored(t){return!t.isVertex()||!t.isVisible()}isEdgeIgnored(t){return!t.isEdge()||!t.isVisible()||t.getTerminal(!0)==null||t.getTerminal(!1)==null}setEdgeStyleEnabled(t,e){this.graph.setCellStyles("noEdgeStyle",e?"0":"1",[t])}setOrthogonalEdge(t,e){this.graph.setCellStyles("orthogonal",e?"1":"0",[t])}getParentOffset(t){const e=new I;if(t!=null&&t!==this.parent&&(this.graph.getDataModel(),this.parent&&this.parent.isAncestor(t))){let s=t.getGeometry();for(;t!==this.parent;)e.x+=s.x,e.y+=s.y,t=t.getParent(),s=t.getGeometry()}return e}setEdgePoints(t,e){if(t!=null){const{model:s}=this.graph;let n=t.getGeometry();if(n==null?(n=new yt,n.setRelative(!0)):n=n.clone(),this.parent!=null&&e!=null){const i=t.getParent(),o=this.getParentOffset(i);for(let a=0;a<e.length;a+=1)e[a].x=e[a].x-o.x,e[a].y=e[a].y-o.y}n.points=e,s.setGeometry(t,n)}}setVertexLocation(t,e,s){const n=this.graph.getDataModel();let i=t.getGeometry(),o=null;if(i!=null){if(o=new O(e,s,i.width,i.height),this.useBoundingBox){const a=this.graph.getView().getState(t);if(a!=null&&a.text!=null&&a.text.boundingBox!=null){const{scale:d}=this.graph.getView(),h=a.text.boundingBox;a.text.boundingBox.x<a.x&&(e+=(a.x-h.x)/d,o.width=h.width),a.text.boundingBox.y<a.y&&(s+=(a.y-h.y)/d,o.height=h.height)}}if(this.parent!=null){const a=t.getParent();if(a!=null&&a!==this.parent){const d=this.getParentOffset(a);e-=d.x,s-=d.y}}(i.x!==e||i.y!==s)&&(i=i.clone(),i.x=e,i.y=s,n.setGeometry(t,i))}return o}getVertexBounds(t){let e=t.getGeometry();if(this.useBoundingBox){const s=this.graph.getView().getState(t);if(s!=null&&s.text!=null&&s.text.boundingBox!=null){const{scale:n}=this.graph.getView(),i=s.text.boundingBox,o=Math.max(s.x-i.x,0)/n,a=Math.max(s.y-i.y,0)/n,d=Math.max(i.x+i.width-(s.x+s.width),0)/n,h=Math.max(i.y+i.height-(s.y+s.height),0)/n;e=new O(e.x-o,e.y-a,e.width+o+d,e.height+a+h)}}if(this.parent!=null){const s=t.getParent();if(e=e.clone(),s!=null&&s!==this.parent){const n=this.getParentOffset(s);e.x+=n.x,e.y+=n.y}}return new O(e.x,e.y,e.width,e.height)}arrangeGroups(t,e,s,n,i,o){return this.graph.updateGroupBounds(t,e,!0,s,n,i,o)}}class At extends Mt{constructor(t){super(t),this.useInputOrigin=!0,this.resetEdges=!0,this.disableEdgeStyle=!0,this.forceConstant=50,this.forceConstantSquared=0,this.minDistanceLimit=2,this.maxDistanceLimit=500,this.minDistanceLimitSquared=4,this.initialTemp=200,this.temperature=0,this.maxIterations=0,this.iteration=0,this.vertexArray=[],this.dispX=[],this.dispY=[],this.cellLocation=[],this.radius=[],this.radiusSquared=[],this.isMoveable=[],this.neighbours={},this.indices={},this.allowedToRun=!0}isVertexIgnored(t){return super.isVertexIgnored(t)||this.graph.getConnections(t).length===0}execute(t){this.vertexArray=[];let e=this.graph.getChildVertices(t);for(let i=0;i<e.length;i+=1)this.isVertexIgnored(e[i])||this.vertexArray.push(e[i]);const s=this.useInputOrigin?this.graph.getBoundingBoxFromGeometry(this.vertexArray):null,n=this.vertexArray.length;this.indices={},this.dispX=[],this.dispY=[],this.cellLocation=[],this.isMoveable=[],this.neighbours={},this.radius=[],this.radiusSquared=[],this.forceConstant<.001&&(this.forceConstant=.001),this.forceConstantSquared=this.forceConstant*this.forceConstant;for(let i=0;i<this.vertexArray.length;i+=1){const o=this.vertexArray[i];this.cellLocation[i]=[];const a=q.get(o);this.indices[a]=i;const d=this.getVertexBounds(o),{width:h}=d,{height:c}=d,{x:u}=d,{y:f}=d;this.cellLocation[i][0]=u+h/2,this.cellLocation[i][1]=f+c/2,this.radius[i]=Math.min(h,c),this.radiusSquared[i]=this.radius[i]*this.radius[i]}this.graph.batchUpdate(()=>{for(let h=0;h<n;h+=1){this.dispX[h]=0,this.dispY[h]=0,this.isMoveable[h]=this.isVertexMovable(this.vertexArray[h]);const c=this.graph.getConnections(this.vertexArray[h],t);e=this.graph.getOpposites(c,this.vertexArray[h]),this.neighbours[h]=[];for(let u=0;u<e.length;u+=1){this.resetEdges&&this.graph.resetEdge(c[u]),this.disableEdgeStyle&&this.setEdgeStyleEnabled(c[u],!1);const f=q.get(e[u]),x=this.indices[f];x!=null?this.neighbours[h][u]=x:this.neighbours[h][u]=h}}for(this.temperature=this.initialTemp,this.maxIterations===0&&(this.maxIterations=20*Math.sqrt(n)),this.iteration=0;this.iteration<this.maxIterations;this.iteration+=1){if(!this.allowedToRun)return;this.calcRepulsion(),this.calcAttraction(),this.calcPositions(),this.reduceTemperature()}let i=null,o=null;for(let h=0;h<this.vertexArray.length;h+=1){const c=this.vertexArray[h];if(this.isVertexMovable(c)){const u=this.getVertexBounds(c);if(u!=null){this.cellLocation[h][0]-=u.width/2,this.cellLocation[h][1]-=u.height/2;const f=this.graph.snap(Math.round(this.cellLocation[h][0])),x=this.graph.snap(Math.round(this.cellLocation[h][1]));this.setVertexLocation(c,f,x),i==null?i=f:i=Math.min(i,f),o==null?o=x:o=Math.min(o,x)}}}let a=-(i||0)+1,d=-(o||0)+1;s!=null&&(a+=s.x,d+=s.y),this.graph.moveCells(this.vertexArray,a,d)})}calcPositions(){for(let t=0;t<this.vertexArray.length;t+=1)if(this.isMoveable[t]){let e=Math.sqrt(this.dispX[t]*this.dispX[t]+this.dispY[t]*this.dispY[t]);e<.001&&(e=.001);const s=this.dispX[t]/e*Math.min(e,this.temperature),n=this.dispY[t]/e*Math.min(e,this.temperature);this.dispX[t]=0,this.dispY[t]=0,this.cellLocation[t][0]+=s,this.cellLocation[t][1]+=n}}calcAttraction(){for(let t=0;t<this.vertexArray.length;t+=1)for(let e=0;e<this.neighbours[t].length;e+=1){const s=this.neighbours[t][e];if(t!==s&&this.isMoveable[t]&&this.isMoveable[s]){const n=this.cellLocation[t][0]-this.cellLocation[s][0],i=this.cellLocation[t][1]-this.cellLocation[s][1];let o=n*n+i*i-this.radiusSquared[t]-this.radiusSquared[s];o<this.minDistanceLimitSquared&&(o=this.minDistanceLimitSquared);const a=Math.sqrt(o),d=o/this.forceConstant,h=n/a*d,c=i/a*d;this.dispX[t]-=h,this.dispY[t]-=c,this.dispX[s]+=h,this.dispY[s]+=c}}}calcRepulsion(){const t=this.vertexArray.length;for(let e=0;e<t;e+=1)for(let s=e;s<t;s+=1){if(!this.allowedToRun)return;if(s!==e&&this.isMoveable[e]&&this.isMoveable[s]){let n=this.cellLocation[e][0]-this.cellLocation[s][0],i=this.cellLocation[e][1]-this.cellLocation[s][1];n===0&&(n=.01+Math.random()),i===0&&(i=.01+Math.random());const o=Math.sqrt(n*n+i*i);let a=o-this.radius[e]-this.radius[s];if(a>this.maxDistanceLimit)continue;a<this.minDistanceLimit&&(a=this.minDistanceLimit);const d=this.forceConstantSquared/a,h=n/o*d,c=i/o*d;this.dispX[e]+=h,this.dispY[e]+=c,this.dispX[s]-=h,this.dispY[s]-=c}}}reduceTemperature(){this.temperature=this.initialTemp*(1-this.iteration/this.maxIterations)}}class It extends ot{constructor(t=20){super(),this.thread=null,this.delay=t}isRunning(){return this.thread!=null}startAnimation(){this.thread==null&&(this.thread=window.setInterval(this.updateAnimation.bind(this),this.delay))}updateAnimation(){this.fireEvent(new S(p.EXECUTE))}stopAnimation(){this.thread!=null&&(window.clearInterval(this.thread),this.thread=null,this.fireEvent(new S(p.DONE)))}}class kt{constructor(t){this.count=0,this.deltas=new Map,this.graph=t}isEmpty(){return this.count===0}moveState(t,e,s,n=!0,i=!0){let o=this.deltas.get(t.cell);return o==null?(o={point:new I(e,s),state:t},this.deltas.set(t.cell,o),this.count++):n?(o.point.x+=e,o.point.y+=s):(o.point.x=e,o.point.y=s),i&&this.addEdges(t),o.point}show(t=null){this.deltas.forEach(e=>{this.translateState(e.state,e.point.x,e.point.y)}),this.deltas.forEach(e=>{this.revalidateState(e.state,e.point.x,e.point.y,t)})}translateState(t,e,s){if(t!=null){if(t.cell.isVertex()){t.view.updateCellState(t);const n=t.cell.getGeometry();(e!==0||s!==0)&&n!=null&&(!n.relative||this.deltas.get(t.cell)!=null)&&(t.x+=e,t.y+=s)}for(const n of t.cell.getChildren())this.translateState(t.view.getState(n),e,s)}}revalidateState(t,e,s,n=null){t.cell.isEdge()&&t.view.updateCellState(t);const i=t.cell.getGeometry(),o=t.view.getState(t.cell.getParent());(e!==0||s!==0)&&i!=null&&i.relative&&t.cell.isVertex()&&(o==null||o.cell.isVertex()||this.deltas.get(t.cell)!=null)&&(t.x+=e,t.y+=s),this.graph.cellRenderer.redraw(t),n!=null&&n(t);for(const a of t.cell.getChildren())this.revalidateState(this.graph.view.getState(a),e,s,n)}addEdges(t){const e=t.cell.getEdgeCount();for(let s=0;s<e;s+=1){const n=t.view.getState(t.cell.getEdgeAt(s));n!=null&&this.moveState(n,0,0)}}}class Bt extends It{constructor(t,e=6,s=1.5,n){super(n),this.step=0,this.cells=null,this.graph=t,this.steps=e,this.ease=s}updateAnimation(){super.updateAnimation();const t=new kt(this.graph);if(this.cells!=null)for(const e of this.cells)this.animateCell(e,t,!1);else this.animateCell(this.graph.getDataModel().getRoot(),t,!0);this.show(t),(t.isEmpty()||this.step++>=this.steps)&&this.stopAnimation()}show(t){t.show()}animateCell(t,e,s=!1){const n=this.graph.getView().getState(t);let i=null;if(n!=null&&(i=this.getDelta(n),t.isVertex()&&(i.x!=0||i.y!=0))){const o=this.graph.view.getTranslate(),a=this.graph.view.getScale();i.x+=o.x*a,i.y+=o.y*a,e.moveState(n,-i.x/this.ease,-i.y/this.ease)}if(s&&!this.stopRecursion(n,i)){const o=t.getChildCount();for(let a=0;a<o;a+=1)this.animateCell(t.getChildAt(a),e,s)}}stopRecursion(t=null,e=null){return e!=null&&(e.x!=0||e.y!=0)}getDelta(t){const e=this.getOriginForCell(t.cell),s=this.graph.getView().getTranslate(),n=this.graph.getView().getScale(),i=t.x/n-s.x,o=t.y/n-s.y;return new I((e.x-i)*n,(e.y-o)*n)}getOriginForCell(t=null){let e=null;if(t!=null){const s=t.getParent(),n=t.getGeometry();if(e=this.getOriginForCell(s),n!=null&&s!=null)if(n.relative){const i=s.getGeometry();i!=null&&(e.x+=n.x*i.width,e.y+=n.y*i.height)}else e.x+=n.x,e.y+=n.y}if(e==null){const s=this.graph.view.getTranslate();e=new I(-s.x,-s.y)}return e}}const Ot=[vt,Et,bt,St,lt],E=document.getElementById("graph-container");if(!E)throw new Error("#graph-container introuvable");const l=new mt(E,new xt,Ot),M=l.getDataModel(),k=l.getStylesheet().getDefaultEdgeStyle();k.labelBackgroundColor="#FFFFFF";k.strokeWidth=2;k.rounded=!0;k.entryPerimeter=!1;k.edgeStyle="manhattanEdgeStyle";l.getFoldingImage=()=>null;at.selectionColor="#00a8ff";at.selectionStrokeWidth=2;const v=new Dt,ht=(r,t)=>{const e=t.getProperty("edit");e&&v.undoableEditHappened(e)};M.addListener(p.UNDO,ht);l.getView().addListener(p.UNDO,ht);const z=document.getElementById("undoButton"),H=document.getElementById("redoButton");z&&z.addEventListener("click",()=>{v.canUndo()&&v.undo()});H&&H.addEventListener("click",()=>{v.canRedo()&&v.redo()});document.addEventListener("keydown",r=>{r.ctrlKey&&r.key==="z"?(r.preventDefault(),v.canUndo()&&v.undo()):r.ctrlKey&&r.key==="y"&&(r.preventDefault(),v.canRedo()&&v.redo())});const y=document.getElementById("edge-context-menu"),b=document.getElementById("edge-color-select"),w=document.getElementById("edge-thickness-select"),m=document.getElementById("text-context-menu"),V=document.getElementById("text-font-select"),T=document.getElementById("text-color-select"),P=document.getElementById("text-size-select"),C=document.getElementById("text-bold-select"),L=document.getElementById("text-italic-select"),D=document.getElementById("text-underline-select");let g=null;l.container.addEventListener("contextmenu",r=>{r.preventDefault();const t=l.getCellAt(r.offsetX,r.offsetY);if(!t||!y||!m)return;const e=E.getBoundingClientRect(),s=r.clientX-e.left,n=r.clientY-e.top,i=l.getCellStyle(t);if(t.isEdge())g=t,y.style.display="block",y.style.left=`${s+75}px`,y.style.top=`${n+100}px`,b&&w&&(b.value=i.strokeColor||"#000000",w.value=String(i.strokeWidth??"1")),m.style.display="none";else if(t.isVertex()){const o=t.value,a=!!o&&o.trim()!=="",d=t.style;if(a&&T&&V&&P){g=t,m.style.display="block",m.style.left=`${s+75}px`,m.style.top=`${n+100}px`,y.style.display="none",T.value=i.fontColor||"#000000",V.value=i.fontFamily||"Arial",P.value=String(i.fontSize??"12");const h=(d==null?void 0:d.fontStyle)??0;C&&(h&1?C.classList.add("selected"):C.classList.remove("selected")),L&&(h&2?L.classList.add("selected"):L.classList.remove("selected")),D&&(h&4?D.classList.add("selected"):D.classList.remove("selected"))}else!(d!=null&&d.image)&&(!t.children||t.children.length===0)?(g=t,y.style.display="block",y.style.left=`${s+75}px`,y.style.top=`${n+100}px`,b&&w&&(b.value=i.strokeColor||"#000000",w.value=String(i.strokeWidth??"1")),m.style.display="none"):(m.style.display="none",y.style.display="none")}else m.style.display="none",y.style.display="none"});var Z;(Z=document.getElementById("apply-edge-style"))==null||Z.addEventListener("click",r=>{r.preventDefault(),!(!g||!b||!w)&&(l.batchUpdate(()=>{const t=(g==null?void 0:g.style)??{},e=parseInt(w.value,10)||1;g!=null&&g.isEdge()?(t.strokeColor=b.value,t.strokeWidth=e):(t.fillColor=b.value,t.strokeWidth=e),g.style=t,l.refresh(g)}),y&&(y.style.display="none"))});var tt;(tt=document.getElementById("apply-text-style"))==null||tt.addEventListener("click",r=>{r.preventDefault(),!(!g||!V||!T||!P)&&(l.batchUpdate(()=>{const t=(g==null?void 0:g.style)??{};t.fontFamily=V.value,t.fontColor=T.value,t.fontSize=parseInt(P.value,10)||12;let e=0;C!=null&&C.classList.contains("selected")&&(e|=1),L!=null&&L.classList.contains("selected")&&(e|=2),D!=null&&D.classList.contains("selected")&&(e|=4),t.fontStyle=e,g&&(g.style=t,l.refresh(g)),l.refresh(g)}),m&&(m.style.display="none"))});document.querySelectorAll(".button").forEach(r=>{r.addEventListener("click",()=>{r.classList.toggle("selected")})});document.addEventListener("click",r=>{const t=r.target;m&&!m.contains(t)&&(m.style.display="none"),y&&!y.contains(t)&&(y.style.display="none")});l.setGridEnabled(!0);l.setGridSize(10);E.style.backgroundImage=`
  linear-gradient(to right, #e0e0e0 1px, transparent 1px),
  linear-gradient(to bottom, #e0e0e0 1px, transparent 1px)
`;E.style.backgroundSize="10px 10px";l.setPanning(!0);l.allowAutoPanning=!0;l.useScrollbarsForPanning=!0;function Vt(r){new X(M).import(r)}window.loadGraph=Vt;async function Tt(r,t,e,s){const n=document.querySelector('meta[name="csrf-token"]'),i=n==null?void 0:n.content;if(!i){console.error("CSRF token manquant"),alert("Token CSRF manquant.");return}try{const o=await fetch(`/admin/graphs/${r}`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":i,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({_method:"PUT",id:r,name:t,type:e,content:s})});if(o.status!==200){let a="Erreur lors de la sauvegarde du graphe.";try{const d=await o.json();d!=null&&d.message&&(a=d.message)}catch{}throw new Error(a)}console.log("Graphe sauvegardé avec succès")}catch(o){console.error("Erreur lors de la sauvegarde :",o),alert("Erreur lors de la sauvegarde du graphe.")}}function Pt(){return new X(l.getDataModel()).export()}window.getXMLGraph=Pt;function Rt(){const r=document.querySelector("#id"),t=document.querySelector("#name"),e=document.querySelector("#type");if(!r||!t||!e){alert("Champs id / name / type manquants");return}const s=new X(M).export();Tt(r.value,t.value,e.value,s)}var et;(et=document.getElementById("saveButton"))==null||et.addEventListener("click",Rt);function U(r,t){if(typeof r.getPointForEvent=="function"){const d=r.getPointForEvent(t);return{x:d.x,y:d.y}}const e=r.view??r.getView(),s=rt(r.container,Lt(t),Ct(t)),n=e.translate??{x:0,y:0},i=e.scale??1,o=r.panDx??0,a=r.panDy??0;return{x:(s.x-o)/i-n.x-20,y:(s.y-a)/i-n.y-20}}l.enterStopsCellEditing=!0;const Y=document.getElementById("font-btn");Y&&Y.addEventListener("dragstart",r=>{var t;(t=r.dataTransfer)==null||t.setData("node-type","text-node")});E.addEventListener("dragover",r=>{r.preventDefault()});E.addEventListener("drop",r=>{var e;if(r.preventDefault(),((e=r.dataTransfer)==null?void 0:e.getData("node-type"))==="text-node"){const s=U(l,r);l.batchUpdate(()=>{const n=l.getDefaultParent();l.insertVertex({parent:n,value:"Text",position:[s.x,s.y],size:[150,30],style:{fillColor:"none",strokeColor:"none",fontColor:"#000000",fontSize:14,align:"left",verticalAlign:"middle"}})})}});const _=document.getElementById("square-btn");_&&_.addEventListener("dragstart",r=>{var t;(t=r.dataTransfer)==null||t.setData("node-type","square-node")});E.addEventListener("drop",r=>{var e;if(r.preventDefault(),((e=r.dataTransfer)==null?void 0:e.getData("node-type"))==="square-node"){const s=U(l,r);l.batchUpdate(()=>{const n=l.getDefaultParent(),i=l.insertVertex({parent:n,value:"",position:[s.x,s.y],size:[150,120],style:{fillColor:"#fffacd",strokeColor:"#000000",strokeWidth:1,rounded:2}});l.orderCells(!0,[i])})}});const A=document.getElementById("nodeImage"),W=document.getElementById("node");A&&A.addEventListener("dragstart",r=>{var t;(t=r.dataTransfer)==null||t.setData("node-type","icon-node")});E.addEventListener("drop",r=>{var e;if(r.preventDefault(),((e=r.dataTransfer)==null?void 0:e.getData("node-type"))==="icon-node"&&A&&A.src&&W){const s=U(l,r),n=l.getDefaultParent(),i=W.value;l.batchUpdate(()=>{const o=M.getCell(i);if(o)l.setSelectionCells([o]);else{const a=_nodes.get(i);if(!a)return;const d=l.insertVertex({parent:n,id:i,value:a.label,position:[s.x-16,s.y-16],size:[32,32],style:{shape:"image",image:A.src,editable:!1,resizable:!0,verticalLabelPosition:"bottom",spacingTop:-15}});a.edges.forEach(h=>{const c=M.getCell(h.attachedNodeId);c&&l.insertEdge({parent:n,value:"",source:d,target:c,style:{editable:!1,strokeColor:"#ff0000",strokeWidth:1,startArrow:"none",endArrow:"none"}})})}})}});const j=document.getElementById("zoom-in-btn"),K=document.getElementById("zoom-out-btn");j&&j.addEventListener("click",()=>l.zoomIn());K&&K.addEventListener("click",()=>l.zoomOut());document.addEventListener("keydown",r=>{if(r.key==="Delete"||r.key==="Backspace"){const t=l.getSelectionCells();t.length>0&&l.removeCells(t)}});$("body").keydown(r=>{r.ctrlKey&&r.keyCode===65&&(r.preventDefault(),r.stopPropagation(),l.selectAll())});l.setConnectable(!1);l.isCellDisconnectable=()=>!1;const J=document.getElementById("group-btn"),Q=document.getElementById("ungroup-btn");J&&J.addEventListener("click",()=>{const r=l.getSelectionCells();if(r.length>1){const t=l.getDefaultParent(),e=l.insertVertex({parent:t,style:{fillColor:"none",strokeColor:"none"}});l.addCell(e),l.groupCells(e,5,r)}});Q&&Q.addEventListener("click",()=>{const r=l.getSelectionCells();r.length===1&&(l.ungroupCells(r),l.setSelectionCells(r))});function B(r,t,e){const s=r.getSelectionCell();s&&s.isVertex()&&r.batchUpdate(()=>{const n=s.getGeometry();n&&(n.translate(t,e),r.refresh())})}document.addEventListener("keydown",r=>{switch(r.key){case"ArrowUp":B(l,0,-1);break;case"ArrowDown":B(l,0,1);break;case"ArrowLeft":B(l,-1,0);break;case"ArrowRight":B(l,1,0);break}});function Gt(r,t,e){const s=[],n=2*Math.PI/e;for(let i=0;i<e;i++){const o=i*n;s.push({x:r.x+t*Math.cos(o),y:r.y+t*Math.sin(o)})}return s}function Ft(){const r=document.getElementById("filters");if(!r)return[];const t=[];for(const e of Array.from(r.options))e.selected&&t.push(e.value);return t}function Nt(r,t,e){if(!r||!t)return!1;let s=!1;return(i=>{i.forEach(o=>{o.target===t&&(e==null||o.value===e)&&(s=!0)})})(l.getEdges(r)),s||l.getEdges(t).forEach(o=>{o.target===r&&(e==null||o.value===e)&&(s=!0)}),s}l.addListener(p.DOUBLE_CLICK,(r,t)=>{const e=t.getProperty("cell");if(!e||!e.isVertex())return;const s=e.style;if((s==null?void 0:s.shape)!=="image")return;const n=_nodes.get(e.id);n&&l.batchUpdate(()=>{const i=[],o=l.getDefaultParent(),a=Ft();n.edges.forEach(c=>{const u=_nodes.get(c.attachedNodeId);if(!u)return;const f=M.getCell(c.attachedNodeId);!f&&!i.some(x=>x.attachedNodeId===c.attachedNodeId)?(a.length===0||a.includes(u.vue)||a.includes("8")&&c.edgeType==="CABLE"||a.includes("9")&&c.edgeType==="FLUX")&&i.push(c):f&&!Nt(e,f,c.name)&&l.insertEdge({parent:o,value:c.name,source:e,target:f,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:c.edgeType==="FLUX"&&(c.bidirectional||c.edgeDirection==="FROM")?"classic":"none",endArrow:c.edgeType==="FLUX"&&(c.bidirectional||c.edgeDirection==="TO")?"classic":"none"}})});const d=e.getGeometry();if(!d)return;const h=Gt({x:d.x,y:d.y},80,i.length);for(let c=0;c<h.length;c++){const u=i[c],f=_nodes.get(u.attachedNodeId);if(!f)continue;const x=l.insertVertex({parent:o,id:f.id,value:f.label,position:[h[c].x,h[c].y],size:[32,32],style:{shape:"image",image:f.image,editable:!1,resizable:!0,verticalLabelPosition:"bottom",spacingTop:-15}});l.insertEdge({parent:o,value:u.name,source:e,target:x,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:u.edgeType==="FLUX"&&(u.bidirectional||u.edgeDirection==="FROM")?"classic":"none",endArrow:u.edgeType==="FLUX"&&(u.bidirectional||u.edgeDirection==="TO")?"classic":"none"}})}})});var st;(st=document.getElementById("update-btn"))==null||st.addEventListener("click",()=>{l.batchUpdate(()=>{l.getChildCells().forEach(t=>{const e=t.style;if(!t.isEdge()){if(e!=null&&e.image){const s=_nodes.get(t.id);s?(t.value=s.label,wt(l.getDataModel(),[t],{image:s.image})):l.removeCells([t],!0)}}}),l.refresh()})});const N=l.container.querySelector("svg");function Xt(r){r.querySelectorAll("image").forEach(e=>{const s=e.getAttribute("xlink:href");s&&fetch(s).then(n=>n.blob()).then(n=>{const i=new FileReader;i.onloadend=()=>{const o=i.result;typeof o=="string"&&e.setAttribute("xlink:href",o)},i.readAsDataURL(n)}).catch(n=>console.error("Erreur embed image SVG",n))})}function Ut(){if(!N){alert("SVG introuvable");return}Xt(N),setTimeout(()=>{const t=new XMLSerializer().serializeToString(N),e=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(e),n=document.createElement("a"),i=new Date,o=i.getFullYear()+String(i.getMonth()+1).padStart(2,"0")+String(i.getDate()).padStart(2,"0")+String(i.getHours()).padStart(2,"0")+String(i.getMinutes()).padStart(2,"0");n.href=s,n.download=`graph-${o}.svg`,n.click(),URL.revokeObjectURL(s)},1e3)}var it;(it=document.getElementById("download-btn"))==null||it.addEventListener("click",Ut);function qt(){const r=l.getDefaultParent(),t=l.getChildVertices(r);if(!t||t.length===0)return;const e=new At(l);e.forceConstant=60,e.disableEdgeStyle=!1,l.getDataModel().beginUpdate();try{e.execute(r,t)}finally{const s=new Bt(l);s.addListener(p.DONE,()=>l.getDataModel().endUpdate()),s.startAnimation()}}var nt;(nt=document.getElementById("layout-btn"))==null||nt.addEventListener("click",qt);
