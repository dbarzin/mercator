{"version":3,"file":"bpmn-load.js","sources":["../../resources/ts/bpmn-load.ts"],"sourcesContent":["// src/bpmn-load.ts\nimport {Cell, EdgeParameters, Graph, VertexParameters} from '@maxgraph/core';\nimport {showStatus} from './bpmn-edit';\n\nexport interface BpmnElements {\n    startEvents: any[];\n    tasks: any[];\n    gateways: any[];\n    endEvents: any[];\n    flows: any[];\n    participants: any[];\n}\n\nexport interface BpmnPositions {\n    [id: string]: {\n        x: number;\n        y: number;\n        width: number;\n        height: number;\n    };\n}\n\nexport interface BpmnData {\n    elements: BpmnElements;\n    positions: BpmnPositions;\n    xmlDoc: Document;\n}\n\nlet currentBpmnData: BpmnData | null = null;\n\nexport function getCurrentBpmnData(): BpmnData | null {\n    return currentBpmnData;\n}\n\n// Sanitize XML (d√©fense en profondeur)\nexport function sanitizeXml(xml: string): string {\n    return xml\n        .replace(/[\\u0000-\\u0008\\u000B\\u000C\\u000E-\\u001F\\u007F]/g, '')\n        .trim();\n}\n\n// Parser BPMN\nexport function parseBPMN(xmlText: string): BpmnData {\n    console.log('üîß D√©but du parsing BPMN');\n    const parser = new DOMParser();\n    const sanitizedXmlText = sanitizeXml(xmlText);\n    const xmlDoc = parser.parseFromString(sanitizedXmlText, 'application/xml');\n\n    const parserError = xmlDoc.getElementsByTagName('parsererror')[0];\n    if (parserError) {\n        console.error('Erreur XML :', parserError.textContent);\n        throw new Error(parserError.textContent || 'Erreur de parsing XML');\n    }\n\n    console.log('üì¶ Document XML pars√©');\n\n    const elements: BpmnElements = {\n        startEvents: [],\n        tasks: [],\n        gateways: [],\n        endEvents: [],\n        flows: [],\n        participants: [],\n    };\n\n    // Participants\n    const participants = xmlDoc.getElementsByTagName('participant');\n    console.log(`üèä Participants trouv√©s: ${participants.length}`);\n    for (const p of Array.from(participants)) {\n        elements.participants.push({\n            id: p.getAttribute('id'),\n            name: p.getAttribute('name'),\n            processRef: p.getAttribute('processRef'),\n        });\n    }\n\n    // Start events\n    const startEvents = xmlDoc.getElementsByTagNameNS('*', 'startEvent');\n    console.log(`‚ñ∂Ô∏è Start events trouv√©s: ${startEvents.length}`);\n    for (const se of Array.from(startEvents)) {\n        elements.startEvents.push({\n            id: se.getAttribute('id'),\n            name: se.getAttribute('name'),\n        });\n    }\n\n    // Tasks\n    const tasks = xmlDoc.getElementsByTagNameNS('*', 'task');\n    console.log(`üìã Tasks trouv√©es: ${tasks.length}`);\n    for (const t of Array.from(tasks)) {\n        elements.tasks.push({\n            id: t.getAttribute('id'),\n            name: t.getAttribute('name'),\n        });\n    }\n\n    // Gateways\n    const gateways = xmlDoc.querySelectorAll('exclusiveGateway, parallelGateway, inclusiveGateway');\n    console.log(`üîÄ Gateways trouv√©s: ${gateways.length}`);\n    gateways.forEach((g) => {\n        elements.gateways.push({\n            id: g.getAttribute('id'),\n            name: g.getAttribute('name'),\n            type: g.tagName.replace(/Gateway$/, ''),\n        });\n    });\n\n    // End events\n    const endEvents = xmlDoc.getElementsByTagNameNS('*', 'endEvent');\n    console.log(`‚èπÔ∏è End events trouv√©s: ${endEvents.length}`);\n    for (const ee of Array.from(endEvents)) {\n        elements.endEvents.push({\n            id: ee.getAttribute('id'),\n            name: ee.getAttribute('name'),\n        });\n    }\n\n    // Flows\n    const flows = xmlDoc.getElementsByTagNameNS('*', 'sequenceFlow');\n    console.log(`‚û°Ô∏è Flows trouv√©s: ${flows.length}`);\n    for (const f of Array.from(flows)) {\n        elements.flows.push({\n            id: f.getAttribute('id'),\n            source: f.getAttribute('sourceRef'),\n            target: f.getAttribute('targetRef'),\n        });\n    }\n\n    // Positions\n    const shapes = xmlDoc.getElementsByTagNameNS('*', 'BPMNShape');\n    console.log(`üìê Shapes trouv√©s: ${shapes.length}`);\n    const positions: BpmnPositions = {};\n\n    for (const shape of Array.from(shapes)) {\n        const id = shape.getAttribute('bpmnElement');\n        const bounds = shape.getElementsByTagNameNS('*', 'Bounds')[0];\n\n        if (id && bounds) {\n            positions[id] = {\n                x: parseFloat(bounds.getAttribute('x') || '0'),\n                y: parseFloat(bounds.getAttribute('y') || '0'),\n                width: parseFloat(bounds.getAttribute('width') || '0'),\n                height: parseFloat(bounds.getAttribute('height') || '0'),\n            };\n        }\n    }\n\n    console.log('üìç Positions r√©cup√©r√©es:', Object.keys(positions).length);\n    console.log('‚úÖ Parsing termin√© avec succ√®s');\n\n    const data: BpmnData = { elements, positions, xmlDoc };\n    currentBpmnData = data;\n\n    return data;\n}\n\n//=============================================\n// Changes swimlane orientation while collapsed\nconst getStyle = function (this: Cell) {\n    if (!this.isCollapsed()) {\n        return this.style;\n    }\n    // Need to create a copy the original style as we don't want to change the original style stored in the Cell\n    // Otherwise, when expanding the cell, the style will be incorrect\n    const style = { ...this.style };\n    style.horizontal = true;\n    style.align = 'left';\n    style.spacingLeft = 14;\n    return style;\n};\n\nconst insertVertex = (graph: Graph, options: VertexParameters) => {\n    const v = graph.insertVertex(options);\n    v.getStyle = getStyle;\n    return v;\n};\n\nconst insertEdge = (graph: Graph, options: EdgeParameters) => {\n    const e = graph.insertEdge(options);\n    e.getStyle = getStyle;\n    return e;\n};\n//=============================================\n\n// Dessiner le diagramme\nexport function drawDiagram(graph: Graph, data: BpmnData): void {\n    console.log('üé® D√©but du dessin du diagramme');\n    const { elements, positions } = data;\n    const parent = graph.getDefaultParent();\n    const vertexMap: Record<string, any> = {};\n\n    graph.model.beginUpdate();\n    try {\n        graph.removeCells(graph.getChildCells(parent));\n        console.log('üßπ Cellules pr√©c√©dentes supprim√©es');\n\n        // Participants\n        elements.participants.forEach((p) => {\n            const pos = positions[p.id] || { x: 100, y: 100, width: 600, height: 250 };\n            vertexMap[p.id] = graph.insertVertex(\n                parent,\n                p.id,\n                p.name || 'Lane',\n                pos.x,\n                pos.y,\n                pos.width,\n                pos.height,\n                { baseStyleNames: ['swimlane'] },\n                //'swimlane;startSize=30;fillColor=#f0f0f0;strokeColor=#666;'\n            );\n        });\n\n        // Start events\n        elements.startEvents.forEach((se) => {\n            const pos = positions[se.id] || { x: 200, y: 150, width: 36, height: 36 };\n            console.log(\"Add start event \", se.name);\n            vertexMap[se.id] = graph.insertVertex(\n                parent,\n                se.id,\n                se.name || '',\n                pos.x,\n                pos.y,\n                pos.width,\n                pos.height,\n                // 'ellipse;fillColor=#c8e6c9;strokeColor=#205022;strokeWidth=2;'\n                { baseStyleNames: ['state'] },\n            );\n        });\n\n        // Tasks\n        elements.tasks.forEach((t) => {\n            console.log(\"Add task \", t.name);\n            const pos = positions[t.id] || { x: 300, y: 130, width: 100, height: 80 };\n            vertexMap[t.id] = graph.insertVertex(\n                parent,\n                t.id,\n                t.name || 'Task',\n                pos.x,\n                pos.y,\n                pos.width,\n                pos.height,\n                // 'rounded=1;fillColor=#bbdefb;strokeColor=#0d4372;strokeWidth=2;'\n                { baseStyleNames: ['process'] },\n            );\n\n        });\n\n        // Gateways\n        elements.gateways.forEach((g) => {\n            console.log(\"Add gateway \", g.name);\n            const pos = positions[g.id] || { x: 450, y: 145, width: 50, height: 50 };\n            vertexMap[g.id] = graph.insertVertex(\n                parent,\n                g.id,\n                g.name || '',\n                pos.x,\n                pos.y,\n                pos.width,\n                pos.height,\n                { baseStyleNames: ['condition'] },\n                // 'rhombus;fillColor=#fff59d;strokeColor=#f57f17;strokeWidth=2;'\n            );\n        });\n\n        // End events\n        elements.endEvents.forEach((ee) => {\n            console.log(\"Add end event \", ee.name);\n            const pos = positions[ee.id] || { x: 550, y: 152, width: 36, height: 36 };\n            vertexMap[ee.id] = graph.insertVertex(\n                parent,\n                ee.id,\n                ee.name || '',\n                pos.x,\n                pos.y,\n                pos.width,\n                pos.height,\n                { baseStyleNames: ['state'] },\n                // 'ellipse;fillColor=#ffcdd2;strokeColor=#831311;strokeWidth=3;'\n            );\n        });\n\n        // Flows\n        elements.flows.forEach((f) => {\n            const source = vertexMap[f.source];\n            const target = vertexMap[f.target];\n\n            if (source && target) {\n                graph.insertEdge(\n                    parent,\n                    f.id,\n                    '',\n                    source,\n                    target,\n                    { baseStyleNames: ['arrow'] },\n                );\n            } else {\n                console.warn(`‚ö†Ô∏è Flow ignor√© (source ou target manquant): ${f.id}`);\n            }\n        });\n    } finally {\n        graph.model.endUpdate();\n    }\n\n    console.log('‚úÖ Diagramme dessin√© avec succ√®s');\n\n    setTimeout(() => {\n        graph.center();\n        console.log('üìê Vue centr√©e');\n    }, 100);\n}\n\n// Gestion de l‚Äôinput fichier\nexport function bindBpmnFileInput(graph: Graph, inputId = 'file-input') {\n    const input = document.getElementById(inputId) as HTMLInputElement | null;\n    if (!input) {\n        console.warn(`#${inputId} introuvable, pas de chargement BPMN via fichier`);\n        return;\n    }\n\n    input.addEventListener('change', async (e: Event) => {\n        console.log('üìÅ √âv√©nement file input d√©clench√©');\n        const target = e.target as HTMLInputElement;\n        const file = target.files?.[0];\n        if (!file) {\n            console.log('‚ùå Pas de fichier s√©lectionn√©');\n            return;\n        }\n\n        console.log('üìÑ Fichier:', file.name, file.size, 'bytes');\n        const text = await file.text();\n        console.log('üìù Contenu XML (extrait):', text.substring(0, 200) + '...');\n\n        try {\n            console.log('üîç Parsing BPMN...');\n            const data = parseBPMN(text);\n            console.log('‚úÖ Parsing r√©ussi');\n\n            console.log('üé® Dessin du diagramme...');\n            drawDiagram(graph, data);\n\n            const totalElements =\n                data.elements.startEvents.length +\n                data.elements.tasks.length +\n                data.elements.gateways.length +\n                data.elements.endEvents.length;\n\n            console.log(`üìä Total: ${totalElements} √©l√©ments, ${data.elements.flows.length} flux`);\n\n            showStatus('‚úì Fichier charg√© avec succ√®s');\n        } catch (error: any) {\n            console.error('‚ùå ERREUR:', error);\n            showStatus('‚úó Erreur lors du chargement du fichier');\n        }\n    });\n}\n"],"names":["sanitizeXml","xml","parseBPMN","xmlText","parser","sanitizedXmlText","xmlDoc","parserError","elements","participants","p","startEvents","se","tasks","t","gateways","g","endEvents","ee","flows","f","shapes","positions","shape","id","bounds","drawDiagram","graph","data","parent","vertexMap","pos","source","target","bindBpmnFileInput","inputId","input","e","file","text","totalElements","showStatus","error"],"mappings":"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"}