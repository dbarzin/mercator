class ImageBox{constructor(t,e,i){this.src=t,this.width=e,this.height=i}}class EventObject{constructor(t="",...e){if(this.consumed=!1,this.name=t,this.properties={},e[0]&&e[0].constructor===Object)for(const[i,s]of Object.entries(e[0]))this.properties[i]=s;else for(let i=0;i<e.length;i+=2)e[i+1]!==null&&(this.properties[e[i]]=e[i+1])}getName(){return this.name}getProperties(){return this.properties}getProperty(t){return this.properties[t]}isConsumed(){return this.consumed}consume(){this.consumed=!0}}class EventSource{constructor(t=null){this.eventListeners=[],this.eventsEnabled=!0,this.eventSource=null,this.eventSource=t}isEventsEnabled(){return this.eventsEnabled}setEventsEnabled(t){this.eventsEnabled=t}getEventSource(){return this.eventSource}setEventSource(t){this.eventSource=t}addListener(t,e){this.eventListeners.push({name:t,funct:e})}removeListener(t){let e=0;for(;e<this.eventListeners.length;)this.eventListeners[e].funct===t?this.eventListeners.splice(e,1):e+=1}fireEvent(t,e=null){if(this.isEventsEnabled()){t||(t=new EventObject("")),e||(e=this.getEventSource()),e||(e=this);for(const i of this.eventListeners)(i.name===null||i.name===t.getName())&&i.funct.apply(this,[e,t])}}}const DEFAULT_HOTSPOT=.3,MIN_HOTSPOT_SIZE=8,MAX_HOTSPOT_SIZE=0;var RENDERING_HINT;(function(n){n.EXACT="exact",n.FASTER="faster",n.FASTEST="fastest"})(RENDERING_HINT||(RENDERING_HINT={}));var DIALECT;(function(n){n.SVG="svg",n.MIXEDHTML="mixedHtml",n.PREFERHTML="preferHtml",n.STRICTHTML="strictHtml"})(DIALECT||(DIALECT={}));const IDENTITY_FIELD_NAME="mxObjectId",NS_SVG="http://www.w3.org/2000/svg",NS_XLINK="http://www.w3.org/1999/xlink",SHADOWCOLOR="gray",SHADOW_OFFSET_X=2,SHADOW_OFFSET_Y=3,SHADOW_OPACITY=1;var NODETYPE;(function(n){n[n.ELEMENT=1]="ELEMENT",n[n.ATTRIBUTE=2]="ATTRIBUTE",n[n.TEXT=3]="TEXT",n[n.CDATA=4]="CDATA",n[n.ENTITY_REFERENCE=5]="ENTITY_REFERENCE",n[n.ENTITY=6]="ENTITY",n[n.PROCESSING_INSTRUCTION=7]="PROCESSING_INSTRUCTION",n[n.COMMENT=8]="COMMENT",n[n.DOCUMENT=9]="DOCUMENT",n[n.DOCUMENTTYPE=10]="DOCUMENTTYPE",n[n.DOCUMENT_FRAGMENT=11]="DOCUMENT_FRAGMENT",n[n.NOTATION=12]="NOTATION"})(NODETYPE||(NODETYPE={}));const TOOLTIP_VERTICAL_OFFSET=16,DEFAULT_VALID_COLOR="#00FF00",DEFAULT_INVALID_COLOR="#FF0000",OUTLINE_HIGHLIGHT_COLOR="#00FF00",OUTLINE_HIGHLIGHT_STROKEWIDTH=5,HIGHLIGHT_STROKEWIDTH=3,HIGHLIGHT_SIZE=2,HIGHLIGHT_OPACITY=100;var CURSOR;(function(n){n.MOVABLE_VERTEX="move",n.MOVABLE_EDGE="move",n.LABEL_HANDLE="default",n.TERMINAL_HANDLE="pointer",n.BEND_HANDLE="crosshair",n.VIRTUAL_BEND_HANDLE="crosshair",n.CONNECT="pointer"})(CURSOR||(CURSOR={}));const INVALID_CONNECT_TARGET_COLOR="#FF0000",DROP_TARGET_COLOR="#0000FF",VALID_COLOR="#00FF00",INVALID_COLOR="#FF0000",EDGE_SELECTION_COLOR="#00FF00",VERTEX_SELECTION_COLOR="#00FF00",VERTEX_SELECTION_STROKEWIDTH=1,EDGE_SELECTION_STROKEWIDTH=1,VERTEX_SELECTION_DASHED=!0,EDGE_SELECTION_DASHED=!0,GUIDE_COLOR="#FF0000",GUIDE_STROKEWIDTH=1,HANDLE_SIZE=6,LABEL_HANDLE_SIZE=4,HANDLE_FILLCOLOR="#00FF00",HANDLE_STROKECOLOR="black",LABEL_HANDLE_FILLCOLOR="yellow",CONNECT_HANDLE_FILLCOLOR="#0000FF",LOCKED_HANDLE_FILLCOLOR="#FF0000",DEFAULT_FONTFAMILY="Arial,Helvetica",DEFAULT_FONTSIZE=11,DEFAULT_TEXT_DIRECTION="",LINE_HEIGHT=1.2,WORD_WRAP="normal",DEFAULT_FONTSTYLE=0,DEFAULT_STARTSIZE=40,DEFAULT_MARKERSIZE=6,DEFAULT_IMAGESIZE=24,ENTITY_SEGMENT=30,RECTANGLE_ROUNDING_FACTOR=.15,LINE_ARCSIZE=20,ARROW_SPACING=0,ARROW_WIDTH=30,ARROW_SIZE=30,PAGE_FORMAT_A4_PORTRAIT=[0,0,827,1169],NONE="none";var FONT;(function(n){n[n.BOLD=1]="BOLD",n[n.ITALIC=2]="ITALIC",n[n.UNDERLINE=4]="UNDERLINE",n[n.STRIKETHROUGH=8]="STRIKETHROUGH"})(FONT||(FONT={}));var ARROW;(function(n){n.CLASSIC="classic",n.CLASSIC_THIN="classicThin",n.BLOCK="block",n.BLOCK_THIN="blockThin",n.OPEN="open",n.OPEN_THIN="openThin",n.OVAL="oval",n.DIAMOND="diamond",n.DIAMOND_THIN="diamondThin"})(ARROW||(ARROW={}));var ALIGN;(function(n){n.LEFT="left",n.CENTER="center",n.RIGHT="right",n.TOP="top",n.MIDDLE="middle",n.BOTTOM="bottom"})(ALIGN||(ALIGN={}));var DIRECTION;(function(n){n.NORTH="north",n.SOUTH="south",n.EAST="east",n.WEST="west"})(DIRECTION||(DIRECTION={}));var TEXT_DIRECTION;(function(n){n.DEFAULT="",n.AUTO="auto",n.LTR="ltr",n.RTL="rtl"})(TEXT_DIRECTION||(TEXT_DIRECTION={}));const DIRECTION_MASK={NONE:0,WEST:1,NORTH:2,SOUTH:4,EAST:8,ALL:15};var ELBOW;(function(n){n.VERTICAL="vertical",n.HORIZONTAL="horizontal"})(ELBOW||(ELBOW={}));var EDGESTYLE;(function(n){n.ELBOW="elbowEdgeStyle",n.ENTITY_RELATION="entityRelationEdgeStyle",n.LOOP="loopEdgeStyle",n.SIDETOSIDE="sideToSideEdgeStyle",n.TOPTOBOTTOM="topToBottomEdgeStyle",n.ORTHOGONAL="orthogonalEdgeStyle",n.SEGMENT="segmentEdgeStyle",n.MANHATTAN="manhattanEdgeStyle"})(EDGESTYLE||(EDGESTYLE={}));var PERIMETER;(function(n){n.ELLIPSE="ellipsePerimeter",n.RECTANGLE="rectanglePerimeter",n.RHOMBUS="rhombusPerimeter",n.HEXAGON="hexagonPerimeter",n.TRIANGLE="trianglePerimeter"})(PERIMETER||(PERIMETER={}));var SHAPE;(function(n){n.RECTANGLE="rectangle",n.ELLIPSE="ellipse",n.DOUBLE_ELLIPSE="doubleEllipse",n.RHOMBUS="rhombus",n.LINE="line",n.IMAGE="image",n.ARROW="arrow",n.ARROW_CONNECTOR="arrowConnector",n.LABEL="label",n.CYLINDER="cylinder",n.SWIMLANE="swimlane",n.CONNECTOR="connector",n.ACTOR="actor",n.CLOUD="cloud",n.TRIANGLE="triangle",n.HEXAGON="hexagon"})(SHAPE||(SHAPE={}));class Client{}Client.basePath=".";Client.setBasePath=n=>{typeof n<"u"&&n.length>0?(n.substring(n.length-1)==="/"&&(n=n.substring(0,n.length-1)),Client.basePath=n):Client.basePath="."};Client.imageBasePath=".";Client.setImageBasePath=n=>{typeof n<"u"&&n.length>0?(n.substring(n.length-1)==="/"&&(n=n.substring(0,n.length-1)),Client.imageBasePath=n):Client.imageBasePath=`${Client.basePath}/images`};Client.IS_EDGE=typeof window<"u"&&navigator.userAgent!=null&&!!navigator.userAgent.match(/Edge\//);Client.IS_NS=typeof window<"u"&&navigator.userAgent!=null&&navigator.userAgent.indexOf("Mozilla/")>=0&&navigator.userAgent.indexOf("MSIE")<0&&navigator.userAgent.indexOf("Edge/")<0;Client.IS_SF=typeof window<"u"&&/Apple Computer, Inc/.test(navigator.vendor);Client.IS_ANDROID=typeof window<"u"&&navigator.appVersion.indexOf("Android")>=0;Client.IS_IOS=typeof window<"u"&&/iP(hone|od|ad)/.test(navigator.platform);Client.IS_GC=typeof window<"u"&&/Google Inc/.test(navigator.vendor);Client.IS_CHROMEAPP=typeof window<"u"&&window.chrome!=null&&chrome.app!=null&&chrome.app.runtime!=null;Client.IS_FF=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;Client.IS_MT=typeof window<"u"&&(navigator.userAgent.indexOf("Firefox/")>=0&&navigator.userAgent.indexOf("Firefox/1.")<0&&navigator.userAgent.indexOf("Firefox/2.")<0||navigator.userAgent.indexOf("Iceweasel/")>=0&&navigator.userAgent.indexOf("Iceweasel/1.")<0&&navigator.userAgent.indexOf("Iceweasel/2.")<0||navigator.userAgent.indexOf("SeaMonkey/")>=0&&navigator.userAgent.indexOf("SeaMonkey/1.")<0||navigator.userAgent.indexOf("Iceape/")>=0&&navigator.userAgent.indexOf("Iceape/1.")<0);Client.IS_SVG=typeof window<"u"&&navigator.appName.toUpperCase()!=="MICROSOFT INTERNET EXPLORER";Client.NO_FO=typeof window<"u"&&(!document.createElementNS||document.createElementNS(NS_SVG,"foreignObject").toString()!=="[object SVGForeignObjectElement]"||navigator.userAgent.indexOf("Opera/")>=0);Client.IS_WIN=typeof window<"u"&&navigator.appVersion.indexOf("Win")>0;Client.IS_MAC=typeof window<"u"&&navigator.appVersion.indexOf("Mac")>0;Client.IS_CHROMEOS=typeof window<"u"&&/\bCrOS\b/.test(navigator.appVersion);Client.IS_TOUCH=typeof window<"u"&&"ontouchstart"in document.documentElement;Client.IS_POINTER=typeof window<"u"&&window.PointerEvent!=null&&!(navigator.appVersion.indexOf("Mac")>0);Client.IS_LOCAL=typeof window<"u"&&document.location.href.indexOf("http://")<0&&document.location.href.indexOf("https://")<0;const getMainEvent=n=>{let t=n;return(t.type==="touchstart"||t.type==="touchmove")&&t.touches&&t.touches[0]?t=t.touches[0]:t.type==="touchend"&&t.changedTouches&&t.changedTouches[0]&&(t=t.changedTouches[0]),t},getClientX=n=>getMainEvent(n).clientX,getClientY=n=>getMainEvent(n).clientY,getSource=n=>n.target,isConsumed=n=>{const t=n;return t.isConsumed!==void 0&&t.isConsumed},isTouchEvent=n=>{const t=n;return t.pointerType?t.pointerType==="touch"||t.pointerType===t.MSPOINTER_TYPE_TOUCH:t.mozInputSource!==void 0?t.mozInputSource===5:t.type.indexOf("touch")===0},isPenEvent=n=>{const t=n;return t.pointerType?t.pointerType=="pen"||t.pointerType===t.MSPOINTER_TYPE_PEN:t.mozInputSource!==void 0?t.mozInputSource===2:t.type.indexOf("pen")===0},isMultiTouchEvent=n=>{const t=n;return t.type&&t.type.indexOf("touch")==0&&t.touches!==void 0&&t.touches.length>1},isMouseEvent=n=>{const t=n;return t.pointerType?t.pointerType=="mouse"||t.pointerType===t.MSPOINTER_TYPE_MOUSE:t.mozInputSource!==void 0?t.mozInputSource===1:t.type.indexOf("mouse")===0},isLeftMouseButton=n=>"buttons"in n&&(n.type==="mousedown"||n.type==="mousemove")?n.buttons===1:n.which!==void 0?n.which===1:n.button===1,isRightMouseButton=n=>n.button===2,isPopupTrigger=n=>isRightMouseButton(n)||Client.IS_MAC&&isControlDown(n)&&!isShiftDown(n)&&!isMetaDown(n)&&!isAltDown(n),isShiftDown=n=>n.shiftKey,isAltDown=n=>n.altKey,isControlDown=n=>n.ctrlKey,isMetaDown=n=>n.metaKey,extractTextWithWhitespace=n=>{const t=["BLOCKQUOTE","DIV","H1","H2","H3","H4","H5","H6","OL","P","PRE","TABLE","UL"],e=[];function i(s){if(!(s.length==1&&(s[0].nodeName=="BR"||s[0].innerHTML==`
`)))for(let l=0;l<s.length;l+=1){const r=s[l];r.nodeName=="BR"||r.innerHTML==`
`||(s.length==1||l==0)&&r.nodeName=="DIV"&&r.innerHTML.toLowerCase()=="<br>"?e.push(`
`):(r.nodeType===3||r.nodeType===4?r.nodeValue&&r.nodeValue.length>0&&e.push(r.nodeValue):r.nodeType!==8&&r.childNodes.length>0&&i(Array.from(r.childNodes)),l<s.length-1&&t.indexOf(s[l+1].nodeName)>=0&&e.push(`
`))}}return i(n),e.join("")},getTextContent=n=>n!=null&&n.textContent?n.textContent:"",write=(n,t)=>{const i=n.ownerDocument.createTextNode(t);return n!=null&&n.appendChild(i),i},isNode=(n,t=null,e,i)=>n!=null&&!isNaN(n.nodeType)&&(t==null||n.nodeName.toLowerCase()==t.toLowerCase())?e==null||n.getAttribute(e)==i:!1,isAncestorNode=(n,t)=>{let e=t;for(;e!=null;){if(e===n)return!0;e=e.parentNode}return!1},importNode=(n,t,e)=>n.importNode(t,e),clearSelection=()=>{const n=window.getSelection?window.getSelection():document.selection;n&&(n.removeAllRanges?n.removeAllRanges():n.empty&&n.empty())};class InternalMouseEvent{constructor(t,e=null){this.consumed=!1,this.evt=t,this.state=e,this.sourceState=e,this.graphX=0,this.graphY=0}getEvent(){return this.evt}getSource(){return getSource(this.evt)}isSource(t){return t?isAncestorNode(t.node,this.getSource()):!1}getX(){return getClientX(this.getEvent())}getY(){return getClientY(this.getEvent())}getGraphX(){return this.graphX}getGraphY(){return this.graphY}getState(){return this.state}getCell(){const t=this.getState();return t?t.cell:null}isPopupTrigger(){return isPopupTrigger(this.getEvent())}isConsumed(){return this.consumed}consume(t){t=t||window.TouchEvent&&this.evt instanceof TouchEvent||isMouseEvent(this.evt),t&&this.evt.preventDefault&&this.evt.preventDefault(),this.consumed=!0}}let supportsPassive=!1;try{document.addEventListener("test",()=>{},Object.defineProperty&&Object.defineProperty({},"passive",{get:()=>{supportsPassive=!0}}))}catch{}class InternalEvent{static addListener(t,e,i){t.addEventListener(e,i,supportsPassive?{passive:!1}:!1),t.mxListenerList||(t.mxListenerList=[]);const s={name:e,f:i};t.mxListenerList.push(s)}static removeListener(t,e,i){if(t.removeEventListener(e,i,!1),t.mxListenerList){const s=t.mxListenerList.length;for(let l=0;l<s;l+=1)if(t.mxListenerList[l].f===i){t.mxListenerList.splice(l,1);break}}}static removeAllListeners(t){const e=t.mxListenerList;if(e)for(;e.length>0;){const i=e[0];InternalEvent.removeListener(t,i.name,i.f)}}static addGestureListeners(t,e=null,i=null,s=null){e&&InternalEvent.addListener(t,Client.IS_POINTER?"pointerdown":"mousedown",e),i&&InternalEvent.addListener(t,Client.IS_POINTER?"pointermove":"mousemove",i),s&&InternalEvent.addListener(t,Client.IS_POINTER?"pointerup":"mouseup",s),!Client.IS_POINTER&&Client.IS_TOUCH&&(e&&InternalEvent.addListener(t,"touchstart",e),i&&InternalEvent.addListener(t,"touchmove",i),s&&InternalEvent.addListener(t,"touchend",s))}static removeGestureListeners(t,e,i,s){e&&InternalEvent.removeListener(t,Client.IS_POINTER?"pointerdown":"mousedown",e),i&&InternalEvent.removeListener(t,Client.IS_POINTER?"pointermove":"mousemove",i),s&&InternalEvent.removeListener(t,Client.IS_POINTER?"pointerup":"mouseup",s),!Client.IS_POINTER&&Client.IS_TOUCH&&(e&&InternalEvent.removeListener(t,"touchstart",e),i&&InternalEvent.removeListener(t,"touchmove",i),s&&InternalEvent.removeListener(t,"touchend",s))}static redirectMouseEvents(t,e,i=null,s=null,l=null,r=null,o=null){const h=a=>typeof i=="function"?i(a):i;InternalEvent.addGestureListeners(t,a=>{s?s(a):isConsumed(a)||e.fireMouseEvent(InternalEvent.MOUSE_DOWN,new InternalMouseEvent(a,h(a)))},a=>{l?l(a):isConsumed(a)||e.fireMouseEvent(InternalEvent.MOUSE_MOVE,new InternalMouseEvent(a,h(a)))},a=>{r?r(a):isConsumed(a)||e.fireMouseEvent(InternalEvent.MOUSE_UP,new InternalMouseEvent(a,h(a)))}),InternalEvent.addListener(t,"dblclick",a=>{if(o)o(a);else if(!isConsumed(a)){const d=h(a);e.dblClick(a,d==null?void 0:d.cell)}})}static release(t){try{InternalEvent.removeAllListeners(t);const e=t.childNodes;if(e!==void 0){const i=e.length;for(let s=0;s<i;s+=1)InternalEvent.release(e[s])}}catch{}}static addMouseWheelListener(t,e){if(t!=null){const i=s=>{s.ctrlKey&&s.preventDefault(),(Math.abs(s.deltaX)>.5||Math.abs(s.deltaY)>.5)&&t(s,s.deltaY==0?-s.deltaX>0:-s.deltaY>0)};if(e=e??window,Client.IS_SF&&!Client.IS_TOUCH){let s=1;InternalEvent.addListener(e,"gesturestart",l=>{InternalEvent.consume(l),s=1}),InternalEvent.addListener(e,"gesturechange",l=>{if(InternalEvent.consume(l),typeof l.scale=="number"){const r=s-l.scale;Math.abs(r)>.2&&(t(l,r<0,!0),s=l.scale)}}),InternalEvent.addListener(e,"gestureend",l=>{InternalEvent.consume(l)})}else{let s=[],l=0,r=0;InternalEvent.addGestureListeners(e,o=>{!isMouseEvent(o)&&o.pointerId!=null&&s.push(o)},o=>{if(!isMouseEvent(o)&&s.length==2){for(let g=0;g<s.length;g+=1)if(o.pointerId==s[g].pointerId){s[g]=o;break}const h=Math.abs(s[0].clientX-s[1].clientX),a=Math.abs(s[0].clientY-s[1].clientY),d=Math.abs(h-l),c=Math.abs(a-r);if(d>InternalEvent.PINCH_THRESHOLD||c>InternalEvent.PINCH_THRESHOLD){const g=s[0].clientX+(s[1].clientX-s[0].clientX)/2,u=s[0].clientY+(s[1].clientY-s[0].clientY)/2;t(s[0],d>c?h>l:a>r,!0,g,u),l=h,r=a}}},o=>{s=[],l=0,r=0})}InternalEvent.addListener(e,"wheel",i)}}static disableContextMenu(t){InternalEvent.addListener(t,"contextmenu",e=>(e.preventDefault&&e.preventDefault(),!1))}static consume(t,e=!0,i=!0){e&&(t.preventDefault?(i&&t.stopPropagation(),t.preventDefault()):i&&(t.cancelBubble=!0)),t.isConsumed=!0,t.preventDefault||(t.returnValue=!1)}}InternalEvent.LABEL_HANDLE=-1;InternalEvent.ROTATION_HANDLE=-2;InternalEvent.CUSTOM_HANDLE=-100;InternalEvent.VIRTUAL_HANDLE=-1e5;InternalEvent.MOUSE_DOWN="mouseDown";InternalEvent.MOUSE_MOVE="mouseMove";InternalEvent.MOUSE_UP="mouseUp";InternalEvent.ACTIVATE="activate";InternalEvent.RESIZE_START="resizeStart";InternalEvent.RESIZE="resize";InternalEvent.RESIZE_END="resizeEnd";InternalEvent.MOVE_START="moveStart";InternalEvent.MOVE="move";InternalEvent.MOVE_END="moveEnd";InternalEvent.PAN_START="panStart";InternalEvent.PAN="pan";InternalEvent.PAN_END="panEnd";InternalEvent.MINIMIZE="minimize";InternalEvent.NORMALIZE="normalize";InternalEvent.MAXIMIZE="maximize";InternalEvent.HIDE="hide";InternalEvent.SHOW="show";InternalEvent.CLOSE="close";InternalEvent.DESTROY="destroy";InternalEvent.REFRESH="refresh";InternalEvent.SIZE="size";InternalEvent.SELECT="select";InternalEvent.FIRED="fired";InternalEvent.FIRE_MOUSE_EVENT="fireMouseEvent";InternalEvent.GESTURE="gesture";InternalEvent.TAP_AND_HOLD="tapAndHold";InternalEvent.GET="get";InternalEvent.RECEIVE="receive";InternalEvent.CONNECT="connect";InternalEvent.DISCONNECT="disconnect";InternalEvent.SUSPEND="suspend";InternalEvent.RESUME="resume";InternalEvent.MARK="mark";InternalEvent.ROOT="root";InternalEvent.POST="post";InternalEvent.OPEN="open";InternalEvent.SAVE="save";InternalEvent.BEFORE_ADD_VERTEX="beforeAddVertex";InternalEvent.ADD_VERTEX="addVertex";InternalEvent.AFTER_ADD_VERTEX="afterAddVertex";InternalEvent.DONE="done";InternalEvent.EXECUTE="execute";InternalEvent.EXECUTED="executed";InternalEvent.BEGIN_UPDATE="beginUpdate";InternalEvent.START_EDIT="startEdit";InternalEvent.END_UPDATE="endUpdate";InternalEvent.END_EDIT="endEdit";InternalEvent.BEFORE_UNDO="beforeUndo";InternalEvent.UNDO="undo";InternalEvent.REDO="redo";InternalEvent.CHANGE="change";InternalEvent.NOTIFY="notify";InternalEvent.LAYOUT_CELLS="layoutCells";InternalEvent.CLICK="click";InternalEvent.SCALE="scale";InternalEvent.TRANSLATE="translate";InternalEvent.SCALE_AND_TRANSLATE="scaleAndTranslate";InternalEvent.UP="up";InternalEvent.DOWN="down";InternalEvent.ADD="add";InternalEvent.REMOVE="remove";InternalEvent.CLEAR="clear";InternalEvent.ADD_CELLS="addCells";InternalEvent.CELLS_ADDED="cellsAdded";InternalEvent.MOVE_CELLS="moveCells";InternalEvent.CELLS_MOVED="cellsMoved";InternalEvent.RESIZE_CELLS="resizeCells";InternalEvent.CELLS_RESIZED="cellsResized";InternalEvent.TOGGLE_CELLS="toggleCells";InternalEvent.CELLS_TOGGLED="cellsToggled";InternalEvent.ORDER_CELLS="orderCells";InternalEvent.CELLS_ORDERED="cellsOrdered";InternalEvent.REMOVE_CELLS="removeCells";InternalEvent.CELLS_REMOVED="cellsRemoved";InternalEvent.GROUP_CELLS="groupCells";InternalEvent.UNGROUP_CELLS="ungroupCells";InternalEvent.REMOVE_CELLS_FROM_PARENT="removeCellsFromParent";InternalEvent.FOLD_CELLS="foldCells";InternalEvent.CELLS_FOLDED="cellsFolded";InternalEvent.ALIGN_CELLS="alignCells";InternalEvent.LABEL_CHANGED="labelChanged";InternalEvent.CONNECT_CELL="connectCell";InternalEvent.CELL_CONNECTED="cellConnected";InternalEvent.SPLIT_EDGE="splitEdge";InternalEvent.FLIP_EDGE="flipEdge";InternalEvent.START_EDITING="startEditing";InternalEvent.EDITING_STARTED="editingStarted";InternalEvent.EDITING_STOPPED="editingStopped";InternalEvent.ADD_OVERLAY="addOverlay";InternalEvent.REMOVE_OVERLAY="removeOverlay";InternalEvent.UPDATE_CELL_SIZE="updateCellSize";InternalEvent.ESCAPE="escape";InternalEvent.DOUBLE_CLICK="doubleClick";InternalEvent.START="start";InternalEvent.RESET="reset";InternalEvent.PINCH_THRESHOLD=10;class Point{constructor(t=0,e=0){this._x=0,this._y=0,this.x=t,this.y=e}get x(){return this._x}set x(t){if(Number.isNaN(t))throw new Error("Invalid x supplied.");this._x=t}get y(){return this._y}set y(t){if(Number.isNaN(t))throw new Error("Invalid y supplied.");this._y=t}equals(t){return t?t.x===this.x&&t.y===this.y:!1}clone(){return new Point(this.x,this.y)}}class Rectangle extends Point{constructor(t=0,e=0,i=0,s=0){super(t,e),this._width=0,this._height=0,this.width=i,this.height=s}get width(){return this._width}set width(t){if(Number.isNaN(t))throw new Error("Invalid width supplied.");this._width=t}get height(){return this._height}set height(t){if(Number.isNaN(t))throw new Error("Invalid height supplied.");this._height=t}setRect(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s}getCenterX(){return this.x+this.width/2}getCenterY(){return this.y+this.height/2}add(t){const e=Math.min(this.x,t.x),i=Math.min(this.y,t.y),s=Math.max(this.x+this.width,t.x+t.width),l=Math.max(this.y+this.height,t.y+t.height);this.x=e,this.y=i,this.width=s-e,this.height=l-i}intersect(t){const e=this.x+this.width,i=t.x+t.width,s=this.y+this.height,l=t.y+t.height;this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.width=Math.min(e,i)-this.x,this.height=Math.min(s,l)-this.y}grow(t){this.x-=t,this.y-=t,this.width+=2*t,this.height+=2*t}getPoint(){return new Point(this.x,this.y)}rotate90(){const t=(this.width-this.height)/2;this.x+=t,this.y-=t;const e=this.width;this.width=this.height,this.height=e}equals(t){return t?t.x===this.x&&t.y===this.y&&t.width===this.width&&t.height===this.height:!1}clone(){return new Rectangle(this.x,this.y,this.width,this.height)}}Rectangle.fromRectangle=n=>new Rectangle(n.x,n.y,n.width,n.height);const ltrim=(n,t="\\s")=>n!=null?n.replace(new RegExp(`^[${t}]+`,"g"),""):null,rtrim=(n,t="\\s")=>n!=null?n.replace(new RegExp(`[${t}]+$`,"g"),""):null,trim=(n,t)=>ltrim(rtrim(n,t),t),getFunctionName=n=>{let t=null;if(n!=null){if(n.name!=null)t=n.name;else if(t=trim(n.toString()),t!==null&&/^function\s/.test(t)&&(t=ltrim(t.substring(9)),t!==null)){const e=t.indexOf("(");e>0&&(t=t.substring(0,e))}}return t},replaceTrailingNewlines=(n,t)=>{let e="";for(;n.length>0&&n.charAt(n.length-1)==`
`;)n=n.substring(0,n.length-1),e+=t;return n+e},removeWhitespace=(n,t)=>{var i,s;let e=t?n.previousSibling:n.nextSibling;for(;e!=null&&e.nodeType===NODETYPE.TEXT;){const l=t?e.previousSibling:e.nextSibling,r=getTextContent(e);((i=trim(r))==null?void 0:i.length)===0&&((s=e.parentNode)==null||s.removeChild(e)),e=l}},htmlEntities=(n,t=!0)=>(n=String(n||""),n=n.replace(/&/g,"&amp;"),n=n.replace(/"/g,"&quot;"),n=n.replace(/'/g,"&#39;"),n=n.replace(/</g,"&lt;"),n=n.replace(/>/g,"&gt;"),t&&(n=n.replace(/\n/g,"&#xa;")),n);class ObjectIdentity{static get(t){if(t){if(t[IDENTITY_FIELD_NAME]===null||t[IDENTITY_FIELD_NAME]===void 0)if(typeof t=="object"){const e=getFunctionName(t.constructor);t[IDENTITY_FIELD_NAME]=`${e}#${ObjectIdentity.counter++}`}else typeof t=="function"&&(t[IDENTITY_FIELD_NAME]=`Function#${ObjectIdentity.counter++}`);return t[IDENTITY_FIELD_NAME]}return null}static clear(t){delete t[IDENTITY_FIELD_NAME]}}ObjectIdentity.FIELD_NAME=IDENTITY_FIELD_NAME;ObjectIdentity.counter=0;class Dictionary{constructor(){this.map={},this.clear()}clear(){this.map={}}get(t){const e=ObjectIdentity.get(t);return this.map[e]??null}put(t,e){const i=ObjectIdentity.get(t),s=this.map[i];return this.map[i]=e,s??null}remove(t){const e=ObjectIdentity.get(t),i=this.map[e];return delete this.map[e],i??null}getKeys(){const t=[];for(const e in this.map)t.push(e);return t}getValues(){const t=[];for(const e in this.map)t.push(this.map[e]);return t}visit(t){for(const e in this.map)t(e,this.map[e])}}class NoOpLogger{debug(t){}enter(t){}error(t,...e){}info(t){}leave(t,e){}show(){}trace(t){}warn(t){}}const clone=function n(t,e=null,i=!1){i=i??!1;let s=null;if(t!=null&&typeof t.constructor=="function"){s=new t.constructor;for(const l in t)l!=ObjectIdentity.FIELD_NAME&&(e==null||e.indexOf(l)<0)&&(!i&&typeof t[l]=="object"?s[l]=n(t[l]):s[l]=t[l])}return s},shallowCopy=(n,t)=>{for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e)){const i=n[e];Array.isArray(i)?t[e]=[...i]:t[e]=i}},GlobalConfig={logger:new NoOpLogger},StyleDefaultsConfig={shadowColor:SHADOWCOLOR,shadowOffsetX:SHADOW_OFFSET_X,shadowOffsetY:SHADOW_OFFSET_Y,shadowOpacity:SHADOW_OPACITY},isNullish=n=>n==null,isNotNullish=n=>!isNullish(n),mixInto=n=>t=>{const e=Reflect.ownKeys(t);try{for(const i of e)Object.defineProperty(n.prototype,i,{value:t[i],writable:!0})}catch(i){GlobalConfig.logger.error("Error while mixing",i)}},toRadians=n=>Math.PI*n/180,arcToCurves=(n,t,e,i,s,l,r,o,h)=>{if(o-=n,h-=t,e===0||i===0)return[];const a=r,d=s;e=Math.abs(e),i=Math.abs(i);const c=-o/2,g=-h/2,u=Math.cos(d*Math.PI/180),f=Math.sin(d*Math.PI/180),p=u*c+f*g,E=-1*f*c+u*g,C=p*p,y=E*E,w=e*e,v=i*i,S=C/w+y/v;let I;if(S>1)e=Math.sqrt(S)*e,i=Math.sqrt(S)*i,I=0;else{let $=1;l===a&&($=-1),I=$*Math.sqrt((w*v-w*y-v*C)/(w*y+v*C))}const T=I*e*E/i,A=-1*I*i*p/e,R=u*T-f*A+o/2,N=f*T+u*A+h/2;let O=Math.atan2((E-A)/i,(p-T)/e)-Math.atan2(0,1),G=O>=0?O:2*Math.PI+O;O=Math.atan2((-E-A)/i,(-p-T)/e)-Math.atan2((E-A)/i,(p-T)/e);let Y=O>=0?O:2*Math.PI+O;!a&&Y>0?Y-=2*Math.PI:a&&Y<0&&(Y+=2*Math.PI);const Z=Y*2/Math.PI,x=Math.ceil(Z<0?-1*Z:Z),b=Y/x,L=8/3*Math.sin(b/4)*Math.sin(b/4)/Math.sin(b/2),M=u*e,P=u*i,H=f*e,V=f*i;let B=Math.cos(G),F=Math.sin(G),D=-L*(M*F+V*B),U=-L*(H*F-P*B),_=0,W=0;const z=[];for(let $=0;$<x;++$){G+=b,B=Math.cos(G),F=Math.sin(G),_=M*B-V*F+R,W=H*B+P*F+N;const K=-L*(M*F+V*B),k=-L*(H*F-P*B),X=$*6;z[X]=Number(D+n),z[X+1]=Number(U+t),z[X+2]=Number(_-K+n),z[X+3]=Number(W-k+t),z[X+4]=Number(_+n),z[X+5]=Number(W+t),D=_+K,U=W+k}return z},getBoundingBox=(n,t,e=null)=>{let i=null;if(n&&t!==0){const s=toRadians(t),l=Math.cos(s),r=Math.sin(s);e=e??new Point(n.x+n.width/2,n.y+n.height/2);let o=new Point(n.x,n.y),h=new Point(n.x+n.width,n.y),a=new Point(h.x,n.y+n.height),d=new Point(n.x,a.y);o=getRotatedPoint(o,l,r,e),h=getRotatedPoint(h,l,r,e),a=getRotatedPoint(a,l,r,e),d=getRotatedPoint(d,l,r,e),i=new Rectangle(o.x,o.y,0,0),i.add(new Rectangle(h.x,h.y,0,0)),i.add(new Rectangle(a.x,a.y,0,0)),i.add(new Rectangle(d.x,d.y,0,0))}return i},getRotatedPoint=(n,t,e,i=new Point)=>{const s=n.x-i.x,l=n.y-i.y,r=s*t-l*e,o=l*t+s*e;return new Point(r+i.x,o+i.y)},getPortConstraints=(n,t,e,i)=>{const s=n.style.portConstraint??(e?t.style.sourcePortConstraint:t.style.targetPortConstraint)??null;if(isNullish(s))return i;const l=s.toString();let r=DIRECTION_MASK.NONE;const o=n.style.portConstraintRotation??!1;let h=0;o&&(h=n.style.rotation??0);let a=0;if(h>45?(a=1,h>=135&&(a=2)):h<-45&&(a=3,h<=-135&&(a=2)),l.indexOf(DIRECTION.NORTH)>=0)switch(a){case 0:r|=DIRECTION_MASK.NORTH;break;case 1:r|=DIRECTION_MASK.EAST;break;case 2:r|=DIRECTION_MASK.SOUTH;break;case 3:r|=DIRECTION_MASK.WEST;break}if(l.indexOf(DIRECTION.WEST)>=0)switch(a){case 0:r|=DIRECTION_MASK.WEST;break;case 1:r|=DIRECTION_MASK.NORTH;break;case 2:r|=DIRECTION_MASK.EAST;break;case 3:r|=DIRECTION_MASK.SOUTH;break}if(l.indexOf(DIRECTION.SOUTH)>=0)switch(a){case 0:r|=DIRECTION_MASK.SOUTH;break;case 1:r|=DIRECTION_MASK.WEST;break;case 2:r|=DIRECTION_MASK.NORTH;break;case 3:r|=DIRECTION_MASK.EAST;break}if(l.indexOf(DIRECTION.EAST)>=0)switch(a){case 0:r|=DIRECTION_MASK.EAST;break;case 1:r|=DIRECTION_MASK.SOUTH;break;case 2:r|=DIRECTION_MASK.WEST;break;case 3:r|=DIRECTION_MASK.NORTH;break}return r},reversePortConstraints=n=>{let t=0;return t=(n&DIRECTION_MASK.WEST)<<3,t|=(n&DIRECTION_MASK.NORTH)<<1,t|=(n&DIRECTION_MASK.SOUTH)>>1,t|=(n&DIRECTION_MASK.EAST)>>3,t},findNearestSegment=(n,t,e)=>{let i=-1;if(n.absolutePoints.length>0){let s=n.absolutePoints[0],l=null;for(let r=1;r<n.absolutePoints.length;r+=1){const o=n.absolutePoints[r];if(!s||!o)continue;const h=ptSegDistSq(s.x,s.y,o.x,o.y,t,e);(l==null||h<l)&&(l=h,i=r-1),s=o}}return i},getDirectedBounds=(n,t,e,i,s)=>{const l=(e==null?void 0:e.direction)??"east";if(i??(i=(e==null?void 0:e.flipH)??!1),s??(s=(e==null?void 0:e.flipV)??!1),t.x=Math.round(Math.max(0,Math.min(n.width,t.x))),t.y=Math.round(Math.max(0,Math.min(n.height,t.y))),t.width=Math.round(Math.max(0,Math.min(n.width,t.width))),t.height=Math.round(Math.max(0,Math.min(n.height,t.height))),s&&(l===DIRECTION.SOUTH||l===DIRECTION.NORTH)||i&&(l===DIRECTION.EAST||l===DIRECTION.WEST)){const o=t.x;t.x=t.width,t.width=o}if(i&&(l===DIRECTION.SOUTH||l===DIRECTION.NORTH)||s&&(l===DIRECTION.EAST||l===DIRECTION.WEST)){const o=t.y;t.y=t.height,t.height=o}const r=Rectangle.fromRectangle(t);return l===DIRECTION.SOUTH?(r.y=t.x,r.x=t.height,r.width=t.y,r.height=t.width):l===DIRECTION.WEST?(r.y=t.height,r.x=t.width,r.width=t.x,r.height=t.y):l===DIRECTION.NORTH&&(r.y=t.width,r.x=t.y,r.width=t.height,r.height=t.x),new Rectangle(n.x+r.x,n.y+r.y,n.width-r.width-r.x,n.height-r.height-r.y)},contains=(n,t,e)=>n.x<=t&&n.x+n.width>=t&&n.y<=e&&n.y+n.height>=e,intersects=(n,t)=>{let e=n.width,i=n.height,s=t.width,l=t.height;if(s<=0||l<=0||e<=0||i<=0)return!1;const r=n.x,o=n.y,h=t.x,a=t.y;return s+=h,l+=a,e+=r,i+=o,(s<h||s>r)&&(l<a||l>o)&&(e<r||e>h)&&(i<o||i>a)},intersectsHotspot=(n,t,e,i,s,l)=>{if(i=i??1,s=s??0,l=l??0,i>0){let r=n.getCenterX(),o=n.getCenterY(),h=n.width,a=n.height;const d=n.style,c=((d==null?void 0:d.startSize)??0)*n.view.scale;c>0&&((d==null?void 0:d.horizontal)??!0?(o=n.y+c/2,a=c):(r=n.x+c/2,h=c)),h=Math.max(s,h*i),a=Math.max(s,a*i),l>0&&(h=Math.min(h,l),a=Math.min(a,l));const g=new Rectangle(r-h/2,o-a/2,h,a),u=toRadians((d==null?void 0:d.rotation)??0);if(u!=0){const f=Math.cos(-u),p=Math.sin(-u),E=new Point(n.getCenterX(),n.getCenterY()),C=getRotatedPoint(new Point(t,e),f,p,E);t=C.x,e=C.y}return contains(g,t,e)}return!0},isNumeric=n=>!Number.isNaN(parseFloat(n))&&isFinite(+n)&&(typeof n!="string"||n.toLowerCase().indexOf("0x")<0),isInteger=n=>String(parseInt(n))===String(n),mod=(n,t)=>(n%t+t)%t,intersection=(n,t,e,i,s,l,r,o)=>{const h=(o-l)*(e-n)-(r-s)*(i-t),a=(r-s)*(t-l)-(o-l)*(n-s),d=(e-n)*(t-l)-(i-t)*(n-s),c=a/h,g=d/h;if(c>=0&&c<=1&&g>=0&&g<=1){const u=n+c*(e-n),f=t+c*(i-t);return new Point(u,f)}return null},ptSegDistSq=(n,t,e,i,s,l)=>{e-=n,i-=t,s-=n,l-=t;let r=s*e+l*i,o;r<=0?o=0:(s=e-s,l=i-l,r=s*e+l*i,r<=0?o=0:o=r*r/(e*e+i*i));let h=s*s+l*l-o;return h<0&&(h=0),h},relativeCcw=(n,t,e,i,s,l)=>{e-=n,i-=t,s-=n,l-=t;let r=s*i-l*e;return r==0&&(r=s*e+l*i,r>0&&(s-=e,l-=i,r=s*e+l*i,r<0&&(r=0))),r<0?-1:r>0?1:0};class CellPath{constructor(){throw new Error("Static class can't be instantiated!")}static create(t){let e="",i=t.getParent();for(;i;)e=i.getIndex(t)+CellPath.PATH_SEPARATOR+e,t=i,i=t.getParent();const s=e.length;return s>1&&(e=e.substring(0,s-1)),e}static getParentPath(t){const e=t.lastIndexOf(CellPath.PATH_SEPARATOR);return e>=0?t.substring(0,e):t.length>0?"":null}static resolve(t,e){let i=t;const s=e.split(CellPath.PATH_SEPARATOR);for(let l=0;l<s.length;l+=1)i=i.getChildAt(parseInt(s[l]));return i}static compare(t,e){const i=Math.min(t.length,e.length);let s=0;for(let l=0;l<i;l+=1)if(t[l]!==e[l]){if(t[l].length===0||e[l].length===0)s=t[l]===e[l]?0:t[l]>e[l]?1:-1;else{const r=parseInt(t[l]),o=parseInt(e[l]);s=r===o?0:r>o?1:-1}break}if(s===0){const l=t.length,r=e.length;l!==r&&(s=l>r?1:-1)}return s}}CellPath.PATH_SEPARATOR=".";const getCurrentStyle=n=>!n||n.toString()==="[object ShadowRoot]"?null:window.getComputedStyle(n,""),parseCssNumber=n=>{n==="thin"?n="2":n==="medium"?n="4":n==="thick"&&(n="6");let t=parseFloat(n);return Number.isNaN(t)&&(t=0),t},setPrefixedStyle=(n,t,e)=>{let i=null;Client.IS_SF||Client.IS_GC?i="Webkit":Client.IS_MT&&(i="Moz"),n.setProperty(t,e),i!==null&&t.length>0&&(t=i+t.substring(0,1).toUpperCase()+t.substring(1),n.setProperty(t,e))},hasScrollbars=n=>{const t=getCurrentStyle(n);return!!t&&(t.overflow==="scroll"||t.overflow==="auto")},getDocumentSize=()=>{const n=document.body,t=document.documentElement;try{return new Rectangle(0,0,n.clientWidth??t.clientWidth,Math.max(n.clientHeight??0,t.clientHeight))}catch{return new Rectangle}},fit=n=>{const t=getDocumentSize(),e=n.offsetLeft,i=n.offsetWidth,s=getDocumentScrollOrigin(n.ownerDocument),l=s.x,r=s.y,o=l+t.width;e+i>o&&(n.style.left=`${Math.max(l,o-i)}px`);const h=n.offsetTop,a=n.offsetHeight,d=r+t.height;h+a>d&&(n.style.top=`${Math.max(r,d-a)}px`)},getOffset=(n,t=!1)=>{let e=0,i=0,s=!1,l=n;const r=document.body,o=document.documentElement;for(;l!=null&&l!=r&&l!=o&&!s;){const a=getCurrentStyle(l);a!=null&&(s=s||a.position=="fixed"),l=l.parentNode}if(!t&&!s){const a=getDocumentScrollOrigin(n.ownerDocument);e+=a.x,i+=a.y}const h=n.getBoundingClientRect();return h!=null&&(e+=h.left,i+=h.top),new Point(e,i)},getDocumentScrollOrigin=n=>{const t=n.defaultView||n.parentWindow,e=t!=null&&window.pageXOffset!==void 0?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,i=t!=null&&window.pageYOffset!==void 0?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;return new Point(e,i)},getScrollOrigin=(n=null,t=!1,e=!0)=>{const i=n!=null?n.ownerDocument:document,s=i.body,l=i.documentElement,r=new Point;let o=!1;for(;n!=null&&n!=s&&n!=l;){!Number.isNaN(n.scrollLeft)&&!Number.isNaN(n.scrollTop)&&(r.x+=n.scrollLeft,r.y+=n.scrollTop);const h=getCurrentStyle(n);h!=null&&(o=o||h.position=="fixed"),n=t?n.parentNode:null}if(!o&&e){const h=getDocumentScrollOrigin(i);r.x+=h.x,r.y+=h.y}return r},convertPoint=(n,t,e)=>{const i=getScrollOrigin(n,!1),s=getOffset(n);return s.x-=i.x,s.y-=i.y,new Point(t-s.x,e-s.y)},setCellStyles=(n,t,e,i)=>{t.length>0&&n.batchUpdate(()=>{for(let s=0;s<t.length;s+=1){const l=t[s];if(l){const r=l.getClonedStyle();r[e]=i,n.setStyle(l,r)}}})},setCellStyleFlags=(n,t,e,i,s)=>{t.length>0&&n.batchUpdate(()=>{for(let l=0;l<t.length;l+=1){const r=t[l];if(r){const o=setStyleFlag(r.getClonedStyle(),e,i,s);n.setStyle(r,o)}}})},setStyleFlag=(n,t,e,i)=>{const s=n[t];return s===void 0?n[t]=i===void 0||i?e:0:i===void 0?n[t]=s^e:i?n[t]=s|e:n[t]=s&~e,n},setOpacity=(n,t)=>{n.style.opacity=String(t/100)},matchBinaryMask=(n,t)=>(n&t)===t,getSizeForString=(n,t=DEFAULT_FONTSIZE,e=DEFAULT_FONTFAMILY,i=null,s=null)=>{const l=document.createElement("div");if(l.style.fontFamily=e,l.style.fontSize=`${Math.round(t)}px`,l.style.lineHeight=`${Math.round(t*LINE_HEIGHT)}px`,s!==null){matchBinaryMask(s,FONT.BOLD)&&(l.style.fontWeight="bold"),matchBinaryMask(s,FONT.ITALIC)&&(l.style.fontWeight="italic");const o=[];matchBinaryMask(s,FONT.UNDERLINE)&&o.push("underline"),matchBinaryMask(s,FONT.STRIKETHROUGH)&&o.push("line-through"),o.length>0&&(l.style.textDecoration=o.join(" "))}l.style.position="absolute",l.style.visibility="hidden",l.style.display="inline-block",i!==null?(l.style.width=`${i}px`,l.style.whiteSpace="normal"):l.style.whiteSpace="nowrap",l.innerHTML=n,document.body.appendChild(l);const r=new Rectangle(0,0,l.offsetWidth,l.offsetHeight);return document.body.removeChild(l),r},sortCells=(n,t=!0)=>{const e=new Dictionary;return n.sort((i,s)=>{let l=e.get(i);l==null&&(l=CellPath.create(i).split(CellPath.PATH_SEPARATOR),e.put(i,l));let r=e.get(s);r==null&&(r=CellPath.create(s).split(CellPath.PATH_SEPARATOR),e.put(s,r));const o=CellPath.compare(l,r);return o==0?0:o>0==t?1:-1}),n},getAlignmentAsPoint=(n,t)=>{let e=-.5,i=-.5;return n===ALIGN.LEFT?e=0:n===ALIGN.RIGHT&&(e=-1),t===ALIGN.TOP?i=0:t===ALIGN.BOTTOM&&(i=-1),new Point(e,i)};class UrlConverter{constructor(){this.enabled=!0,this.baseUrl=null,this.baseDomain=null}updateBaseUrl(){this.baseDomain=`${location.protocol}//${location.host}`,this.baseUrl=this.baseDomain+location.pathname;const t=this.baseUrl.lastIndexOf("/");t>0&&(this.baseUrl=this.baseUrl.substring(0,t+1))}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}getBaseUrl(){return this.baseUrl}setBaseUrl(t){this.baseUrl=t}getBaseDomain(){return this.baseDomain}setBaseDomain(t){this.baseDomain=t}isRelativeUrl(t){return t&&t.substring(0,2)!=="//"&&t.substring(0,7)!=="http://"&&t.substring(0,8)!=="https://"&&t.substring(0,10)!=="data:image"&&t.substring(0,7)!=="file://"}convert(t){return this.isEnabled()&&this.isRelativeUrl(t)&&(this.getBaseUrl()||this.updateBaseUrl(),t.charAt(0)==="/"?t=this.getBaseDomain()+t:t=this.getBaseUrl()+t),t}}class AbstractCanvas2D{constructor(){this.state=this.createState(),this.states=[],this.path=[],this.rotateHtml=!0,this.lastX=0,this.lastY=0,this.moveOp="M",this.lineOp="L",this.quadOp="Q",this.curveOp="C",this.closeOp="Z",this.pointerEvents=!1,this.pointerEventsValue=null,this.addOp=(t,...e)=>{if(this.path.push(t),e.length>1){const i=this.state;for(let s=1;s<e.length;s+=2)this.lastX=e[s-1],this.lastY=e[s],this.path.push(this.format((this.lastX+i.dx)*i.scale)),this.path.push(this.format((this.lastY+i.dy)*i.scale))}},this.converter=this.createUrlConverter(),this.reset()}createUrlConverter(){return new UrlConverter}reset(){this.state=this.createState(),this.states=[]}createState(){return{dx:0,dy:0,scale:1,alpha:1,fillAlpha:1,strokeAlpha:1,fillColor:NONE,gradientFillAlpha:1,gradientColor:NONE,gradientAlpha:1,gradientDirection:DIRECTION.EAST,strokeColor:NONE,strokeWidth:1,dashed:!1,dashPattern:"3 3",fixDash:!1,lineCap:"flat",lineJoin:"miter",miterLimit:10,fontColor:"#000000",fontBackgroundColor:NONE,fontBorderColor:NONE,fontSize:DEFAULT_FONTSIZE,fontFamily:DEFAULT_FONTFAMILY,fontStyle:0,shadow:!1,shadowColor:StyleDefaultsConfig.shadowColor,shadowAlpha:StyleDefaultsConfig.shadowOpacity,shadowDx:StyleDefaultsConfig.shadowOffsetX,shadowDy:StyleDefaultsConfig.shadowOffsetY,rotation:0,rotationCx:0,rotationCy:0}}format(t){return Math.round(t)}rotatePoint(t,e,i,s,l){const r=i*(Math.PI/180);return getRotatedPoint(new Point(t,e),Math.cos(r),Math.sin(r),new Point(s,l))}save(){this.states.push(this.state),this.state=clone(this.state)}restore(){const t=this.states.pop();t&&(this.state=t)}setLink(t){}scale(t){this.state.scale*=t,this.state.strokeWidth!==null&&(this.state.strokeWidth*=t)}translate(t,e){this.state.dx+=t,this.state.dy+=e}rotate(t,e,i,s,l){}setAlpha(t){this.state.alpha=t}setFillAlpha(t){this.state.fillAlpha=t}setStrokeAlpha(t){this.state.strokeAlpha=t}setFillColor(t){this.state.fillColor=t??NONE,this.state.gradientColor=NONE}setGradient(t,e,i,s,l,r,o,h=1,a=1){const d=this.state;d.fillColor=t,d.gradientFillAlpha=h,d.gradientColor=e,d.gradientAlpha=a,d.gradientDirection=o}setStrokeColor(t){this.state.strokeColor=t??NONE}setStrokeWidth(t){this.state.strokeWidth=t}setDashed(t,e=!1){this.state.dashed=t,this.state.fixDash=e}setDashPattern(t){this.state.dashPattern=t}setLineCap(t){this.state.lineCap=t}setLineJoin(t){this.state.lineJoin=t}setMiterLimit(t){this.state.miterLimit=t}setFontColor(t){this.state.fontColor=t??NONE}setFontBackgroundColor(t){this.state.fontBackgroundColor=t??NONE}setFontBorderColor(t){this.state.fontBorderColor=t??NONE}setFontSize(t){this.state.fontSize=t}setFontFamily(t){this.state.fontFamily=t}setFontStyle(t){this.state.fontStyle=t}setShadow(t){this.state.shadow=t}setShadowColor(t){this.state.shadowColor=t??NONE}setShadowAlpha(t){this.state.shadowAlpha=t}setShadowOffset(t,e){this.state.shadowDx=t,this.state.shadowDy=e}begin(){this.lastX=0,this.lastY=0,this.path=[]}moveTo(t,e){this.addOp(this.moveOp,t,e)}lineTo(t,e){this.addOp(this.lineOp,t,e)}quadTo(t,e,i,s){this.addOp(this.quadOp,t,e,i,s)}curveTo(t,e,i,s,l,r){this.addOp(this.curveOp,t,e,i,s,l,r)}arcTo(t,e,i,s,l,r,o){const h=arcToCurves(this.lastX,this.lastY,t,e,i,s,l,r,o);if(h!=null)for(let a=0;a<h.length;a+=6)this.curveTo(h[a],h[a+1],h[a+2],h[a+3],h[a+4],h[a+5])}close(t,e,i,s,l,r){this.addOp(this.closeOp)}}const equalPoints=(n,t)=>{if(!n&&t||n&&!t||n&&t&&n.length!=t.length)return!1;if(n&&t)for(let e=0;e<n.length;e+=1){const i=n[e];if(!i||i&&!i.equals(t[e]))return!1}return!0},equalEntries=(n,t)=>{let e=0;if(!n&&t||n&&!t||n&&t&&n.length!=t.length)return!1;if(n&&t){for(const i in t)e++;for(const i in n)if(e--,(!Number.isNaN(n[i])||!Number.isNaN(t[i]))&&n[i]!==t[i])return!1}return e===0},removeDuplicates=n=>{const t=new Dictionary,e=[];for(let i=0;i<n.length;i+=1)t.get(n[i])||(e.push(n[i]),t.put(n[i],!0));return e};class Geometry extends Rectangle{constructor(t=0,e=0,i=0,s=0){super(t,e,i,s),this.TRANSLATE_CONTROL_POINTS=!0,this.alternateBounds=null,this.sourcePoint=null,this.targetPoint=null,this.points=null,this.offset=null,this.relative=!1}setRelative(t){this.relative=t}swap(){if(this.alternateBounds){const t=new Rectangle(this.x,this.y,this.width,this.height);this.x=this.alternateBounds.x,this.y=this.alternateBounds.y,this.width=this.alternateBounds.width,this.height=this.alternateBounds.height,this.alternateBounds=t}}getTerminalPoint(t){return t?this.sourcePoint:this.targetPoint}setTerminalPoint(t,e){return e?this.sourcePoint=t:this.targetPoint=t,t}rotate(t,e){const i=toRadians(t),s=Math.cos(i),l=Math.sin(i);if(!this.relative){const r=new Point(this.getCenterX(),this.getCenterY()),o=getRotatedPoint(r,s,l,e);this.x=Math.round(o.x-this.width/2),this.y=Math.round(o.y-this.height/2)}if(this.sourcePoint){const r=getRotatedPoint(this.sourcePoint,s,l,e);this.sourcePoint.x=Math.round(r.x),this.sourcePoint.y=Math.round(r.y)}if(this.targetPoint){const r=getRotatedPoint(this.targetPoint,s,l,e);this.targetPoint.x=Math.round(r.x),this.targetPoint.y=Math.round(r.y)}if(this.points){for(let r=0;r<this.points.length;r+=1)if(this.points[r]){const o=getRotatedPoint(this.points[r],s,l,e);this.points[r].x=Math.round(o.x),this.points[r].y=Math.round(o.y)}}}translate(t,e){if(this.relative||(this.x+=t,this.y+=e),this.sourcePoint&&(this.sourcePoint.x=this.sourcePoint.x+t,this.sourcePoint.y=this.sourcePoint.y+e),this.targetPoint&&(this.targetPoint.x=this.targetPoint.x+t,this.targetPoint.y=this.targetPoint.y+e),this.TRANSLATE_CONTROL_POINTS&&this.points)for(let i=0;i<this.points.length;i+=1)this.points[i]&&(this.points[i].x=this.points[i].x+t,this.points[i].y=this.points[i].y+e)}scale(t,e,i){if(this.sourcePoint&&(this.sourcePoint.x=this.sourcePoint.x*t,this.sourcePoint.y=this.sourcePoint.y*e),this.targetPoint&&(this.targetPoint.x=this.targetPoint.x*t,this.targetPoint.y=this.targetPoint.y*e),this.points)for(let s=0;s<this.points.length;s+=1)this.points[s]&&(this.points[s].x=this.points[s].x*t,this.points[s].y=this.points[s].y*e);this.relative||(this.x*=t,this.y*=e,i&&(e=t=Math.min(t,e)),this.width*=t,this.height*=e)}equals(t){var e,i,s,l;return t?super.equals(t)&&this.relative===t.relative&&(this.sourcePoint===null&&t.sourcePoint===null||!!((e=this.sourcePoint)!=null&&e.equals(t.sourcePoint)))&&(this.targetPoint===null&&t.targetPoint===null||!!((i=this.targetPoint)!=null&&i.equals(t.targetPoint)))&&equalPoints(this.points,t.points)&&(this.alternateBounds===null&&t.alternateBounds===null||!!((s=this.alternateBounds)!=null&&s.equals(t.alternateBounds)))&&(this.offset===null&&t.offset===null||!!((l=this.offset)!=null&&l.equals(t.offset))):!1}clone(){return clone(this)}}class MaxXmlRequest{constructor(t,e=null,i="POST",s=!0,l=null,r=null){this.binary=!1,this.withCredentials=!1,this.request=null,this.decodeSimulateValues=!1,this.url=t,this.params=e,this.method=i||"POST",this.async=s,this.username=l,this.password=r}isBinary(){return this.binary}setBinary(t){this.binary=t}getText(){return this.request.responseText}isReady(){return this.request.readyState===4}getDocumentElement(){const t=this.getXml();return t!=null?t.documentElement:null}getXml(){let t=this.request.responseXML;return(t==null||t.documentElement==null)&&(t=new DOMParser().parseFromString(this.request.responseText,"text/xml")),t}getStatus(){return this.request!=null?this.request.status:null}create(){const t=new XMLHttpRequest;return this.isBinary()&&t.overrideMimeType&&t.overrideMimeType("text/plain; charset=x-user-defined"),t}send(t=null,e=null,i=null,s=null){this.request=this.create(),this.request!=null&&(t!=null&&(this.request.onreadystatechange=()=>{this.isReady()&&(t(this),this.request.onreadystatechange=null)}),this.request.open(this.method,this.url,this.async,this.username,this.password),this.setRequestHeaders(this.request,this.params),window.XMLHttpRequest&&this.withCredentials&&(this.request.withCredentials="true"),window.XMLHttpRequest&&i!=null&&s!=null&&(this.request.timeout=i,this.request.ontimeout=s),this.request.send(this.params))}setRequestHeaders(t,e){e!=null&&t.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}simulate(t,e=null){t=t||document;let i=null;t===document&&(i=window.onbeforeunload,window.onbeforeunload=null);const s=t.createElement("form");s.setAttribute("method",this.method),s.setAttribute("action",this.url),e!=null&&s.setAttribute("target",e),s.style.display="none",s.style.visibility="hidden";const l=this.params,r=l.indexOf("&")>0?l.split("&"):l.split(" ");for(let o=0;o<r.length;o+=1){const h=r[o].indexOf("=");if(h>0){const a=r[o].substring(0,h);let d=r[o].substring(h+1);this.decodeSimulateValues&&(d=decodeURIComponent(d));const c=t.createElement("textarea");c.setAttribute("wrap","off"),c.setAttribute("name",a),write(c,d),s.appendChild(c)}}t.body.appendChild(s),s.submit(),s.parentNode!=null&&s.parentNode.removeChild(s),i!=null&&(window.onbeforeunload=i)}}const load=n=>{const t=new MaxXmlRequest(n,null,"GET",!1);return t.send(),t},get=(n,t=null,e=null,i=!1,s=null,l=null,r=null)=>{const o=new MaxXmlRequest(n,null,"GET"),{setRequestHeaders:h}=o;return r&&(o.setRequestHeaders=(a,d)=>{h.apply(void 0,[a,d]);for(const c in r)a.setRequestHeader(c,r[c])}),i!=null&&o.setBinary(i),o.send(t,e,s,l),o};class ObjectCodec{constructor(n,t=[],e=[],i={}){this.template=n,this.exclude=t,this.idrefs=e,this.mapping=i,this.reverse={};for(const s in this.mapping)this.reverse[this.mapping[s]]=s}getName(){return this.name??this.template.constructor.name}setName(n){this.name=n}cloneTemplate(){return new this.template.constructor}getFieldName(n){if(n!=null){const t=this.reverse[n];t!=null&&(n=t)}return n}getAttributeName(n){if(n!=null){const t=this.mapping[n];t!=null&&(n=t)}return n}isExcluded(n,t,e,i){return t==ObjectIdentity.FIELD_NAME||this.exclude.indexOf(t)>=0}isReference(n,t,e,i){return this.idrefs.indexOf(t)>=0}encode(n,t){const e=n.document.createElement(this.getName());return t=this.beforeEncode(n,t,e),this.encodeObject(n,t,e),this.afterEncode(n,t,e)}encodeObject(n,t,e){n.setAttribute(e,"id",n.getId(t));for(const i in t){let s=i;const l=t[s];l!=null&&!this.isExcluded(t,s,l,!0)&&(isInteger(s)&&(s=null),this.encodeValue(n,t,s,l,e))}}encodeValue(n,t,e,i,s){if(i!=null){if(e!=null&&this.isReference(t,e,i,!0)){const l=n.getId(i);if(l==null){GlobalConfig.logger.warn(`ObjectCodec.encode: No ID for ${this.getName()}.${e}=${i}`);return}i=l}(e==null||n.encodeDefaults||this.template[e]!=i)&&(e=this.getAttributeName(e),this.writeAttribute(n,t,e,i,s))}}writeAttribute(n,t,e,i,s){typeof i!="object"?this.writePrimitiveAttribute(n,t,e,i,s):this.writeComplexAttribute(n,t,e,i,s)}writePrimitiveAttribute(n,t,e,i,s){if(i=this.convertAttributeToXml(n,t,e,i,s),e==null){const l=n.document.createElement("add");typeof i=="function"?l.appendChild(n.document.createTextNode(i)):n.setAttribute(l,"value",i),s.appendChild(l)}else typeof i!="function"&&n.setAttribute(s,e,i)}writeComplexAttribute(n,t,e,i,s){const l=n.encode(i);l!=null?(e!=null&&l.setAttribute("as",e),s.appendChild(l)):GlobalConfig.logger.warn(`ObjectCodec.encode: No node for ${this.getName()}.${e}: ${i}`)}convertAttributeToXml(n,t,e,i,s){return this.isBooleanAttribute(n,t,e,i)&&(i=i==!0?"1":"0"),i}isBooleanAttribute(n,t,e,i){return typeof i.length>"u"&&(i==!0||i==!1)}convertAttributeFromXml(n,t,e){let{value:i}=t;return this.isNumericAttribute(n,t,e)&&(i=parseFloat(i),(Number.isNaN(i)||!Number.isFinite(i))&&(i=0)),i}isNumericAttribute(n,t,e){return e.constructor===Geometry&&(t.name==="x"||t.name==="y"||t.name==="width"||t.name==="height")||e.constructor===Point&&(t.name==="x"||t.name==="y")||isNumeric(t.value)}beforeEncode(n,t,e){return t}afterEncode(n,t,e){return e}decode(n,t,e){const i=t.getAttribute("id");let s=n.objects[i];s==null&&(s=e||this.cloneTemplate(),i!=null&&n.putObject(i,s));const l=this.beforeDecode(n,t,s);return this.decodeNode(n,l,s),this.afterDecode(n,l,s)}decodeNode(n,t,e){t!=null&&(this.decodeAttributes(n,t,e),this.decodeChildren(n,t,e))}decodeAttributes(n,t,e){const i=t.attributes;if(i!=null)for(let s=0;s<i.length;s+=1)this.decodeAttribute(n,i[s],e)}isIgnoredAttribute(n,t,e){return t.nodeName==="as"||t.nodeName==="id"}decodeAttribute(n,t,e){if(!this.isIgnoredAttribute(n,t,e)){const i=t.nodeName;let s=this.convertAttributeFromXml(n,t,e);const l=this.getFieldName(i);if(this.isReference(e,l,s,!1)){const r=n.getObject(s);if(r==null){GlobalConfig.logger.warn(`ObjectCodec.decode: No object for ${this.getName()}.${i}=${s}`);return}s=r}this.isExcluded(e,i,s,!1)||(e[i]=s)}}decodeChildren(n,t,e){let i=t.firstChild;for(;i!=null;){const s=i.nextSibling;i.nodeType===NODETYPE.ELEMENT&&!this.processInclude(n,i,e)&&this.decodeChild(n,i,e),i=s}}decodeChild(dec,child,obj){const fieldname=this.getFieldName(child.getAttribute("as"));if(fieldname==null||!this.isExcluded(obj,fieldname,child,!1)){const template=this.getFieldTemplate(obj,fieldname,child);let value=null;child.nodeName==="add"?(value=child.getAttribute("value"),value==null&&ObjectCodec.allowEval&&(value=eval(getTextContent(child)))):value=dec.decode(child,template);try{this.addObjectValue(obj,fieldname,value,template)}catch(n){throw new Error(`${n.message} for ${child.nodeName}`)}}}getFieldTemplate(n,t,e){let i=n[t];return i instanceof Array&&i.length>0&&(i=null),i}addObjectValue(n,t,e,i){e!=null&&e!==i&&(t!=null&&t.length>0?n[t]=e:n.push(e))}processInclude(n,t,e){if(t.nodeName==="include"){const i=t.getAttribute("name");if(i!=null)try{const s=load(i).getDocumentElement();s!=null&&n.decode(s,e)}catch{}return!0}return!1}beforeDecode(n,t,e){return t}afterDecode(n,t,e){return e}}ObjectCodec.allowEval=!1;class CodecRegistry{static register(t,e=!0){if(t!=null){const i=t.getName();CodecRegistry.codecs[i]=t;const s=t.template.constructor.name;e&&s!==i&&CodecRegistry.addAlias(s,i)}return t}static addAlias(t,e){CodecRegistry.aliases[t]=e}static getCodec(t){if(t==null)return null;let e=null,i=typeof t=="string"?t:t.name;const s=CodecRegistry.aliases[i];if(s!=null&&(i=s),e=CodecRegistry.codecs[i]??null,e==null)try{e=new ObjectCodec(new t),CodecRegistry.register(e)}catch{}return e}static getCodecByName(t){let e=CodecRegistry.codecs[t];if(!e){const i=CodecRegistry.aliases[t];i&&(e=CodecRegistry.codecs[i])}return e??null}}CodecRegistry.codecs={};CodecRegistry.aliases={};class Cell{constructor(t=null,e=null,i={}){this.invalidating=!1,this.onInit=null,this.overlays=[],this.id=null,this.value=null,this.geometry=null,this.style={},this.vertex=!1,this.edge=!1,this.connectable=!0,this.visible=!0,this.collapsed=!1,this.parent=null,this.source=null,this.target=null,this.children=[],this.edges=[],this.mxTransient=["id","value","parent","source","target","children","edges"],this.value=t,this.setGeometry(e),this.setStyle(i),this.onInit&&this.onInit()}getChildren(){return this.children||[]}getId(){return this.id}setId(t){this.id=t}getValue(){return this.value}setValue(t){this.value=t}valueChanged(t){const e=this.getValue();return this.setValue(t),e}getGeometry(){return this.geometry}setGeometry(t){this.geometry=t}getStyle(){return this.style}getClonedStyle(){return clone(this.getStyle())}setStyle(t){this.style=t}isVertex(){return this.vertex}setVertex(t){this.vertex=t}isEdge(){return this.edge}setEdge(t){this.edge=t}isConnectable(){return this.connectable}setConnectable(t){this.connectable=t}isVisible(){return this.visible}setVisible(t){this.visible=t}isCollapsed(){return this.collapsed}setCollapsed(t){this.collapsed=t}getParent(){return this.parent}setParent(t){this.parent=t}getTerminal(t=!1){return t?this.source:this.target}setTerminal(t,e){return e?this.source=t:this.target=t,t}getChildCount(){return this.children.length}getIndex(t){return t===null?-1:this.children.indexOf(t)}getChildAt(t){return this.children[t]}insert(t,e){return e===void 0&&(e=this.getChildCount(),t.getParent()===this&&e--),t.removeFromParent(),t.setParent(this),this.children.splice(e,0,t),t}remove(t){let e=null;return t>=0&&(e=this.getChildAt(t),e&&(this.children.splice(t,1),e.setParent(null))),e}removeFromParent(){if(this.parent){const t=this.parent.getIndex(this);this.parent.remove(t)}}getEdgeCount(){return this.edges.length}getEdgeIndex(t){return this.edges.indexOf(t)}getEdgeAt(t){return this.edges[t]}insertEdge(t,e=!1){return t.removeFromTerminal(e),t.setTerminal(this,e),(this.edges.length===0||t.getTerminal(!e)!==this||this.edges.indexOf(t)<0)&&this.edges.push(t),t}removeEdge(t,e=!1){if(t!=null){if(t.getTerminal(!e)!==this&&this.edges!=null){const i=this.getEdgeIndex(t);i>=0&&this.edges.splice(i,1)}t.setTerminal(null,e)}return t}removeFromTerminal(t){const e=this.getTerminal(t);e&&e.removeEdge(this,t)}hasAttribute(t){var i;const e=this.getValue();return isNotNullish(e)&&(e.nodeType===NODETYPE.ELEMENT&&e.hasAttribute?e.hasAttribute(t):isNotNullish((i=e.getAttribute)==null?void 0:i.call(e,t)))}getAttribute(t,e){var l;const i=this.getValue();return(isNotNullish(i)&&i.nodeType===NODETYPE.ELEMENT?(l=i.getAttribute)==null?void 0:l.call(i,t):null)??e}setAttribute(t,e){var s;const i=this.getValue();isNotNullish(i)&&i.nodeType===NODETYPE.ELEMENT&&((s=i.setAttribute)==null||s.call(i,t,e))}clone(){const t=clone(this,this.mxTransient);return t.setValue(this.cloneValue()),t}cloneValue(){let t=this.getValue();return isNotNullish(t)&&(typeof t.clone=="function"?t=t.clone():isNotNullish(t.nodeType)&&t.cloneNode&&(t=t.cloneNode(!0))),t}getNearestCommonAncestor(t){let e=CellPath.create(t);if(e.length>0){let i=this,s=CellPath.create(i);if(e.length<s.length){i=t;const l=s;s=e,e=l}for(;i&&s;){const l=i.getParent();if(e.indexOf(s+CellPath.PATH_SEPARATOR)===0&&l)return i;s=CellPath.getParentPath(s),i=l}}return null}isAncestor(t){for(;t&&t!==this;)t=t.getParent();return t===this}getChildVertices(){return this.getChildCells(!0,!1)}getChildEdges(){return this.getChildCells(!1,!0)}getChildCells(t=!1,e=!1){const i=this.getChildCount(),s=[];for(let l=0;l<i;l+=1){const r=this.getChildAt(l);(!e&&!t||e&&r.isEdge()||t&&r.isVertex())&&s.push(r)}return s}getDirectedEdgeCount(t,e=null){let i=0;const s=this.getEdgeCount();for(let l=0;l<s;l+=1){const r=this.getEdgeAt(l);r!==e&&r&&r.getTerminal(t)===this&&(i+=1)}return i}getConnections(){return this.getEdges(!0,!0,!1)}getIncomingEdges(){return this.getEdges(!0,!1,!1)}getOutgoingEdges(){return this.getEdges(!1,!0,!1)}getEdges(t=!0,e=!0,i=!0){const s=this.getEdgeCount(),l=[];for(let r=0;r<s;r+=1){const o=this.getEdgeAt(r),h=o.getTerminal(!0),a=o.getTerminal(!1);(i&&h===a||h!==a&&(t&&a===this||e&&h===this))&&l.push(o)}return l}getOrigin(){let t=new Point;const e=this.getParent();if(e&&(t=e.getOrigin(),!this.isEdge())){const i=this.getGeometry();i&&(t.x+=i.x,t.y+=i.y)}return t}getDescendants(){return this.filterDescendants(null)}filterDescendants(t){let e=[];(t===null||t(this))&&e.push(this);const i=this.getChildCount();for(let s=0;s<i;s+=1){const l=this.getChildAt(s);e=e.concat(l.filterDescendants(t))}return e}getRoot(){let t=this,e=t;for(;t;)e=t,t=t.getParent();return e}}const createXmlDocument=()=>document.implementation.createDocument("","",null);class Codec{constructor(t=createXmlDocument()){this.elements=null,this.encodeDefaults=!1,this.document=t,this.objects={}}putObject(t,e){return this.objects[t]=e,e}getObject(t){let e=null;if(t!=null&&(e=this.objects[t],e==null&&(e=this.lookup(t),e==null))){const i=this.getElementById(t);i!=null&&(e=this.decode(i))}return e}lookup(t){return null}getElementById(t){return this.updateElements(),this.elements[t]}updateElements(){this.elements==null&&(this.elements={},this.document.documentElement!=null&&this.addElement(this.document.documentElement))}addElement(t){if(t.nodeType===NODETYPE.ELEMENT){const i=t.getAttribute("id");if(i!=null){if(this.elements[i]==null)this.elements[i]=t;else if(this.elements[i]!==t)throw new Error(`${i}: Duplicate ID`)}}let e=t.firstChild;for(;e!=null;)this.addElement(e),e=e.nextSibling}getId(t){let e=null;return t!=null&&(e=this.reference(t),e==null&&t instanceof Cell&&(e=t.getId(),e==null&&(e=CellPath.create(t),e.length===0&&(e="root")))),e}reference(t){return null}encode(t){let e=null;if(t!=null&&t.constructor!=null){const i=CodecRegistry.getCodec(t.constructor);i!=null?e=i.encode(this,t):isNode(t)?e=importNode(this.document,t,!0):GlobalConfig.logger.warn(`Codec.encode: No codec for ${getFunctionName(t.constructor)}`)}return e}decode(t,e){this.updateElements();let i=null;if(t!=null&&t.nodeType===NODETYPE.ELEMENT){const s=CodecRegistry.getCodecByName(t.nodeName);s!=null?i=s.decode(this,t,e):(i=t.cloneNode(!0),i.removeAttribute("as"))}return i}encodeCell(t,e,i){const s=this.encode(t);if(s&&e.appendChild(s),i==null||i){const l=t.getChildCount();for(let r=0;r<l;r+=1)this.encodeCell(t.getChildAt(r),e)}}isCellCodec(t){return t!=null&&"isCellCodec"in t?t.isCellCodec():!1}decodeCell(t,e=!0){if((t==null?void 0:t.nodeType)!==NODETYPE.ELEMENT)return null;let i=CodecRegistry.getCodec(t.nodeName);if(!this.isCellCodec(i)){let l=t.firstChild;for(;l!=null&&!this.isCellCodec(i);)i=CodecRegistry.getCodec(l.nodeName),l=l.nextSibling}this.isCellCodec(i)||(i=CodecRegistry.getCodec(Cell));const s=i==null?void 0:i.decode(this,t);return e&&this.insertIntoGraph(s),s}insertIntoGraph(t){const{parent:e}=t,i=t.getTerminal(!0),s=t.getTerminal(!1);if(t.setTerminal(null,!1),t.setTerminal(null,!0),t.parent=null,e!=null){if(e===t)throw new Error(`${e.id}: Self Reference`);e.insert(t)}i!=null&&i.insertEdge(t,!0),s!=null&&s.insertEdge(t,!1)}setAttribute(t,e,i){e!=null&&i!=null&&t.setAttribute(e,i)}}const parseXml=n=>new DOMParser().parseFromString(n,"text/xml"),getXml=(n,t="&#xa;")=>{let i=new XMLSerializer().serializeToString(n);return i=i.replace(/\n/g,t),i},getPrettyXml=(n,t="  ",e="",i=`
`,s=null)=>{const l=[];if(n!=null)if(n.namespaceURI!=null&&n.namespaceURI!==s&&(s=n.namespaceURI,n.getAttribute("xmlns")==null&&n.setAttribute("xmlns",n.namespaceURI)),n.nodeType===NODETYPE.DOCUMENT)l.push(getPrettyXml(n.documentElement,t,e,i,s));else if(n.nodeType===NODETYPE.DOCUMENT_FRAGMENT){let r=n.firstChild;if(r!=null)for(;r!=null;)l.push(getPrettyXml(r,t,e,i,s)),r=r.nextSibling}else if(n.nodeType===NODETYPE.COMMENT){const r=getTextContent(n);r.length>0&&l.push(`${e}<!--${r}-->${i}`)}else if(n.nodeType===NODETYPE.TEXT){const r=trim(getTextContent(n));r&&r.length>0&&l.push(e+htmlEntities(r,!1)+i)}else if(n.nodeType===NODETYPE.CDATA){const r=getTextContent(n);r.length>0&&l.push(`${e}<![CDATA[${r}]]${i}`)}else{l.push(`${e}<${n.nodeName}`);const r=n.attributes;if(r!=null)for(let h=0;h<r.length;h+=1){const a=htmlEntities(r[h].value);l.push(` ${r[h].nodeName}="${a}"`)}let o=n.firstChild;if(o!=null){for(l.push(`>${i}`);o!=null;)l.push(getPrettyXml(o,t,e+t,i,s)),o=o.nextSibling;l.push(`${e}</${n.nodeName}>${i}`)}else l.push(` />${i}`)}return l.join("")},useAbsoluteIds=typeof DOMParser=="function"&&!Client.IS_CHROMEAPP&&!Client.IS_EDGE&&document.getElementsByTagName("base").length>0;class SvgCanvas2D extends AbstractCanvas2D{constructor(t,e){super(),this.defs=null,this.styleEnabled=!0,this.node=null,this.matchHtmlAlignment=!0,this.textEnabled=!0,this.foEnabled=!0,this.foAltText="[Object]",this.foOffset=0,this.textOffset=0,this.imageOffset=0,this.strokeTolerance=0,this.minStrokeWidth=1,this.refCount=0,this.lineHeightCorrection=1,this.pointerEventsValue="all",this.fontMetricsPadding=10,this.cacheOffsetSize=!0,this.originalRoot=null,this.root=t,this.gradients={},this.defs=null,this.styleEnabled=e??!1;let i=null;if(t.ownerDocument!==document){let s=t;for(;s&&s.nodeName!=="svg";)s=s.parentElement;i=s}i&&(i.getElementsByTagName("defs").length>0&&(this.defs=i.getElementsByTagName("defs")[0]),this.defs||(this.defs=this.createElement("defs"),i.firstChild!=null?i.insertBefore(this.defs,i.firstChild):i.appendChild(this.defs)),this.styleEnabled&&this.defs.appendChild(this.createStyle()))}format(t){return parseFloat(t.toFixed(2))}getBaseUrl(){let{href:t}=window.location;const e=t.lastIndexOf("#");return e>0&&(t=t.substring(0,e)),t}reset(){super.reset(),this.gradients={}}end(){}createStyle(){const t=this.createElement("style");return t.setAttribute("type","text/css"),write(t,`svg{font-family:${DEFAULT_FONTFAMILY};font-size:${DEFAULT_FONTSIZE};fill:none;stroke-miterlimit:10}`),t}createElement(t,e){var i;return(i=this.root)==null?void 0:i.ownerDocument.createElementNS(e||NS_SVG,t)}getAlternateText(t,e,i,s,l,r,o,h,a,d,c,g,u){return isNotNullish(r)?this.foAltText:null}createAlternateContent(t,e,i,s,l,r,o,h,a,d,c,g,u){const f=this.getAlternateText(t,e,i,s,l,r,o,h,a,d,c,g,u),p=this.state;if(isNotNullish(f)&&p.fontSize>0){const E=h===ALIGN.TOP?1:h===ALIGN.BOTTOM?0:.3,C=o===ALIGN.RIGHT?"end":o===ALIGN.LEFT?"start":"middle",y=this.createElement("text");y.setAttribute("x",String(Math.round(e+p.dx))),y.setAttribute("y",String(Math.round(i+p.dy+E*p.fontSize))),y.setAttribute("fill",p.fontColor||"black"),y.setAttribute("font-family",p.fontFamily),y.setAttribute("font-size",`${Math.round(p.fontSize)}px`),C!=="start"&&y.setAttribute("text-anchor",C);const w=p.fontStyle;matchBinaryMask(w,FONT.BOLD)&&y.setAttribute("font-weight","bold"),matchBinaryMask(w,FONT.ITALIC)&&y.setAttribute("font-style","italic");const v=[];return matchBinaryMask(w,FONT.UNDERLINE)&&v.push("underline"),matchBinaryMask(w,FONT.STRIKETHROUGH)&&v.push("line-through"),v.length>0&&y.setAttribute("text-decoration",v.join(" ")),write(y,f),y}return null}createGradientId(t,e,i,s,l){t.charAt(0)==="#"&&(t=t.substring(1)),e.charAt(0)==="#"&&(e=e.substring(1)),t=`${t.toLowerCase()}-${i}`,e=`${e.toLowerCase()}-${s}`;let r=null;if(l==null||l===DIRECTION.SOUTH)r="s";else if(l===DIRECTION.EAST)r="e";else{const o=t;t=e,e=o,l===DIRECTION.NORTH?r="s":l===DIRECTION.WEST&&(r="e")}return`mx-gradient-${t}-${e}-${r}`}getSvgGradient(t,e,i,s,l){const r=this.createGradientId(t,e,i,s,l);let o=this.gradients[r];if(!o){const h=this.root.ownerSVGElement;let a=0,d=`${r}-${a}`;if(h)for(o=h.ownerDocument.getElementById(d);o&&o.ownerSVGElement!==h;)d=`${r}-${a++}`,o=h.ownerDocument.getElementById(d);else d=`id${++this.refCount}`;o||(o=this.createSvgGradient(t,e,i,s,l),o.setAttribute("id",d),this.defs?this.defs.appendChild(o):h&&h.appendChild(o)),this.gradients[r]=o}return o.getAttribute("id")}createSvgGradient(t,e,i,s,l){const r=this.createElement("linearGradient");r.setAttribute("x1","0%"),r.setAttribute("y1","0%"),r.setAttribute("x2","0%"),r.setAttribute("y2","0%"),l==null||l===DIRECTION.SOUTH?r.setAttribute("y2","100%"):l===DIRECTION.EAST?r.setAttribute("x2","100%"):l===DIRECTION.NORTH?r.setAttribute("y1","100%"):l===DIRECTION.WEST&&r.setAttribute("x1","100%");let o=i<1?`;stop-opacity:${i}`:"",h=this.createElement("stop");return h.setAttribute("offset","0%"),h.setAttribute("style",`stop-color:${t}${o}`),r.appendChild(h),o=s<1?`;stop-opacity:${s}`:"",h=this.createElement("stop"),h.setAttribute("offset","100%"),h.setAttribute("style",`stop-color:${e}${o}`),r.appendChild(h),r}addNode(t,e){const{node:i}=this,s=this.state;if(i){if(i.nodeName==="path")if(this.path&&this.path.length>0)i.setAttribute("d",this.path.join(" "));else return;t&&s.fillColor!==NONE?this.updateFill():this.styleEnabled||(i.nodeName==="ellipse"&&Client.IS_FF?i.setAttribute("fill","transparent"):i.setAttribute("fill",NONE),t=!1),e&&s.strokeColor!==NONE?this.updateStroke():this.styleEnabled||i.setAttribute("stroke",NONE),s.transform&&s.transform.length>0&&i.setAttribute("transform",s.transform),s.shadow&&this.root.appendChild(this.createShadow(i)),this.strokeTolerance>0&&!t&&this.root.appendChild(this.createTolerance(i)),this.pointerEvents?i.setAttribute("pointer-events",this.pointerEventsValue):!this.pointerEvents&&!this.originalRoot&&i.setAttribute("pointer-events",NONE),(i.nodeName!=="rect"&&i.nodeName!=="path"&&i.nodeName!=="ellipse"||i.getAttribute("fill")!==NONE&&i.getAttribute("fill")!=="transparent"||i.getAttribute("stroke")!==NONE||i.getAttribute("pointer-events")!==NONE)&&this.root.appendChild(i),this.node=null}}updateFill(){var e;const t=this.state;if((t.alpha<1||t.fillAlpha<1)&&this.node.setAttribute("fill-opacity",String(t.alpha*t.fillAlpha)),t.fillColor!==NONE)if(t.gradientColor!==NONE){const i=this.getSvgGradient(t.fillColor,t.gradientColor,t.gradientFillAlpha,t.gradientAlpha,t.gradientDirection);if(((e=this.root)==null?void 0:e.ownerDocument)===document&&useAbsoluteIds){const s=this.getBaseUrl().replace(/([()])/g,"\\$1");this.node.setAttribute("fill",`url(${s}#${i})`)}else this.node.setAttribute("fill",`url(#${i})`)}else this.node.setAttribute("fill",t.fillColor.toLowerCase())}getCurrentStrokeWidth(){return Math.max(this.minStrokeWidth,Math.max(.01,this.format(this.state.strokeWidth*this.state.scale)))}updateStroke(){const t=this.state;t.strokeColor&&t.strokeColor!==NONE&&this.node.setAttribute("stroke",t.strokeColor.toLowerCase()),(t.alpha<1||t.strokeAlpha<1)&&this.node.setAttribute("stroke-opacity",String(t.alpha*t.strokeAlpha));const e=this.getCurrentStrokeWidth();e!==1&&this.node.setAttribute("stroke-width",String(e)),this.node.nodeName==="path"&&this.updateStrokeAttributes(),t.dashed&&this.node.setAttribute("stroke-dasharray",this.createDashPattern((t.fixDash?1:t.strokeWidth)*t.scale))}updateStrokeAttributes(){const t=this.state;if(t.lineJoin&&t.lineJoin!=="miter"&&this.node.setAttribute("stroke-linejoin",t.lineJoin),t.lineCap){let e=t.lineCap;e==="flat"&&(e="butt"),e!=="butt"&&this.node.setAttribute("stroke-linecap",e)}t.miterLimit!=null&&(!this.styleEnabled||t.miterLimit!==10)&&this.node.setAttribute("stroke-miterlimit",String(t.miterLimit))}createDashPattern(t){const e=[];if(typeof this.state.dashPattern=="string"){const i=this.state.dashPattern.split(" ");if(i.length>0)for(let s=0;s<i.length;s+=1)e[s]=Number(i[s])*t}return e.join(" ")}createTolerance(t){const e=t.cloneNode(!0),i=parseFloat(e.getAttribute("stroke-width")||"1")+this.strokeTolerance;return e.setAttribute("pointer-events","stroke"),e.setAttribute("visibility","hidden"),e.removeAttribute("stroke-dasharray"),e.setAttribute("stroke-width",String(i)),e.setAttribute("fill","none"),e.setAttribute("stroke","white"),e}createShadow(t){const e=t.cloneNode(!0),i=this.state;return e.getAttribute("fill")!=="none"&&(!Client.IS_FF||e.getAttribute("fill")!=="transparent")&&e.setAttribute("fill",i.shadowColor),e.getAttribute("stroke")!=="none"&&i.shadowColor&&i.shadowColor!==NONE&&e.setAttribute("stroke",i.shadowColor),e.setAttribute("transform",`translate(${this.format(i.shadowDx*i.scale)},${this.format(i.shadowDy*i.scale)})${i.transform||""}`),e.setAttribute("opacity",String(i.shadowAlpha)),e}setLink(t){if(!t)this.root=this.originalRoot;else{this.originalRoot=this.root;const e=this.createElement("a");e.setAttributeNS==null||this.root.ownerDocument!==document?e.setAttribute("xlink:href",t):e.setAttributeNS(NS_XLINK,"xlink:href",t),this.root.appendChild(e),this.root=e}}rotate(t,e,i,s,l){if(t!==0||e||i){const r=this.state;if(s+=r.dx,l+=r.dy,s*=r.scale,l*=r.scale,r.transform=r.transform||"",e&&i)t+=180;else if(e!==i){const o=e?s:0,h=e?-1:1,a=i?l:0,d=i?-1:1;r.transform+=`translate(${this.format(o)},${this.format(a)})scale(${this.format(h)},${this.format(d)})translate(${this.format(-o)},${this.format(-a)})`}(e?!i:i)&&(t*=-1),t!==0&&(r.transform+=`rotate(${this.format(t)},${this.format(s)},${this.format(l)})`),r.rotation+=t,r.rotationCx=s,r.rotationCy=l}}begin(){super.begin(),this.node=this.createElement("path")}rect(t,e,i,s){const l=this.state,r=this.createElement("rect");r.setAttribute("x",String(this.format((t+l.dx)*l.scale))),r.setAttribute("y",String(this.format((e+l.dy)*l.scale))),r.setAttribute("width",String(this.format(i*l.scale))),r.setAttribute("height",String(this.format(s*l.scale))),this.node=r}roundrect(t,e,i,s,l,r){this.rect(t,e,i,s),l>0&&this.node.setAttribute("rx",String(this.format(l*this.state.scale))),r>0&&this.node.setAttribute("ry",String(this.format(r*this.state.scale)))}ellipse(t,e,i,s){const l=this.state,r=this.createElement("ellipse");r.setAttribute("cx",String(this.format((t+i/2+l.dx)*l.scale))),r.setAttribute("cy",String(this.format((e+s/2+l.dy)*l.scale))),r.setAttribute("rx",String(i/2*l.scale)),r.setAttribute("ry",String(s/2*l.scale)),this.node=r}image(t,e,i,s,l,r=!0,o=!1,h=!1){l=this.converter.convert(l);const a=this.state;t+=a.dx,e+=a.dy;const d=this.createElement("image");d.setAttribute("x",String(this.format(t*a.scale)+this.imageOffset)),d.setAttribute("y",String(this.format(e*a.scale)+this.imageOffset)),d.setAttribute("width",String(this.format(i*a.scale))),d.setAttribute("height",String(this.format(s*a.scale))),d.setAttributeNS?d.setAttributeNS(NS_XLINK,"xlink:href",l):d.setAttribute("xlink:href",l),r||d.setAttribute("preserveAspectRatio","none"),(a.alpha<1||a.fillAlpha<1)&&d.setAttribute("opacity",String(a.alpha*a.fillAlpha));let c=this.state.transform||"";if(o||h){let g=1,u=1,f=0,p=0;o&&(g=-1,f=-i-2*t),h&&(u=-1,p=-s-2*e),c+=`scale(${g},${u})translate(${f*a.scale},${p*a.scale})`}c.length>0&&d.setAttribute("transform",c),this.pointerEvents||d.setAttribute("pointer-events","none"),this.root.appendChild(d)}convertHtml(t){const e=new DOMParser().parseFromString(t,"text/html");return e!=null&&(t=new XMLSerializer().serializeToString(e.body),t.substring(0,5)==="<body"&&(t=t.substring(t.indexOf(">",5)+1)),t.substring(t.length-7,t.length)==="</body>"&&(t=t.substring(0,t.length-7))),t}createDiv(t){let e=t;if(isNode(e)||(e=`<div><div>${this.convertHtml(e)}</div></div>`),document.createElementNS){const i=document.createElementNS("http://www.w3.org/1999/xhtml","div");if(isNode(e)){const s=e,l=document.createElement("div"),r=l.cloneNode(!1);this.root.ownerDocument!==document?l.appendChild(s.cloneNode(!0)):l.appendChild(s),r.appendChild(l),i.appendChild(r)}else i.innerHTML=e;return i}return isNode(e)&&(e=`<div><div>${getXml(e)}</div></div>`),e=`<div xmlns="http://www.w3.org/1999/xhtml">${e}</div>`,new DOMParser().parseFromString(e,"text/xml").documentElement}updateText(t,e,i,s,l,r,o,h,a,d,c){c&&c.firstChild&&c.firstChild.firstChild&&this.updateTextNodes(t,e,i,s,l,r,o,h,a,d,c.firstChild)}addForeignObject(t,e,i,s,l,r,o,h,a,d,c,g,u,f,p){var y;const E=this.createElement("g"),C=this.createElement("foreignObject");if(C.setAttribute("style","overflow: visible; text-align: left;"),C.setAttribute("pointer-events","none"),C.appendChild(f),E.appendChild(C),this.updateTextNodes(t,e,i,s,r,o,h,d,c,g,E),((y=this.root)==null?void 0:y.ownerDocument)!==document){const w=this.createAlternateContent(C,t,e,i,s,l,r,o,h,a,d,c,g);if(w!=null){C.setAttribute("requiredFeatures","http://www.w3.org/TR/SVG11/feature#Extensibility");const v=this.createElement("switch");v.appendChild(C),v.appendChild(w),E.appendChild(v)}}p.appendChild(E)}updateTextNodes(t,e,i,s,l,r,o,h,a,d,c){const g=this.state.scale;SvgCanvas2D.createCss(i+2,s,l,r,o,h,a,this.state.fontBackgroundColor!=null?this.state.fontBackgroundColor:null,this.state.fontBorderColor!=null?this.state.fontBorderColor:null,`display: flex; align-items: unsafe ${r===ALIGN.TOP?"flex-start":r===ALIGN.BOTTOM?"flex-end":"center"}; justify-content: unsafe ${l===ALIGN.LEFT?"flex-start":l===ALIGN.RIGHT?"flex-end":"center"}; `,this.getTextCss(),g,(u,f,p,E,C)=>{t+=this.state.dx,e+=this.state.dy;const y=c.firstChild,w=y.firstChild,v=w.firstChild,S=v.firstChild,I=(this.rotateHtml?this.state.rotation:0)+(d??0);let T=(this.foOffset!==0?`translate(${this.foOffset} ${this.foOffset})`:"")+(g!==1?`scale(${g})`:"");S.setAttribute("style",C),v.setAttribute("style",E),y.setAttribute("width",`${Math.ceil(1/Math.min(1,g)*100)}%`),y.setAttribute("height",`${Math.ceil(1/Math.min(1,g)*100)}%`);const A=Math.round(e+f);A<0?y.setAttribute("y",String(A)):(y.removeAttribute("y"),p+=`padding-top: ${A}px; `),w.setAttribute("style",`${p}margin-left: ${Math.round(t+u)}px;`),T+=I!==0?`rotate(${I} ${t} ${e})`:"",T!==""?c.setAttribute("transform",T):c.removeAttribute("transform"),this.state.alpha!==1?c.setAttribute("opacity",String(this.state.alpha)):c.removeAttribute("opacity")})}getTextCss(){const t=this.state,e=LINE_HEIGHT*this.lineHeightCorrection;let i=`display: inline-block; font-size: ${t.fontSize}px; font-family: ${t.fontFamily}; color: ${t.fontColor}; line-height: ${e}; pointer-events: ${this.pointerEvents?this.pointerEventsValue:"none"}; `;const s=t.fontStyle;matchBinaryMask(s,FONT.BOLD)&&(i+="font-weight: bold; "),matchBinaryMask(s,FONT.ITALIC)&&(i+="font-style: italic; ");const l=[];return matchBinaryMask(s,FONT.UNDERLINE)&&l.push("underline"),matchBinaryMask(s,FONT.STRIKETHROUGH)&&l.push("line-through"),l.length>0&&(i+=`text-decoration: ${l.join(" ")}; `),i}text(t,e,i,s,l,r,o,h,a,d,c,g=0,u){if(this.textEnabled&&l!=null)if(g=g??0,this.foEnabled&&a==="html"){const f=this.createDiv(l);f!=null&&(u!=null&&f.setAttribute("dir",u),this.addForeignObject(t,e,i,s,l,r,o,h,a,d,c,g,u,f,this.root))}else this.plainText(t+this.state.dx,e+this.state.dy,i,s,l,r,o,h,d,c,g,u)}createClip(t,e,i,s){t=Math.round(t),e=Math.round(e),i=Math.round(i),s=Math.round(s);const l=`mx-clip-${t}-${e}-${i}-${s}`;let r=0,o=`${l}-${r}`;for(;document.getElementById(o)!=null;)o=`${l}-${++r}`;const h=this.createElement("clipPath");h.setAttribute("id",o);const a=this.createElement("rect");return a.setAttribute("x",String(t)),a.setAttribute("y",String(e)),a.setAttribute("width",String(i)),a.setAttribute("height",String(s)),h.appendChild(a),h}plainText(t,e,i,s,l,r,o,h,a,d,c=0,g){const u=this.state,f=u.fontSize,p=this.createElement("g");let E=u.transform||"";if(this.updateFont(p),!this.pointerEvents&&this.originalRoot==null&&p.setAttribute("pointer-events","none"),c!==0&&(E+=`rotate(${c},${this.format(t*u.scale)},${this.format(e*u.scale)})`),g!=null&&p.setAttribute("direction",g),d&&i>0&&s>0){let I=t,T=e;r===ALIGN.CENTER?I-=i/2:r===ALIGN.RIGHT&&(I-=i),a!=="fill"&&(o===ALIGN.MIDDLE?T-=s/2:o===ALIGN.BOTTOM&&(T-=s));const A=this.createClip(I*u.scale-2,T*u.scale-2,i*u.scale+4,s*u.scale+4);if(this.defs!=null?this.defs.appendChild(A):this.root.appendChild(A),!Client.IS_CHROMEAPP&&!Client.IS_EDGE&&this.root.ownerDocument===document){const R=this.getBaseUrl().replace(/([()])/g,"\\$1");p.setAttribute("clip-path",`url(${R}#${A.getAttribute("id")})`)}else p.setAttribute("clip-path",`url(#${A.getAttribute("id")})`)}const C=r===ALIGN.RIGHT?"end":r===ALIGN.CENTER?"middle":"start";C!=="start"&&p.setAttribute("text-anchor",C),(!this.styleEnabled||f!==DEFAULT_FONTSIZE)&&p.setAttribute("font-size",`${f*u.scale}px`),E.length>0&&p.setAttribute("transform",E),u.alpha<1&&p.setAttribute("opacity",String(u.alpha));const y=l.split(`
`),w=Math.round(f*LINE_HEIGHT),v=f+(y.length-1)*w;let S=e+f-1;if(o===ALIGN.MIDDLE)if(a==="fill")S-=s/2;else{const I=(this.matchHtmlAlignment&&d&&s>0?Math.min(v,s):v)/2;S-=I}else if(o===ALIGN.BOTTOM)if(a==="fill")S-=s;else{const I=this.matchHtmlAlignment&&d&&s>0?Math.min(v,s):v;S-=I+1}for(let I=0;I<y.length;I+=1){const T=trim(y[I]);if(T){const A=this.createElement("text");A.setAttribute("x",String(this.format(t*u.scale)+this.textOffset)),A.setAttribute("y",String(this.format(S*u.scale)+this.textOffset)),write(A,T),p.appendChild(A)}S+=w}this.root.appendChild(p),this.addTextBackground(p,l,t,e,i,a==="fill"?s:v,r,o,a)}updateFont(t){const e=this.state;e.fontColor&&e.fontColor!==NONE&&t.setAttribute("fill",e.fontColor),(!this.styleEnabled||e.fontFamily!==DEFAULT_FONTFAMILY)&&t.setAttribute("font-family",e.fontFamily);const i=e.fontStyle;matchBinaryMask(i,FONT.BOLD)&&t.setAttribute("font-weight","bold"),matchBinaryMask(i,FONT.ITALIC)&&t.setAttribute("font-style","italic");const s=[];matchBinaryMask(i,FONT.UNDERLINE)&&s.push("underline"),matchBinaryMask(i,FONT.STRIKETHROUGH)&&s.push("line-through"),s.length>0&&t.setAttribute("text-decoration",s.join(" "))}addTextBackground(t,e,i,s,l,r,o,h,a){var c;const d=this.state;if(d.fontBackgroundColor!=null||d.fontBorderColor!=null){let g=null;if(a==="fill"||a==="width")o===ALIGN.CENTER?i-=l/2:o===ALIGN.RIGHT&&(i-=l),h===ALIGN.MIDDLE?s-=r/2:h===ALIGN.BOTTOM&&(s-=r),g=new Rectangle((i+1)*d.scale,s*d.scale,(l-2)*d.scale,(r+2)*d.scale);else if(t.getBBox!=null&&this.root.ownerDocument===document)try{g=t.getBBox(),g=new Rectangle(g.x,g.y+1,g.width,g.height+0)}catch{}if(g==null||g.width===0||g.height===0){const u=document.createElement("div");u.style.lineHeight=String(LINE_HEIGHT),u.style.fontSize=`${d.fontSize}px`,u.style.fontFamily=d.fontFamily,u.style.whiteSpace="nowrap",u.style.position="absolute",u.style.visibility="hidden",u.style.display="inline-block",matchBinaryMask(d.fontStyle,FONT.BOLD)&&(u.style.fontWeight="bold"),matchBinaryMask(d.fontStyle,FONT.ITALIC)&&(u.style.fontStyle="italic"),e=htmlEntities(e,!1),u.innerHTML=e.replace(/\n/g,"<br/>"),document.body.appendChild(u);const f=u.offsetWidth,p=u.offsetHeight;document.body.removeChild(u),o===ALIGN.CENTER?i-=f/2:o===ALIGN.RIGHT&&(i-=f),h===ALIGN.MIDDLE?s-=p/2:h===ALIGN.BOTTOM&&(s-=p),g=new Rectangle((i+1)*d.scale,(s+2)*d.scale,f*d.scale,(p+1)*d.scale)}if(g!=null){const u=this.createElement("rect");u.setAttribute("fill",d.fontBackgroundColor||"none"),u.setAttribute("stroke",d.fontBorderColor||"none"),u.setAttribute("x",String(Math.floor(g.x-1))),u.setAttribute("y",String(Math.floor(g.y-1))),u.setAttribute("width",String(Math.ceil(g.width+2))),u.setAttribute("height",String(Math.ceil(g.height)));const f=d.fontBorderColor?Math.max(1,this.format(d.scale)):0;u.setAttribute("stroke-width",String(f)),((c=this.root)==null?void 0:c.ownerDocument)===document&&mod(f,2)===1&&u.setAttribute("transform","translate(0.5, 0.5)"),t.insertBefore(u,t.firstChild)}}}stroke(){this.addNode(!1,!0)}fill(){this.addNode(!0,!1)}fillAndStroke(){this.addNode(!0,!0)}}SvgCanvas2D.createCss=(n,t,e,i,s,l,r,o,h,a,d,c,g)=>{let u=`box-sizing: border-box; font-size: 0; text-align: ${e===ALIGN.LEFT?"left":e===ALIGN.RIGHT?"right":"center"}; `;const f=getAlignmentAsPoint(e,i);let p="overflow: hidden; ",E="width: 1px; ",C="height: 1px; ",y=f.x*n,w=f.y*t;r?(E=`width: ${Math.round(n)}px; `,u+=`max-height: ${Math.round(t)}px; `,w=0):l==="fill"?(E=`width: ${Math.round(n)}px; `,C=`height: ${Math.round(t)}px; `,d+="width: 100%; height: 100%; ",u+=E+C):l==="width"?(E=`width: ${Math.round(n)}px; `,d+="width: 100%; ",u+=E,w=0,t>0&&(u+=`max-height: ${Math.round(t)}px; `)):(p="",w=0);let v="";o&&(v+=`background-color: ${o}; `),h&&(v+=`border: 1px solid ${h}; `),p==""||r?d+=v:u+=v,s&&n>0?(d+=`white-space: normal; word-wrap: ${WORD_WRAP}; `,E=`width: ${Math.round(n)}px; `,p!==""&&l!=="fill"&&(w=0)):(d+="white-space: nowrap; ",p===""&&(y=0)),g(y,w,a+E+C,u+p,d,p)};class Shape{constructor(t=null){this.preserveImageAspect=!1,this.overlay=null,this.indicator=null,this.indicatorShape=null,this.opacity=100,this.isDashed=!1,this.fill=NONE,this.gradient=NONE,this.gradientDirection=DIRECTION.EAST,this.fillOpacity=100,this.strokeOpacity=100,this.stroke=NONE,this.strokeWidth=1,this.spacing=0,this.startSize=1,this.endSize=1,this.startArrow=NONE,this.endArrow=NONE,this.direction=DIRECTION.EAST,this.flipH=!1,this.flipV=!1,this.isShadow=!1,this.isRounded=!1,this.rotation=0,this.cursor="",this.verticalTextRotation=0,this.oldGradients={},this.glass=!1,this.dialect=null,this.scale=1,this.antiAlias=!0,this.minSvgStrokeWidth=1,this.bounds=null,this.points=[],this.state=null,this.style=null,this.boundingBox=null,this.stencil=null,this.svgStrokeTolerance=8,this.pointerEvents=!0,this.originalPointerEvents=null,this.svgPointerEvents="all",this.shapePointerEvents=!1,this.stencilPointerEvents=!1,this.outline=!1,this.visible=!0,this.useSvgBoundingBox=!0,this.image=null,this.imageSrc=null,this.indicatorColor=NONE,this.indicatorStrokeColor=NONE,this.indicatorGradientColor=NONE,this.indicatorDirection=DIRECTION.EAST,this.indicatorImageSrc=null,t&&(this.stencil=t),this.node=this.create()}init(t){this.node.parentNode||t.appendChild(this.node)}initStyles(){this.strokeWidth=1,this.rotation=0,this.opacity=100,this.fillOpacity=100,this.strokeOpacity=100,this.flipH=!1,this.flipV=!1}isHtmlAllowed(){return!1}getSvgScreenOffset(){const t=this.stencil&&this.stencil.strokeWidthValue!=="inherit"?Number(this.stencil.strokeWidthValue):this.strokeWidth??0;return mod(Math.max(1,Math.round(t*this.scale)),2)===1?.5:0}create(){return document.createElementNS(NS_SVG,"g")}redraw(){this.updateBoundsFromPoints(),this.visible&&this.checkBounds()?(this.node.style.visibility="visible",this.clear(),this.redrawShape(),this.updateBoundingBox()):(this.node.style.visibility="hidden",this.boundingBox=null)}clear(){for(;this.node.lastChild;)this.node.removeChild(this.node.lastChild)}updateBoundsFromPoints(){const t=this.points;if(t.length>0&&t[0]){this.bounds=new Rectangle(Math.round(t[0].x),Math.round(t[0].y),1,1);for(const e of t)e&&this.bounds.add(new Rectangle(Math.round(e.x),Math.round(e.y),1,1))}}getLabelBounds(t){var l,r,o;const e=((l=this.style)==null?void 0:l.direction)??DIRECTION.EAST;let i=t.clone();e!==DIRECTION.SOUTH&&e!==DIRECTION.NORTH&&this.state&&this.state.text&&this.state.text.isPaintBoundsInverted()&&(i=i.clone(),[i.width,i.height]=[i.height,i.width]);let s=this.getLabelMargins(i);if(s){s=s.clone();let h=((r=this.style)==null?void 0:r.flipH)??!1,a=((o=this.style)==null?void 0:o.flipV)??!1;if(this.state&&this.state.text&&this.state.text.isPaintBoundsInverted()){const d=s.x;s.x=s.height,s.height=s.width,s.width=s.y,s.y=d,[h,a]=[a,h]}return getDirectedBounds(t,s,this.style,h,a)}return t}getLabelMargins(t){return null}checkBounds(){return!Number.isNaN(this.scale)&&Number.isFinite(this.scale)&&this.scale>0&&this.bounds&&!Number.isNaN(this.bounds.x)&&!Number.isNaN(this.bounds.y)&&!Number.isNaN(this.bounds.width)&&!Number.isNaN(this.bounds.height)&&this.bounds.width>0&&this.bounds.height>0}redrawShape(){const t=this.createCanvas();t&&(t.pointerEvents=this.pointerEvents,this.beforePaint(t),this.paint(t),this.afterPaint(t),this.node!==t.root&&t.root&&this.node.insertAdjacentHTML("beforeend",t.root.outerHTML),this.destroyCanvas(t))}createCanvas(){const t=this.createSvgCanvas();return t&&this.outline&&(t.setStrokeWidth(this.strokeWidth),t.setStrokeColor(this.stroke),this.isDashed&&t.setDashed(this.isDashed),t.setStrokeWidth=()=>{},t.setStrokeColor=()=>{},t.setFillColor=()=>{},t.setGradient=()=>{},t.setDashed=()=>{},t.text=()=>{}),t}createSvgCanvas(){if(!this.node)return null;const t=new SvgCanvas2D(this.node,!1);t.strokeTolerance=this.pointerEvents?this.svgStrokeTolerance:0,t.pointerEventsValue=this.svgPointerEvents;const e=this.getSvgScreenOffset();return e!==0?this.node.setAttribute("transform",`translate(${e},${e})`):this.node.removeAttribute("transform"),t.minStrokeWidth=this.minSvgStrokeWidth,this.antiAlias||(t.format=i=>Math.round(i)),t}destroyCanvas(t){if(t instanceof SvgCanvas2D){for(const e in t.gradients){const i=t.gradients[e];i&&(i.mxRefCount=(i.mxRefCount||0)+1)}this.releaseSvgGradients(this.oldGradients),this.oldGradients=t.gradients}}beforePaint(t){}afterPaint(t){}paint(t){let e=!1;if(t&&this.outline){const{stroke:l}=t;t.stroke=(...o)=>{e=!0,l.apply(t,o)};const{fillAndStroke:r}=t;t.fillAndStroke=(...o)=>{e=!0,r.apply(t,o)}}const i=this.scale,s=this.bounds;if(s){let l=s.x/i,r=s.y/i,o=s.width/i,h=s.height/i;if(this.isPaintBoundsInverted()){const d=(o-h)/2;l+=d,r-=d;const c=o;o=h,h=c}this.updateTransform(t,l,r,o,h),this.configureCanvas(t,l,r,o,h);let a=null;if(!this.stencil&&this.points.length===0&&this.shapePointerEvents||this.stencil&&this.stencilPointerEvents){const d=this.createBoundingBox();d&&this.node&&(a=this.createTransparentSvgRectangle(d.x,d.y,d.width,d.height),this.node.appendChild(a))}if(this.stencil)this.stencil.drawShape(t,this,l,r,o,h);else if(t.setStrokeWidth(this.strokeWidth),this.points.length>0){const d=[];for(let c=0;c<this.points.length;c+=1){const g=this.points[c];g&&d.push(new Point(g.x/i,g.y/i))}this.paintEdgeShape(t,d)}else this.paintVertexShape(t,l,r,o,h);a&&t.state&&isNotNullish(t.state.transform)&&a.setAttribute("transform",t.state.transform),t&&this.outline&&!e&&(t.rect(l,r,o,h),t.stroke())}}configureCanvas(t,e,i,s,l){var o;let r=null;if(this.style&&this.style.dashPattern!=null&&(r=this.style.dashPattern),t.setAlpha(this.opacity/100),t.setFillAlpha(this.fillOpacity/100),t.setStrokeAlpha(this.strokeOpacity/100),this.isShadow&&t.setShadow(this.isShadow),this.isDashed&&t.setDashed(this.isDashed,((o=this.style)==null?void 0:o.fixDash)??!1),r&&t.setDashPattern(r),this.fill!==NONE&&this.gradient!==NONE){const h=this.getGradientBounds(t,e,i,s,l);t.setGradient(this.fill,this.gradient,h.x,h.y,h.width,h.height,this.gradientDirection)}else t.setFillColor(this.fill);t.setStrokeColor(this.stroke)}getGradientBounds(t,e,i,s,l){return new Rectangle(e,i,s,l)}updateTransform(t,e,i,s,l){t.scale(this.scale),t.rotate(this.getShapeRotation(),this.flipH,this.flipV,e+s/2,i+l/2)}paintVertexShape(t,e,i,s,l){this.paintBackground(t,e,i,s,l),(!this.outline||!this.style||!(this.style.backgroundOutline??!1))&&(t.setShadow(!1),this.paintForeground(t,e,i,s,l))}paintBackground(t,e,i,s,l){}paintForeground(t,e,i,s,l){}paintEdgeShape(t,e){}getArcSize(t,e){var s,l,r;let i=0;if(((s=this.style)==null?void 0:s.absoluteArcSize)??!1)i=Math.min(t/2,Math.min(e/2,(((l=this.style)==null?void 0:l.arcSize)??LINE_ARCSIZE)/2));else{const o=(((r=this.style)==null?void 0:r.arcSize)??RECTANGLE_ROUNDING_FACTOR*100)/100;i=Math.min(t*o,e*o)}return i}paintGlassEffect(t,e,i,s,l,r){const o=Math.ceil((this.strokeWidth??0)/2),h=.4;t.setGradient("#ffffff","#ffffff",e,i,s,l*.6,"south",.9,.1),t.begin(),r+=2*o,this.isRounded?(t.moveTo(e-o+r,i-o),t.quadTo(e-o,i-o,e-o,i-o+r),t.lineTo(e-o,i+l*h),t.quadTo(e+s*.5,i+l*.7,e+s+o,i+l*h),t.lineTo(e+s+o,i-o+r),t.quadTo(e+s+o,i-o,e+s+o-r,i-o)):(t.moveTo(e-o,i-o),t.lineTo(e-o,i+l*h),t.quadTo(e+s*.5,i+l*.7,e+s+o,i+l*h),t.lineTo(e+s+o,i-o)),t.close(),t.fill()}addPoints(t,e,i=!1,s,l=!1,r=[],o=!0){if(e.length>0){const h=e[e.length-1];if(l&&i){e=e.slice();const c=e[0],g=new Point(h.x+(c.x-h.x)/2,h.y+(c.y-h.y)/2);e.splice(0,0,g)}let a=e[0],d=1;for(o?t.moveTo(a.x,a.y):t.lineTo(a.x,a.y);d<(l?e.length:e.length-1);){let c=e[mod(d,e.length)],g=a.x-c.x,u=a.y-c.y;if(i&&(g!==0||u!==0)&&r.indexOf(d-1)<0){let f=Math.sqrt(g*g+u*u);const p=g*Math.min(s,f/2)/f,E=u*Math.min(s,f/2)/f,C=c.x+p,y=c.y+E;t.lineTo(C,y);let w=e[mod(d+1,e.length)];for(;d<e.length-2&&Math.round(w.x-c.x)===0&&Math.round(w.y-c.y)===0;)w=e[mod(d+2,e.length)],d++;g=w.x-c.x,u=w.y-c.y,f=Math.max(1,Math.sqrt(g*g+u*u));const v=g*Math.min(s,f/2)/f,S=u*Math.min(s,f/2)/f,I=c.x+v,T=c.y+S;t.quadTo(c.x,c.y,I,T),c=new Point(I,T)}else t.lineTo(c.x,c.y);a=c,d+=1}l?t.close():t.lineTo(h.x,h.y)}}resetStyles(){this.initStyles(),this.spacing=0,this.fill=NONE,this.gradient=NONE,this.gradientDirection=DIRECTION.EAST,this.stroke=NONE,this.startSize=1,this.endSize=1,this.startArrow=NONE,this.endArrow=NONE,this.direction=DIRECTION.EAST,this.isShadow=!1,this.isDashed=!1,this.isRounded=!1,this.glass=!1}apply(t){if(this.state=t,this.style=t.style,this.style){if(this.fill=this.style.fillColor??this.fill,this.gradient=this.style.gradientColor??this.gradient,this.gradientDirection=this.style.gradientDirection??this.gradientDirection,this.opacity=this.style.opacity??this.opacity,this.fillOpacity=this.style.fillOpacity??this.fillOpacity,this.strokeOpacity=this.style.strokeOpacity??this.strokeOpacity,this.stroke=this.style.strokeColor??this.stroke,this.strokeWidth=this.style.strokeWidth??this.strokeWidth,this.spacing=this.style.spacing??this.spacing,this.startSize=this.style.startSize??this.startSize,this.endSize=this.style.endSize??this.endSize,this.startArrow=this.style.startArrow??this.startArrow,this.endArrow=this.style.endArrow??this.endArrow,this.rotation=this.style.rotation??this.rotation,this.direction=this.style.direction??this.direction,this.flipH=!!this.style.flipH,this.flipV=!!this.style.flipV,this.direction===DIRECTION.NORTH||this.direction===DIRECTION.SOUTH){const e=this.flipH;this.flipH=this.flipV,this.flipV=e}this.isShadow=this.style.shadow??this.isShadow,this.isDashed=this.style.dashed??this.isDashed,this.isRounded=this.style.rounded??this.isRounded,this.glass=this.style.glass??this.glass}}setCursor(t){this.cursor=t,this.node.style.cursor=t}getCursor(){return this.cursor}isRoundable(t,e,i,s,l){return!1}updateBoundingBox(){if(this.useSvgBoundingBox&&this.node.ownerSVGElement)try{const t=this.node.getBBox();if(t.width>0&&t.height>0){this.boundingBox=new Rectangle(t.x,t.y,t.width,t.height),this.boundingBox.grow((this.strokeWidth??0)*this.scale/2);return}}catch{}if(this.bounds){let t=this.createBoundingBox();if(t){this.augmentBoundingBox(t);const e=this.getShapeRotation();e!==0&&(t=getBoundingBox(t,e))}this.boundingBox=t}}createBoundingBox(){if(!this.bounds)return null;const t=this.bounds.clone();return(this.stencil&&(this.direction===DIRECTION.NORTH||this.direction===DIRECTION.SOUTH)||this.isPaintBoundsInverted())&&t.rotate90(),t}augmentBoundingBox(t){this.isShadow&&(t.width+=Math.ceil(StyleDefaultsConfig.shadowOffsetX*this.scale),t.height+=Math.ceil(StyleDefaultsConfig.shadowOffsetX*this.scale)),t.grow((this.strokeWidth??0)*this.scale/2)}isPaintBoundsInverted(){return!this.stencil&&(this.direction===DIRECTION.NORTH||this.direction===DIRECTION.SOUTH)}getRotation(){return this.rotation??0}getTextRotation(){var e;let t=this.getRotation();return(((e=this.style)==null?void 0:e.horizontal)??!0)||(t+=this.verticalTextRotation||-90),t}getShapeRotation(){let t=this.getRotation();return this.direction===DIRECTION.NORTH?t+=270:this.direction===DIRECTION.WEST?t+=180:this.direction===DIRECTION.SOUTH&&(t+=90),t}createTransparentSvgRectangle(t,e,i,s){const l=document.createElementNS(NS_SVG,"rect");return l.setAttribute("x",String(t)),l.setAttribute("y",String(e)),l.setAttribute("width",String(i)),l.setAttribute("height",String(s)),l.setAttribute("fill",NONE),l.setAttribute("stroke",NONE),l.setAttribute("pointer-events","all"),l}redrawHtmlShape(){}setTransparentBackgroundImage(t){t.style.backgroundImage=`url('${Client.imageBasePath}/transparent.gif')`}releaseSvgGradients(t){for(const e in t){const i=t[e];i&&(i.mxRefCount=(i.mxRefCount||0)-1,i.mxRefCount===0&&i.parentNode&&i.parentNode.removeChild(i))}}destroy(){InternalEvent.release(this.node),this.node.parentNode&&this.node.parentNode.removeChild(this.node),this.node.innerHTML="",this.releaseSvgGradients(this.oldGradients),this.oldGradients={}}}class RectangleShape extends Shape{constructor(t,e,i,s=1){super(),this.bounds=t,this.fill=e,this.stroke=i,this.strokeWidth=s}isHtmlAllowed(){let t=!0;return this.style&&this.style.pointerEvents!=null&&(t=this.style.pointerEvents),!this.isRounded&&!this.glass&&this.rotation===0&&(t||this.fill!==NONE)}paintBackground(t,e,i,s,l){var o,h,a;let r=!0;if(this.style&&this.style.pointerEvents!=null&&(r=this.style.pointerEvents),r||this.fill!==NONE||this.stroke!==NONE){if(!r&&this.fill===NONE&&(t.pointerEvents=!1),this.isRounded){let d=0;if(((o=this.style)==null?void 0:o.absoluteArcSize)??!1)d=Math.min(s/2,Math.min(l/2,(((h=this.style)==null?void 0:h.arcSize)??LINE_ARCSIZE)/2));else{const c=(((a=this.style)==null?void 0:a.arcSize)??RECTANGLE_ROUNDING_FACTOR*100)/100;d=Math.min(s*c,l*c)}t.roundrect(e,i,s,l,d,d)}else t.rect(e,i,s,l);t.fillAndStroke()}}isRoundable(t,e,i,s,l){return!0}paintForeground(t,e,i,s,l){this.glass&&!this.outline&&this.fill!==NONE&&this.paintGlassEffect(t,e,i,s,l,this.getArcSize(s+this.strokeWidth,l+this.strokeWidth))}}class CellState extends Rectangle{constructor(t=null,e=null,i=null){super(),this.node=null,this.cellBounds=null,this.paintBounds=null,this.boundingBox=null,this.control=null,this.overlays=new Dictionary,this.invalidStyle=!1,this.invalid=!0,this.absolutePoints=[],this.visibleSourceState=null,this.visibleTargetState=null,this.terminalDistance=0,this.length=0,this.segments=[],this.shape=null,this.text=null,this.unscaledWidth=0,this.unscaledHeight=0,this.parentHighlight=null,this.point=null,t&&(this.view=t),e&&(this.cell=e),this.style=i??{},this.origin=new Point,this.absoluteOffset=new Point}getPerimeterBounds(t=0,e=new Rectangle(this.x,this.y,this.width,this.height)){var i,s;if(((s=(i=this.shape)==null?void 0:i.stencil)==null?void 0:s.aspect)==="fixed"){const l=this.shape.stencil.computeAspect(this.shape,e.x,e.y,e.width,e.height);e.x=l.x,e.y=l.y,e.width=this.shape.stencil.w0*l.width,e.height=this.shape.stencil.h0*l.height}return t!==0&&e.grow(t),e}setAbsoluteTerminalPoint(t,e=!1){e?this.absolutePoints.length===0?this.absolutePoints.push(t):this.absolutePoints[0]=t:this.absolutePoints.length===0?(this.absolutePoints.push(null),this.absolutePoints.push(t)):this.absolutePoints.length===1?this.absolutePoints.push(t):this.absolutePoints[this.absolutePoints.length-1]=t}setCursor(t){this.shape&&this.shape.setCursor(t),this.text&&this.text.setCursor(t)}getVisibleTerminal(t=!1){var e;return((e=this.getVisibleTerminalState(t))==null?void 0:e.cell)??null}getVisibleTerminalState(t=!1){return t?this.visibleSourceState:this.visibleTargetState}setVisibleTerminalState(t,e=!1){e?this.visibleSourceState=t:this.visibleTargetState=t}getCellBounds(){return this.cellBounds}getPaintBounds(){return this.paintBounds}updateCachedBounds(){const t=this.view,e=t.translate,i=t.scale;this.cellBounds=new Rectangle(this.x/i-e.x,this.y/i-e.y,this.width/i,this.height/i),this.paintBounds=Rectangle.fromRectangle(this.cellBounds),this.shape&&this.shape.isPaintBoundsInverted()&&this.paintBounds.rotate90()}setState(t){this.view=t.view,this.cell=t.cell,this.style=t.style,this.absolutePoints=t.absolutePoints,this.origin=t.origin,this.absoluteOffset=t.absoluteOffset,this.boundingBox=t.boundingBox,this.terminalDistance=t.terminalDistance,this.segments=t.segments,this.length=t.length,this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.unscaledWidth=t.unscaledWidth,this.unscaledHeight=t.unscaledHeight}clone(){const t=new CellState(this.view,this.cell,this.style);for(let e=0;e<this.absolutePoints.length;e+=1){const i=this.absolutePoints[e];t.absolutePoints[e]=i?i.clone():null}return this.origin&&(t.origin=this.origin.clone()),this.absoluteOffset&&(t.absoluteOffset=this.absoluteOffset.clone()),this.boundingBox&&(t.boundingBox=this.boundingBox.clone()),t.terminalDistance=this.terminalDistance,t.segments=this.segments,t.length=this.length,t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t.unscaledWidth=this.unscaledWidth,t.unscaledHeight=this.unscaledHeight,t}destroy(){this.view.graph.cellRenderer.destroy(this)}isLoop(t){const e=this.getVisibleTerminalState(!0);return e&&e===this.getVisibleTerminalState(!1)}getVerticalAlign(){return this.style.verticalAlign??ALIGN.MIDDLE}isTransparentState(){return(this.style.strokeColor??NONE)===NONE&&(this.style.fillColor??NONE)===NONE&&!this.getImageSrc()}getImageSrc(){return this.style.image||null}getIndicatorColor(){return this.style.indicatorColor||null}getIndicatorGradientColor(){return this.style.gradientColor||null}getIndicatorShape(){return this.style.indicatorShape||null}getIndicatorImageSrc(){return this.style.indicatorImage||null}}class UndoableEdit{constructor(t,e=!0){this.changes=[],this.significant=!0,this.undone=!1,this.redone=!1,this.source=t,this.changes=[],this.significant=e}isEmpty(){return this.changes.length===0}isSignificant(){return this.significant}add(t){this.changes.push(t)}notify(){}die(){}undo(){if(!this.undone){this.source.fireEvent(new EventObject(InternalEvent.START_EDIT));const t=this.changes.length;for(let e=t-1;e>=0;e--){const i=this.changes[e];i.execute?i.execute():i.undo&&i.undo(),this.source.fireEvent(new EventObject(InternalEvent.EXECUTED,{change:i}))}this.undone=!0,this.redone=!1,this.source.fireEvent(new EventObject(InternalEvent.END_EDIT))}this.notify()}redo(){if(!this.redone){this.source.fireEvent(new EventObject(InternalEvent.START_EDIT));const t=this.changes.length;for(let e=0;e<t;e+=1){const i=this.changes[e];i.execute!=null?i.execute():i.redo!=null&&i.redo(),this.source.fireEvent(new EventObject(InternalEvent.EXECUTED,{change:i}))}this.undone=!1,this.redone=!0,this.source.fireEvent(new EventObject(InternalEvent.END_EDIT))}this.notify()}}class ImageShape extends RectangleShape{constructor(t,e,i="#FFFFFF",s="#000000",l=1){super(t,i,s,l),this.imageSrc=e,this.shadow=!1,this.preserveImageAspect=!0}getSvgScreenOffset(){return 0}apply(t){super.apply(t),this.fill=NONE,this.stroke=NONE,this.gradient=NONE,this.style&&this.style.imageAspect!=null&&(this.preserveImageAspect=this.style.imageAspect)}isHtmlAllowed(){return!this.preserveImageAspect}isRoundable(t,e,i,s,l){return!1}paintVertexShape(t,e,i,s,l){var r,o;if(this.imageSrc){const h=((r=this.style)==null?void 0:r.imageBackground)??NONE,a=((o=this.style)==null?void 0:o.imageBorder)??NONE;h!==NONE&&(t.setFillColor(h),t.setStrokeColor(a),t.rect(e,i,s,l),t.fillAndStroke()),t.image(e,i,s,l,this.imageSrc,this.preserveImageAspect,!1,!1),a!==NONE&&(t.setShadow(!1),t.setStrokeColor(a),t.rect(e,i,s,l),t.stroke())}else this.paintBackground(t,e,i,s,l)}}class CurrentRootChange{constructor(t,e){if(this.view=t,this.root=e,this.previous=e,this.isUp=e===null,!this.isUp){let i=this.view.currentRoot;for(;i;){if(i===e){this.isUp=!0;break}i=i.getParent()}}}execute(){const t=this.view.currentRoot;this.view.currentRoot=this.previous,this.previous=t;const e=this.view.graph.getTranslateForRoot(this.view.currentRoot);e&&(this.view.translate=new Point(-e.x,-e.y)),this.isUp?(this.view.clear(this.view.currentRoot,!0,!0),this.view.validate(null)):this.view.refresh();const i=this.isUp?InternalEvent.UP:InternalEvent.DOWN;this.view.fireEvent(new EventObject(i,{root:this.view.currentRoot,previous:this.previous})),this.isUp=!this.isUp}}class StyleRegistry{static putValue(t,e){StyleRegistry.values[t]=e}static getValue(t){return StyleRegistry.values[t]}static getName(t){for(const e in StyleRegistry.values)if(StyleRegistry.values[e]===t)return e;return null}}StyleRegistry.values={};function getNavigatorLanguage(){return typeof window<"u"?navigator.language:"en"}const values={defaultLanguage:"en",language:getNavigatorLanguage(),languages:[]},originalValues={};shallowCopy(values,originalValues);const TranslationsConfig={isEnabled(){return this.getLanguage()!=="none"},getLanguage(){return values.language},setLanguage(n){values.language=isNullish(n)?getNavigatorLanguage():n},getLanguages(){return values.languages},setLanguages(n){isNullish(n)||(values.languages=n)},getDefaultLanguage(){return values.defaultLanguage},setDefaultLanguage(n){values.defaultLanguage=isNullish(n)?"en":n}};class GraphView extends EventSource{constructor(n){super(),this.backgroundImage=null,this.backgroundPageShape=null,this.EMPTY_POINT=new Point,this.doneResource=TranslationsConfig.isEnabled()?"done":"",this.updatingDocumentResource=TranslationsConfig.isEnabled()?"updatingDocument":"",this.allowEval=!1,this.captureDocumentGesture=!0,this.rendering=!0,this.currentRoot=null,this.graphBounds=new Rectangle,this.scale=1,this.translate=new Point,this.states=new Dictionary,this.updateStyle=!1,this.lastNode=null,this.lastHtmlNode=null,this.lastForegroundNode=null,this.lastForegroundHtmlNode=null,this.endHandler=null,this.moveHandler=null,this.graph=n}getGraphBounds(){return this.graphBounds}setGraphBounds(n){this.graphBounds=n}getScale(){return this.scale}setScale(n){const t=this.scale;t!==n&&(this.scale=n,this.isEventsEnabled()&&this.viewStateChanged()),this.fireEvent(new EventObject(InternalEvent.SCALE,{scale:n,previousScale:t}))}getTranslate(){return this.translate}isRendering(){return this.rendering}setRendering(n){this.rendering=n}setTranslate(n,t){const e=new Point(this.translate.x,this.translate.y);(this.translate.x!==n||this.translate.y!==t)&&(this.translate.x=n,this.translate.y=t,this.isEventsEnabled()&&this.viewStateChanged()),this.fireEvent(new EventObject(InternalEvent.TRANSLATE,{translate:this.translate,previousTranslate:e}))}isAllowEval(){return this.allowEval}setAllowEval(n){this.allowEval=n}getStates(){return this.states}setStates(n){this.states=n}getCanvas(){return this.canvas}getBackgroundPane(){return this.backgroundPane}getDrawPane(){return this.drawPane}getOverlayPane(){return this.overlayPane}getDecoratorPane(){return this.decoratorPane}getBounds(n){let t=null;if(n.length>0){for(let e=0;e<n.length;e+=1)if(n[e].isVertex()||n[e].isEdge()){const i=this.getState(n[e]);i&&(t?t.add(i):t=Rectangle.fromRectangle(i))}}return t}setCurrentRoot(n){if(this.currentRoot!==n){const t=new CurrentRootChange(this,n);t.execute();const e=new UndoableEdit(this,!0);e.add(t),this.fireEvent(new EventObject(InternalEvent.UNDO,{edit:e})),this.graph.sizeDidChange(),this.currentRoot=n}return n}scaleAndTranslate(n,t,e){const i=this.scale,s=new Point(this.translate.x,this.translate.y);(this.scale!==n||this.translate.x!==t||this.translate.y!==e)&&(this.scale=n,this.translate.x=t,this.translate.y=e,this.isEventsEnabled()&&this.viewStateChanged()),this.fireEvent(new EventObject(InternalEvent.SCALE_AND_TRANSLATE,{scale:n,previousScale:i,translate:this.translate,previousTranslate:s}))}viewStateChanged(){this.revalidate(),this.graph.sizeDidChange()}refresh(){this.currentRoot&&this.clear(),this.revalidate()}revalidate(){this.invalidate(),this.validate()}clear(n,t=!1,e=!0){if(n||(n=this.graph.getDataModel().getRoot()),n)if(this.removeState(n),e&&(t||n!==this.currentRoot)){const i=n.getChildCount();for(let s=0;s<i;s+=1)this.clear(n.getChildAt(s),t)}else this.invalidate(n)}invalidate(n=null,t=!0,e=!0){const i=this.graph.getDataModel();if(n=n??i.getRoot(),n){const s=this.getState(n);if(s&&(s.invalid=!0),!n.invalidating){if(n.invalidating=!0,t){const l=n.getChildCount();for(let r=0;r<l;r+=1){const o=n.getChildAt(r);this.invalidate(o,t,e)}}if(e){const l=n.getEdgeCount();for(let r=0;r<l;r+=1)this.invalidate(n.getEdgeAt(r),t,e)}n.invalidating=!1}}}validate(n=null){const t=GlobalConfig.logger.enter("GraphView.validate");this.resetValidationState();const e=n||(this.currentRoot??this.graph.getDataModel().getRoot());if(e){const i=this.getBoundingBox(this.validateCellState(e?this.validateCell(e):null));this.setGraphBounds(i??this.getEmptyBounds()),this.validateBackground(),this.resetValidationState()}GlobalConfig.logger.leave("GraphView.validate",t)}getEmptyBounds(){return new Rectangle(this.translate.x*this.scale,this.translate.y*this.scale)}getBoundingBox(n=null,t=!0){let e=null;if(n&&(n.shape&&n.shape.boundingBox&&(e=n.shape.boundingBox.clone()),n.text&&n.text.boundingBox&&(e?e.add(n.text.boundingBox):e=n.text.boundingBox.clone()),t)){const i=n.cell.getChildCount();for(let s=0;s<i;s+=1){const l=this.getBoundingBox(this.getState(n.cell.getChildAt(s)));l&&(e?e.add(l):e=l)}}return e}createBackgroundPageShape(n){return new RectangleShape(n,"white","black")}validateBackground(){this.validateBackgroundImage(),this.validateBackgroundPage()}validateBackgroundImage(){const n=this.graph.getBackgroundImage();if(n){if(!this.backgroundImage||this.backgroundImage.imageSrc!==n.src){this.backgroundImage&&this.backgroundImage.destroy();const t=new Rectangle(0,0,1,1);this.backgroundImage=new ImageShape(t,n.src),this.backgroundImage.dialect=this.graph.dialect,this.backgroundImage.init(this.backgroundPane),this.backgroundImage.redraw()}this.redrawBackgroundImage(this.backgroundImage,n)}else this.backgroundImage&&(this.backgroundImage.destroy(),this.backgroundImage=null)}validateBackgroundPage(){const n=this.graph;if(n.pageVisible){const t=this.getBackgroundPageBounds();this.backgroundPageShape==null?(this.backgroundPageShape=this.createBackgroundPageShape(t),this.backgroundPageShape.scale=this.scale,this.backgroundPageShape.isShadow=!0,this.backgroundPageShape.dialect=this.graph.dialect,this.backgroundPageShape.init(this.backgroundPane),this.backgroundPageShape.redraw(),this.backgroundPageShape.node&&(n.isNativeDblClickEnabled()&&InternalEvent.addListener(this.backgroundPageShape.node,"dblclick",e=>{n.dblClick(e)}),InternalEvent.addGestureListeners(this.backgroundPageShape.node,e=>{n.fireMouseEvent(InternalEvent.MOUSE_DOWN,new InternalMouseEvent(e))},e=>{const i=n.getPlugin("TooltipHandler");i&&i.isHideOnHover()&&i.hide(),n.isMouseDown&&!isConsumed(e)&&n.fireMouseEvent(InternalEvent.MOUSE_MOVE,new InternalMouseEvent(e))},e=>{n.fireMouseEvent(InternalEvent.MOUSE_UP,new InternalMouseEvent(e))}))):(this.backgroundPageShape.scale=this.scale,this.backgroundPageShape.bounds=t,this.backgroundPageShape.redraw())}else this.backgroundPageShape&&(this.backgroundPageShape.destroy(),this.backgroundPageShape=null)}getBackgroundPageBounds(){const n=this.graph.pageFormat,t=this.scale*this.graph.pageScale;return new Rectangle(this.scale*this.translate.x,this.scale*this.translate.y,n.width*t,n.height*t)}redrawBackgroundImage(n,t){if(n.scale=this.scale,n.bounds){const e=n.bounds;e.x=this.scale*this.translate.x,e.y=this.scale*this.translate.y,e.width=this.scale*t.width,e.height=this.scale*t.height}n.redraw()}validateCell(n,t=!0){if(t=t&&n.isVisible(),this.getState(n,t)&&!t)this.removeState(n);else{const i=n.getChildCount();for(let s=0;s<i;s+=1)this.validateCell(n.getChildAt(s),t&&(!n.isCollapsed()||n===this.currentRoot))}return n}validateCellState(n,t=!0){let e=null;if(n&&(e=this.getState(n),e&&(e.invalid&&(e.invalid=!1,(!e.style||e.invalidStyle)&&(e.style=this.graph.getCellStyle(e.cell),e.invalidStyle=!1),n!==this.currentRoot&&this.validateCellState(n.getParent(),!1),e.setVisibleTerminalState(this.validateCellState(this.getVisibleTerminal(n,!0),!1),!0),e.setVisibleTerminalState(this.validateCellState(this.getVisibleTerminal(n,!1),!1),!1),this.updateCellState(e),n!==this.currentRoot&&!e.invalid&&(this.graph.cellRenderer.redraw(e,!1,this.isRendering()),e.updateCachedBounds())),t&&!e.invalid))){e.shape&&this.stateValidated(e);const i=n.getChildCount();for(let s=0;s<i;s+=1)this.validateCellState(n.getChildAt(s))}return e}updateCellState(n){const t=n.absoluteOffset,e=n.origin;if(t.x=0,t.y=0,e.x=0,e.y=0,n.length=0,n.cell!==this.currentRoot){const i=n.cell.getParent(),s=i?this.getState(i):null;s&&s.cell!==this.currentRoot&&(e.x+=s.origin.x,e.y+=s.origin.y);let l=this.graph.getChildOffsetForCell(n.cell);l&&(e.x+=l.x,e.y+=l.y);const r=n.cell.getGeometry();if(r){if(!n.cell.isEdge())if(l=r.offset?r.offset:this.EMPTY_POINT,r.relative&&s)if(s.cell.isEdge()){const o=this.getPoint(s,r);o&&(e.x+=o.x/this.scale-s.origin.x-this.translate.x,e.y+=o.y/this.scale-s.origin.y-this.translate.y)}else e.x+=r.x*s.unscaledWidth+l.x,e.y+=r.y*s.unscaledHeight+l.y;else t.x=this.scale*l.x,t.y=this.scale*l.y,e.x+=r.x,e.y+=r.y;n.x=this.scale*(this.translate.x+e.x),n.y=this.scale*(this.translate.y+e.y),n.width=this.scale*r.width,n.unscaledWidth=r.width,n.height=this.scale*r.height,n.unscaledHeight=r.height,n.cell.isVertex()&&this.updateVertexState(n,r),n.cell.isEdge()&&this.updateEdgeState(n,r)}}n.updateCachedBounds()}updateVertexState(n,t){const e=n.cell.getParent(),i=e?this.getState(e):null;if(t.relative&&i&&!i.cell.isEdge()){const s=toRadians(i.style.rotation??0);if(s!==0){const l=Math.cos(s),r=Math.sin(s),o=new Point(n.getCenterX(),n.getCenterY()),h=new Point(i.getCenterX(),i.getCenterY()),a=getRotatedPoint(o,l,r,h);n.x=a.x-n.width/2,n.y=a.y-n.height/2}}this.updateVertexLabelOffset(n)}updateEdgeState(n,t){const e=n.getVisibleTerminalState(!0),i=n.getVisibleTerminalState(!1);if(n.cell.getTerminal(!0)&&!e||!e&&!t.getTerminalPoint(!0)||n.cell.getTerminal(!1)&&!i||!i&&!t.getTerminalPoint(!1))this.clear(n.cell,!0);else{this.updateFixedTerminalPoints(n,e,i),this.updatePoints(n,t.points,e,i),this.updateFloatingTerminalPoints(n,e,i);const s=n.absolutePoints;n.cell!==this.currentRoot&&(s==null||s.length<2||s[0]==null||s[s.length-1]==null)?this.clear(n.cell,!0):(this.updateEdgeBounds(n),this.updateEdgeLabelOffset(n))}}updateVertexLabelOffset(n){const t=n.style.labelPosition??ALIGN.CENTER;if(t===ALIGN.LEFT){let i=n.style.labelWidth??null;i!=null?i*=this.scale:i=n.width,n.absoluteOffset.x-=i}else if(t===ALIGN.RIGHT)n.absoluteOffset.x+=n.width;else if(t===ALIGN.CENTER){const i=n.style.labelWidth??null;if(i!=null){const s=n.style.align??ALIGN.CENTER;let l=0;s===ALIGN.CENTER?l=.5:s===ALIGN.RIGHT&&(l=1),l!==0&&(n.absoluteOffset.x-=(i*this.scale-n.width)*l)}}const e=n.style.verticalLabelPosition??ALIGN.MIDDLE;e===ALIGN.TOP?n.absoluteOffset.y-=n.height:e===ALIGN.BOTTOM&&(n.absoluteOffset.y+=n.height)}resetValidationState(){this.lastNode=null,this.lastHtmlNode=null,this.lastForegroundNode=null,this.lastForegroundHtmlNode=null}stateValidated(n){const t=this.graph,e=n.cell.isEdge()&&t.keepEdgesInForeground||n.cell.isVertex()&&t.keepEdgesInBackground,i=e?this.lastForegroundHtmlNode||this.lastHtmlNode:this.lastHtmlNode,s=e?this.lastForegroundNode||this.lastNode:this.lastNode,l=t.cellRenderer.insertStateAfter(n,s,i);e?(this.lastForegroundHtmlNode=l[1],this.lastForegroundNode=l[0]):(this.lastHtmlNode=l[1],this.lastNode=l[0])}updateFixedTerminalPoints(n,t,e){this.updateFixedTerminalPoint(n,t,!0,this.graph.getConnectionConstraint(n,t,!0)),this.updateFixedTerminalPoint(n,e,!1,this.graph.getConnectionConstraint(n,e,!1))}updateFixedTerminalPoint(n,t,e,i){n.setAbsoluteTerminalPoint(this.getFixedTerminalPoint(n,t,e,i),e)}getFixedTerminalPoint(n,t,e,i){let s=null;if(i&&t&&(s=this.graph.getConnectionPoint(t,i,!1)),!s&&!t){const l=this.scale,r=this.translate,o=n.origin;s=n.cell.getGeometry().getTerminalPoint(e),s&&(s=new Point(l*(r.x+s.x+o.x),l*(r.y+s.y+o.y)))}return s}updateBoundsFromStencil(n){let t=null;if(n&&n.shape&&n.shape.stencil&&n.shape.stencil.aspect==="fixed"){t=Rectangle.fromRectangle(n);const e=n.shape.stencil.computeAspect(null,n.x,n.y,n.width,n.height);n.setRect(e.x,e.y,n.shape.stencil.w0*e.width,n.shape.stencil.h0*e.height)}return t}updatePoints(n,t,e,i){const s=[];s.push(n.absolutePoints[0]);const l=this.getEdgeStyle(n,t,e,i);if(l&&e){const o=this.getTerminalPort(n,e,!0),h=i?this.getTerminalPort(n,i,!1):null,a=this.updateBoundsFromStencil(o),d=this.updateBoundsFromStencil(h);l(n,o,h,t,s),o&&a&&o.setRect(a.x,a.y,a.width,a.height),h&&d&&h.setRect(d.x,d.y,d.width,d.height)}else if(t){for(let o=0;o<t.length;o+=1)if(t[o]){const h=clone(t[o]);s.push(this.transformControlPoint(n,h))}}const r=n.absolutePoints;s.push(r[r.length-1]),n.absolutePoints=s}transformControlPoint(n,t,e=!1){if(n&&t){const i=n.origin,s=e?1:this.scale;return new Point(s*(t.x+this.translate.x+i.x),s*(t.y+this.translate.y+i.y))}return null}isLoopStyleEnabled(n,t=[],e=null,i=null){const s=this.graph.getConnectionConstraint(n,e,!0),l=this.graph.getConnectionConstraint(n,i,!1);return(t==null||t.length<2)&&!((n.style.orthogonalLoop??!1)||(s==null||s.point==null)&&(l==null||l.point==null))?e!=null&&e===i:!1}getEdgeStyle(edge,points=[],source=null,target=null){let edgeStyle=this.isLoopStyleEnabled(edge,points,source,target)?edge.style.loopStyle??this.graph.defaultLoopStyle:edge.style.noEdgeStyle??!1?null:edge.style.edgeStyle;if(typeof edgeStyle=="string"){let tmp=StyleRegistry.getValue(edgeStyle);!tmp&&this.isAllowEval()&&(tmp=eval(edgeStyle)),edgeStyle=tmp}return typeof edgeStyle=="function"?edgeStyle:null}updateFloatingTerminalPoints(n,t,e){const i=n.absolutePoints,s=i[0];!i[i.length-1]&&e&&this.updateFloatingTerminalPoint(n,e,t,!1),!s&&t&&this.updateFloatingTerminalPoint(n,t,e,!0)}updateFloatingTerminalPoint(n,t,e,i){n.setAbsoluteTerminalPoint(this.getFloatingTerminalPoint(n,t,e,i),i)}getFloatingTerminalPoint(n,t,e,i){t=this.getTerminalPort(n,t,i);let s=this.getNextPoint(n,e,i);const l=this.graph.isOrthogonal(n),r=toRadians(t.style.rotation??0),o=new Point(t.getCenterX(),t.getCenterY());if(r!==0){const d=Math.cos(-r),c=Math.sin(-r);s=getRotatedPoint(s,d,c,o)}let h=n.style.perimeterSpacing??0;h+=n.style[i?"sourcePerimeterSpacing":"targetPerimeterSpacing"]??0;let a=this.getPerimeterPoint(t,s,r===0&&l,h);if(a&&r!==0){const d=Math.cos(r),c=Math.sin(r);a=getRotatedPoint(a,d,c,o)}return a}getTerminalPort(n,t,e=!1){const i=e?"sourcePort":"targetPort",s=n.style[i];if(s){const l=this.graph.getDataModel().getCell(s);if(l){const r=this.getState(l,!1);r&&(t=r)}}return t}getPerimeterPoint(n,t,e,i=0){let s=null;if(n!=null){const l=this.getPerimeterFunction(n);if(l!=null&&t!=null){const r=this.getPerimeterBounds(n,i);if(r.width>0||r.height>0){s=new Point(t.x,t.y);let o=!1,h=!1;n.cell.isVertex()&&(o=!!n.style.flipH,h=!!n.style.flipV,o&&(s.x=2*r.getCenterX()-s.x),h&&(s.y=2*r.getCenterY()-s.y)),s=l(r,n,s,e),s!=null&&(o&&(s.x=2*r.getCenterX()-s.x),h&&(s.y=2*r.getCenterY()-s.y))}}s==null&&(s=this.getPoint(n))}return s}getRoutingCenterX(n){const t=n.style?n.style.routingCenterX??0:0;return n.getCenterX()+t*n.width}getRoutingCenterY(n){const t=n.style?n.style.routingCenterY??0:0;return n.getCenterY()+t*n.height}getPerimeterBounds(n,t=0){return t+=n.style.perimeterSpacing??0,n.getPerimeterBounds(t*this.scale)}getPerimeterFunction(state){let perimeter=state.style.perimeter;if(typeof perimeter=="string"){let tmp=StyleRegistry.getValue(perimeter);tmp==null&&this.isAllowEval()&&(tmp=eval(perimeter)),perimeter=tmp}return typeof perimeter=="function"?perimeter:null}getNextPoint(n,t,e=!1){const i=n.absolutePoints;let s=null;if(i.length>=2){const l=i.length;s=i[e?Math.min(1,l-1):Math.max(0,l-2)]}return!s&&t&&(s=new Point(t.getCenterX(),t.getCenterY())),s}getVisibleTerminal(n,t){const e=this.graph.getDataModel();let i=n.getTerminal(t),s=i;for(;i&&i!==this.currentRoot;)(s&&!s.isVisible()||i.isCollapsed())&&(s=i),i=i.getParent();return s&&(!e.contains(s)||s.getParent()===e.getRoot()||s===this.currentRoot)&&(s=null),s}updateEdgeBounds(n){const t=n.absolutePoints,e=t[0],i=t[t.length-1];if(e&&i&&(e.x!==i.x||e.y!==i.y)){const o=i.x-e.x,h=i.y-e.y;n.terminalDistance=Math.sqrt(o*o+h*h)}else n.terminalDistance=0;let s=0;const l=[];let r=e;if(r){let o=r.x,h=r.y,a=o,d=h;for(let g=1;g<t.length;g+=1){const u=t[g];if(u){const f=r.x-u.x,p=r.y-u.y,E=Math.sqrt(f*f+p*p);l.push(E),s+=E,r=u,o=Math.min(r.x,o),h=Math.min(r.y,h),a=Math.max(r.x,a),d=Math.max(r.y,d)}}n.length=s,n.segments=l;const c=1;n.x=o,n.y=h,n.width=Math.max(c,a-o),n.height=Math.max(c,d-h)}}getPoint(n,t=null){let e=n.getCenterX(),i=n.getCenterY();if(n.segments!=null&&(t==null||t.relative)){const s=t!=null?t.x/2:0,l=n.absolutePoints.length,r=Math.round((s+.5)*n.length);let o=n.segments[0],h=0,a=1;for(;r>=Math.round(h+o)&&a<l-1;)h+=o,o=n.segments[a++];const d=o===0?0:(r-h)/o,c=n.absolutePoints[a-1],g=n.absolutePoints[a];if(c!=null&&g!=null){let u=0,f=0,p=0;if(t!=null){u=t.y;const{offset:v}=t;v!=null&&(f=v.x,p=v.y)}const E=g.x-c.x,C=g.y-c.y,y=o===0?0:C/o,w=o===0?0:E/o;e=c.x+E*d+(y*u+f)*this.scale,i=c.y+C*d-(w*u-p)*this.scale}}else if(t!=null){const{offset:s}=t;s!=null&&(e+=s.x,i+=s.y)}return new Point(e,i)}getRelativePoint(n,t,e){const i=n.cell.getGeometry();if(i){const s=n.absolutePoints,l=s.length;if(i.relative&&l>1){const r=n.length,{segments:o}=n;let h=s[0],a=s[1],d=ptSegDistSq(h.x,h.y,a.x,a.y,t,e),c=0,g=0,u=0;for(let G=2;G<l;G+=1){h=a,a=s[G];const Y=ptSegDistSq(h.x,h.y,a.x,a.y,t,e);u+=o[G-2],Y<=d&&(d=Y,g=G-1,c=u)}const f=o[g];h=s[g],a=s[g+1];const p=h.x,E=h.y,C=a.x,y=a.y;let w=t,v=e;const S=p-C,I=E-y;w-=C,v-=y;let T=0;w=S-w,v=I-v;const A=w*S+v*I;A<=0?T=0:T=A*A/(S*S+I*I);let R=Math.sqrt(T);R>f&&(R=f);let N=Math.sqrt(ptSegDistSq(h.x,h.y,a.x,a.y,t,e));return relativeCcw(h.x,h.y,a.x,a.y,t,e)===-1&&(N=-N),new Point((r/2-c-R)/r*-2,N/this.scale)}}return new Point}updateEdgeLabelOffset(n){const t=n.absolutePoints,e=n.absoluteOffset;if(e.x=n.getCenterX(),e.y=n.getCenterY(),t.length>0&&n.segments){const i=n.cell.getGeometry();if(i)if(i.relative){const s=this.getPoint(n,i);n.absoluteOffset=s}else{const s=t[0],l=t[t.length-1];if(s&&l){const r=l.x-s.x,o=l.y-s.y;let h=0,a=0;const d=i.offset;d&&(h=d.x,a=d.y);const c=s.x+r/2+h*this.scale,g=s.y+o/2+a*this.scale;e.x=c,e.y=g}}}}getState(n,t=!1){let e=this.states.get(n);return t&&(!e||this.updateStyle)&&n.isVisible()&&(e?e.style=this.graph.getCellStyle(n):(e=this.createState(n),this.states.put(n,e))),e}getCellStates(n=null){if(!n)return this.states.getValues();const t=[];for(const e of n){const i=this.getState(e);i&&t.push(i)}return t}removeState(n){const t=this.states.remove(n);return t&&(this.graph.cellRenderer.destroy(t),t.invalid=!0,t.destroy()),t}createState(n){return new CellState(this,n,this.graph.getCellStyle(n))}isContainerEvent(n){const t=getSource(n);return t&&(t===this.graph.container||t.parentNode===this.backgroundPane||t.parentNode&&t.parentNode.parentNode===this.backgroundPane||t===this.canvas.parentNode||t===this.canvas||t===this.backgroundPane||t===this.drawPane||t===this.overlayPane||t===this.decoratorPane)}isScrollEvent(n){const t=this.graph,e=getOffset(t.container),i=n instanceof MouseEvent?[n.clientX,n.clientY]:[n.touches[0].clientX,n.touches[0].clientY],s=new Point(i[0]-e.x,i[1]-e.y),l=t.container,r=l.offsetWidth,o=l.clientWidth;if(r>o&&s.x>o+2&&s.x<=r)return!0;const h=l.offsetHeight,a=l.clientHeight;return h>a&&s.y>a+2&&s.y<=h}init(){this.installListeners(),this.createSvg()}installListeners(){const n=this.graph,{container:t}=n;Client.IS_TOUCH&&(InternalEvent.addListener(t,"gesturestart",s=>{n.fireGestureEvent(s),InternalEvent.consume(s)}),InternalEvent.addListener(t,"gesturechange",s=>{n.fireGestureEvent(s),InternalEvent.consume(s)}),InternalEvent.addListener(t,"gestureend",s=>{n.fireGestureEvent(s),InternalEvent.consume(s)}));let e=null;InternalEvent.addGestureListeners(t,s=>{this.isContainerEvent(s)&&(!Client.IS_GC&&!Client.IS_SF||!this.isScrollEvent(s))&&(n.fireMouseEvent(InternalEvent.MOUSE_DOWN,new InternalMouseEvent(s)),e=s.pointerId)},s=>{this.isContainerEvent(s)&&(e===null||s.pointerId===e)&&n.fireMouseEvent(InternalEvent.MOUSE_MOVE,new InternalMouseEvent(s))},s=>{this.isContainerEvent(s)&&n.fireMouseEvent(InternalEvent.MOUSE_UP,new InternalMouseEvent(s)),e=null}),InternalEvent.addListener(t,"dblclick",s=>{this.isContainerEvent(s)&&n.dblClick(s)});const i=s=>{let l=null;if(Client.IS_TOUCH){const r=getClientX(s),o=getClientY(s),h=convertPoint(t,r,o),a=n.getCellAt(h.x,h.y);a&&(l=n.view.getState(a))}return l};n.addMouseListener({mouseDown:(s,l)=>{const r=n.getPlugin("PopupMenuHandler");r==null||r.hideMenu()},mouseMove:()=>{},mouseUp:()=>{}}),this.moveHandler=s=>{const l=n.getPlugin("TooltipHandler");l&&l.isHideOnHover()&&l.hide(),this.captureDocumentGesture&&n.isMouseDown&&n.container!=null&&!this.isContainerEvent(s)&&n.container.style.display!=="none"&&n.container.style.visibility!=="hidden"&&!isConsumed(s)&&n.fireMouseEvent(InternalEvent.MOUSE_MOVE,new InternalMouseEvent(s,i(s)))},this.endHandler=s=>{this.captureDocumentGesture&&n.isMouseDown&&n.container!=null&&!this.isContainerEvent(s)&&n.container.style.display!=="none"&&n.container.style.visibility!=="hidden"&&n.fireMouseEvent(InternalEvent.MOUSE_UP,new InternalMouseEvent(s))},InternalEvent.addGestureListeners(document,null,this.moveHandler,this.endHandler)}createSvg(){const{container:n}=this.graph,t=this.canvas=document.createElementNS(NS_SVG,"g");this.backgroundPane=document.createElementNS(NS_SVG,"g"),t.appendChild(this.backgroundPane),this.drawPane=document.createElementNS(NS_SVG,"g"),t.appendChild(this.drawPane),this.overlayPane=document.createElementNS(NS_SVG,"g"),t.appendChild(this.overlayPane),this.decoratorPane=document.createElementNS(NS_SVG,"g"),t.appendChild(this.decoratorPane);const e=document.createElementNS(NS_SVG,"svg");e.style.left="0px",e.style.top="0px",e.style.width="100%",e.style.height="100%",e.style.display="block",e.appendChild(this.canvas),n!=null&&(n.appendChild(e),this.updateContainerStyle(n))}createHtml(){const n=this.graph.container;n!=null&&(this.canvas=this.createHtmlPane("100%","100%"),this.canvas.style.overflow="hidden",this.backgroundPane=this.createHtmlPane("1px","1px"),this.drawPane=this.createHtmlPane("1px","1px"),this.overlayPane=this.createHtmlPane("1px","1px"),this.decoratorPane=this.createHtmlPane("1px","1px"),this.canvas.appendChild(this.backgroundPane),this.canvas.appendChild(this.drawPane),this.canvas.appendChild(this.overlayPane),this.canvas.appendChild(this.decoratorPane),n.appendChild(this.canvas),this.updateContainerStyle(n))}updateHtmlCanvasSize(n,t){if(this.graph.container!=null){const e=this.graph.container.offsetWidth,i=this.graph.container.offsetHeight;e<n?this.canvas.style.width=n+"px":this.canvas.style.width="100%",i<t?this.canvas.style.height=t+"px":this.canvas.style.height="100%"}}createHtmlPane(n,t){const e=document.createElement("DIV");return n!=null&&t!=null?(e.style.position="absolute",e.style.left="0px",e.style.top="0px",e.style.width=n,e.style.height=t):e.style.position="relative",e}updateContainerStyle(n){const t=getCurrentStyle(n);t!=null&&t.position=="static"&&(n.style.position="relative"),Client.IS_POINTER&&(n.style.touchAction="none")}destroy(){let n=null;this.canvas&&this.canvas instanceof SVGElement&&(n=this.canvas.ownerSVGElement),n||(n=this.canvas),n&&n.parentNode&&(this.clear(this.currentRoot,!0),InternalEvent.removeGestureListeners(document,null,this.moveHandler,this.endHandler),InternalEvent.release(this.graph.container),n.parentNode.removeChild(n),this.moveHandler=null,this.endHandler=null,this.canvas=null,this.backgroundPane=null,this.drawPane=null,this.overlayPane=null,this.decoratorPane=null)}}class PolylineShape extends Shape{constructor(t,e,i=1){super(),this.points=t,this.stroke=e,this.strokeWidth=i}getRotation(){return 0}getShapeRotation(){return 0}isPaintBoundsInverted(){return!1}paintEdgeShape(t,e){const i=t.pointerEventsValue;t.pointerEventsValue="stroke",!this.style||!this.style.curved?this.paintLine(t,e,this.isRounded):this.paintCurvedLine(t,e),t.pointerEventsValue=i}paintLine(t,e,i){var l;const s=((l=this.style)==null?void 0:l.arcSize)??LINE_ARCSIZE;t.begin(),this.addPoints(t,e,i,s,!1),t.stroke()}paintCurvedLine(t,e){t.begin();const i=e[0],s=e.length;t.moveTo(i.x,i.y);for(let o=1;o<s-2;o+=1){const h=e[o],a=e[o+1],d=(h.x+a.x)/2,c=(h.y+a.y)/2;t.quadTo(h.x,h.y,d,c)}const l=e[s-2],r=e[s-1];t.quadTo(l.x,l.y,r.x,r.y),t.stroke()}}class MarkerShape{static addMarker(t,e){MarkerShape.markers[t]=e}static createMarker(t,e,i,s,l,r,o,h,a,d){const c=MarkerShape.markers[i];return c?c(t,e,i,s,l,r,o,h,a,d):null}}MarkerShape.markers={};function createArrow(n){return(t,e,i,s,l,r,o,h,a,d)=>{const c=l*a*1.118,g=r*a*1.118;l*=o+a,r*=o+a;const u=s.clone();u.x-=c,u.y-=g;const f=i!==ARROW.CLASSIC&&i!==ARROW.CLASSIC_THIN?1:3/4;return s.x+=-l*f-c,s.y+=-r*f-g,()=>{t.begin(),t.moveTo(u.x,u.y),t.lineTo(u.x-l-r/n,u.y-r+l/n),(i===ARROW.CLASSIC||i===ARROW.CLASSIC_THIN)&&t.lineTo(u.x-l*3/4,u.y-r*3/4),t.lineTo(u.x+r/n-l,u.y-r-l/n),t.close(),d?t.fillAndStroke():t.stroke()}}}function createOpenArrow(n){return(t,e,i,s,l,r,o,h,a,d)=>{const c=l*a*1.118,g=r*a*1.118;l*=o+a,r*=o+a;const u=s.clone();return u.x-=c,u.y-=g,s.x+=-c*2,s.y+=-g*2,()=>{t.begin(),t.moveTo(u.x-l-r/n,u.y-r+l/n),t.lineTo(u.x,u.y),t.lineTo(u.x+r/n-l,u.y-r-l/n),t.stroke()}}}const oval=(n,t,e,i,s,l,r,o,h,a)=>{const d=r/2,c=i.clone();return i.x-=s*d,i.y-=l*d,()=>{n.ellipse(c.x-d,c.y-d,r,r),a?n.fillAndStroke():n.stroke()}};function diamond(n,t,e,i,s,l,r,o,h,a){const d=e===ARROW.DIAMOND?.7071:.9862,c=s*h*d,g=l*h*d;s*=r+h,l*=r+h;const u=i.clone();u.x-=c,u.y-=g,i.x+=-s-c,i.y+=-l-g;const f=e===ARROW.DIAMOND?2:3.4;return()=>{n.begin(),n.moveTo(u.x,u.y),n.lineTo(u.x-s/2-l/f,u.y+s/f-l/2),n.lineTo(u.x-s,u.y-l),n.lineTo(u.x-s/2+l/f,u.y-l/2-s/f),n.close(),a?n.fillAndStroke():n.stroke()}}let isDefaultMarkersRegistered=!1;const registerDefaultEdgeMarkers=()=>{isDefaultMarkersRegistered||(MarkerShape.addMarker("classic",createArrow(2)),MarkerShape.addMarker("classicThin",createArrow(3)),MarkerShape.addMarker("block",createArrow(2)),MarkerShape.addMarker("blockThin",createArrow(3)),MarkerShape.addMarker("open",createOpenArrow(2)),MarkerShape.addMarker("openThin",createOpenArrow(3)),MarkerShape.addMarker("oval",oval),MarkerShape.addMarker("diamond",diamond),MarkerShape.addMarker("diamondThin",diamond),isDefaultMarkersRegistered=!0)};class ConnectorShape extends PolylineShape{constructor(t,e,i){super(t,e,i)}updateBoundingBox(){var t;this.useSvgBoundingBox=!!((t=this.style)!=null&&t.curved),super.updateBoundingBox()}paintEdgeShape(t,e){var l,r,o,h;const i=this.createMarker(t,e,!0),s=this.createMarker(t,e,!1);if(super.paintEdgeShape(t,e),t.setShadow(!1),t.setDashed(!1),i){const a=((l=this.style)==null?void 0:l.startStrokeColor)??this.stroke;t.setStrokeColor(a),t.setFillColor(((r=this.style)==null?void 0:r.startFillColor)??a),i()}if(s){const a=((o=this.style)==null?void 0:o.endStrokeColor)??this.stroke;t.setStrokeColor(a),t.setFillColor(((h=this.style)==null?void 0:h.endFillColor)??a),s()}}createMarker(t,e,i){if(!this.style)return null;let s=null;const l=e.length,r=(i?this.style.startArrow:this.style.endArrow)||NONE;let o=i?e[1]:e[l-2];const h=i?e[0]:e[l-1];if(r!==NONE&&o!==null&&h!==null){let a=1;for(;a<l-1&&Math.round(o.x-h.x)===0&&Math.round(o.y-h.y)===0;)o=i?e[1+a]:e[l-2-a],a++;const d=h.x-o.x,c=h.y-o.y,g=Math.max(1,Math.sqrt(d*d+c*c)),u=d/g,f=c/g,p=(i?this.style.startSize:this.style.endSize)??DEFAULT_MARKERSIZE,E=(i?this.style.startFill:this.style.endFill)??!0;s=MarkerShape.createMarker(t,this,r,h,u,f,p,i,this.strokeWidth,E)}return s}augmentBoundingBox(t){if(super.augmentBoundingBox(t),!this.style)return;let e=0;this.style.startArrow!==NONE&&(e=(this.style.startSize??DEFAULT_MARKERSIZE)+1),this.style.endArrow!==NONE&&(e=Math.max(e,this.style.endSize??DEFAULT_MARKERSIZE)+1),t.grow(e*this.scale)}}class TextShape extends Shape{constructor(t,e,i=ALIGN.CENTER,s=ALIGN.MIDDLE,l="black",r=DEFAULT_FONTFAMILY,o=DEFAULT_FONTSIZE,h=DEFAULT_FONTSTYLE,a=2,d=0,c=0,g=0,u=0,f=!0,p=NONE,E=NONE,C=!1,y=!1,w="visible",v=0,S=DEFAULT_TEXT_DIRECTION){super(),this.margin=null,this.unrotatedBoundingBox=null,this.flipH=!1,this.flipV=!1,this.baseSpacingTop=0,this.baseSpacingBottom=0,this.baseSpacingLeft=0,this.baseSpacingRight=0,this.replaceLinefeeds=!0,this.verticalTextRotation=-90,this.ignoreClippedStringSize=!0,this.ignoreStringSize=!1,this.lastValue=null,this.cacheEnabled=!0,this.value=t,this.bounds=e,this.color=l??"black",this.align=i??ALIGN.CENTER,this.valign=s??ALIGN.MIDDLE,this.family=r??DEFAULT_FONTFAMILY,this.size=o??DEFAULT_FONTSIZE,this.fontStyle=h??DEFAULT_FONTSTYLE,this.spacing=a??2,this.spacingTop=this.spacing+(d??0),this.spacingRight=this.spacing+(c??0),this.spacingBottom=this.spacing+(g??0),this.spacingLeft=this.spacing+(u??0),this.horizontal=f??!0,this.background=p,this.border=E,this.wrap=C??!1,this.clipped=y??!1,this.overflow=w??"visible",this.labelPadding=v??0,this.textDirection=S,this.rotation=0,this.updateMargin()}getSvgScreenOffset(){return 0}checkBounds(){return!isNaN(this.scale)&&isFinite(this.scale)&&this.scale>0&&this.bounds&&!isNaN(this.bounds.x)&&!isNaN(this.bounds.y)&&!isNaN(this.bounds.width)&&!isNaN(this.bounds.height)}paint(t,e=!1){const i=this.scale,s=this.bounds.x/i,l=this.bounds.y/i,r=this.bounds.width/i,o=this.bounds.height/i;if(this.updateTransform(t,s,l,r,o),this.configureCanvas(t,s,l,r,o),e)t.updateText(s,l,r,o,this.align,this.valign,this.wrap,this.overflow,this.clipped,this.getTextRotation(),this.node);else{const h=isNode(this.value)||this.dialect===DIALECT.STRICTHTML,a=h?"html":"";let d=this.value;!h&&a==="html"&&(d=htmlEntities(d,!1)),a==="html"&&!isNode(this.value)&&(d=replaceTrailingNewlines(d,"<div><br></div>")),d=!isNode(this.value)&&this.replaceLinefeeds&&a==="html"?d.replace(/\n/g,"<br/>"):d;let c=this.textDirection;c===TEXT_DIRECTION.AUTO&&!h&&(c=this.getAutoDirection()),c!==TEXT_DIRECTION.LTR&&c!==TEXT_DIRECTION.RTL&&(c=TEXT_DIRECTION.DEFAULT),t.text(s,l,r,o,d,this.align,this.valign,this.wrap,a,this.overflow,this.clipped,this.getTextRotation(),c)}}redraw(){if(this.visible&&this.checkBounds()&&this.cacheEnabled&&this.lastValue===this.value&&(isNode(this.value)||this.dialect===DIALECT.STRICTHTML))if(this.node.nodeName==="DIV")this.redrawHtmlShape(),this.updateBoundingBox();else{const t=this.createCanvas();t&&(t.pointerEvents=this.pointerEvents,this.paint(t,!0),this.destroyCanvas(t),this.updateBoundingBox())}else super.redraw(),isNode(this.value)||this.dialect===DIALECT.STRICTHTML?this.lastValue=this.value:this.lastValue=null}resetStyles(){super.resetStyles(),this.color="black",this.align=ALIGN.CENTER,this.valign=ALIGN.MIDDLE,this.family=DEFAULT_FONTFAMILY,this.size=DEFAULT_FONTSIZE,this.fontStyle=DEFAULT_FONTSTYLE,this.spacing=2,this.spacingTop=2,this.spacingRight=2,this.spacingBottom=2,this.spacingLeft=2,this.horizontal=!0,this.background=NONE,this.border=NONE,this.textDirection=DEFAULT_TEXT_DIRECTION,this.margin=null}apply(t){const e=this.spacing;super.apply(t),this.style&&(this.fontStyle=this.style.fontStyle??this.fontStyle,this.family=this.style.fontFamily??this.family,this.size=this.style.fontSize??this.size,this.color=this.style.fontColor??this.color,this.align=this.style.align??this.align,this.valign=this.style.verticalAlign??this.valign,this.spacing=this.style.spacing??this.spacing,this.spacingTop=(this.style.spacingTop??this.spacingTop-e)+this.spacing,this.spacingRight=(this.style.spacingRight??this.spacingRight-e)+this.spacing,this.spacingBottom=(this.style.spacingBottom??this.spacingBottom-e)+this.spacing,this.spacingLeft=(this.style.spacingLeft??this.spacingLeft-e)+this.spacing,this.horizontal=this.style.horizontal??this.horizontal,this.background=this.style.labelBackgroundColor??this.background,this.border=this.style.labelBorderColor??this.border,this.textDirection=this.style.textDirection??DEFAULT_TEXT_DIRECTION,this.opacity=this.style.textOpacity??100,this.updateMargin()),this.flipV=!1,this.flipH=!1}getAutoDirection(){const t=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(String(this.value));return t&&t.length>0&&t[0]>"z"?TEXT_DIRECTION.RTL:TEXT_DIRECTION.LTR}getContentNode(){let t=this.node;return t&&(t.ownerSVGElement?t=t.firstChild.firstChild.firstChild.firstChild.firstChild:t=this.node.firstChild.firstChild),t}updateBoundingBox(){var l,r,o;let{node:t}=this;this.boundingBox=this.bounds.clone();const e=this.getTextRotation(),i=((l=this.style)==null?void 0:l.labelPosition)??ALIGN.CENTER,s=((r=this.style)==null?void 0:r.verticalLabelPosition)??ALIGN.MIDDLE;if(!this.ignoreStringSize&&t&&this.overflow!=="fill"&&(!this.clipped||!this.ignoreClippedStringSize||i!==ALIGN.CENTER||s!==ALIGN.MIDDLE)){let h=null,a=null;if(t.firstChild&&t.firstChild.firstChild&&t.firstChild.firstChild.nodeName==="foreignObject")t=t.firstChild.firstChild.firstChild.firstChild,a=t.offsetHeight*this.scale,this.overflow==="width"?h=this.boundingBox.width:h=t.offsetWidth*this.scale;else try{const d=t.getBBox();typeof this.value=="string"&&((o=trim(this.value))==null?void 0:o.length)===0?this.boundingBox=null:d.width===0&&d.height===0?this.boundingBox=null:this.boundingBox=new Rectangle(d.x,d.y,d.width,d.height);return}catch{}h&&a&&(this.boundingBox=new Rectangle(this.bounds.x,this.bounds.y,h,a))}if(this.boundingBox){const h=this.margin;if(e!==0){const a=getBoundingBox(new Rectangle(h.x*this.boundingBox.width,h.y*this.boundingBox.height,this.boundingBox.width,this.boundingBox.height),e,new Point(0,0));this.unrotatedBoundingBox=Rectangle.fromRectangle(this.boundingBox),this.unrotatedBoundingBox.x+=h.x*this.unrotatedBoundingBox.width,this.unrotatedBoundingBox.y+=h.y*this.unrotatedBoundingBox.height,this.boundingBox.x+=a.x,this.boundingBox.y+=a.y,this.boundingBox.width=a.width,this.boundingBox.height=a.height}else this.boundingBox.x+=h.x*this.boundingBox.width,this.boundingBox.y+=h.y*this.boundingBox.height,this.unrotatedBoundingBox=null}}getShapeRotation(){return 0}getTextRotation(){return this.state&&this.state.shape?this.state.shape.getTextRotation():0}isPaintBoundsInverted(){return!this.horizontal&&!!this.state&&this.state.cell.isVertex()}configureCanvas(t,e,i,s,l){super.configureCanvas(t,e,i,s,l),t.setFontColor(this.color),t.setFontBackgroundColor(this.background),t.setFontBorderColor(this.border),t.setFontFamily(this.family),t.setFontSize(this.size),t.setFontStyle(this.fontStyle)}getHtmlValue(){let t=this.value;return this.dialect!==DIALECT.STRICTHTML&&(t=htmlEntities(t,!1)),t=replaceTrailingNewlines(t,"<div><br></div>"),t=this.replaceLinefeeds?t.replace(/\n/g,"<br/>"):t,t}getTextCss(){const t=LINE_HEIGHT;let e=`display: inline-block; font-size: ${this.size}px; font-family: ${this.family}; color: ${this.color}; line-height: ${t}; pointer-events: ${this.pointerEvents?"all":"none"}; `;matchBinaryMask(this.fontStyle,FONT.BOLD)&&(e+="font-weight: bold; "),matchBinaryMask(this.fontStyle,FONT.ITALIC)&&(e+="font-style: italic; ");const i=[];return matchBinaryMask(this.fontStyle,FONT.UNDERLINE)&&i.push("underline"),matchBinaryMask(this.fontStyle,FONT.STRIKETHROUGH)&&i.push("line-through"),i.length>0&&(e+=`text-decoration: ${i.join(" ")}; `),e}redrawHtmlShape(){const t=Math.max(0,Math.round(this.bounds.width/this.scale)),e=Math.max(0,Math.round(this.bounds.height/this.scale)),i=`position: absolute; left: ${Math.round(this.bounds.x)}px; top: ${Math.round(this.bounds.y)}px; pointer-events: none; `,s=this.getTextCss(),l=this.margin,r=this.node;SvgCanvas2D.createCss(t+2,e,this.align,this.valign,this.wrap,this.overflow,this.clipped,this.background!==NONE?htmlEntities(this.background,!0):null,this.border!==NONE?htmlEntities(this.border,!0):null,i,s,this.scale,(o,h,a,d,c,g)=>{const u=this.getTextRotation();let f=(this.scale!==1?`scale(${this.scale}) `:"")+(u!==0?`rotate(${u}deg) `:"")+(l.x!==0||l.y!==0?`translate(${l.x*100}%,${l.y*100}%)`:"");f!==""&&(f=`transform-origin: 0 0; transform: ${f}; `),g===""?(a+=d,d=`display:inline-block; min-width: 100%; ${f}`):(d+=f,Client.IS_SF&&(d+="-webkit-clip-path: content-box;")),this.opacity<100&&(c+=`opacity: ${this.opacity/100}; `),r.setAttribute("style",a);const p=isNode(this.value)?this.value.outerHTML:this.getHtmlValue();r.firstChild||(r.innerHTML=`<div><div>${p}</div></div>`),r.firstChild.firstChild.setAttribute("style",c),r.firstChild.setAttribute("style",d)})}updateInnerHtml(t){if(isNode(this.value))t.innerHTML=this.value.outerHTML;else{let e=this.value;this.dialect!==DIALECT.STRICTHTML&&(e=htmlEntities(e,!1)),e=replaceTrailingNewlines(e,"<div>&nbsp;</div>"),e=this.replaceLinefeeds?e.replace(/\n/g,"<br/>"):e,e=`<div style="display:inline-block;_display:inline;">${e}</div>`,t.innerHTML=e}}updateValue(){const t=this.node;if(isNode(this.value))t.innerHTML="",t.appendChild(this.value);else{let e=this.value;this.dialect!==DIALECT.STRICTHTML&&(e=htmlEntities(e,!1)),e=replaceTrailingNewlines(e,"<div><br></div>"),e=this.replaceLinefeeds?e.replace(/\n/g,"<br/>"):e;const i=this.background!==NONE?this.background:null,s=this.border!==NONE?this.border:null;if(this.overflow==="fill"||this.overflow==="width")i&&(t.style.backgroundColor=i),s&&(t.style.border=`1px solid ${s}`);else{let r="";i&&(r+=`background-color:${htmlEntities(i,!0)};`),s&&(r+=`border:1px solid ${htmlEntities(s,!0)};`),e=`<div style="zoom:1;${r}display:inline-block;_display:inline;text-decoration:inherit;padding-bottom:1px;padding-right:1px;line-height:${LINE_HEIGHT}">${e}</div>`}t.innerHTML=e;const l=t.getElementsByTagName("div");if(l.length>0){let r=this.textDirection;r===TEXT_DIRECTION.AUTO&&this.dialect!==DIALECT.STRICTHTML&&(r=this.getAutoDirection()),r===TEXT_DIRECTION.LTR||r===TEXT_DIRECTION.RTL?l[l.length-1].setAttribute("dir",r):l[l.length-1].removeAttribute("dir")}}}updateFont(t){const{style:e}=t;e.lineHeight=LINE_HEIGHT,e.fontSize=`${this.size}px`,e.fontFamily=this.family,e.verticalAlign="top",e.color=this.color,matchBinaryMask(this.fontStyle,FONT.BOLD)?e.fontWeight="bold":e.fontWeight="",matchBinaryMask(this.fontStyle,FONT.ITALIC)?e.fontStyle="italic":e.fontStyle="";const i=[];matchBinaryMask(this.fontStyle,FONT.UNDERLINE)&&i.push("underline"),matchBinaryMask(this.fontStyle,FONT.STRIKETHROUGH)&&i.push("line-through"),i.length>0&&(e.textDecoration=i.join(" ")),this.align===ALIGN.CENTER?e.textAlign="center":this.align===ALIGN.RIGHT?e.textAlign="right":e.textAlign="left"}updateSize(t,e=!1){const i=Math.max(0,Math.round(this.bounds.width/this.scale)),s=Math.max(0,Math.round(this.bounds.height/this.scale)),{style:l}=t;if(this.clipped?(l.overflow="hidden",l.maxHeight=`${s}px`,l.maxWidth=`${i}px`):this.overflow==="fill"?(l.width=`${i+1}px`,l.height=`${s+1}px`,l.overflow="hidden"):this.overflow==="width"&&(l.width=`${i+1}px`,l.maxHeight=`${s+1}px`,l.overflow="hidden"),this.wrap&&i>0){if(l.wordWrap=WORD_WRAP,l.whiteSpace="normal",l.width=`${i}px`,e&&this.overflow!=="fill"&&this.overflow!=="width"){let r=t;r.firstChild!=null&&r.firstChild.nodeName==="DIV"&&(r=r.firstChild,t.style.wordWrap==="break-word"&&(r.style.width="100%"));let o=r.offsetWidth;if(o===0){const h=t.parentNode;t.style.visibility="hidden",document.body.appendChild(t),o=r.offsetWidth,t.style.visibility="",h.appendChild(t)}o+=3,this.clipped&&(o=Math.min(o,i)),l.width=`${o}px`}}else l.whiteSpace="nowrap"}updateMargin(){this.margin=getAlignmentAsPoint(this.align,this.valign)}getSpacing(){let t=0,e=0;return this.align===ALIGN.CENTER?t=(this.spacingLeft-this.spacingRight)/2:this.align===ALIGN.RIGHT?t=-this.spacingRight-this.baseSpacingRight:t=this.spacingLeft+this.baseSpacingLeft,this.valign===ALIGN.MIDDLE?e=(this.spacingTop-this.spacingBottom)/2:this.valign===ALIGN.BOTTOM?e=-this.spacingBottom-this.baseSpacingBottom:e=this.spacingTop+this.baseSpacingTop,new Point(t,e)}}class StencilShapeRegistry{static addStencil(t,e){StencilShapeRegistry.stencils[t]=e}static getStencil(t){return StencilShapeRegistry.stencils[t]}}StencilShapeRegistry.stencils={};const placeholderStyleValues=["inherit","swimlane","indicated"],placeholderStyleProperties=["fillColor","strokeColor","gradientColor","fontColor"];class CellRenderer{constructor(){this.defaultEdgeShape=ConnectorShape,this.defaultVertexShape=RectangleShape,this.defaultTextShape=TextShape,this.legacyControlPosition=!0,this.legacySpacing=!0,this.antiAlias=!0,this.minSvgStrokeWidth=1,this.forceControlClickHandler=!1}static registerShape(t,e){CellRenderer.defaultShapes[t]=e}initializeShape(t){t.shape&&(t.shape.dialect=t.view.graph.dialect,this.configureShape(t),t.shape.init(t.view.getDrawPane()))}createShape(t){const e=StencilShapeRegistry.getStencil(t.style.shape);if(e)return new Shape(e);const i=this.getShapeConstructor(t);return new i}createIndicatorShape(t){t.shape&&(t.shape.indicatorShape=this.getShape(t.getIndicatorShape()))}getShape(t){return t?CellRenderer.defaultShapes[t]:null}getShapeConstructor(t){let e=this.getShape(t.style.shape||null);return e||(e=t.cell.isEdge()?this.defaultEdgeShape:this.defaultVertexShape),e}configureShape(t){const e=t.shape;e&&(e.apply(t),e.imageSrc=t.getImageSrc()||null,e.indicatorColor=t.getIndicatorColor()||NONE,e.indicatorStrokeColor=t.style.indicatorStrokeColor||NONE,e.indicatorGradientColor=t.getIndicatorGradientColor()||NONE,t.style.indicatorDirection&&(e.indicatorDirection=t.style.indicatorDirection),e.indicatorImageSrc=t.getIndicatorImageSrc()||null,this.postConfigureShape(t))}postConfigureShape(t){t.shape&&(this.resolveColor(t,"indicatorGradientColor","gradientColor"),this.resolveColor(t,"indicatorColor","fillColor"),this.resolveColor(t,"gradient","gradientColor"),this.resolveColor(t,"stroke","strokeColor"),this.resolveColor(t,"fill","fillColor"))}checkPlaceholderStyles(t){for(const e of placeholderStyleProperties)if(placeholderStyleValues.includes(t.style[e]))return!0;return!1}resolveColor(t,e,i){const s=i==="fontColor"?t.text:t.shape;if(s){const l=t.view.graph,r=s[e];let o=null;if(r==="inherit"?o=t.cell.getParent():r==="swimlane"?(s[e]=i==="strokeColor"||i==="fontColor"?"#000000":"#ffffff",t.cell.getTerminal(!1)?o=t.cell.getTerminal(!1):o=t.cell,o=l.getSwimlane(o),i=l.swimlaneIndicatorColorAttribute):r==="indicated"&&t.shape?s[e]=t.shape.indicatorColor:i!=="fillColor"&&r==="fillColor"&&t.shape?s[e]=t.style.fillColor:i!=="strokeColor"&&r==="strokeColor"&&t.shape&&(s[e]=t.style.strokeColor),o){const h=l.getView().getState(o);if(s[e]=null,h){const a=i==="fontColor"?h.text:h.shape;a&&e!=="indicatorColor"?s[e]=a[e]:s[e]=h.style[i]}}}}getLabelValue(t){return t.view.graph.getLabel(t.cell)}createLabel(t,e){const i=t.view.graph;if((t.style.fontSize||0)>0||t.style.fontSize==null){const s=i.isHtmlLabel(t.cell)||isNode(e);t.text=new this.defaultTextShape(e,new Rectangle,t.style.align??ALIGN.CENTER,t.getVerticalAlign(),t.style.fontColor,t.style.fontFamily,t.style.fontSize,t.style.fontStyle,t.style.spacing,t.style.spacingTop,t.style.spacingRight,t.style.spacingBottom,t.style.spacingLeft,t.style.horizontal,t.style.labelBackgroundColor,t.style.labelBorderColor,i.isWrapping(t.cell)&&i.isHtmlLabel(t.cell),i.isLabelClipped(t.cell),t.style.overflow,t.style.labelPadding,t.style.textDirection??DEFAULT_TEXT_DIRECTION),t.text.opacity=t.style.textOpacity??100,t.text.dialect=s?DIALECT.STRICTHTML:i.dialect,t.text.style=t.style,t.text.state=t,this.initializeLabel(t,t.text);let l=!1;const r=o=>{let h=t;if(Client.IS_TOUCH||l){const a=getClientX(o),d=getClientY(o),c=convertPoint(i.container,a,d);h=i.view.getState(i.getCellAt(c.x,c.y))}return h};InternalEvent.addGestureListeners(t.text.node,o=>{if(this.isLabelEvent(t,o)){i.fireMouseEvent(InternalEvent.MOUSE_DOWN,new InternalMouseEvent(o,t));const h=getSource(o);l=i.dialect!==DIALECT.SVG&&h.nodeName==="IMG"}},o=>{this.isLabelEvent(t,o)&&i.fireMouseEvent(InternalEvent.MOUSE_MOVE,new InternalMouseEvent(o,r(o)))},o=>{this.isLabelEvent(t,o)&&(i.fireMouseEvent(InternalEvent.MOUSE_UP,new InternalMouseEvent(o,r(o))),l=!1)}),i.isNativeDblClickEnabled()&&InternalEvent.addListener(t.text.node,"dblclick",o=>{this.isLabelEvent(t,o)&&(i.dblClick(o,t.cell),InternalEvent.consume(o))})}}initializeLabel(t,e){if(Client.IS_SVG&&Client.NO_FO&&e.dialect!==DIALECT.SVG){const i=t.view.graph;e.init(i.container)}else e.init(t.view.getDrawPane())}createCellOverlays(t){const e=t.view.graph,i=e.getCellOverlays(t.cell),s=new Dictionary;for(const l of i){const r=t.overlays.remove(l);if(r){s.put(l,r);continue}const o=this.createOverlayShape(t,l);o.dialect=e.dialect,o.overlay=l,this.initializeOverlay(t,o),this.installCellOverlayListeners(t,l,o),this.configureOverlayShape(t,l,o),s.put(l,o)}t.overlays.visit((l,r)=>{r.destroy()}),t.overlays=s}createOverlayShape(t,e){const i=new ImageShape(new Rectangle,e.image.src);return i.preserveImageAspect=!1,i}initializeOverlay(t,e){e.init(t.view.getOverlayPane())}installCellOverlayListeners(t,e,i){const s=t.view.graph;InternalEvent.addListener(i.node,"click",l=>{s.isEditing()&&s.stopEditing(!s.isInvokesStopCellEditing()),e.fireEvent(new EventObject(InternalEvent.CLICK,{event:l,cell:t.cell}))}),InternalEvent.addGestureListeners(i.node,l=>{InternalEvent.consume(l)},l=>{s.fireMouseEvent(InternalEvent.MOUSE_MOVE,new InternalMouseEvent(l,t))}),Client.IS_TOUCH&&InternalEvent.addListener(i.node,"touchend",l=>{e.fireEvent(new EventObject(InternalEvent.CLICK,{event:l,cell:t.cell}))})}configureOverlayShape(t,e,i){e.cursor&&(i.node.style.cursor=e.cursor)}createControl(t){const e=t.view.graph,i=e.getFoldingImage(t);if(e.isFoldingEnabled()&&i){if(!t.control){const s=new Rectangle(0,0,i.width,i.height);t.control=new ImageShape(s,i.src),t.control.preserveImageAspect=!1,t.control.dialect=e.dialect,this.initControl(t,t.control,!0,this.createControlClickHandler(t))}}else t.control&&(t.control.destroy(),t.control=null)}createControlClickHandler(t){const e=t.view.graph;return i=>{if(this.forceControlClickHandler||e.isEnabled()){const s=!t.cell.isCollapsed();e.foldCells(s,!1,[t.cell],!1,i),InternalEvent.consume(i)}}}initControl(t,e,i,s){const l=t.view.graph;l.isHtmlLabel(t.cell)&&Client.NO_FO&&l.dialect===DIALECT.SVG?(e.dialect=DIALECT.PREFERHTML,e.init(l.container),e.node.style.zIndex=String(1)):e.init(t.view.getOverlayPane());const o=e.node;if(s&&!Client.IS_IOS&&(l.isEnabled()&&(o.style.cursor="pointer"),InternalEvent.addListener(o,"click",s)),i){let h=null;InternalEvent.addGestureListeners(o,a=>{h=new Point(getClientX(a),getClientY(a)),l.fireMouseEvent(InternalEvent.MOUSE_DOWN,new InternalMouseEvent(a,t)),InternalEvent.consume(a)},a=>{l.fireMouseEvent(InternalEvent.MOUSE_MOVE,new InternalMouseEvent(a,t))},a=>{l.fireMouseEvent(InternalEvent.MOUSE_UP,new InternalMouseEvent(a,t)),InternalEvent.consume(a)}),s&&Client.IS_IOS&&o.addEventListener("touchend",a=>{if(h){const d=l.getEventTolerance();Math.abs(h.x-getClientX(a))<d&&Math.abs(h.y-getClientY(a))<d&&(s.call(s,a),InternalEvent.consume(a))}},!0)}return o}isShapeEvent(t,e){return!0}isLabelEvent(t,e){return!0}installListeners(t){const e=t.view.graph,i=s=>{let l=t;const r=getSource(s);if(r&&e.dialect!==DIALECT.SVG&&r.nodeName==="IMG"||Client.IS_TOUCH){const o=getClientX(s),h=getClientY(s),a=convertPoint(e.container,o,h),d=e.getCellAt(a.x,a.y);l=d?e.view.getState(d):null}return l};t.shape&&(InternalEvent.addGestureListeners(t.shape.node,s=>{this.isShapeEvent(t,s)&&e.fireMouseEvent(InternalEvent.MOUSE_DOWN,new InternalMouseEvent(s,t))},s=>{this.isShapeEvent(t,s)&&e.fireMouseEvent(InternalEvent.MOUSE_MOVE,new InternalMouseEvent(s,i(s)))},s=>{this.isShapeEvent(t,s)&&e.fireMouseEvent(InternalEvent.MOUSE_UP,new InternalMouseEvent(s,i(s)))}),e.isNativeDblClickEnabled()&&InternalEvent.addListener(t.shape.node,"dblclick",s=>{this.isShapeEvent(t,s)&&(e.dblClick(s,t.cell),InternalEvent.consume(s))}))}redrawLabel(t,e){const i=t.view.graph,s=this.getLabelValue(t),l=i.isWrapping(t.cell),r=i.isLabelClipped(t.cell),h=i.isHtmlLabel(t.cell)||s&&isNode(s)?DIALECT.STRICTHTML:i.dialect,a=t.style.overflow??"visible";if(t.text&&(t.text.wrap!==l||t.text.clipped!==r||t.text.overflow!==a||t.text.dialect!==h)&&(t.text.destroy(),t.text=null),t.text==null&&s!=null&&(isNode(s)||s.length>0)?this.createLabel(t,s):t.text!=null&&(s==null||s.length==0)&&(t.text.destroy(),t.text=null),t.text!=null){e&&(t.text.lastValue!=null&&this.isTextShapeInvalid(t,t.text)&&(t.text.lastValue=null),t.text.resetStyles(),t.text.apply(t),t.text.valign=t.getVerticalAlign());const d=this.getLabelBounds(t),c=this.getTextScale(t);if(this.resolveColor(t,"color","fontColor"),e||t.text.value!==s||t.text.wrap!==l||t.text.overflow!==a||t.text.clipped!==r||t.text.scale!==c||t.text.dialect!==h||t.text.bounds==null||!t.text.bounds.equals(d)){t.text.dialect=h,t.text.value=s,t.text.bounds=d,t.text.scale=c,t.text.wrap=l,t.text.clipped=r,t.text.overflow=a;const g=t.text.node.style.visibility;this.redrawLabelShape(t.text),t.text.node.style.visibility=g}}}isTextShapeInvalid(t,e){function i(s,l,r){let o=!1;return l==="spacingTop"||l==="spacingRight"||l==="spacingBottom"||l==="spacingLeft"?o=parseFloat(String(e[s]))-parseFloat(String(e.spacing))!==(t.style[l]||r):o=e[s]!==(t.style[l]||r),o}return i("fontStyle","fontStyle",DEFAULT_FONTSTYLE)||i("family","fontFamily",DEFAULT_FONTFAMILY)||i("size","fontSize",DEFAULT_FONTSIZE)||i("color","fontColor","black")||i("align","align","")||i("valign","verticalAlign","")||i("spacing","spacing",2)||i("spacingTop","spacingTop",0)||i("spacingRight","spacingRight",0)||i("spacingBottom","spacingBottom",0)||i("spacingLeft","spacingLeft",0)||i("horizontal","horizontal",!0)||i("background","labelBackgroundColor",null)||i("border","labelBorderColor",null)||i("opacity","textOpacity",100)||i("textDirection","textDirection",DEFAULT_TEXT_DIRECTION)}redrawLabelShape(t){t.redraw()}getTextScale(t){return t.view.scale}getLabelBounds(t){const{scale:e}=t.view,i=t.cell.isEdge();let s=new Rectangle(t.absoluteOffset.x,t.absoluteOffset.y);if(i){const r=t.text.getSpacing();s.x+=r.x*e,s.y+=r.y*e;const o=t.cell.getGeometry();o!=null&&(s.width=Math.max(0,o.width*e),s.height=Math.max(0,o.height*e))}else{if(t.text.isPaintBoundsInverted()){const r=s.x;s.x=s.y,s.y=r}s.x+=t.x,s.y+=t.y,s.width=Math.max(1,t.width),s.height=Math.max(1,t.height)}if(t.text.isPaintBoundsInverted()){const r=(t.width-t.height)/2;s.x+=r,s.y-=r;const o=s.width;s.width=s.height,s.height=o}if(t.shape!=null){const r=t.style.labelPosition??ALIGN.CENTER,o=t.style.verticalLabelPosition??ALIGN.MIDDLE;r===ALIGN.CENTER&&o===ALIGN.MIDDLE&&(s=t.shape.getLabelBounds(s))}const l=t.style.labelWidth??null;return l!=null&&(s.width=l*e),i||this.rotateLabelBounds(t,s),s}rotateLabelBounds(t,e){if(e.y-=t.text.margin.y*e.height,e.x-=t.text.margin.x*e.width,!this.legacySpacing||t.style.overflow!=="fill"&&t.style.overflow!=="width"){const s=t.view.scale,l=t.text.getSpacing();e.x+=l.x*s,e.y+=l.y*s;const r=t.style.labelPosition??ALIGN.CENTER,o=t.style.verticalLabelPosition??ALIGN.MIDDLE,h=t.style.labelWidth??null;e.width=Math.max(0,e.width-(r===ALIGN.CENTER&&h==null?t.text.spacingLeft*s+t.text.spacingRight*s:0)),e.height=Math.max(0,e.height-(o===ALIGN.MIDDLE?t.text.spacingTop*s+t.text.spacingBottom*s:0))}const i=t.text.getTextRotation();if(i!==0&&t!=null&&t.cell.isVertex()){const s=t.getCenterX(),l=t.getCenterY();if(e.x!==s||e.y!==l){const r=i*(Math.PI/180),o=getRotatedPoint(new Point(e.x,e.y),Math.cos(r),Math.sin(r),new Point(s,l));e.x=o.x,e.y=o.y}}}redrawCellOverlays(t,e=!1){if(this.createCellOverlays(t),t.overlays!=null){const i=mod(t.style.rotation??0,90),s=toRadians(i),l=Math.cos(s),r=Math.sin(s);t.overlays.visit((o,h)=>{const a=h.overlay.getBounds(t);if(!t.cell.isEdge()&&t.shape!=null&&i!==0){let d=a.getCenterX(),c=a.getCenterY();const g=getRotatedPoint(new Point(d,c),l,r,new Point(t.getCenterX(),t.getCenterY()));d=g.x,c=g.y,a.x=Math.round(d-a.width/2),a.y=Math.round(c-a.height/2)}(e||h.bounds==null||h.scale!==t.view.scale||!h.bounds.equals(a))&&(h.bounds=a,h.scale=t.view.scale,h.redraw())})}}redrawControl(t,e=!1){const i=t.view.graph.getFoldingImage(t);if(t.control!=null&&i!=null){const s=this.getControlBounds(t,i.width,i.height),l=this.legacyControlPosition?t.style.rotation??0:t.shape.getTextRotation(),r=t.view.scale;(e||t.control.scale!==r||!t.control.bounds.equals(s)||t.control.rotation!==l)&&(t.control.rotation=l,t.control.bounds=s,t.control.scale=r,t.control.redraw())}}getControlBounds(t,e,i){if(t.control!=null){const s=t.view.scale;let l=t.getCenterX(),r=t.getCenterY();if(!t.cell.isEdge()&&(l=t.x+e*s,r=t.y+i*s,t.shape!=null)){let o=t.shape.getShapeRotation();if(this.legacyControlPosition)o=t.style.rotation??0;else if(t.shape.isPaintBoundsInverted()){const h=(t.width-t.height)/2;l+=h,r-=h}if(o!==0){const h=toRadians(o),a=Math.cos(h),d=Math.sin(h),c=getRotatedPoint(new Point(l,r),a,d,new Point(t.getCenterX(),t.getCenterY()));l=c.x,r=c.y}}return t.cell.isEdge()?new Rectangle(Math.round(l-e/2*s),Math.round(r-i/2*s),Math.round(e*s),Math.round(i*s)):new Rectangle(Math.round(l-e/2*s),Math.round(r-i/2*s),Math.round(e*s),Math.round(i*s))}return null}insertStateAfter(t,e,i){const s=t.view.graph,l=this.getShapesForState(t);for(let r=0;r<l.length;r+=1)if(l[r]!=null&&l[r].node!=null){const o=l[r].node.parentNode!==t.view.getDrawPane()&&l[r].node.parentNode!==t.view.getOverlayPane(),h=o?i:e;if(h!=null&&h.nextSibling!==l[r].node)h.nextSibling==null?h.parentNode.appendChild(l[r].node):h.parentNode.insertBefore(l[r].node,h.nextSibling);else if(h==null){const a=l[r].node;if(a.parentNode===s.container){let{canvas:d}=t.view;for(;d!=null&&d.parentNode!==s.container;)d=d.parentNode;d!=null&&d.nextSibling!=null?d.nextSibling!==a&&a.parentNode.insertBefore(a,d.nextSibling):a.parentNode.appendChild(a)}else a.parentNode!=null&&a.parentNode.firstChild!=null&&a.parentNode.firstChild!=a&&a.parentNode.insertBefore(a,a.parentNode.firstChild)}o?i=l[r].node:e=l[r].node}return[e,i]}getShapesForState(t){return[t.shape,t.text,t.control]}redraw(t,e=!1,i=!0){const s=this.redrawShape(t,e,i);t.shape!=null&&i&&(this.redrawLabel(t,s),this.redrawCellOverlays(t,s),this.redrawControl(t,s))}redrawShape(t,e=!1,i=!0){let s=!1;const l=t.view.graph;if(t.shape!=null&&t.shape.style!=null&&t.style!=null&&t.shape.style.shape!==t.style.shape&&(t.shape.destroy(),t.shape=null),t.shape==null&&l.container!=null&&t.cell!==t.view.currentRoot&&(t.cell.isVertex()||t.cell.isEdge())){if(t.shape=this.createShape(t),t.shape!=null){t.shape.minSvgStrokeWidth=this.minSvgStrokeWidth,t.shape.antiAlias=this.antiAlias,this.createIndicatorShape(t),this.initializeShape(t),this.createCellOverlays(t),this.installListeners(t);const r=l.getPlugin("SelectionCellsHandler");r==null||r.updateHandler(t)}}else if(!e&&t.shape!=null&&(!equalEntries(t.shape.style,t.style)||this.checkPlaceholderStyles(t))){t.shape.resetStyles(),this.configureShape(t);const r=l.getPlugin("SelectionCellsHandler");r==null||r.updateHandler(t),e=!0}return t.shape!=null&&t.shape.indicatorShape!=this.getShape(t.getIndicatorShape())&&(t.shape.indicator!=null&&(t.shape.indicator.destroy(),t.shape.indicator=null),this.createIndicatorShape(t),t.shape.indicatorShape!=null&&(t.shape.indicator=new t.shape.indicatorShape,t.shape.indicator.dialect=t.shape.dialect,t.shape.indicator.init(t.node),e=!0)),t.shape&&(this.createControl(t),(e||this.isShapeInvalid(t,t.shape))&&(t.absolutePoints.length>0?(t.shape.points=t.absolutePoints.slice(),t.shape.bounds=null):(t.shape.points=[],t.shape.bounds=new Rectangle(t.x,t.y,t.width,t.height)),t.shape.scale=t.view.scale,i==null||i?this.doRedrawShape(t):t.shape.updateBoundingBox(),s=!0)),s}doRedrawShape(t){var e;(e=t.shape)==null||e.redraw()}isShapeInvalid(t,e){return e.bounds==null||e.scale!==t.view.scale||t.absolutePoints.length===0&&!e.bounds.equals(t)||t.absolutePoints.length>0&&!equalPoints(e.points,t.absolutePoints)}destroy(t){t.shape&&(t.text&&(t.text.destroy(),t.text=null),t.overlays.visit((e,i)=>{i.destroy()}),t.overlays=new Dictionary,t.control&&(t.control.destroy(),t.control=null),t.shape.destroy(),t.shape=null)}}CellRenderer.defaultShapes={};class ChildChange{constructor(t,e,i,s=0){this.model=t,this.parent=e,this.previous=e,this.child=i,this.index=s,this.previousIndex=s}execute(){let t=this.child.getParent();const e=t?t.getIndex(this.child):0;this.previous||this.connect(this.child,!1),t=this.model.parentForCellChanged(this.child,this.previous,this.previousIndex),this.previous&&this.connect(this.child,!0),this.parent=this.previous,this.previous=t,this.index=this.previousIndex,this.previousIndex=e}connect(t,e=!0){const i=t.getTerminal(!0),s=t.getTerminal(!1);i&&(e?this.model.terminalForCellChanged(t,i,!0):this.model.terminalForCellChanged(t,null,!0)),s&&(e?this.model.terminalForCellChanged(t,s,!1):this.model.terminalForCellChanged(t,null,!1)),t.setTerminal(i,!0),t.setTerminal(s,!1);const l=t.getChildCount();for(let r=0;r<l;r+=1)this.connect(t.getChildAt(r),e)}}class CollapseChange{constructor(t,e,i){this.model=t,this.cell=e,this.collapsed=i,this.previous=i}execute(){this.collapsed=this.previous,this.previous=this.model.collapsedStateForCellChanged(this.cell,this.previous)}}class GeometryChange{constructor(t,e,i){this.model=t,this.cell=e,this.geometry=i,this.previous=i}execute(){this.geometry=this.previous,this.previous=this.model.geometryForCellChanged(this.cell,this.previous)}}class RootChange{constructor(t,e){this.model=t,this.root=e,this.previous=e}execute(){this.root=this.previous,this.previous=this.model.rootChanged(this.previous)}}class StyleChange{constructor(t,e,i){this.model=t,this.cell=e,this.style=i,this.previous=i}execute(){this.style=this.previous,this.previous=this.model.styleForCellChanged(this.cell,this.previous)}}class TerminalChange{constructor(t,e,i,s){this.model=t,this.cell=e,this.terminal=i,this.previous=i,this.source=s}execute(){this.terminal=this.previous,this.previous=this.model.terminalForCellChanged(this.cell,this.previous,this.source)}}class ValueChange{constructor(t,e,i){this.model=t,this.cell=e,this.value=i,this.previous=i}execute(){this.value=this.previous,this.previous=this.model.valueForCellChanged(this.cell,this.previous)}}class VisibleChange{constructor(t,e,i){this.model=t,this.cell=e,this.visible=i,this.previous=i}execute(){this.visible=this.previous,this.previous=this.model.visibleStateForCellChanged(this.cell,this.previous)}}const filterCells=n=>t=>{const e=[];for(let i=0;i<t.length;i+=1)n(t[i])&&e.push(t[i]);return e},getTopmostCells=n=>{const t=new Dictionary,e=[];for(let i=0;i<n.length;i+=1)t.put(n[i],!0);for(let i=0;i<n.length;i+=1){const s=n[i];let l=!0,r=s.getParent();for(;r!=null;){if(t.get(r)){l=!1;break}r=r.getParent()}l&&e.push(s)}return e},cloneCells=(n,t=!0,e={})=>{const i=[];for(const s of n)i.push(cloneCellImpl(s,e,t));for(let s=0;s<i.length;s+=1)i[s]!=null&&restoreClone(i[s],n[s],e);return i},cloneCellImpl=(n,t={},e=!1)=>{const i=ObjectIdentity.get(n);let s=t?t[i]:null;if(s==null&&(s=n.clone(),t[i]=s,e)){const l=n.getChildCount();for(let r=0;r<l;r+=1){const o=cloneCellImpl(n.getChildAt(r),t,!0);s.insert(o)}}return s},restoreClone=(n,t,e)=>{const i=t.getTerminal(!0);if(i!=null){const r=e[ObjectIdentity.get(i)];r!=null&&r.insertEdge(n,!0)}const s=t.getTerminal(!1);if(s!=null){const r=e[ObjectIdentity.get(s)];r!=null&&r.insertEdge(n,!1)}const l=n.getChildCount();for(let r=0;r<l;r+=1)restoreClone(n.getChildAt(r),t.getChildAt(r),e)};class GraphDataModel extends EventSource{constructor(t=null){super(),this.root=null,this.cells={},this.maintainEdgeParent=!0,this.ignoreRelativeEdgeParent=!0,this.createIds=!0,this.prefix="",this.postfix="",this.nextId=0,this.currentEdit=null,this.updateLevel=0,this.endingUpdate=!1,this.currentEdit=this.createUndoableEdit(),t!=null?this.setRoot(t):this.clear()}clear(){this.setRoot(this.createRoot())}isCreateIds(){return this.createIds}setCreateIds(t){this.createIds=t}createRoot(){const t=new Cell;return t.insert(new Cell),t}getCell(t){return this.cells?this.cells[t]:null}filterCells(t,e){return filterCells(e)(t)}getRoot(t=null){return t?t.getRoot():this.root}setRoot(t){return this.execute(new RootChange(this,t)),t}rootChanged(t){const e=this.root;return this.root=t,this.nextId=0,this.cells=null,this.cellAdded(t),e}isRoot(t=null){return t!=null&&this.root===t}isLayer(t){return t?this.isRoot(t.getParent()):!1}contains(t){return this.root.isAncestor(t)}add(t,e,i=null){if(e!==t&&t!=null&&e!=null){i==null&&(i=t.getChildCount());const s=t!==e.getParent();this.execute(new ChildChange(this,t,e,i)),this.maintainEdgeParent&&s&&this.updateEdgeParents(e)}return e}cellAdded(t){if(t!=null){if(t.getId()==null&&this.createIds&&t.setId(this.createId(t)),t.getId()!=null){let e=this.getCell(t.getId());if(e!==t){for(;e!=null;)t.setId(this.createId(t)),e=this.getCell(t.getId());this.cells==null&&(this.cells={}),this.cells[t.getId()]=t}}isNumeric(String(t.getId()))&&(this.nextId=Math.max(this.nextId,parseInt(t.getId())));for(const e of t.getChildren())this.cellAdded(e)}}createId(t){const e=this.nextId;return this.nextId++,this.prefix+e+this.postfix}updateEdgeParents(t,e=this.getRoot(t)){const i=t.getChildCount();for(let r=0;r<i;r+=1){const o=t.getChildAt(r);this.updateEdgeParents(o,e)}const s=t.getEdgeCount(),l=[];for(let r=0;r<s;r+=1)l.push(t.getEdgeAt(r));for(let r=0;r<l.length;r+=1){const o=l[r];e.isAncestor(o)&&this.updateEdgeParent(o,e)}}updateEdgeParent(t,e){let i=t.getTerminal(!0),s=t.getTerminal(!1),l=null;for(;i!=null&&!i.isEdge()&&i.geometry!=null&&i.geometry.relative;)i=i.getParent();for(;s!=null&&this.ignoreRelativeEdgeParent&&!s.isEdge()&&s.geometry!=null&&s.geometry.relative;)s=s.getParent();if(e.isAncestor(i)&&e.isAncestor(s)&&(i===s?l=i?i.getParent():null:i&&(l=i.getNearestCommonAncestor(s)),l!=null&&(l.getParent()!==this.root||l.isAncestor(t))&&t&&t.getParent()!==l)){let r=t.getGeometry();if(r!=null){const o=t.getParent().getOrigin(),h=l.getOrigin(),a=h.x-o.x,d=h.y-o.y;r=r.clone(),r.translate(-a,-d),this.setGeometry(t,r)}this.add(l,t,l.getChildCount())}}remove(t){return t===this.root?this.setRoot(null):t.getParent()!=null&&this.execute(new ChildChange(this,null,t)),t}cellRemoved(t){if(t!=null&&this.cells!=null){const e=t.getChildCount();for(let i=e-1;i>=0;i--)this.cellRemoved(t.getChildAt(i));this.cells!=null&&t.getId()!=null&&delete this.cells[t.getId()]}}parentForCellChanged(t,e,i){const s=t.getParent();if(e!=null)(e!==s||s.getIndex(t)!==i)&&e.insert(t,i);else if(s!=null){const o=s.getIndex(t);s.remove(o)}const l=e?this.contains(e):null,r=this.contains(s);return l&&!r?this.cellAdded(t):r&&!l&&this.cellRemoved(t),s}setTerminal(t,e,i){const s=e!==t.getTerminal(i);return this.execute(new TerminalChange(this,t,e,i)),this.maintainEdgeParent&&s&&this.updateEdgeParent(t,this.getRoot()),e}setTerminals(t,e,i){this.beginUpdate();try{this.setTerminal(t,e,!0),this.setTerminal(t,i,!1)}finally{this.endUpdate()}}terminalForCellChanged(t,e,i=!1){const s=t.getTerminal(i);return e!=null?e.insertEdge(t,i):s!=null&&s.removeEdge(t,i),s}getEdgesBetween(t,e,i=!1){const s=t.getEdgeCount(),l=e.getEdgeCount();let r=t,o=s;l<s&&(o=l,r=e);const h=[];for(let a=0;a<o;a+=1){const d=r.getEdgeAt(a),c=d.getTerminal(!0),g=d.getTerminal(!1);(c===t&&g===e||!i&&(g===t&&c===e))&&h.push(d)}return h}setValue(t,e){return this.execute(new ValueChange(this,t,e)),e}valueForCellChanged(t,e){return t.valueChanged(e)}setGeometry(t,e){return e!==t.getGeometry()&&this.execute(new GeometryChange(this,t,e)),e}geometryForCellChanged(t,e){const i=t.getGeometry();return t.setGeometry(e),i}setStyle(t,e){e!==t.getStyle()&&this.execute(new StyleChange(this,t,e))}styleForCellChanged(t,e){const i=t.getStyle();return t.setStyle(e),i}setCollapsed(t,e){return e!==t.isCollapsed()&&this.execute(new CollapseChange(this,t,e)),e}collapsedStateForCellChanged(t,e){const i=t.isCollapsed();return t.setCollapsed(e),i}setVisible(t,e){return e!==t.isVisible()&&this.execute(new VisibleChange(this,t,e)),e}visibleStateForCellChanged(t,e){const i=t.isVisible();return t.setVisible(e),i}execute(t){t.execute(),this.beginUpdate(),this.currentEdit.add(t),this.fireEvent(new EventObject(InternalEvent.EXECUTE,{change:t})),this.fireEvent(new EventObject(InternalEvent.EXECUTED,{change:t})),this.endUpdate()}batchUpdate(t){this.beginUpdate();try{t()}finally{this.endUpdate()}}beginUpdate(){this.updateLevel+=1,this.fireEvent(new EventObject(InternalEvent.BEGIN_UPDATE)),this.updateLevel===1&&this.fireEvent(new EventObject(InternalEvent.START_EDIT))}endUpdate(){if(this.updateLevel-=1,this.updateLevel===0&&this.fireEvent(new EventObject(InternalEvent.END_EDIT)),!this.endingUpdate){this.endingUpdate=this.updateLevel===0,this.fireEvent(new EventObject(InternalEvent.END_UPDATE,{edit:this.currentEdit}));try{if(this.endingUpdate&&!this.currentEdit.isEmpty()){this.fireEvent(new EventObject(InternalEvent.BEFORE_UNDO,{edit:this.currentEdit}));const t=this.currentEdit;this.currentEdit=this.createUndoableEdit(),t.notify(),this.fireEvent(new EventObject(InternalEvent.UNDO,{edit:t}))}}finally{this.endingUpdate=!1}}}createUndoableEdit(t=!0){const e=new UndoableEdit(this,t);return e.notify=()=>{e.source.fireEvent(new EventObject(InternalEvent.CHANGE,{edit:e,changes:e.changes})),e.source.fireEvent(new EventObject(InternalEvent.NOTIFY,{edit:e,changes:e.changes}))},e}mergeChildren(t,e,i=!0){this.beginUpdate();try{const s={};this.mergeChildrenImpl(t,e,i,s);for(const l in s){const r=s[l];let o=r.getTerminal(!0);o!=null&&(o=s[CellPath.create(o)],this.setTerminal(r,o,!0)),o=r.getTerminal(!1),o!=null&&(o=s[CellPath.create(o)],this.setTerminal(r,o,!1))}}finally{this.endUpdate()}}mergeChildrenImpl(t,e,i,s={}){this.beginUpdate();try{const l=t.getChildCount();for(let r=0;r<l;r+=1){const o=t.getChildAt(r);if(typeof o.getId=="function"){const h=o.getId();let a=h!=null&&(!o.isEdge()||!i)?this.getCell(h):null;if(a==null){const d=o.clone();d.setId(h),d.setTerminal(o.getTerminal(!0),!0),d.setTerminal(o.getTerminal(!1),!1),a=e.insert(d),this.cellAdded(a)}s[CellPath.create(o)]=a,this.mergeChildrenImpl(o,a,i,s)}}}finally{this.endUpdate()}}}class Stylesheet{constructor(){this.styles=new Map,this.putDefaultVertexStyle(this.createDefaultVertexStyle()),this.putDefaultEdgeStyle(this.createDefaultEdgeStyle())}createDefaultVertexStyle(){const t={};return t.shape=SHAPE.RECTANGLE,t.perimeter="rectanglePerimeter",t.verticalAlign=ALIGN.MIDDLE,t.align=ALIGN.CENTER,t.fillColor="#C3D9FF",t.strokeColor="#6482B9",t.fontColor="#774400",t}createDefaultEdgeStyle(){const t={};return t.shape=SHAPE.CONNECTOR,t.endArrow=ARROW.CLASSIC,t.verticalAlign=ALIGN.MIDDLE,t.align=ALIGN.CENTER,t.strokeColor="#6482B9",t.fontColor="#446299",t}putDefaultVertexStyle(t){this.putCellStyle("defaultVertex",t)}putDefaultEdgeStyle(t){this.putCellStyle("defaultEdge",t)}getDefaultVertexStyle(){return this.styles.get("defaultVertex")}getDefaultEdgeStyle(){return this.styles.get("defaultEdge")}putCellStyle(t,e){this.styles.set(t,e)}getCellStyle(t,e){let i=t.ignoreDefaultStyle?{}:{...e};t.baseStyleNames&&(i=t.baseStyleNames.reduce((s,l)=>({...s,...this.styles.get(l)}),i));for(const s of Object.keys(t))t[s]!==void 0&&(t[s]==NONE?delete i[s]:i[s]=t[s]);return"baseStyleNames"in i&&delete i.baseStyleNames,"ignoreDefaultStyle"in i&&delete i.ignoreDefaultStyle,i}}const SideToSide=(n,t,e,i,s)=>{const{view:l}=n;let r=i!=null&&i.length>0?i[0]:null;const o=n.absolutePoints,h=o[0],a=o[o.length-1];if(r!=null&&(r=l.transformControlPoint(n,r)),h!=null&&(t=new CellState,t.x=h.x,t.y=h.y),a!=null&&(e=new CellState,e.x=a.x,e.y=a.y),t!=null&&e!=null){const d=Math.max(t.x,e.x),c=Math.min(t.x+t.width,e.x+e.width),g=r!=null?r.x:Math.round(c+(d-c)/2);let u=l.getRoutingCenterY(t),f=l.getRoutingCenterY(e);if(r!=null&&(r.y>=t.y&&r.y<=t.y+t.height&&(u=r.y),r.y>=e.y&&r.y<=e.y+e.height&&(f=r.y)),!contains(e,g,u)&&!contains(t,g,u)&&s.push(new Point(g,u)),!contains(e,g,f)&&!contains(t,g,f)&&s.push(new Point(g,f)),s.length===1)if(r!=null)!contains(e,g,r.y)&&!contains(t,g,r.y)&&s.push(new Point(g,r.y));else{const p=Math.max(t.y,e.y),E=Math.min(t.y+t.height,e.y+e.height);s.push(new Point(g,p+(E-p)/2))}}},TopToBottom=(n,t,e,i,s)=>{const{view:l}=n;let r=i!=null&&i.length>0?i[0]:null;const o=n.absolutePoints,h=o[0],a=o[o.length-1];if(r!=null&&(r=l.transformControlPoint(n,r)),h!=null&&(t=new CellState,t.x=h.x,t.y=h.y),a!=null&&(e=new CellState,e.x=a.x,e.y=a.y),t!=null&&e!=null){const d=Math.max(t.y,e.y),c=Math.min(t.y+t.height,e.y+e.height);let g=l.getRoutingCenterX(t);r!=null&&r.x>=t.x&&r.x<=t.x+t.width&&(g=r.x);const u=r!=null?r.y:Math.round(c+(d-c)/2);if(!contains(e,g,u)&&!contains(t,g,u)&&s.push(new Point(g,u)),r!=null&&r.x>=e.x&&r.x<=e.x+e.width?g=r.x:g=l.getRoutingCenterX(e),!contains(e,g,u)&&!contains(t,g,u)&&s.push(new Point(g,u)),s.length===1)if(r!=null&&s.length===1)!contains(e,r.x,u)&&!contains(t,r.x,u)&&s.push(new Point(r.x,u));else{const f=Math.max(t.x,e.x),p=Math.min(t.x+t.width,e.x+e.width);s.push(new Point(f+(p-f)/2,u))}}},ElbowConnector=(n,t,e,i,s)=>{let l=i!=null&&i.length>0?i[0]:null,r=!1,o=!1;if(t!=null&&e!=null)if(l!=null){const h=Math.min(t.x,e.x),a=Math.max(t.x+t.width,e.x+e.width),d=Math.min(t.y,e.y),c=Math.max(t.y+t.height,e.y+e.height);l=n.view.transformControlPoint(n,l),r=l.y<d||l.y>c,o=l.x<h||l.x>a}else{const h=Math.max(t.x,e.x),a=Math.min(t.x+t.width,e.x+e.width);if(r=h===a,!r){const d=Math.max(t.y,e.y),c=Math.min(t.y+t.height,e.y+e.height);o=d===c}}!o&&(r||n.style.elbow===ELBOW.VERTICAL)?TopToBottom(n,t,e,i,s):SideToSide(n,t,e,i,s)},EntityRelationConnectorConfig={segment:ENTITY_SEGMENT},OrthogonalConnectorConfig={buffer:10},ManhattanConnectorConfig={maxAllowedDirectionChange:90,maxLoops:2e3,endDirections:Object.values(DIRECTION),startDirections:Object.values(DIRECTION),step:12},originalManhattanConnectorConfig={};shallowCopy(ManhattanConnectorConfig,originalManhattanConnectorConfig);const EntityRelation=(n,t,e,i,s)=>{var g;const{view:l}=n,r=(((g=n.style)==null?void 0:g.segment)??EntityRelationConnectorConfig.segment)*l.scale,o=n.absolutePoints,h=o[0],a=o[o.length-1];let d=!1;if(t!=null){const u=t.cell.getGeometry();u.relative?d=u.x<=.5:e!=null&&(d=(a!=null?a.x:e.x+e.width)<(h!=null?h.x:t.x))}if(h!=null)t=new CellState,t.x=h.x,t.y=h.y;else if(t!=null){const u=getPortConstraints(t,n,!0,DIRECTION_MASK.NONE);u!==DIRECTION_MASK.NONE&&u!==DIRECTION_MASK.WEST+DIRECTION_MASK.EAST&&(d=u===DIRECTION_MASK.WEST)}else return;let c=!0;if(e!=null){const u=e.cell.getGeometry();u.relative?c=u.x<=.5:t!=null&&(c=(h!=null?h.x:t.x+t.width)<(a!=null?a.x:e.x))}if(a!=null)e=new CellState,e.x=a.x,e.y=a.y;else if(e!=null){const u=getPortConstraints(e,n,!1,DIRECTION_MASK.NONE);u!==DIRECTION_MASK.NONE&&u!=DIRECTION_MASK.WEST+DIRECTION_MASK.EAST&&(c=u===DIRECTION_MASK.WEST)}if(t!=null&&e!=null){const u=d?t.x:t.x+t.width,f=l.getRoutingCenterY(t),p=c?e.x:e.x+e.width,E=l.getRoutingCenterY(e),C=r;let y=d?-C:C;const w=new Point(u+y,f);y=c?-C:C;const v=new Point(p+y,E);if(d===c){const S=d?Math.min(u,p)-r:Math.max(u,p)+r;s.push(new Point(S,f)),s.push(new Point(S,E))}else if(w.x<v.x===d){const S=f+(E-f)/2;s.push(w),s.push(new Point(w.x,S)),s.push(new Point(v.x,S)),s.push(v)}else s.push(w),s.push(v)}},Loop=(n,t,e,i,s)=>{var h;const l=n.absolutePoints,r=l[0],o=l[l.length-1];if(r!=null&&o!=null){if(i!=null&&i.length>0)for(let a=0;a<i.length;a+=1){let d=i[a];d=n.view.transformControlPoint(n,d),s.push(new Point(d.x,d.y))}return}if(t!=null){const{view:a}=n,{graph:d}=a;let c=i!=null&&i.length>0?i[0]:null;c!=null&&(c=a.transformControlPoint(n,c),contains(t,c.x,c.y)&&(c=null));let g=0,u=0,f=0,p=0;const E=(n.style.segment??d.gridSize)*a.scale,C=((h=n.style)==null?void 0:h.direction)??DIRECTION.WEST;C===DIRECTION.NORTH||C===DIRECTION.SOUTH?(g=a.getRoutingCenterX(t),u=E):(f=a.getRoutingCenterY(t),p=E),c==null||c.x<t.x||c.x>t.x+t.width?c!=null?(g=c.x,p=Math.max(Math.abs(f-c.y),p)):C===DIRECTION.NORTH?f=t.y-2*u:C===DIRECTION.SOUTH?f=t.y+t.height+2*u:C===DIRECTION.EAST?g=t.x-2*p:g=t.x+t.width+2*p:c!==null&&(g=a.getRoutingCenterX(t),u=Math.max(Math.abs(g-c.x),p),f=c.y,p=0),s.push(new Point(g-u,f-p)),s.push(new Point(g+u,f+p))}};function scalePointArray(n,t){let e=[];if(n!=null)for(let i=0;i<n.length;i+=1)n[i]!=null?e[i]=new Point(Math.round(n[i].x/t*10)/10,Math.round(n[i].y/t*10)/10):e[i]=null;else e=null;return e}function scaleCellState(n,t){let e=null;return n!=null&&(e=n.clone(),e.setRect(Math.round(n.x/t*10)/10,Math.round(n.y/t*10)/10,Math.round(n.width/t*10)/10,Math.round(n.height/t*10)/10)),e}const SegmentConnector=(n,t,e,i,s)=>{const l=scalePointArray(n.absolutePoints,n.view.scale),r=scaleCellState(t,n.view.scale),o=scaleCellState(e,n.view.scale),h=1;let a=s.length>0?s[0]:null,d=!0,c=null;function g(E){return E.x=Math.round(E.x*n.view.scale*10)/10,E.y=Math.round(E.y*n.view.scale*10)/10,(a==null||Math.abs(a.x-E.x)>=h||Math.abs(a.y-E.y)>=Math.max(1,n.view.scale))&&(s.push(E),a=E),a}let u=l[0];u==null&&r!=null?u=new Point(n.view.getRoutingCenterX(r),n.view.getRoutingCenterY(r)):u!=null&&(u=u.clone());const f=l.length-1;let p=null;if(i!=null&&i.length>0){let E=[];for(let I=0;I<i.length;I+=1){const T=n.view.transformControlPoint(n,i[I],!0);T!=null&&E.push(T)}if(E.length===0)return;u!=null&&E[0]!=null&&(Math.abs(E[0].x-u.x)<h&&(E[0].x=u.x),Math.abs(E[0].y-u.y)<h&&(E[0].y=u.y)),p=l[f],p!=null&&E[E.length-1]!=null&&(Math.abs(E[E.length-1].x-p.x)<h&&(E[E.length-1].x=p.x),Math.abs(E[E.length-1].y-p.y)<h&&(E[E.length-1].y=p.y)),c=E[0];let C=r,y=l[0],w=!1,v=!1,S=c;y!=null&&(C=null);for(let I=0;I<2;I+=1){const T=y!=null&&y.x===S.x,A=y!=null&&y.y===S.y,R=C!=null&&S.y>=C.y&&S.y<=C.y+C.height,N=C!=null&&S.x>=C.x&&S.x<=C.x+C.width;if(w=A||y==null&&R,v=T||y==null&&N,!(I==0&&(w&&v||T&&A))){if(y!=null&&!A&&!T&&(R||N)){d=!R;break}if(v||w){d=w,I===1&&(d=E.length%2===0?w:v);break}}C=o,y=l[f],y!=null&&(C=null),S=E[E.length-1],T&&A&&(E=E.slice(1))}d&&(l[0]!=null&&l[0].y!==c.y||l[0]==null&&r!=null&&(c.y<r.y||c.y>r.y+r.height))?g(new Point(u.x,c.y)):!d&&(l[0]!=null&&l[0].x!==c.x||l[0]==null&&r!=null&&(c.x<r.x||c.x>r.x+r.width))&&g(new Point(c.x,u.y)),d?u.y=c.y:u.x=c.x;for(let I=0;I<E.length;I+=1)d=!d,c=E[I],d?u.y=c.y:u.x=c.x,g(u.clone())}else c=u,d=!0;if(u=l[f],u==null&&o!=null&&(u=new Point(n.view.getRoutingCenterX(o),n.view.getRoutingCenterY(o))),u!=null&&c!=null&&(d&&(l[f]!=null&&l[f].y!==c.y||l[f]==null&&o!=null&&(c.y<o.y||c.y>o.y+o.height))?g(new Point(u.x,c.y)):!d&&(l[f]!=null&&l[f].x!==c.x||l[f]==null&&o!=null&&(c.x<o.x||c.x>o.x+o.width))&&g(new Point(c.x,u.y))),l[0]==null&&r!=null)for(;s.length>1&&s[1]!=null&&contains(r,s[1].x,s[1].y);)s.splice(1,1);if(l[f]==null&&o!=null)for(;s.length>1&&s[s.length-1]!=null&&contains(o,s[s.length-1].x,s[s.length-1].y);)s.splice(s.length-1,1);p!=null&&s[s.length-1]!=null&&Math.abs(p.x-s[s.length-1].x)<=h&&Math.abs(p.y-s[s.length-1].y)<=h&&(s.splice(s.length-1,1),s[s.length-1]!=null&&(Math.abs(s[s.length-1].x-p.x)<h&&(s[s.length-1].x=p.x),Math.abs(s[s.length-1].y-p.y)<h&&(s[s.length-1].y=p.y)))},dirVectors=[[-1,0],[0,-1],[1,0],[0,1],[-1,0],[0,-1],[1,0]],wayPoints1=[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]],routePatterns=[[[513,2308,2081,2562],[513,1090,514,2184,2114,2561],[513,1090,514,2564,2184,2562],[513,2308,2561,1090,514,2568,2308]],[[514,1057,513,2308,2081,2562],[514,2184,2114,2561],[514,2184,2562,1057,513,2564,2184],[514,1057,513,2568,2308,2561]],[[1090,514,1057,513,2308,2081,2562],[2114,2561],[1090,2562,1057,513,2564,2184],[1090,514,1057,513,2308,2561,2568]],[[2081,2562],[1057,513,1090,514,2184,2114,2561],[1057,513,1090,514,2184,2562,2564],[1057,2561,1090,514,2568,2308]]],vertexSeparations=[],limits=[[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0]],SIDE_MASK=480,CENTER_MASK=512,SOURCE_MASK=1024,TARGET_MASK=2048;function getJettySize(n,t){const e=OrthogonalConnectorConfig.buffer;let i=(t?n.style.sourceJettySize:n.style.targetJettySize)??n.style.jettySize??e;if(i==="auto")if(((t?n.style.startArrow:n.style.endArrow)??NONE)!==NONE){const l=(t?n.style.startSize:n.style.endSize)??DEFAULT_MARKERSIZE;i=Math.max(2,Math.ceil((l+e)/e))*e}else i=2*e;return i}const OrthogonalConnector=(n,t,e,i,s)=>{const l=scalePointArray(n.absolutePoints,n.view.scale),r=scaleCellState(t,n.view.scale),o=scaleCellState(e,n.view.scale),h=r==null?!1:r.cell.isEdge(),a=o==null?!1:o.cell.isEdge(),d=l[0],c=l[l.length-1];let g=r!=null?r.x:d.x,u=r!=null?r.y:d.y,f=r!=null?r.width:0,p=r!=null?r.height:0,E=o!=null?o.x:c.x,C=o!=null?o.y:c.y,y=o!=null?o.width:0,w=o!=null?o.height:0,v=getJettySize(n,!0),S=getJettySize(n,!1);r!=null&&o===r&&(S=Math.max(v,S),v=S);const I=S+v;let T=!1;if(d!=null&&c!=null){const m=c.x-d.x,rt=c.y-d.y;T=m*m+rt*rt<I*I}if(T||i!=null&&i.length>0||h||a){SegmentConnector(n,t,e,i,s);return}const A=[DIRECTION_MASK.ALL,DIRECTION_MASK.ALL];let R=0;if(r!=null&&(A[0]=getPortConstraints(r,n,!0,DIRECTION_MASK.ALL),R=r.style.rotation??0,R!==0)){const m=getBoundingBox(new Rectangle(g,u,f,p),R);g=m.x,u=m.y,f=m.width,p=m.height}if(o!=null&&(A[1]=getPortConstraints(o,n,!1,DIRECTION_MASK.ALL),R=o.style.rotation??0,R!==0)){const m=getBoundingBox(new Rectangle(E,C,y,w),R);E=m.x,C=m.y,y=m.width,w=m.height}const N=[0,0],O=[[g,u,f,p],[E,C,y,w]],G=[v,S];for(let m=0;m<2;m+=1)limits[m][1]=O[m][0]-G[m],limits[m][2]=O[m][1]-G[m],limits[m][4]=O[m][0]+O[m][2]+G[m],limits[m][8]=O[m][1]+O[m][3]+G[m];const Y=O[0][0]+O[0][2]/2,Z=O[0][1]+O[0][3]/2,x=O[1][0]+O[1][2]/2,b=O[1][1]+O[1][3]/2,L=Y-x,M=Z-b;let P=0;L<0?M<0?P=2:P=1:M<=0&&(P=3,L===0&&(P=2));let H=null;r!=null&&(H=d);const V=[[.5,.5],[.5,.5]];for(let m=0;m<2;m+=1)H!=null&&(V[m][0]=(H.x-O[m][0])/O[m][2],Math.abs(H.x-O[m][0])<=1?N[m]=DIRECTION_MASK.WEST:Math.abs(H.x-O[m][0]-O[m][2])<=1&&(N[m]=DIRECTION_MASK.EAST),V[m][1]=(H.y-O[m][1])/O[m][3],Math.abs(H.y-O[m][1])<=1?N[m]=DIRECTION_MASK.NORTH:Math.abs(H.y-O[m][1]-O[m][3])<=1&&(N[m]=DIRECTION_MASK.SOUTH)),H=null,o!=null&&(H=c);const B=O[0][1]-(O[1][1]+O[1][3]),F=O[0][0]-(O[1][0]+O[1][2]),D=O[1][1]-(O[0][1]+O[0][3]),U=O[1][0]-(O[0][0]+O[0][2]);vertexSeparations[1]=Math.max(F-I,0),vertexSeparations[2]=Math.max(B-I,0),vertexSeparations[4]=Math.max(D-I,0),vertexSeparations[3]=Math.max(U-I,0);const _=[],W=[],z=[];W[0]=F>=U?DIRECTION_MASK.WEST:DIRECTION_MASK.EAST,z[0]=B>=D?DIRECTION_MASK.NORTH:DIRECTION_MASK.SOUTH,W[1]=reversePortConstraints(W[0]),z[1]=reversePortConstraints(z[0]);const $=F>=U?F:U,K=B>=D?B:D,k=[[0,0],[0,0]];let X=!1;for(let m=0;m<2;m+=1)N[m]===0&&((W[m]&A[m])===0&&(W[m]=reversePortConstraints(W[m])),(z[m]&A[m])===0&&(z[m]=reversePortConstraints(z[m])),k[m][0]=z[m],k[m][1]=W[m]);K>0&&$>0&&((W[0]&A[0])>0&&(z[1]&A[1])>0?(k[0][0]=W[0],k[0][1]=z[0],k[1][0]=z[1],k[1][1]=W[1],X=!0):(z[0]&A[0])>0&&(W[1]&A[1])>0&&(k[0][0]=z[0],k[0][1]=W[0],k[1][0]=W[1],k[1][1]=z[1],X=!0)),K>0&&!X&&(k[0][0]=z[0],k[0][1]=W[0],k[1][0]=z[1],k[1][1]=W[1],X=!0),$>0&&!X&&(k[0][0]=W[0],k[0][1]=z[0],k[1][0]=W[1],k[1][1]=z[1],X=!0);for(let m=0;m<2;m+=1)N[m]===0&&((k[m][0]&A[m])===0&&(k[m][0]=k[m][1]),_[m]=k[m][0]&A[m],_[m]|=(k[m][1]&A[m])<<8,_[m]|=(k[1-m][m]&A[m])<<16,_[m]|=(k[1-m][1-m]&A[m])<<24,(_[m]&15)===0&&(_[m]=_[m]<<8),(_[m]&3840)===0&&(_[m]=_[m]&15|_[m]>>8),(_[m]&983040)===0&&(_[m]=_[m]&65535|(_[m]&251658240)>>8),N[m]=_[m]&15,(A[m]===DIRECTION_MASK.WEST||A[m]===DIRECTION_MASK.NORTH||A[m]===DIRECTION_MASK.EAST||A[m]===DIRECTION_MASK.SOUTH)&&(N[m]=A[m]));let tt=N[0]===DIRECTION_MASK.EAST?3:N[0],q=N[1]===DIRECTION_MASK.EAST?3:N[1];tt-=P,q-=P,tt<1&&(tt+=4),q<1&&(q+=4);const J=routePatterns[tt-1][q-1];switch(wayPoints1[0][0]=O[0][0],wayPoints1[0][1]=O[0][1],N[0]){case DIRECTION_MASK.WEST:wayPoints1[0][0]-=v,wayPoints1[0][1]+=V[0][1]*O[0][3];break;case DIRECTION_MASK.SOUTH:wayPoints1[0][0]+=V[0][0]*O[0][2],wayPoints1[0][1]+=O[0][3]+v;break;case DIRECTION_MASK.EAST:wayPoints1[0][0]+=O[0][2]+v,wayPoints1[0][1]+=V[0][1]*O[0][3];break;case DIRECTION_MASK.NORTH:wayPoints1[0][0]+=V[0][0]*O[0][2],wayPoints1[0][1]-=v;break}let j=0,nt=(N[0]&(DIRECTION_MASK.EAST|DIRECTION_MASK.WEST))>0?0:1;const it=nt;let Q=0;for(let m=0;m<J.length;m+=1){const rt=J[m]&15;let st=rt===DIRECTION_MASK.EAST?3:rt;st+=P,st>4&&(st-=4);const ot=dirVectors[st-1];Q=st%2>0?0:1,Q!==nt&&(j++,wayPoints1[j][0]=wayPoints1[j-1][0],wayPoints1[j][1]=wayPoints1[j-1][1]);const ft=(J[m]&TARGET_MASK)>0,gt=(J[m]&SOURCE_MASK)>0;let ht=(J[m]&SIDE_MASK)>>5;ht<<=P,ht>15&&(ht>>=4);const ct=(J[m]&CENTER_MASK)>0;if((gt||ft)&&ht<9){let at=0;const lt=gt?0:1;if(ct&&Q===0?at=O[lt][0]+V[lt][0]*O[lt][2]:ct?at=O[lt][1]+V[lt][1]*O[lt][3]:at=limits[lt][ht],Q===0){const ut=wayPoints1[j][0],dt=(at-ut)*ot[0];dt>0&&(wayPoints1[j][0]+=ot[0]*dt)}else{const ut=wayPoints1[j][1],dt=(at-ut)*ot[1];dt>0&&(wayPoints1[j][1]+=ot[1]*dt)}}else ct&&(wayPoints1[j][0]+=ot[0]*Math.abs(vertexSeparations[st]/2),wayPoints1[j][1]+=ot[1]*Math.abs(vertexSeparations[st]/2));j>0&&wayPoints1[j][Q]===wayPoints1[j-1][Q]?j--:nt=Q}for(let m=0;m<=j&&!(m===j&&(((N[1]&(DIRECTION_MASK.EAST|DIRECTION_MASK.WEST))>0?0:1)===it?0:1)!==(j+1)%2);m+=1)s.push(new Point(Math.round(wayPoints1[m][0]*n.view.scale*10)/10,Math.round(wayPoints1[m][1]*n.view.scale*10)/10));let et=1;for(;et<s.length;)s[et-1]==null||s[et]==null||s[et-1].x!==s[et].x||s[et-1].y!==s[et].y?et++:s.splice(et,1)},ManhattanConnector=(n,t,e,i,s)=>{function l(x,b){return x.x+=b.x||0,x.y+=b.y||0,x.width+=b.width||0,x.height+=b.height||0,x}function r(x,b){return b*Math.round(x/b)}function o(x,b,L){return x.x=r(x.x,b),x.y=r(x.y,b),x}function h(x,b){return b.x>=x.x&&b.x<=x.x+x.width&&b.y>=x.y&&b.y<=x.y+x.height}function a(x){return new Point(x.x+x.width/2,x.y+x.height/2)}function d(x,b){return new Point(x.x-b.x,x.y-b.y)}function c(x,b,L){return x.x+=b||0,x.y+=L||0,x}function g(x,b){const L=b.clone(),M=-(L.y-x.y),P=L.x-x.x,H=10;return 180*(M.toFixed(H)=="0"&&P.toFixed(H)=="0"?0:Math.atan2(M,P))/Math.PI}function u(x){return new Point(x.x===0?0:Math.abs(x.x)/x.x,x.y===0?0:Math.abs(x.y)/x.y)}function f(x,b){return Math.abs(b.x-x.x)+Math.abs(b.y-x.y)}function p(x){const b=x.split(x.indexOf("@")===-1?" ":"@");return new Point(parseInt(b[0],10),parseInt(b[1],10))}function E(x){return`${x.x}@${x.y}`}function C(x){var U;const b=x.view.graph,L=(U=b.getCellBounds(x.cell,!1,!1))==null?void 0:U.clone();if(!L)return;const M=b.view,{scale:P,translate:H}=M,{x:V,y:B}=H,F=_=>Math.round(_*10)/10;return new Rectangle(F(L.x/P-V),F(L.y/P-B),F(L.width/P),F(L.height/P))}const y=ManhattanConnectorConfig.step,w={paddingBox:new Geometry(-y,-y,y*2,y*2),directions:[{offsetX:y,offsetY:0,cost:y,angle:A(g(new Point(0,0),new Point(y,0)))},{offsetX:0,offsetY:y,cost:y,angle:A(g(new Point(0,0),new Point(0,y)))},{offsetX:-y,offsetY:0,cost:y,angle:A(g(new Point(0,0),new Point(-y,0)))},{offsetX:0,offsetY:-y,cost:y,angle:A(g(new Point(0,0),new Point(0,-y)))}],directionMap:{east:{x:1,y:0},south:{x:0,y:1},west:{x:-1,y:0},north:{x:0,y:-1}},penaltiesGenerator:x=>x==45||x==90||x==180?y/2:0,draggingRoute:null,previousDirAngle:0};class v{constructor(b){this.options=b,this.mapGridSize=100,this.map=new Map}build(b,L){const M=(b==null?void 0:b.view.graph)||(L==null?void 0:L.view.graph);if(M)return Array.from(M.getView().getCellStates()).filter(P=>P.cell&&P.cell.isVertex()&&!P.cell.isEdge()).map(P=>C(P)).map(P=>P?l(P,this.options.paddingBox):null).forEach(P=>{if(!P)return;const H=o(new Point(P.x,P.y),this.mapGridSize),V=o(new Point(P.x+P.width,P.y+P.height),this.mapGridSize);for(let B=H.x;B<=V.x;B+=this.mapGridSize)for(let F=H.y;F<=V.y;F+=this.mapGridSize){const D=B+"@"+F,U=this.map.get(D)||[];this.map.has(D)||this.map.set(D,U),U.push(P)}})}isPointAccessible(b){const L=E(o(b.clone(),this.mapGridSize)),M=this.map.get(L);return M?M.every(P=>!h(P,b)):!0}}class S{constructor(){this.items=[],this.hash=new Map}add(b,L){const M=this.hash.get(b);M?(M.value=L,this.items.splice(this.items.indexOf(b),1)):this.hash.set(b,{value:L,open:!0}),this.items.push(b),this.items.sort((P,H)=>{const V=this.hash.get(P),B=this.hash.get(H);return!V||!B?0:V.value-B.value})}remove(b){const L=this.hash.get(b);L&&(L.open=!1)}isOpen(b){const L=this.hash.get(b);return L&&L.open==!0}isClose(b){const L=this.hash.get(b);return L&&L.open==!1}isEmpty(){return this.items.length==0}pop(){const b=this.items.shift();return b&&this.remove(b),b}}function I(x,b,L,M){const P=[];let H=u(d(M,b)),V=b,B;for(;x[E(V)];){if(B=x[E(V)],!B)continue;const D=u(d(V,B));D.equals(H)||(P.unshift(V),H=D),V=B}return u(d(V,L)).equals(H)||P.unshift(V),P}function T(x,b,L){const M=ManhattanConnectorConfig.step,P=a(x),H=[];for(const V of b){const B=L.directionMap[V],F=B.x*x.width/2,D=B.y*x.height/2,U=c(P.clone(),F,D);h(x,U)&&c(U,B.x*M,B.y*M),H.push(o(U,M))}return H}function A(x){return x%360+(x<0?360:0)}function R(x,b,L){const M=360/L;return Math.floor(A(g(x,b)+M/2)/M)*M}function N(x,b){const L=Math.abs(x-b);return L>180?360-L:L}function O(x,b){let L=1/0;for(let M=0,P=b.length;M<P;M++){const H=f(x,b[M]);H<L&&(L=H)}return L}function G(x,b,L,M){const P=C(L),H=M?b.style.exitY:b.style.entryY,V=M?ManhattanConnectorConfig.startDirections.every(D=>D!=DIRECTION.NORTH&&D!=DIRECTION.SOUTH):ManhattanConnectorConfig.endDirections.every(D=>D!=DIRECTION.NORTH&&D!=DIRECTION.SOUTH);if(H!=null&&V){const D=(P==null?void 0:P.height)||0;x.y=(P==null?void 0:P.y)!=null?(P==null?void 0:P.y)+D*H:x.y-D/2+D*H}const B=M?b.style.exitX:b.style.entryX,F=M?ManhattanConnectorConfig.startDirections.every(D=>D!=DIRECTION.WEST&&D!=DIRECTION.EAST):ManhattanConnectorConfig.endDirections.every(D=>D!=DIRECTION.WEST&&D!=DIRECTION.EAST);if(B!=null&&F){const D=(P==null?void 0:P.width)||0;x.x=(P==null?void 0:P.x)!=null?(P==null?void 0:P.x)+D*B:x.x-D/2+D*(B||0)}}function Y(x,b,L,M){const P=ManhattanConnectorConfig.step,H=T(x,ManhattanConnectorConfig.startDirections,M).filter(D=>L.isPointAccessible(D)),V=o(a(x),P),B=T(b,ManhattanConnectorConfig.endDirections,M).filter(D=>L.isPointAccessible(D)),F=o(a(b),P);if(H.length>0&&B.length>0){const D=new S,U={},_={};H.forEach(k=>{const X=E(k);D.add(X,O(k,B)),_[X]=0});let W=ManhattanConnectorConfig.maxLoops;const z=B.map(k=>E(k));let $,K;for(;!D.isEmpty()&&W>0;){const k=D.pop();if(k==null)continue;const X=p(k),tt=_[k];if(K=$,$=U[k]?R(U[k],X,M.directions.length):M.previousDirAngle!=0?M.previousDirAngle:R(V,X,M.directions.length),z.indexOf(k)>=0){const q=N($,R(X,F,M.directions.length));if(X.equals(F)||q<180)return M.previousDirAngle=$,I(U,X,V,F)}for(let q=0;q<M.directions.length;q++){const J=M.directions[q],j=N($,J.angle);if(K&&j>ManhattanConnectorConfig.maxAllowedDirectionChange)continue;const nt=c(X.clone(),J.offsetX,J.offsetY),it=E(nt);if(D.isClose(it)||!L.isPointAccessible(nt))continue;const Q=tt+J.cost+M.penaltiesGenerator(j);(!D.isOpen(it)||Q<_[it])&&(U[it]=X,_[it]=Q,D.add(it,Q+O(nt,B)))}W--}return null}return null}function Z(x,b,L,M,P,H){if(M!=null&&M.length>0||b==null||L==null){SegmentConnector(x,b,L,M,P);return}let V=C(b);V=V?l(V,H.paddingBox):void 0;let B=C(L);B=B?l(B,H.paddingBox):void 0;const F=new v(H);if(F.build(b,L),!V||!B)return OrthogonalConnector(x,b,L,M,P);const D=Y(V,B,F,H);if(D==null||D.length==0)return OrthogonalConnector(x,b,L,M,P);x.style&&(x.visibleSourceState&&D.length>0&&G(D[0],x,x.visibleSourceState,!0),x.visibleTargetState&&D.length>1&&G(D[D.length-1],x,x.visibleTargetState,!1));const U=x.view.scale;D.forEach(_=>P.push(new Point(Math.round((_.x+x.view.translate.x)*U*10)/10,Math.round((_.y+x.view.translate.y)*U*10)/10)))}Z(n,t,e,i,s,w)};class EdgeStyle{}EdgeStyle.EntityRelation=EntityRelation;EdgeStyle.Loop=Loop;EdgeStyle.ElbowConnector=ElbowConnector;EdgeStyle.SideToSide=SideToSide;EdgeStyle.TopToBottom=TopToBottom;EdgeStyle.SegmentConnector=SegmentConnector;EdgeStyle.OrthConnector=OrthogonalConnector;EdgeStyle.ManhattanConnector=ManhattanConnector;class CellHighlight{constructor(t,e,i,s){this.strokeWidth=0,this.dashed=!1,this.opacity=100,this.shape=null,this.keepOnTop=!1,this.state=null,this.spacing=2,this.graph=t,this.highlightColor=e??DEFAULT_VALID_COLOR,this.strokeWidth=i??HIGHLIGHT_STROKEWIDTH,this.dashed=s??!1,this.opacity=HIGHLIGHT_OPACITY,this.repaintHandler=()=>{if(this.state){const l=this.graph.view.getState(this.state.cell);l?(this.state=l,this.repaint()):this.hide()}},this.graph.getView().addListener(InternalEvent.SCALE,this.repaintHandler),this.graph.getView().addListener(InternalEvent.TRANSLATE,this.repaintHandler),this.graph.getView().addListener(InternalEvent.SCALE_AND_TRANSLATE,this.repaintHandler),this.graph.getDataModel().addListener(InternalEvent.CHANGE,this.repaintHandler),this.resetHandler=()=>{this.hide()},this.graph.getView().addListener(InternalEvent.DOWN,this.resetHandler),this.graph.getView().addListener(InternalEvent.UP,this.resetHandler)}setHighlightColor(t){this.highlightColor=t,this.shape&&(this.shape.stroke=t)}drawHighlight(){var t;if(this.shape=this.createShape(),this.repaint(),this.shape){const e=this.shape.node;!this.keepOnTop&&((t=e==null?void 0:e.parentNode)==null?void 0:t.firstChild)!==e&&e.parentNode&&e.parentNode.insertBefore(e,e.parentNode.firstChild)}}createShape(){if(!this.state)return null;const t=this.graph.cellRenderer.createShape(this.state);return t.svgStrokeTolerance=this.graph.getEventTolerance(),t.points=this.state.absolutePoints,t.apply(this.state),t.stroke=this.highlightColor,t.opacity=this.opacity,t.isDashed=this.dashed,t.isShadow=!1,t.dialect=DIALECT.SVG,t.init(this.graph.getView().getOverlayPane()),InternalEvent.redirectMouseEvents(t.node,this.graph,this.state),this.graph.dialect!==DIALECT.SVG?t.pointerEvents=!1:t.svgPointerEvents="stroke",t}getStrokeWidth(t=null){return this.strokeWidth}repaint(){this.state&&this.shape&&(this.shape.scale=this.state.view.scale,this.state.cell.isEdge()?(this.shape.strokeWidth=this.getStrokeWidth(),this.shape.points=this.state.absolutePoints,this.shape.outline=!1):(this.shape.bounds=new Rectangle(this.state.x-this.spacing,this.state.y-this.spacing,this.state.width+2*this.spacing,this.state.height+2*this.spacing),this.shape.rotation=this.state.style.rotation??0,this.shape.strokeWidth=this.getStrokeWidth()/this.state.view.scale,this.shape.outline=!0),this.state.shape&&this.shape.setCursor(this.state.shape.getCursor()),this.shape.redraw())}hide(){this.highlight(null)}highlight(t=null){this.state!==t&&(this.shape&&(this.shape.destroy(),this.shape=null),this.state=t,this.state&&this.drawHighlight())}isHighlightAt(t,e){let i=!1;if(this.shape&&document.elementFromPoint){let s=document.elementFromPoint(t,e);for(;s;){if(s===this.shape.node){i=!0;break}s=s.parentNode}}return i}destroy(){const t=this.graph;t.getView().removeListener(this.resetHandler),t.getView().removeListener(this.repaintHandler),t.getDataModel().removeListener(this.repaintHandler),this.shape&&(this.shape.destroy(),this.shape=null)}}class CellMarker extends EventSource{constructor(t,e=DEFAULT_VALID_COLOR,i=DEFAULT_INVALID_COLOR,s=DEFAULT_HOTSPOT){super(),this.enabled=!0,this.hotspot=DEFAULT_HOTSPOT,this.hotspotEnabled=!1,this.currentColor=NONE,this.validState=null,this.markedState=null,this.graph=t,this.validColor=e,this.invalidColor=i,this.hotspot=s,this.highlight=new CellHighlight(t)}setEnabled(t){this.enabled=t}isEnabled(){return this.enabled}setHotspot(t){this.hotspot=t}getHotspot(){return this.hotspot}setHotspotEnabled(t){this.hotspotEnabled=t}isHotspotEnabled(){return this.hotspotEnabled}hasValidState(){return!!this.validState}getValidState(){return this.validState}getMarkedState(){return this.markedState}reset(){this.validState=null,this.markedState&&(this.markedState=null,this.unmark())}process(t){let e=null;return this.isEnabled()&&(e=this.getState(t),this.setCurrentState(e,t)),e}setCurrentState(t,e,i){const s=t?this.isValidState(t):!1;i=i??this.getMarkerColor(e.getEvent(),t,s),s?this.validState=t:this.validState=null,(t!==this.markedState||i!==this.currentColor)&&(this.currentColor=i,t&&this.currentColor!==NONE?(this.markedState=t,this.mark()):this.markedState&&(this.markedState=null,this.unmark()))}markCell(t,e){const i=this.graph.getView().getState(t);i&&(this.currentColor=e??this.validColor,this.markedState=i,this.mark())}mark(){this.highlight.setHighlightColor(this.currentColor),this.highlight.highlight(this.markedState),this.fireEvent(new EventObject(InternalEvent.MARK,"state",this.markedState))}unmark(){this.mark()}isValidState(t){return!0}getMarkerColor(t,e,i){return i?this.validColor:this.invalidColor}getState(t){const e=this.graph.getView(),i=this.getCell(t);if(!i)return null;const s=this.getStateToMark(e.getState(i));return s&&this.intersects(s,t)?s:null}getCell(t){return t.getCell()}getStateToMark(t){return t}intersects(t,e){const i=e.getGraphX(),s=e.getGraphY();return this.hotspotEnabled?intersectsHotspot(t,i,s,this.hotspot,MIN_HOTSPOT_SIZE,MAX_HOTSPOT_SIZE):!0}destroy(){this.highlight.destroy()}}class EllipseShape extends Shape{constructor(t,e,i,s=1){super(),this.bounds=t,this.fill=e,this.stroke=i,this.strokeWidth=s}paintVertexShape(t,e,i,s,l){t.ellipse(e,i,s,l),t.fillAndStroke()}}class ConnectionConstraint{constructor(t,e=!0,i=null,s=0,l=0){this.perimeter=!0,this.name=null,this.dx=0,this.dy=0,this.point=t,this.perimeter=e,this.name=i,this.dx=s,this.dy=l}}class ConstraintHandler{constructor(t){this.pointImage=new ImageBox(`${Client.imageBasePath}/point.gif`,5,5),this.currentFocus=null,this.currentFocusArea=null,this.focusIcons=[],this.constraints=null,this.currentConstraint=null,this.focusHighlight=null,this.focusPoints=[],this.currentPoint=null,this.enabled=!0,this.highlightColor=DEFAULT_VALID_COLOR,this.mouseleaveHandler=null,this.graph=t,this.resetHandler=()=>{this.currentFocus&&!this.graph.view.getState(this.currentFocus.cell)?this.reset():this.redraw()},this.graph.model.addListener(InternalEvent.CHANGE,this.resetHandler),this.graph.view.addListener(InternalEvent.SCALE_AND_TRANSLATE,this.resetHandler),this.graph.view.addListener(InternalEvent.TRANSLATE,this.resetHandler),this.graph.view.addListener(InternalEvent.SCALE,this.resetHandler),this.graph.addListener(InternalEvent.ROOT,this.resetHandler)}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}reset(){for(let t=0;t<this.focusIcons.length;t+=1)this.focusIcons[t].destroy();this.focusIcons=[],this.focusHighlight&&(this.focusHighlight.destroy(),this.focusHighlight=null),this.currentConstraint=null,this.currentFocusArea=null,this.currentPoint=null,this.currentFocus=null,this.focusPoints=[]}getTolerance(t){return this.graph.getEventTolerance()}getImageForConstraint(t,e,i){return this.pointImage}isEventIgnored(t,e=!1){return!1}isStateIgnored(t,e=!1){return!1}destroyIcons(){for(let t=0;t<this.focusIcons.length;t+=1)this.focusIcons[t].destroy();this.focusIcons=[],this.focusPoints=[]}destroyFocusHighlight(){this.focusHighlight&&(this.focusHighlight.destroy(),this.focusHighlight=null)}isKeepFocusEvent(t){return isShiftDown(t.getEvent())}getCellForEvent(t,e){let i=t.getCell();if(!i&&e&&(t.getGraphX()!==e.x||t.getGraphY()!==e.y)&&(i=this.graph.getCellAt(e.x,e.y)),i&&!i.isConnectable()){const s=i.getParent();s&&s.isVertex()&&s.isConnectable()&&(i=s)}return i?this.graph.isCellLocked(i)?null:i:null}update(t,e,i,s){if(this.isEnabled()&&!this.isEventIgnored(t)){!this.mouseleaveHandler&&this.graph.container&&(this.mouseleaveHandler=()=>{this.reset()},InternalEvent.addListener(this.graph.container,"mouseleave",this.resetHandler));const l=this.getTolerance(t),r=s?s.x:t.getGraphX(),o=s?s.y:t.getGraphY(),h=new Rectangle(r-l,o-l,2*l,2*l),a=new Rectangle(t.getGraphX()-l,t.getGraphY()-l,2*l,2*l),d=this.graph.view.getState(this.getCellForEvent(t,s));!this.isKeepFocusEvent(t)&&(!this.currentFocusArea||!this.currentFocus||d||!this.currentFocus.cell.isVertex()||!intersects(this.currentFocusArea,a))&&d!==this.currentFocus&&(this.currentFocusArea=null,this.currentFocus=null,this.setFocus(t,d,e)),this.currentConstraint=null,this.currentPoint=null;let c=null,g;if(this.focusIcons.length>0&&this.constraints&&(!d||this.currentFocus===d)){const u=a.getCenterX(),f=a.getCenterY();for(let p=0;p<this.focusIcons.length;p+=1){const E=u-this.focusIcons[p].bounds.getCenterX(),C=f-this.focusIcons[p].bounds.getCenterY();if(g=E*E+C*C,(this.intersects(this.focusIcons[p],a,e,i)||s&&this.intersects(this.focusIcons[p],h,e,i))&&(c===null||g<c)){if(this.currentConstraint=this.constraints[p],this.currentPoint=this.focusPoints[p],c=g,g=this.focusIcons[p].bounds.clone(),g.grow(HIGHLIGHT_SIZE+1),g.width-=1,g.height-=1,!this.focusHighlight){const y=this.createHighlightShape();y.dialect=DIALECT.SVG,y.pointerEvents=!1,y.init(this.graph.getView().getOverlayPane()),this.focusHighlight=y;const w=()=>this.currentFocus?this.currentFocus:d;InternalEvent.redirectMouseEvents(y.node,this.graph,w)}this.focusHighlight.bounds=g,this.focusHighlight.redraw()}}}this.currentConstraint||this.destroyFocusHighlight()}else this.currentConstraint=null,this.currentFocus=null,this.currentPoint=null}redraw(){if(this.currentFocus&&this.constraints&&this.focusIcons.length>0){const t=this.graph.view.getState(this.currentFocus.cell);this.currentFocus=t,this.currentFocusArea=new Rectangle(t.x,t.y,t.width,t.height);for(let e=0;e<this.constraints.length;e+=1){const i=this.graph.getConnectionPoint(t,this.constraints[e]),s=this.getImageForConstraint(t,this.constraints[e],i),l=new Rectangle(Math.round(i.x-s.width/2),Math.round(i.y-s.height/2),s.width,s.height);this.focusIcons[e].bounds=l,this.focusIcons[e].redraw(),this.currentFocusArea.add(this.focusIcons[e].bounds),this.focusPoints[e]=i}}}setFocus(t,e,i){var s;if(this.constraints=e&&!this.isStateIgnored(e,i)&&e.cell.isConnectable()?this.isEnabled()?this.graph.getAllConnectionConstraints(e,i)??[]:[]:null,this.constraints&&e){this.currentFocus=e,this.currentFocusArea=new Rectangle(e.x,e.y,e.width,e.height);for(let l=0;l<this.focusIcons.length;l+=1)this.focusIcons[l].destroy();this.focusIcons=[],this.focusPoints=[];for(let l=0;l<this.constraints.length;l+=1){const r=this.graph.getConnectionPoint(e,this.constraints[l]),o=this.getImageForConstraint(e,this.constraints[l],r),{src:h}=o,a=new Rectangle(Math.round(r.x-o.width/2),Math.round(r.y-o.height/2),o.width,o.height),d=new ImageShape(a,h);d.dialect=this.graph.dialect!==DIALECT.SVG?DIALECT.MIXEDHTML:DIALECT.SVG,d.preserveImageAspect=!1,d.init(this.graph.getView().getDecoratorPane()),d.node.previousSibling&&((s=d.node.parentNode)==null||s.insertBefore(d.node,d.node.parentNode.firstChild));const c=()=>this.currentFocus?this.currentFocus:e;d.redraw(),InternalEvent.redirectMouseEvents(d.node,this.graph,c),this.currentFocusArea.add(d.bounds),this.focusIcons.push(d),this.focusPoints.push(r)}this.currentFocusArea.grow(this.getTolerance(t))}else this.destroyIcons(),this.destroyFocusHighlight()}createHighlightShape(){const t=new RectangleShape(new Rectangle,this.highlightColor,this.highlightColor,HIGHLIGHT_STROKEWIDTH);return t.opacity=HIGHLIGHT_OPACITY,t}intersects(t,e,i,s){return intersects(t.bounds,e)}onDestroy(){this.reset(),this.graph.model.removeListener(this.resetHandler),this.graph.view.removeListener(this.resetHandler),this.graph.removeListener(this.resetHandler),this.mouseleaveHandler&&this.graph.container&&(InternalEvent.removeListener(this.graph.container,"mouseleave",this.mouseleaveHandler),this.mouseleaveHandler=null)}}const EdgeHandlerConfig={connectFillColor:CONNECT_HANDLE_FILLCOLOR,selectionColor:EDGE_SELECTION_COLOR,selectionDashed:EDGE_SELECTION_DASHED,selectionStrokeWidth:EDGE_SELECTION_STROKEWIDTH,virtualBendOpacity:20,virtualBendsEnabled:!1},HandleConfig={fillColor:HANDLE_FILLCOLOR,labelFillColor:LABEL_HANDLE_FILLCOLOR,labelSize:LABEL_HANDLE_SIZE,size:HANDLE_SIZE,strokeColor:HANDLE_STROKECOLOR},VertexHandlerConfig={rotationEnabled:!1,selectionColor:VERTEX_SELECTION_COLOR,selectionStrokeWidth:VERTEX_SELECTION_STROKEWIDTH,selectionDashed:VERTEX_SELECTION_DASHED};class EdgeHandler{constructor(t){if(this.error=null,this.bends=[],this.cloneEnabled=!0,this.dblClickRemoveEnabled=!1,this.mergeRemoveEnabled=!1,this.straightRemoveEnabled=!1,this.parentHighlightEnabled=!1,this.preferHtml=!1,this.allowHandleBoundsCheck=!0,this.snapToTerminals=!1,this.handleImage=null,this.labelHandleImage=null,this.tolerance=0,this.outlineConnect=!1,this.manageLabelHandle=!1,this.currentPoint=null,this.parentHighlight=null,this.index=null,this.isSource=!1,this.isTarget=!1,this.isLabel=!1,this.points=[],this.snapPoint=null,this.abspoints=[],this.startX=0,this.startY=0,this.outline=!0,this.active=!0,this.state=t,this.graph=this.state.view.graph,this.marker=this.createMarker(),this.constraintHandler=new ConstraintHandler(this.graph),this.points=[],this.abspoints=this.getSelectionPoints(this.state),this.shape=this.createSelectionShape(this.abspoints),this.shape.dialect=this.graph.dialect!==DIALECT.SVG?DIALECT.MIXEDHTML:DIALECT.SVG,this.shape.init(this.graph.getView().getOverlayPane()),this.shape.pointerEvents=!1,this.shape.setCursor(CURSOR.MOVABLE_EDGE),InternalEvent.redirectMouseEvents(this.shape.node,this.graph,this.state),this.preferHtml=this.state.text!=null&&this.state.text.node.parentNode===this.graph.container,!this.preferHtml){const i=this.state.getVisibleTerminalState(!0);if(i!=null&&(this.preferHtml=i.text!=null&&i.text.node.parentNode===this.graph.container),!this.preferHtml){const s=this.state.getVisibleTerminalState(!1);s!=null&&(this.preferHtml=s.text!=null&&s.text.node.parentNode===this.graph.container)}}const e=this.graph.getPlugin("SelectionHandler");e&&(this.graph.getSelectionCount()<e.maxCells||e.maxCells<=0)&&(this.bends=this.createBends(),this.isVirtualBendsEnabled()&&(this.virtualBends=this.createVirtualBends())),this.label=new Point(this.state.absoluteOffset.x,this.state.absoluteOffset.y),this.labelShape=this.createLabelHandleShape(),this.initBend(this.labelShape),this.labelShape.setCursor(CURSOR.LABEL_HANDLE),this.customHandles=this.createCustomHandles(),this.updateParentHighlight(),this.redraw(),this.escapeHandler=(i,s)=>{const l=this.index!=null;this.reset(),l&&this.graph.cellRenderer.redraw(this.state,!1,t.view.isRendering())},this.state.view.graph.addListener(InternalEvent.ESCAPE,this.escapeHandler)}isParentHighlightVisible(){const t=this.state.cell.getParent();return t?!this.graph.isCellSelected(t):null}updateParentHighlight(){if(!this.isDestroyed()){const t=this.isParentHighlightVisible(),e=this.state.cell.getParent(),i=e?this.graph.view.getState(e):null;if(this.parentHighlight)if(e&&e.isVertex()&&t){const s=this.parentHighlight.bounds;i&&s&&(s.x!==i.x||s.y!==i.y||s.width!==i.width||s.height!==i.height)&&(this.parentHighlight.bounds=Rectangle.fromRectangle(i),this.parentHighlight.redraw())}else i&&i.parentHighlight===this.parentHighlight&&(i.parentHighlight=null),this.parentHighlight.destroy(),this.parentHighlight=null;else this.parentHighlightEnabled&&t&&e&&e.isVertex()&&i&&!i.parentHighlight&&(this.parentHighlight=this.createParentHighlightShape(i),this.parentHighlight.dialect=DIALECT.SVG,this.parentHighlight.pointerEvents=!1,i.style.rotation&&(this.parentHighlight.rotation=i.style.rotation),this.parentHighlight.init(this.graph.getView().getOverlayPane()),this.parentHighlight.redraw(),i.parentHighlight=this.parentHighlight)}}createCustomHandles(){return[]}isVirtualBendsEnabled(t){return EdgeHandlerConfig.virtualBendsEnabled}isCellEnabled(t){return!0}isAddPointEvent(t){return isShiftDown(t)}isRemovePointEvent(t){return isShiftDown(t)}getSelectionPoints(t){return t.absolutePoints}createParentHighlightShape(t){const e=new RectangleShape(Rectangle.fromRectangle(t),NONE,this.getSelectionColor());return e.strokeWidth=this.getSelectionStrokeWidth(),e.isDashed=this.isSelectionDashed(),e}createSelectionShape(t){const e=this.state.shape.constructor,i=new e;return i.outline=!0,i.apply(this.state),i.isDashed=this.isSelectionDashed(),i.stroke=this.getSelectionColor(),i.isShadow=!1,i}getSelectionColor(){return EdgeHandlerConfig.selectionColor}getSelectionStrokeWidth(){return EdgeHandlerConfig.selectionStrokeWidth}isSelectionDashed(){return EdgeHandlerConfig.selectionDashed}isConnectableCell(t){return!0}getCellAt(t,e){return this.outlineConnect?null:this.graph.getCellAt(t,e)}createMarker(){return new EdgeHandlerCellMarker(this.graph,this)}validateConnection(t,e){return this.graph.getEdgeValidationError(this.state.cell,t,e)}createBends(){const{cell:t}=this.state,e=[];for(let i=0;i<this.abspoints.length;i+=1)if(this.isHandleVisible(i)){const s=i===0,l=i===this.abspoints.length-1,r=s||l;(r||this.graph.isCellBendable(t))&&(o=>{const h=this.createHandleShape(o);this.initBend(h,()=>{this.dblClickRemoveEnabled&&this.removePoint(this.state,o)}),this.isHandleEnabled(i)&&h.setCursor(r?CURSOR.TERMINAL_HANDLE:CURSOR.BEND_HANDLE),e.push(h),r||(this.points.push(new Point(0,0)),h.node.style.visibility="hidden")})(i)}return e}createVirtualBends(){const{cell:t}=this.state;this.abspoints[0];const e=[];if(this.graph.isCellBendable(t))for(let i=1;i<this.abspoints.length;i+=1)(s=>{this.initBend(s),s.setCursor(CURSOR.VIRTUAL_BEND_HANDLE),e.push(s)})(this.createHandleShape());return e}isHandleEnabled(t){return!0}isHandleVisible(t){const e=this.state.getVisibleTerminalState(!0),i=this.state.getVisibleTerminalState(!1),s=this.state.cell.getGeometry();return(s?this.graph.view.getEdgeStyle(this.state,s.points||void 0,e,i):null)!==EdgeStyle.EntityRelation||t===0||t===this.abspoints.length-1}createHandleShape(t){if(this.handleImage){const s=new ImageShape(new Rectangle(0,0,this.handleImage.width,this.handleImage.height),this.handleImage.src);return s.preserveImageAspect=!1,s}let e=HandleConfig.size;this.preferHtml&&(e-=1);const i=RectangleShape;return new i(new Rectangle(0,0,e,e),HandleConfig.fillColor,HandleConfig.strokeColor)}createLabelHandleShape(){if(this.labelHandleImage){const e=new ImageShape(new Rectangle(0,0,this.labelHandleImage.width,this.labelHandleImage.height),this.labelHandleImage.src);return e.preserveImageAspect=!1,e}const t=HandleConfig.labelSize;return new RectangleShape(new Rectangle(0,0,t,t),HandleConfig.labelFillColor,HandleConfig.strokeColor)}initBend(t,e){this.preferHtml?(t.dialect=DIALECT.STRICTHTML,t.init(this.graph.container)):(t.dialect=this.graph.dialect!==DIALECT.SVG?DIALECT.MIXEDHTML:DIALECT.SVG,t.init(this.graph.getView().getOverlayPane())),InternalEvent.redirectMouseEvents(t.node,this.graph,this.state,null,null,null,e),Client.IS_TOUCH&&t.node.setAttribute("pointer-events","none")}getHandleForEvent(t){let e=null;const i=isMouseEvent(t.getEvent())?1:this.tolerance,s=this.allowHandleBoundsCheck&&i>0?new Rectangle(t.getGraphX()-i,t.getGraphY()-i,2*i,2*i):null;let l=Number.POSITIVE_INFINITY;function r(o){if(o&&o.bounds&&o.node&&o.node.style.display!=="none"&&o.node.style.visibility!=="hidden"&&(t.isSource(o)||s&&intersects(o.bounds,s))){const h=t.getGraphX()-o.bounds.getCenterX(),a=t.getGraphY()-o.bounds.getCenterY(),d=h*h+a*a;if(d<=l)return l=d,!0}return!1}if(this.isCustomHandleEvent(t)&&this.customHandles){for(let o=this.customHandles.length-1;o>=0;o--)if(r(this.customHandles[o].shape))return InternalEvent.CUSTOM_HANDLE-o}(t.isSource(this.state.text)||r(this.labelShape))&&(e=InternalEvent.LABEL_HANDLE);for(let o=0;o<this.bends.length;o+=1)r(this.bends[o])&&(e=o);if(this.virtualBends&&this.isAddVirtualBendEvent(t))for(let o=0;o<this.virtualBends.length;o+=1)r(this.virtualBends[o])&&(e=InternalEvent.VIRTUAL_HANDLE-o);return e}isAddVirtualBendEvent(t){return!0}isCustomHandleEvent(t){return!0}mouseDown(t,e){const i=this.getHandleForEvent(e);if(i!==null&&this.bends[i]){const s=this.bends[i].bounds;s&&(this.snapPoint=new Point(s.getCenterX(),s.getCenterY()))}if(i!==null&&!e.isConsumed()&&this.graph.isEnabled()){const s=e.getCell();(i!==InternalEvent.LABEL_HANDLE||s&&this.graph.isLabelMovable(s))&&(this.virtualBends&&i<=InternalEvent.VIRTUAL_HANDLE&&setOpacity(this.virtualBends[InternalEvent.VIRTUAL_HANDLE-i].node,100),this.start(e.getX(),e.getY(),i)),e.consume()}}start(t,e,i){if(this.startX=t,this.startY=e,this.isSource=this.bends.length===0?!1:i===0,this.isTarget=this.bends.length===0?!1:i===this.bends.length-1,this.isLabel=i===InternalEvent.LABEL_HANDLE,this.isSource||this.isTarget){const{cell:s}=this.state,l=s.getTerminal(this.isSource);(l==null&&this.graph.isTerminalPointMovable(s,this.isSource)||l!=null&&this.graph.isCellDisconnectable(s,l,this.isSource))&&(this.index=i)}else this.index=i;if(this.index!==null&&this.index<=InternalEvent.CUSTOM_HANDLE&&this.index>InternalEvent.VIRTUAL_HANDLE&&this.customHandles!=null)for(let s=0;s<this.customHandles.length;s+=1)s!==InternalEvent.CUSTOM_HANDLE-this.index&&this.customHandles[s].setVisible(!1)}clonePreviewState(t,e){return this.state.clone()}getSnapToTerminalTolerance(){return this.graph.getGridSize()*this.graph.getView().scale/2}updateHint(t,e){}removeHint(){}roundLength(t){return Math.round(t)}isSnapToTerminalsEvent(t){return this.snapToTerminals&&!isAltDown(t.getEvent())}getPointForEvent(t){const e=this.graph.getView(),{scale:i}=e,s=new Point(this.roundLength(t.getGraphX()/i)*i,this.roundLength(t.getGraphY()/i)*i),l=this.getSnapToTerminalTolerance();let r=!1,o=!1;if(l>0&&this.isSnapToTerminalsEvent(t)){const h=d=>{if(d){const{x:c}=d;Math.abs(s.x-c)<l&&(s.x=c,r=!0);const{y:g}=d;Math.abs(s.y-g)<l&&(s.y=g,o=!0)}},a=d=>{d&&h(new Point(e.getRoutingCenterX(d),e.getRoutingCenterY(d)))};a(this.state.getVisibleTerminalState(!0)),a(this.state.getVisibleTerminalState(!1));for(let d=0;d<this.state.absolutePoints.length;d+=1)h(this.state.absolutePoints[d])}if(this.graph.isGridEnabledEvent(t.getEvent())){const h=e.translate;r||(s.x=(this.graph.snap(s.x/i-h.x)+h.x)*i),o||(s.y=(this.graph.snap(s.y/i-h.y)+h.y)*i)}return s}getPreviewTerminalState(t){if(this.constraintHandler.update(t,this.isSource,!0,t.isSource(this.marker.highlight.shape)?null:this.currentPoint),this.constraintHandler.currentFocus&&this.constraintHandler.currentConstraint){this.marker.highlight&&this.marker.highlight.shape&&this.marker.highlight.state&&this.marker.highlight.state.cell===this.constraintHandler.currentFocus.cell?this.marker.highlight.shape.stroke!=="transparent"&&(this.marker.highlight.shape.stroke="transparent",this.marker.highlight.repaint()):this.marker.markCell(this.constraintHandler.currentFocus.cell,"transparent");const e=this.graph.view.getTerminalPort(this.state,this.graph.view.getState(this.state.cell.getTerminal(!this.isSource)),!this.isSource),i=e?e.cell:null,s=this.isSource?this.constraintHandler.currentFocus.cell:i,l=this.isSource?i:this.constraintHandler.currentFocus.cell;this.error=this.validateConnection(s,l);let r=null;return this.error===null&&(r=this.constraintHandler.currentFocus),(this.error!==null||r&&!this.isCellEnabled(r.cell))&&this.constraintHandler.reset(),r}if(!this.graph.isIgnoreTerminalEvent(t.getEvent())){this.marker.process(t);const e=this.marker.getValidState();return e&&!this.isCellEnabled(e.cell)&&(this.constraintHandler.reset(),this.marker.reset()),this.marker.getValidState()}return this.marker.reset(),null}getPreviewPoints(t,e){const i=this.state.cell.getGeometry();if(!i)return null;let s=(i.points||[]).slice();const l=new Point(t.x,t.y);let r=null;if(!this.isSource&&!this.isTarget&&this.index!==null){if(this.convertPoint(l,!1),this.index<=InternalEvent.VIRTUAL_HANDLE&&s.splice(InternalEvent.VIRTUAL_HANDLE-this.index,0,l),!this.isSource&&!this.isTarget){for(let o=0;o<this.bends.length;o+=1)if(o!==this.index){const h=this.bends[o];h&&contains(h.bounds,t.x,t.y)&&(this.index<=InternalEvent.VIRTUAL_HANDLE?s.splice(InternalEvent.VIRTUAL_HANDLE-this.index,1):s.splice(this.index-1,1),r=s)}if(!r&&this.straightRemoveEnabled&&(!e||!isAltDown(e.getEvent()))){const o=this.graph.getEventTolerance()*this.graph.getEventTolerance(),h=this.state.absolutePoints.slice();h[this.index]=t;const a=this.state.getVisibleTerminalState(!0);if(a!=null){const g=this.graph.getConnectionConstraint(this.state,a,!0);(g==null||this.graph.getConnectionPoint(a,g)==null)&&(h[0]=new Point(a.view.getRoutingCenterX(a),a.view.getRoutingCenterY(a)))}const d=this.state.getVisibleTerminalState(!1);if(d!=null){const g=this.graph.getConnectionConstraint(this.state,d,!1);(g==null||this.graph.getConnectionPoint(d,g)==null)&&(h[h.length-1]=new Point(d.view.getRoutingCenterX(d),d.view.getRoutingCenterY(d)))}((g,u)=>{g>0&&g<h.length-1&&ptSegDistSq(h[g-1].x,h[g-1].y,h[g+1].x,h[g+1].y,u.x,u.y)<o&&(s.splice(g-1,1),r=s)})(this.index,t)}}r==null&&this.index>InternalEvent.VIRTUAL_HANDLE&&(s[this.index-1]=l)}else this.graph.isResetEdgesOnConnect()&&(s=[]);return r??s}isOutlineConnectEvent(t){if(!this.currentPoint)return!1;const e=getOffset(this.graph.container),i=t.getEvent(),s=getClientX(i),l=getClientY(i),r=document.documentElement,o=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),h=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),a=this.currentPoint.x-this.graph.container.scrollLeft+e.x-o,d=this.currentPoint.y-this.graph.container.scrollTop+e.y-h;return this.outlineConnect&&!isShiftDown(t.getEvent())&&(t.isSource(this.marker.highlight.shape)||isAltDown(t.getEvent())&&t.getState()!=null||this.marker.highlight.isHighlightAt(s,l)||(a!==s||d!==l)&&t.getState()==null&&this.marker.highlight.isHighlightAt(a,d))}updatePreviewState(t,e,i,s,l=!1){const r=this.isSource?i:this.state.getVisibleTerminalState(!0),o=this.isTarget?i:this.state.getVisibleTerminalState(!1);let h=this.graph.getConnectionConstraint(t,r,!0),a=this.graph.getConnectionConstraint(t,o,!1),d=this.constraintHandler.currentConstraint;if(d==null&&l&&(i!=null?(s.isSource(this.marker.highlight.shape)&&(e=new Point(s.getGraphX(),s.getGraphY())),d=this.graph.getOutlineConstraint(e,i,s),this.constraintHandler.setFocus(s,i,this.isSource),this.constraintHandler.currentConstraint=d,this.constraintHandler.currentPoint=e):d=new ConnectionConstraint(null)),this.outlineConnect&&this.marker.highlight!=null&&this.marker.highlight.shape!=null){const c=this.graph.view.scale;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null)this.marker.highlight.shape.stroke=l?OUTLINE_HIGHLIGHT_COLOR:"transparent",this.marker.highlight.shape.strokeWidth=OUTLINE_HIGHLIGHT_STROKEWIDTH/c/c,this.marker.highlight.repaint();else if(this.marker.hasValidState()){const g=s.getCell();this.marker.highlight.shape.stroke=g&&g.isConnectable()&&this.marker.getValidState()!==s.getState()?"transparent":DEFAULT_VALID_COLOR,this.marker.highlight.shape.strokeWidth=HIGHLIGHT_STROKEWIDTH/c/c,this.marker.highlight.repaint()}}this.isSource?h=d:this.isTarget&&(a=d),(this.isSource||this.isTarget)&&(d!=null&&d.point!=null?(t.style[this.isSource?"exitX":"entryX"]=d.point.x,t.style[this.isSource?"exitY":"entryY"]=d.point.y):(delete t.style[this.isSource?"exitX":"entryX"],delete t.style[this.isSource?"exitY":"entryY"])),t.setVisibleTerminalState(r,!0),t.setVisibleTerminalState(o,!1),(!this.isSource||r!=null)&&t.view.updateFixedTerminalPoint(t,r,!0,h),(!this.isTarget||o!=null)&&t.view.updateFixedTerminalPoint(t,o,!1,a),(this.isSource||this.isTarget)&&i==null&&(t.setAbsoluteTerminalPoint(e,this.isSource),this.marker.getMarkedState()==null&&(this.error=this.graph.isAllowDanglingEdges()?null:"")),t.view.updatePoints(t,this.points,r,o),t.view.updateFloatingTerminalPoints(t,r,o)}mouseMove(t,e){var i;if(this.index!=null&&this.marker!=null){if(this.currentPoint=this.getPointForEvent(e),this.error=null,!this.graph.isIgnoreTerminalEvent(e.getEvent())&&isShiftDown(e.getEvent())&&this.snapPoint!=null&&(Math.abs(this.snapPoint.x-this.currentPoint.x)<Math.abs(this.snapPoint.y-this.currentPoint.y)?this.currentPoint.x=this.snapPoint.x:this.currentPoint.y=this.snapPoint.y),this.index<=InternalEvent.CUSTOM_HANDLE&&this.index>InternalEvent.VIRTUAL_HANDLE)this.customHandles!=null&&(this.customHandles[InternalEvent.CUSTOM_HANDLE-this.index].processEvent(e),this.customHandles[InternalEvent.CUSTOM_HANDLE-this.index].positionChanged(),this.shape!=null&&this.shape.node!=null&&(this.shape.node.style.display="none"));else if(this.isLabel&&this.label)this.label.x=this.currentPoint.x,this.label.y=this.currentPoint.y;else{this.points=this.getPreviewPoints(this.currentPoint,e);let s=this.isSource||this.isTarget?this.getPreviewTerminalState(e):null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentPoint!=null?this.currentPoint=this.constraintHandler.currentPoint.clone():this.outlineConnect&&((this.isSource||this.isTarget?this.isOutlineConnectEvent(e):!1)?s=this.marker.highlight.state:s!=null&&s!==e.getState()&&((i=e.getCell())!=null&&i.isConnectable())&&this.marker.highlight.shape!=null&&(this.marker.highlight.shape.stroke="transparent",this.marker.highlight.repaint(),s=null)),s!=null&&!this.isCellEnabled(s.cell)&&(s=null,this.marker.reset()),this.currentPoint){const l=this.clonePreviewState(this.currentPoint,s!=null?s.cell:null);this.updatePreviewState(l,this.currentPoint,s,e,this.outline);const r=this.error==null?this.marker.validColor:this.marker.invalidColor;this.setPreviewColor(r),this.abspoints=l.absolutePoints,this.active=!0,this.updateHint(e,this.currentPoint)}}this.drawPreview(),InternalEvent.consume(e.getEvent()),e.consume()}}mouseUp(t,e){if(this.index!=null&&this.marker!=null){this.shape!=null&&this.shape.node!=null&&(this.shape.node.style.display="");let i=this.state.cell;const{index:s}=this;if(this.index=null,e.getX()!==this.startX||e.getY()!==this.startY){const l=!this.graph.isIgnoreTerminalEvent(e.getEvent())&&this.graph.isCloneEvent(e.getEvent())&&this.cloneEnabled&&this.graph.isCellsCloneable();if(this.error!=null)this.error.length>0&&this.graph.validationAlert(this.error);else if(s<=InternalEvent.CUSTOM_HANDLE&&s>InternalEvent.VIRTUAL_HANDLE){if(this.customHandles!=null){const r=this.graph.getDataModel();r.beginUpdate();try{this.customHandles[InternalEvent.CUSTOM_HANDLE-s].execute(e),this.shape!=null&&this.shape.node!=null&&(this.shape.apply(this.state),this.shape.redraw())}finally{r.endUpdate()}}}else if(this.isLabel&&this.label)this.moveLabel(this.state,this.label.x,this.label.y);else if(this.isSource||this.isTarget){let r=null;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null&&(r=this.constraintHandler.currentFocus.cell),!r&&this.marker.hasValidState()&&this.marker.highlight!=null&&this.marker.highlight.shape!=null&&this.marker.highlight.shape.stroke!=="transparent"&&this.marker.highlight.shape.stroke!=="white"&&(r=this.marker.validState.cell),r){const o=this.graph.getDataModel(),h=i.getParent();o.beginUpdate();try{if(l){let a=i.getGeometry();const d=this.graph.cloneCell(i);o.add(h,d,h.getChildCount()),a!=null&&(a=a.clone(),o.setGeometry(d,a));const c=i.getTerminal(!this.isSource);this.graph.connectCell(d,c,!this.isSource),i=d}i=this.connect(i,r,this.isSource,l,e)}finally{o.endUpdate()}}else if(this.graph.isAllowDanglingEdges()){const o=this.abspoints[this.isSource?0:this.abspoints.length-1];o.x=this.roundLength(o.x/this.graph.view.scale-this.graph.view.translate.x),o.y=this.roundLength(o.y/this.graph.view.scale-this.graph.view.translate.y);const h=i.getParent(),a=h?this.graph.getView().getState(h):null;a!=null&&(o.x-=a.origin.x,o.y-=a.origin.y),o.x-=this.graph.getPanDx()/this.graph.view.scale,o.y-=this.graph.getPanDy()/this.graph.view.scale,i=this.changeTerminalPoint(i,o,this.isSource,l)}}else this.active?i=this.changePoints(i,this.points,l):(this.graph.getView().invalidate(this.state.cell),this.graph.getView().validate(this.state.cell))}else this.graph.isToggleEvent(e.getEvent())&&this.graph.selectCellForEvent(this.state.cell,e.getEvent());this.marker!=null&&(this.reset(),i!==this.state.cell&&this.graph.setSelectionCell(i)),e.consume()}}reset(){if(this.active&&this.refresh(),this.error=null,this.index=null,this.points=[],this.snapPoint=null,this.isLabel=!1,this.isSource=!1,this.isTarget=!1,this.active=!1,this.marker&&this.marker.reset(),this.constraintHandler.reset(),this.customHandles)for(let t=0;t<this.customHandles.length;t+=1)this.customHandles[t].reset();this.setPreviewColor(EdgeHandlerConfig.selectionColor),this.removeHint(),this.redraw()}setPreviewColor(t){this.shape.stroke=t}convertPoint(t,e){const i=this.graph.getView().getScale(),s=this.graph.getView().getTranslate();e&&(t.x=this.graph.snap(t.x),t.y=this.graph.snap(t.y)),t.x=Math.round(t.x/i-s.x),t.y=Math.round(t.y/i-s.y);const l=this.state.cell.getParent(),r=l&&this.graph.getView().getState(l);return r&&(t.x-=r.origin.x,t.y-=r.origin.y),t}moveLabel(t,e,i){const s=this.graph.getDataModel();let l=t.cell.getGeometry();if(l!=null){const{scale:r}=this.graph.getView();if(l=l.clone(),l.relative){let o=this.graph.getView().getRelativePoint(t,e,i);l.x=Math.round(o.x*1e4)/1e4,l.y=Math.round(o.y),l.offset=new Point(0,0),o=this.graph.view.getPoint(t,l),l.offset=new Point(Math.round((e-o.x)/r),Math.round((i-o.y)/r))}else{const o=t.absolutePoints,h=o[0],a=o[o.length-1];if(h!=null&&a!=null){const d=h.x+(a.x-h.x)/2,c=h.y+(a.y-h.y)/2;l.offset=new Point(Math.round((e-d)/r),Math.round((i-c)/r)),l.x=0,l.y=0}}s.setGeometry(t.cell,l)}}connect(t,e,i,s,l){return t.getParent(),this.graph.batchUpdate(()=>{let r=this.constraintHandler.currentConstraint;r==null&&(r=new ConnectionConstraint(null)),this.graph.connectCell(t,e,i,r)}),t}changeTerminalPoint(t,e,i,s){const l=this.graph.getDataModel();return l.batchUpdate(()=>{if(s){const o=t.getParent(),h=t.getTerminal(!i);t=this.graph.cloneCell(t),l.add(o,t,o.getChildCount()),l.setTerminal(t,h,!i)}let r=t.getGeometry();r!=null&&(r=r.clone(),r.setTerminalPoint(e,i),l.setGeometry(t,r),this.graph.connectCell(t,null,i,new ConnectionConstraint(null)))}),t}changePoints(t,e,i){const s=this.graph.getDataModel();return s.batchUpdate(()=>{if(i){const r=t.getParent(),o=t.getTerminal(!0),h=t.getTerminal(!1);t=this.graph.cloneCell(t),s.add(r,t,r.getChildCount()),s.setTerminal(t,o,!0),s.setTerminal(t,h,!1)}let l=t.getGeometry();l!=null&&(l=l.clone(),l.points=e,s.setGeometry(t,l))}),t}addPoint(t,e){const i=convertPoint(this.graph.container,getClientX(e),getClientY(e)),s=this.graph.isGridEnabledEvent(e);this.convertPoint(i,s),this.addPointAt(t,i.x,i.y),InternalEvent.consume(e)}addPointAt(t,e,i){let s=t.cell.getGeometry();const l=new Point(e,i);if(s!=null){s=s.clone();const r=this.graph.view.translate,o=this.graph.view.scale;let h=new Point(r.x*o,r.y*o);const a=this.state.cell.getParent();if(a&&a.isVertex()){const c=this.graph.view.getState(a);c&&(h=new Point(c.x,c.y))}const d=findNearestSegment(t,l.x*o+h.x,l.y*o+h.y);s.points==null?s.points=[l]:s.points.splice(d,0,l),this.graph.getDataModel().setGeometry(t.cell,s),this.refresh(),this.redraw()}}removePoint(t,e){if(e>0&&e<this.abspoints.length-1){let i=this.state.cell.getGeometry();i!=null&&i.points!=null&&(i=i.clone(),(i.points||[]).splice(e-1,1),this.graph.getDataModel().setGeometry(t.cell,i),this.refresh(),this.redraw())}}getHandleFillColor(t){const e=t===0,{cell:i}=this.state,s=i.getTerminal(e);let l=HandleConfig.fillColor;return s!=null&&!this.graph.isCellDisconnectable(i,s,e)||s==null&&!this.graph.isTerminalPointMovable(i,e)?l=LOCKED_HANDLE_FILLCOLOR:s!=null&&this.graph.isCellDisconnectable(i,s,e)&&(l=EdgeHandlerConfig.connectFillColor),l}redraw(t){this.abspoints=this.state.absolutePoints.slice();const e=this.state.cell.getGeometry();if(e){const i=e.points;if(this.bends!=null&&this.bends.length>0&&i!=null){this.points==null&&(this.points=[]);for(let s=1;s<this.bends.length-1;s+=1)this.bends[s]!=null&&this.abspoints[s]!=null&&(this.points[s-1]=i[s-1])}}this.drawPreview(),t||this.redrawHandles()}redrawHandles(){const{cell:t}=this.state;let e=this.labelShape.bounds;this.label=new Point(this.state.absoluteOffset.x,this.state.absoluteOffset.y),this.labelShape.bounds=new Rectangle(Math.round(this.label.x-e.width/2),Math.round(this.label.y-e.height/2),e.width,e.height);const i=this.graph.getLabel(t);if(this.labelShape.visible=i!=null&&i.length>0&&this.graph.isLabelMovable(t),this.bends!=null&&this.bends.length>0){const s=this.abspoints.length-1,l=this.abspoints[0],r=l.x,o=l.y;e=this.bends[0].bounds,this.bends[0].bounds=new Rectangle(Math.floor(r-e.width/2),Math.floor(o-e.height/2),e.width,e.height),this.bends[0].fill=this.getHandleFillColor(0),this.bends[0].redraw(),this.manageLabelHandle&&this.checkLabelHandle(this.bends[0].bounds);const h=this.abspoints[s],a=h.x,d=h.y,c=this.bends.length-1;e=this.bends[c].bounds,this.bends[c].bounds=new Rectangle(Math.floor(a-e.width/2),Math.floor(d-e.height/2),e.width,e.height),this.bends[c].fill=this.getHandleFillColor(c),this.bends[c].redraw(),this.manageLabelHandle&&this.checkLabelHandle(this.bends[c].bounds),this.redrawInnerBends(l,h)}if(this.virtualBends&&this.virtualBends.length>0){let s=this.abspoints[0];for(let l=0;l<this.virtualBends.length;l+=1)if(this.virtualBends[l]!=null&&this.abspoints[l+1]!=null){const r=this.abspoints[l+1],o=this.virtualBends[l],h=s.x+(r.x-s.x)/2,a=s.y+(r.y-s.y)/2;o.bounds&&(o.bounds=new Rectangle(Math.floor(h-o.bounds.width/2),Math.floor(a-o.bounds.height/2),o.bounds.width,o.bounds.height),o.redraw()),setOpacity(o.node,EdgeHandlerConfig.virtualBendOpacity),s=r,this.manageLabelHandle&&this.checkLabelHandle(o.bounds)}}if(this.labelShape.redraw(),this.customHandles)for(let s=0;s<this.customHandles.length;s+=1){const l=this.customHandles[s].shape;if(l){const r=l.node.style.display;this.customHandles[s].redraw(),l.node.style.display=r,l.node.style.visibility=this.isCustomHandleVisible(this.customHandles[s])?"":"hidden"}}}isCustomHandleVisible(t){return!this.graph.isEditing()&&this.state.view.graph.getSelectionCount()===1}setHandlesVisible(t){for(let e=0;e<this.bends.length;e+=1)this.bends[e].node.style.display=t?"":"none";if(this.virtualBends)for(let e=0;e<this.virtualBends.length;e+=1)this.virtualBends[e].node.style.display=t?"":"none";if(this.labelShape.node.style.display=t?"":"none",this.customHandles)for(let e=0;e<this.customHandles.length;e+=1)this.customHandles[e].setVisible(t)}redrawInnerBends(t,e){for(let i=1;i<this.bends.length-1;i+=1)if(this.bends[i]!=null)if(this.abspoints[i]!=null){const{x:s}=this.abspoints[i],{y:l}=this.abspoints[i],r=this.bends[i].bounds;if(this.bends[i].node.style.visibility="visible",this.bends[i].bounds=new Rectangle(Math.round(s-r.width/2),Math.round(l-r.height/2),r.width,r.height),this.manageLabelHandle)this.checkLabelHandle(this.bends[i].bounds);else if(this.handleImage==null&&this.labelShape.visible&&intersects(this.bends[i].bounds,this.labelShape.bounds)){const o=HandleConfig.size+3,h=o;this.bends[i].bounds=new Rectangle(Math.round(s-o/2),Math.round(l-h/2),o,h)}this.bends[i].redraw()}else this.bends[i].destroy()}checkLabelHandle(t){const e=this.labelShape.bounds;intersects(t,e)&&(t.getCenterY()<e.getCenterY()?e.y=t.y+t.height:e.y=t.y-e.height)}drawPreview(){try{if(this.isLabel){const t=this.labelShape.bounds,e=new Rectangle(Math.round(this.label.x-t.width/2),Math.round(this.label.y-t.height/2),t.width,t.height);t.equals(e)||(this.labelShape.bounds=e,this.labelShape.redraw())}this.shape!=null&&!equalPoints(this.shape.points,this.abspoints)&&(this.shape.apply(this.state),this.shape.points=this.abspoints.slice(),this.shape.scale=this.state.view.scale,this.shape.isDashed=this.isSelectionDashed(),this.shape.stroke=this.getSelectionColor(),this.shape.strokeWidth=this.getSelectionStrokeWidth()/this.shape.scale/this.shape.scale,this.shape.isShadow=!1,this.shape.redraw()),this.updateParentHighlight()}catch{}}refresh(){this.state!=null&&(this.abspoints=this.getSelectionPoints(this.state),this.points=[],this.destroyBends(this.bends),this.bends=this.createBends(),this.virtualBends&&(this.destroyBends(this.virtualBends),this.virtualBends=this.createVirtualBends()),this.customHandles&&(this.destroyBends(this.customHandles),this.customHandles=this.createCustomHandles()),this.labelShape!=null&&this.labelShape.node!=null&&this.labelShape.node.parentNode!=null&&this.labelShape.node.parentNode.appendChild(this.labelShape.node))}isDestroyed(){return this.shape==null}destroyBends(t){if(t!=null)for(let e=0;e<t.length;e+=1)t[e]!=null&&t[e].destroy()}onDestroy(){if(this.state.view.graph.removeListener(this.escapeHandler),this.marker.destroy(),this.marker=null,this.shape.destroy(),this.shape=null,this.parentHighlight){const t=this.state.cell.getParent(),e=t?this.graph.view.getState(t):null;e&&e.parentHighlight===this.parentHighlight&&(e.parentHighlight=null),this.parentHighlight.destroy(),this.parentHighlight=null}this.labelShape.destroy(),this.labelShape=null,this.constraintHandler.onDestroy(),this.constraintHandler=null,this.virtualBends&&(this.destroyBends(this.virtualBends),this.virtualBends=[]),this.customHandles&&(this.destroyBends(this.customHandles),this.customHandles=[]),this.destroyBends(this.bends),this.bends=[],this.removeHint()}}class EdgeHandlerCellMarker extends CellMarker{constructor(t,e,i=DEFAULT_VALID_COLOR,s=DEFAULT_INVALID_COLOR,l=DEFAULT_HOTSPOT){super(t,i,s,l),this.getCell=r=>{let o=super.getCell(r);if((o===this.edgeHandler.state.cell||!o)&&this.edgeHandler.currentPoint&&(o=this.edgeHandler.graph.getCellAt(this.edgeHandler.currentPoint.x,this.edgeHandler.currentPoint.y)),o&&!o.isConnectable()){const h=o.getParent();h&&h.isVertex()&&h.isConnectable()&&(o=h)}return o&&(this.graph.isSwimlane(o)&&this.edgeHandler.currentPoint&&this.graph.hitsSwimlaneContent(o,this.edgeHandler.currentPoint.x,this.edgeHandler.currentPoint.y)||!this.edgeHandler.isConnectableCell(o)||o===this.edgeHandler.state.cell||o&&!this.edgeHandler.graph.connectableEdges&&o.isEdge()||this.edgeHandler.state.cell.isAncestor(o))&&(o=null),o&&!o.isConnectable()&&(o=null),o},this.isValidState=r=>{const o=this.edgeHandler.state.cell.getTerminal(!this.edgeHandler.isSource),h=this.edgeHandler.graph.view.getState(o),a=this.edgeHandler.graph.view.getTerminalPort(r,h,!this.edgeHandler.isSource),d=a?a.cell:null,c=this.edgeHandler.isSource?r.cell:d,g=this.edgeHandler.isSource?d:r.cell;return this.edgeHandler.error=this.edgeHandler.validateConnection(c,g),!this.edgeHandler.error},this.edgeHandler=e}}class VertexHandler{isRotationEnabled(){return VertexHandlerConfig.rotationEnabled}constructor(t){this.sizers=[],this.singleSizer=!1,this.index=null,this.allowHandleBoundsCheck=!0,this.handleImage=null,this.handlesVisible=!0,this.tolerance=0,this.parentHighlightEnabled=!1,this.rotationRaster=!0,this.rotationCursor="crosshair",this.livePreview=!1,this.movePreviewToFront=!1,this.manageSizers=!1,this.constrainGroupByChildren=!1,this.rotationHandleVSpacing=-16,this.horizontalOffset=0,this.verticalOffset=0,this.minBounds=null,this.x0=0,this.y0=0,this.customHandles=[],this.inTolerance=!1,this.startX=0,this.startY=0,this.rotationShape=null,this.currentAlpha=null,this.startAngle=0,this.startDist=0,this.ghostPreview=null,this.livePreviewActive=!1,this.childOffsetX=0,this.childOffsetY=0,this.parentState=null,this.parentHighlight=null,this.unscaledBounds=null,this.preview=null,this.labelShape=null,this.edgeHandlers=[],this.EMPTY_POINT=new Point,this.state=t,this.graph=this.state.view.graph,this.selectionBounds=this.getSelectionBounds(this.state),this.bounds=new Rectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height),this.selectionBorder=this.createSelectionShape(this.bounds),this.selectionBorder.dialect=DIALECT.SVG,this.selectionBorder.pointerEvents=!1,this.selectionBorder.rotation=this.state.style.rotation??0,this.selectionBorder.init(this.graph.getView().getOverlayPane()),InternalEvent.redirectMouseEvents(this.selectionBorder.node,this.graph,this.state),this.graph.isCellMovable(this.state.cell)&&this.selectionBorder.setCursor(CURSOR.MOVABLE_VERTEX);const e=this.graph.getPlugin("SelectionHandler");if(e&&(e.maxCells<=0||this.graph.getSelectionCount()<e.maxCells)){const i=this.graph.isCellResizable(this.state.cell);if(this.sizers=[],i||this.graph.isLabelMovable(this.state.cell)&&this.state.width>=2&&this.state.height>=2){let s=0;i&&(this.singleSizer||(this.sizers.push(this.createSizer("nw-resize",s++)),this.sizers.push(this.createSizer("n-resize",s++)),this.sizers.push(this.createSizer("ne-resize",s++)),this.sizers.push(this.createSizer("w-resize",s++)),this.sizers.push(this.createSizer("e-resize",s++)),this.sizers.push(this.createSizer("sw-resize",s++)),this.sizers.push(this.createSizer("s-resize",s++))),this.sizers.push(this.createSizer("se-resize",s++)));const l=this.state.cell.getGeometry();l!=null&&!l.relative&&!this.graph.isSwimlane(this.state.cell)&&this.graph.isLabelMovable(this.state.cell)&&(this.labelShape=this.createSizer(CURSOR.LABEL_HANDLE,InternalEvent.LABEL_HANDLE,HandleConfig.labelSize,HandleConfig.labelFillColor),this.sizers.push(this.labelShape))}else this.graph.isCellMovable(this.state.cell)&&!this.graph.isCellResizable(this.state.cell)&&this.state.width<2&&this.state.height<2&&(this.labelShape=this.createSizer(CURSOR.MOVABLE_VERTEX,InternalEvent.LABEL_HANDLE,void 0,HandleConfig.labelFillColor),this.sizers.push(this.labelShape))}this.isRotationHandleVisible()&&(this.rotationShape=this.createSizer(this.rotationCursor,InternalEvent.ROTATION_HANDLE,HandleConfig.size+3,HandleConfig.fillColor),this.sizers.push(this.rotationShape)),this.customHandles=this.createCustomHandles(),this.redraw(),this.constrainGroupByChildren&&this.updateMinBounds(),this.escapeHandler=(i,s)=>{this.livePreview&&this.index!=null&&(this.state.view.graph.cellRenderer.redraw(this.state,!0),this.state.view.invalidate(this.state.cell),this.state.invalid=!1,this.state.view.validate()),this.reset()},this.state.view.graph.addListener(InternalEvent.ESCAPE,this.escapeHandler)}isRotationHandleVisible(){const t=this.graph.getPlugin("SelectionHandler"),e=t?t.maxCells<=0||this.graph.getSelectionCount()<t.maxCells:!0;return this.graph.isEnabled()&&this.isRotationEnabled()&&this.graph.isCellRotatable(this.state.cell)&&e}isConstrainedEvent(t){return isShiftDown(t.getEvent())||this.state.style.aspect==="fixed"}isCenteredEvent(t,e){return!1}createCustomHandles(){return[]}updateMinBounds(){const t=this.graph.getChildCells(this.state.cell);if(t.length>0&&(this.minBounds=this.graph.view.getBounds(t),this.minBounds)){const e=this.state.view.scale,i=this.state.view.translate;this.minBounds.x-=this.state.x,this.minBounds.y-=this.state.y,this.minBounds.x/=e,this.minBounds.y/=e,this.minBounds.width/=e,this.minBounds.height/=e,this.x0=this.state.x/e-i.x,this.y0=this.state.y/e-i.y}}getSelectionBounds(t){return new Rectangle(Math.round(t.x),Math.round(t.y),Math.round(t.width),Math.round(t.height))}createParentHighlightShape(t){return this.createSelectionShape(t)}createSelectionShape(t){const e=new RectangleShape(Rectangle.fromRectangle(t),NONE,this.getSelectionColor());return e.strokeWidth=this.getSelectionStrokeWidth(),e.isDashed=this.isSelectionDashed(),e}getSelectionColor(){return VertexHandlerConfig.selectionColor}getSelectionStrokeWidth(){return VertexHandlerConfig.selectionStrokeWidth}isSelectionDashed(){return VertexHandlerConfig.selectionDashed}createSizer(t,e,i=HandleConfig.size,s=HandleConfig.fillColor){const l=new Rectangle(0,0,i,i),r=this.createSizerShape(l,e,s);return r.bounds&&r.isHtmlAllowed()&&this.state.text&&this.state.text.node.parentNode===this.graph.container?(r.bounds.height-=1,r.bounds.width-=1,r.dialect=DIALECT.STRICTHTML,r.init(this.graph.container)):(r.dialect=this.graph.dialect!==DIALECT.SVG?DIALECT.MIXEDHTML:DIALECT.SVG,r.init(this.graph.getView().getOverlayPane())),InternalEvent.redirectMouseEvents(r.node,this.graph,this.state),this.graph.isEnabled()&&r.setCursor(t),this.isSizerVisible(e)||(r.visible=!1),r}isSizerVisible(t){return!0}createSizerShape(t,e,i=HandleConfig.fillColor){if(this.handleImage){t=new Rectangle(t.x,t.y,this.handleImage.width,this.handleImage.height);const l=new ImageShape(t,this.handleImage.src);return l.preserveImageAspect=!1,l}const s=HandleConfig.strokeColor;return e===InternalEvent.ROTATION_HANDLE?new EllipseShape(t,i,s):new RectangleShape(t,i,s)}moveSizerTo(t,e,i){t&&t.bounds&&(t.bounds.x=Math.floor(e-t.bounds.width/2),t.bounds.y=Math.floor(i-t.bounds.height/2),t.node&&t.node.style.display!=="none"&&t.redraw())}getHandleForEvent(t){const e=isMouseEvent(t.getEvent())?1:this.tolerance,i=this.allowHandleBoundsCheck&&e>0?new Rectangle(t.getGraphX()-e,t.getGraphY()-e,2*e,2*e):null,s=l=>{const r=l&&l.constructor!==ImageShape&&this.allowHandleBoundsCheck?l.strokeWidth+l.svgStrokeTolerance:null,o=r?new Rectangle(t.getGraphX()-Math.floor(r/2),t.getGraphY()-Math.floor(r/2),r,r):i;return l&&l.bounds&&(t.isSource(l)||o&&intersects(l.bounds,o)&&l.node.style.display!=="none"&&l.node.style.visibility!=="hidden")};if(s(this.rotationShape))return InternalEvent.ROTATION_HANDLE;if(s(this.labelShape))return InternalEvent.LABEL_HANDLE;for(let l=0;l<this.sizers.length;l+=1)if(s(this.sizers[l]))return l;if(this.customHandles!=null&&this.isCustomHandleEvent(t)){for(let l=this.customHandles.length-1;l>=0;l--)if(s(this.customHandles[l].shape))return InternalEvent.CUSTOM_HANDLE-l}return null}isCustomHandleEvent(t){return!0}mouseDown(t,e){if(!e.isConsumed()&&this.graph.isEnabled()){const i=this.getHandleForEvent(e);i&&(this.start(e.getGraphX(),e.getGraphY(),i),e.consume())}}isLivePreviewBorder(){return this.state.shape&&this.state.shape.fill===NONE&&this.state.shape.stroke===NONE}start(t,e,i){if(this.livePreviewActive=this.livePreview&&this.state.cell.getChildCount()===0,this.inTolerance=!0,this.childOffsetX=0,this.childOffsetY=0,this.index=i,this.startX=t,this.startY=e,this.index<=InternalEvent.CUSTOM_HANDLE&&this.isGhostPreview())this.ghostPreview=this.createGhostPreview();else{const{model:s}=this.state.view.graph,l=this.state.cell.getParent();if(this.state.view.currentRoot!==l&&l&&(l.isVertex()||l.isEdge())&&(this.parentState=this.state.view.graph.view.getState(l)),this.selectionBorder.node.style.display=i===InternalEvent.ROTATION_HANDLE?"inline":"none",(!this.livePreviewActive||this.isLivePreviewBorder())&&(this.preview=this.createSelectionShape(this.bounds),!(Client.IS_SVG&&(this.state.style.rotation??0)!=0)&&this.state.text!=null&&this.state.text.node.parentNode===this.graph.container?(this.preview.dialect=DIALECT.STRICTHTML,this.preview.init(this.graph.container)):(this.preview.dialect=DIALECT.SVG,this.preview.init(this.graph.view.getOverlayPane()))),i===InternalEvent.ROTATION_HANDLE){const r=this.getRotationHandlePosition(),o=r.x-this.state.getCenterX(),h=r.y-this.state.getCenterY();this.startAngle=o!==0?Math.atan(h/o)*180/Math.PI+90:0,this.startDist=Math.sqrt(o*o+h*h)}if(this.livePreviewActive){this.hideSizers(),i===InternalEvent.ROTATION_HANDLE&&this.rotationShape?this.rotationShape.node.style.display="":i===InternalEvent.LABEL_HANDLE&&this.labelShape?this.labelShape.node.style.display="":this.sizers[i]?this.sizers[i].node.style.display="":i<=InternalEvent.CUSTOM_HANDLE&&this.customHandles[InternalEvent.CUSTOM_HANDLE-i].setVisible(!0);const r=this.state.cell.getEdges();this.edgeHandlers=[];const o=this.graph.getPlugin("SelectionCellsHandler");for(let h=0;h<r.length;h+=1){const a=o==null?void 0:o.getHandler(r[h]);a&&this.edgeHandlers.push(a)}}}}createGhostPreview(){const t=this.graph.cellRenderer.createShape(this.state);return t.init(this.graph.view.getOverlayPane()),t.scale=this.state.view.scale,t.bounds=this.bounds,t.outline=!0,t}setHandlesVisible(t){this.handlesVisible=t;for(let e=0;e<this.sizers.length;e+=1)this.sizers[e].node.style.display=t?"":"none";for(let e=0;e<this.customHandles.length;e+=1)this.customHandles[e].setVisible(t)}hideSizers(){this.setHandlesVisible(!1)}checkTolerance(t){this.inTolerance&&this.startX!==null&&this.startY!==null&&(isMouseEvent(t.getEvent())||Math.abs(t.getGraphX()-this.startX)>this.graph.getEventTolerance()||Math.abs(t.getGraphY()-this.startY)>this.graph.getEventTolerance())&&(this.inTolerance=!1)}updateHint(t){}removeHint(){}roundAngle(t){return Math.round(t*10)/10}roundLength(t){return Math.round(t*100)/100}mouseMove(t,e){!e.isConsumed()&&this.index!=null?(this.checkTolerance(e),this.inTolerance||(this.index<=InternalEvent.CUSTOM_HANDLE?this.customHandles!=null&&(this.customHandles[InternalEvent.CUSTOM_HANDLE-this.index].processEvent(e),this.customHandles[InternalEvent.CUSTOM_HANDLE-this.index].active=!0,this.ghostPreview!=null?(this.ghostPreview.apply(this.state),this.ghostPreview.strokeWidth=this.getSelectionStrokeWidth()/this.ghostPreview.scale/this.ghostPreview.scale,this.ghostPreview.isDashed=this.isSelectionDashed(),this.ghostPreview.stroke=this.getSelectionColor(),this.ghostPreview.redraw(),this.selectionBounds!=null&&(this.selectionBorder.node.style.display="none")):(this.movePreviewToFront&&this.moveToFront(),this.customHandles[InternalEvent.CUSTOM_HANDLE-this.index].positionChanged())):this.index===InternalEvent.LABEL_HANDLE?this.moveLabel(e):(this.index===InternalEvent.ROTATION_HANDLE?this.rotateVertex(e):this.resizeVertex(e),this.updateHint(e))),e.consume()):!this.graph.isMouseDown&&this.getHandleForEvent(e)&&e.consume(!1)}isGhostPreview(){return this.state.cell.getChildCount()>0}moveLabel(t){const e=new Point(t.getGraphX(),t.getGraphY()),i=this.graph.view.translate,{scale:s}=this.graph.view;this.graph.isGridEnabledEvent(t.getEvent())&&(e.x=(this.graph.snap(e.x/s-i.x)+i.x)*s,e.y=(this.graph.snap(e.y/s-i.y)+i.y)*s);const l=this.rotationShape?this.sizers.length-2:this.sizers.length-1;this.moveSizerTo(this.sizers[l],e.x,e.y)}rotateVertex(t){const e=new Point(t.getGraphX(),t.getGraphY());let i=this.state.x+this.state.width/2-e.x,s=this.state.y+this.state.height/2-e.y;if(this.currentAlpha=i!==0?Math.atan(s/i)*180/Math.PI+90:s<0?180:0,i>0&&(this.currentAlpha-=180),this.currentAlpha-=this.startAngle,this.rotationRaster&&this.graph.isGridEnabledEvent(t.getEvent())){let l;i=e.x-this.state.getCenterX(),s=e.y-this.state.getCenterY();const r=Math.sqrt(i*i+s*s);r-this.startDist<2?l=15:r-this.startDist<25?l=5:l=1,this.currentAlpha=Math.round(this.currentAlpha/l)*l}else this.currentAlpha=this.roundAngle(this.currentAlpha);this.selectionBorder.rotation=this.currentAlpha,this.selectionBorder.redraw(),this.livePreviewActive&&this.redrawHandles()}resizeVertex(t){const e=new Point(this.state.getCenterX(),this.state.getCenterY()),i=toRadians(this.state.style.rotation??0),s=new Point(t.getGraphX(),t.getGraphY()),l=this.graph.view.translate,{scale:r}=this.graph.view;let o=Math.cos(-i),h=Math.sin(-i),a=s.x-this.startX,d=s.y-this.startY;const c=o*a-h*d,g=h*a+o*d;a=c,d=g;const u=this.state.cell.getGeometry();if(u&&this.index!==null&&(this.unscaledBounds=this.union(u,a/r,d/r,this.index,this.graph.isGridEnabledEvent(t.getEvent()),1,new Point(0,0),this.isConstrainedEvent(t),this.isCenteredEvent(this.state,t))),u&&!u.relative){let f=this.graph.getMaximumGraphBounds();if(f!=null&&this.parentState!=null&&(f=Rectangle.fromRectangle(f),f.x-=(this.parentState.x-l.x*r)/r,f.y-=(this.parentState.y-l.y*r)/r),this.graph.isConstrainChild(this.state.cell)){let p=this.graph.getCellContainmentArea(this.state.cell);if(p!=null){const E=this.graph.getOverlap(this.state.cell);E>0&&(p=Rectangle.fromRectangle(p),p.x-=p.width*E,p.y-=p.height*E,p.width+=2*p.width*E,p.height+=2*p.height*E),f?(f=Rectangle.fromRectangle(f),f.intersect(p)):f=p}}f&&this.unscaledBounds&&(this.unscaledBounds.x<f.x&&(this.unscaledBounds.width-=f.x-this.unscaledBounds.x,this.unscaledBounds.x=f.x),this.unscaledBounds.y<f.y&&(this.unscaledBounds.height-=f.y-this.unscaledBounds.y,this.unscaledBounds.y=f.y),this.unscaledBounds.x+this.unscaledBounds.width>f.x+f.width&&(this.unscaledBounds.width-=this.unscaledBounds.x+this.unscaledBounds.width-f.x-f.width),this.unscaledBounds.y+this.unscaledBounds.height>f.y+f.height&&(this.unscaledBounds.height-=this.unscaledBounds.y+this.unscaledBounds.height-f.y-f.height))}if(this.unscaledBounds){const f=this.bounds;this.bounds=new Rectangle((this.parentState?this.parentState.x:l.x*r)+this.unscaledBounds.x*r,(this.parentState?this.parentState.y:l.y*r)+this.unscaledBounds.y*r,this.unscaledBounds.width*r,this.unscaledBounds.height*r),u&&u.relative&&this.parentState&&(this.bounds.x+=this.state.x-this.parentState.x,this.bounds.y+=this.state.y-this.parentState.y),o=Math.cos(i),h=Math.sin(i);const p=new Point(this.bounds.getCenterX(),this.bounds.getCenterY());a=p.x-e.x,d=p.y-e.y;const E=o*a-h*d,C=h*a+o*d,y=E-a,w=C-d,v=this.bounds.x-this.state.x,S=this.bounds.y-this.state.y,I=o*v-h*S,T=h*v+o*S;this.bounds.x+=y,this.bounds.y+=w,this.unscaledBounds.x=this.roundLength(this.unscaledBounds.x+y/r),this.unscaledBounds.y=this.roundLength(this.unscaledBounds.y+w/r),this.unscaledBounds.width=this.roundLength(this.unscaledBounds.width),this.unscaledBounds.height=this.roundLength(this.unscaledBounds.height),!this.state.cell.isCollapsed()&&(y!==0||w!==0)?(this.childOffsetX=this.state.x-this.bounds.x+I,this.childOffsetY=this.state.y-this.bounds.y+T):(this.childOffsetX=0,this.childOffsetY=0),f.equals(this.bounds)||(this.livePreviewActive&&this.updateLivePreview(t),this.preview!=null?this.drawPreview():this.updateParentHighlight())}}updateLivePreview(t){const{scale:e}=this.graph.view,i=this.graph.view.translate,s=this.state.clone();this.state.x=this.bounds.x,this.state.y=this.bounds.y,this.state.origin=new Point(this.state.x/e-i.x,this.state.y/e-i.y),this.state.width=this.bounds.width,this.state.height=this.bounds.height;let l=this.state.absoluteOffset;l=new Point(l.x,l.y),this.state.absoluteOffset.x=0,this.state.absoluteOffset.y=0;const r=this.state.cell.getGeometry();if(r!=null){const o=r.offset||this.EMPTY_POINT;o!=null&&!r.relative&&(this.state.absoluteOffset.x=this.state.view.scale*o.x,this.state.absoluteOffset.y=this.state.view.scale*o.y),this.state.view.updateVertexLabelOffset(this.state)}this.state.view.graph.cellRenderer.redraw(this.state,!0),this.state.view.invalidate(this.state.cell),this.state.invalid=!1,this.state.view.validate(),this.redrawHandles(),this.movePreviewToFront&&this.moveToFront(),this.state.control!=null&&this.state.control.node!=null&&(this.state.control.node.style.visibility="hidden"),this.state.setState(s)}moveToFront(){(this.state.text&&this.state.text.node&&this.state.text.node.nextSibling||this.state.shape&&this.state.shape.node&&this.state.shape.node.nextSibling&&(!this.state.text||this.state.shape.node.nextSibling!==this.state.text.node))&&(this.state.shape&&this.state.shape.node&&this.state.shape.node.parentNode&&this.state.shape.node.parentNode.appendChild(this.state.shape.node),this.state.text&&this.state.text.node&&this.state.text.node.parentNode&&this.state.text.node.parentNode.appendChild(this.state.text.node))}mouseUp(t,e){if(this.index!=null&&this.state!=null){const i=new Point(e.getGraphX(),e.getGraphY()),{index:s}=this;this.index=null,this.ghostPreview==null&&(this.state.view.invalidate(this.state.cell,!1,!1),this.state.view.validate()),this.graph.batchUpdate(()=>{if(s<=InternalEvent.CUSTOM_HANDLE){if(this.customHandles!=null){const l=this.state.view.graph.getCellStyle(this.state.cell);this.customHandles[InternalEvent.CUSTOM_HANDLE-s].active=!1,this.customHandles[InternalEvent.CUSTOM_HANDLE-s].execute(e),this.customHandles!=null&&this.customHandles[InternalEvent.CUSTOM_HANDLE-s]!=null&&(this.state.style=l,this.customHandles[InternalEvent.CUSTOM_HANDLE-s].positionChanged())}}else if(s===InternalEvent.ROTATION_HANDLE)if(this.currentAlpha!=null){const l=this.currentAlpha-(this.state.style.rotation??0);l!==0&&this.rotateCell(this.state.cell,l)}else this.rotateClick();else{const l=this.graph.isGridEnabledEvent(e.getEvent()),r=toRadians(this.state.style.rotation??0),o=Math.cos(-r),h=Math.sin(-r);let a=i.x-this.startX,d=i.y-this.startY;const c=o*a-h*d,g=h*a+o*d;a=c,d=g;const u=this.graph.view.scale,f=this.isRecursiveResize(this.state,e);this.resizeCell(this.state.cell,this.roundLength(a/u),this.roundLength(d/u),s,l,this.isConstrainedEvent(e),f)}}),e.consume(),this.reset(),this.redrawHandles()}}isRecursiveResize(t,e){return this.graph.isRecursiveResize(this.state)}rotateClick(){}rotateCell(t,e,i){if(e!==0){const s=this.graph.getDataModel();if(t.isVertex()||t.isEdge()){if(!t.isEdge()){const o=(this.graph.getCurrentCellStyle(t).rotation??0)+e;this.graph.setCellStyles("rotation",o,[t])}let l=t.getGeometry();if(l&&i){const r=i.getGeometry();if(r!=null&&!i.isEdge()&&(l=l.clone(),l.rotate(e,new Point(r.width/2,r.height/2)),s.setGeometry(t,l)),t.isVertex()&&!l.relative||t.isEdge()){const o=t.getChildCount();for(let h=0;h<o;h+=1)this.rotateCell(t.getChildAt(h),e,t)}}}}}reset(){if(this.index!==null&&this.sizers[this.index].node.style.display==="none"&&(this.sizers[this.index].node.style.display=""),this.index=null,this.currentAlpha=null,this.preview&&(this.preview.destroy(),this.preview=null),this.ghostPreview&&(this.ghostPreview.destroy(),this.ghostPreview=null),this.livePreviewActive){for(let t=0;t<this.sizers.length;t+=1)this.sizers[t].node.style.display="";this.state.control&&this.state.control.node&&(this.state.control.node.style.visibility="")}for(let t=0;t<this.customHandles.length;t+=1)this.customHandles[t].active?(this.customHandles[t].active=!1,this.customHandles[t].reset()):this.customHandles[t].setVisible(!0);this.selectionBorder.node.style.display="inline",this.selectionBounds=this.getSelectionBounds(this.state),this.bounds=new Rectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height),this.drawPreview(),this.removeHint(),this.redrawHandles(),this.edgeHandlers=[],this.handlesVisible=!0,this.unscaledBounds=null}resizeCell(t,e,i,s,l,r,o){let h=t.getGeometry();if(h){if(s===InternalEvent.LABEL_HANDLE&&this.labelShape&&this.labelShape.bounds){const a=-toRadians(this.state.style.rotation??0),d=Math.cos(a),c=Math.sin(a),{scale:g}=this.graph.view,u=getRotatedPoint(new Point(Math.round((this.labelShape.bounds.getCenterX()-this.startX)/g),Math.round((this.labelShape.bounds.getCenterY()-this.startY)/g)),d,c);h=h.clone(),h.offset==null?h.offset=u:(h.offset.x+=u.x,h.offset.y+=u.y),this.graph.model.setGeometry(t,h)}else if(this.unscaledBounds){const{scale:a}=this.graph.view;(this.childOffsetX!==0||this.childOffsetY!==0)&&this.moveChildren(t,Math.round(this.childOffsetX/a),Math.round(this.childOffsetY/a)),this.graph.resizeCell(t,this.unscaledBounds,o)}}}moveChildren(t,e,i){const s=this.graph.getDataModel(),l=t.getChildCount();for(let r=0;r<l;r+=1){const o=t.getChildAt(r);let h=o.getGeometry();h!=null&&(h=h.clone(),h.translate(e,i),s.setGeometry(o,h))}}union(t,e,i,s,l,r,o,h,a){if(l=l&&this.graph.isGridEnabled(),this.singleSizer){let S=t.x+t.width+e,I=t.y+t.height+i;l&&(S=this.graph.snap(S/r)*r,I=this.graph.snap(I/r)*r);const T=new Rectangle(t.x,t.y,0,0);return T.add(new Rectangle(S,I,0,0)),T}const d=t.width,c=t.height;let g=t.x-o.x*r,u=g+d,f=t.y-o.y*r,p=f+c;const E=g+d/2,C=f+c/2;s>4?(p+=i,l?p=this.graph.snap(p/r)*r:p=Math.round(p/r)*r):s<3&&(f+=i,l?f=this.graph.snap(f/r)*r:f=Math.round(f/r)*r),s===0||s===3||s===5?(g+=e,l?g=this.graph.snap(g/r)*r:g=Math.round(g/r)*r):(s===2||s===4||s===7)&&(u+=e,l?u=this.graph.snap(u/r)*r:u=Math.round(u/r)*r);let y=u-g,w=p-f;if(h){const S=this.state.cell.getGeometry();if(S!=null){const I=S.width/S.height;s===1||s===2||s===7||s===6?y=w*I:w=y/I,s===0&&(g=u-y,f=p-w)}}if(a){y+=y-d,w+=w-c;const S=E-(g+y/2),I=C-(f+w/2);g+=S,f+=I,u+=S,p+=I}y<0&&(g+=y,y=Math.abs(y)),w<0&&(f+=w,w=Math.abs(w));const v=new Rectangle(g+o.x*r,f+o.y*r,y,w);return this.minBounds!=null&&(v.width=Math.max(v.width,this.minBounds.x*r+this.minBounds.width*r+Math.max(0,this.x0*r-v.x)),v.height=Math.max(v.height,this.minBounds.y*r+this.minBounds.height*r+Math.max(0,this.y0*r-v.y))),v}redraw(t){this.selectionBounds=this.getSelectionBounds(this.state),this.bounds=new Rectangle(this.selectionBounds.x,this.selectionBounds.y,this.selectionBounds.width,this.selectionBounds.height),this.drawPreview(),t||this.redrawHandles()}getHandlePadding(){const t=new Point(0,0);let e=this.tolerance;return this.sizers.length>0&&this.sizers[0].bounds&&(this.bounds.width<2*this.sizers[0].bounds.width+2*e||this.bounds.height<2*this.sizers[0].bounds.height+2*e)&&(e/=2,t.x=this.sizers[0].bounds.width+e,t.y=this.sizers[0].bounds.height+e),t}getSizerBounds(){return this.bounds}redrawHandles(){let t=this.getSizerBounds();const e=this.tolerance;this.horizontalOffset=0,this.verticalOffset=0;for(let i=0;i<this.customHandles.length;i+=1){const s=this.customHandles[i].shape;if(s){const l=s.node.style.display;this.customHandles[i].redraw(),s.node.style.display=l,s.node.style.visibility=this.handlesVisible&&this.isCustomHandleVisible(this.customHandles[i])?"":"hidden"}}if(this.sizers.length>0&&this.sizers[0]){if(this.index===null&&this.manageSizers&&this.sizers.length>=8){const l=this.getHandlePadding();this.horizontalOffset=l.x,this.verticalOffset=l.y,(this.horizontalOffset!==0||this.verticalOffset!==0)&&(t=new Rectangle(t.x,t.y,t.width,t.height),t.x-=this.horizontalOffset/2,t.width+=this.horizontalOffset,t.y-=this.verticalOffset/2,t.height+=this.verticalOffset),this.sizers.length>=8&&(this.sizers[0].bounds&&(t.width<2*this.sizers[0].bounds.width+2*e||t.height<2*this.sizers[0].bounds.height+2*e)?(this.sizers[0].node.style.display="none",this.sizers[2].node.style.display="none",this.sizers[5].node.style.display="none",this.sizers[7].node.style.display="none"):this.handlesVisible&&(this.sizers[0].node.style.display="",this.sizers[2].node.style.display="",this.sizers[5].node.style.display="",this.sizers[7].node.style.display=""))}const i=t.x+t.width,s=t.y+t.height;if(this.singleSizer)this.moveSizerTo(this.sizers[0],i,s);else{const l=t.x+t.width/2,r=t.y+t.height/2;if(this.sizers.length>=8){const o=["nw-resize","n-resize","ne-resize","e-resize","se-resize","s-resize","sw-resize","w-resize"],h=toRadians(this.state.style.rotation??0),a=Math.cos(h),d=Math.sin(h),c=Math.round(h*4/Math.PI),g=new Point(t.getCenterX(),t.getCenterY());let u=getRotatedPoint(new Point(t.x,t.y),a,d,g);this.moveSizerTo(this.sizers[0],u.x,u.y),this.sizers[0].setCursor(o[mod(0+c,o.length)]),u.x=l,u.y=t.y,u=getRotatedPoint(u,a,d,g),this.moveSizerTo(this.sizers[1],u.x,u.y),this.sizers[1].setCursor(o[mod(1+c,o.length)]),u.x=i,u.y=t.y,u=getRotatedPoint(u,a,d,g),this.moveSizerTo(this.sizers[2],u.x,u.y),this.sizers[2].setCursor(o[mod(2+c,o.length)]),u.x=t.x,u.y=r,u=getRotatedPoint(u,a,d,g),this.moveSizerTo(this.sizers[3],u.x,u.y),this.sizers[3].setCursor(o[mod(7+c,o.length)]),u.x=i,u.y=r,u=getRotatedPoint(u,a,d,g),this.moveSizerTo(this.sizers[4],u.x,u.y),this.sizers[4].setCursor(o[mod(3+c,o.length)]),u.x=t.x,u.y=s,u=getRotatedPoint(u,a,d,g),this.moveSizerTo(this.sizers[5],u.x,u.y),this.sizers[5].setCursor(o[mod(6+c,o.length)]),u.x=l,u.y=s,u=getRotatedPoint(u,a,d,g),this.moveSizerTo(this.sizers[6],u.x,u.y),this.sizers[6].setCursor(o[mod(5+c,o.length)]),u.x=i,u.y=s,u=getRotatedPoint(u,a,d,g),this.moveSizerTo(this.sizers[7],u.x,u.y),this.sizers[7].setCursor(o[mod(4+c,o.length)]),u.x=l+this.state.absoluteOffset.x,u.y=r+this.state.absoluteOffset.y,u=getRotatedPoint(u,a,d,g),this.moveSizerTo(this.sizers[8],u.x,u.y)}else this.state.width>=2&&this.state.height>=2?this.moveSizerTo(this.sizers[0],l+this.state.absoluteOffset.x,r+this.state.absoluteOffset.y):this.moveSizerTo(this.sizers[0],this.state.x,this.state.y)}}if(this.rotationShape){const i=toRadians(this.currentAlpha??this.state.style.rotation??0),s=Math.cos(i),l=Math.sin(i),r=new Point(this.state.getCenterX(),this.state.getCenterY()),o=getRotatedPoint(this.getRotationHandlePosition(),s,l,r);this.rotationShape.node!=null&&(this.moveSizerTo(this.rotationShape,o.x,o.y),this.rotationShape.node.style.visibility=this.state.view.graph.isEditing()||!this.handlesVisible?"hidden":"")}if(this.selectionBorder!=null&&(this.selectionBorder.rotation=this.state.style.rotation??0),this.edgeHandlers!=null)for(let i=0;i<this.edgeHandlers.length;i+=1)this.edgeHandlers[i].redraw()}isCustomHandleVisible(t){return!this.graph.isEditing()&&this.state.view.graph.getSelectionCount()===1}getRotationHandlePosition(){return new Point(this.bounds.x+this.bounds.width/2,this.bounds.y+this.rotationHandleVSpacing)}isParentHighlightVisible(){const t=this.state.cell.getParent();return t?!this.graph.isCellSelected(t):!1}updateParentHighlight(){if(!this.isDestroyed()){const t=this.isParentHighlightVisible(),e=this.state.cell.getParent(),i=e?this.graph.view.getState(e):null;if(this.parentHighlight)if(e&&e.isVertex()&&t){const s=this.parentHighlight.bounds;i&&s&&(s.x!==i.x||s.y!==i.y||s.width!==i.width||s.height!==i.height)&&(this.parentHighlight.bounds=Rectangle.fromRectangle(i),this.parentHighlight.redraw())}else i!=null&&i.parentHighlight===this.parentHighlight&&(i.parentHighlight=null),this.parentHighlight.destroy(),this.parentHighlight=null;else this.parentHighlightEnabled&&t&&e&&e.isVertex()&&i!=null&&i.parentHighlight==null&&(this.parentHighlight=this.createParentHighlightShape(i),this.parentHighlight.dialect=DIALECT.SVG,this.parentHighlight.pointerEvents=!1,this.parentHighlight.rotation=i.style.rotation??0,this.parentHighlight.init(this.graph.getView().getOverlayPane()),this.parentHighlight.redraw(),i.parentHighlight=this.parentHighlight)}}drawPreview(){this.preview!=null&&(this.preview.bounds=this.bounds,this.preview.node.parentNode===this.graph.container&&(this.preview.bounds.width=Math.max(0,this.preview.bounds.width-1),this.preview.bounds.height=Math.max(0,this.preview.bounds.height-1)),this.preview.rotation=this.state.style.rotation??0,this.preview.redraw()),this.selectionBorder.bounds=this.getSelectionBorderBounds(),this.selectionBorder.redraw(),this.updateParentHighlight()}getSelectionBorderBounds(){return this.bounds}isDestroyed(){return this.selectionBorder==null}onDestroy(){if(this.state.view.graph.removeListener(this.escapeHandler),this.escapeHandler=()=>{},this.preview&&(this.preview.destroy(),this.preview=null),this.parentHighlight){const t=this.state.cell.getParent(),e=t?this.graph.view.getState(t):null;e&&e.parentHighlight===this.parentHighlight&&(e.parentHighlight=null),this.parentHighlight.destroy(),this.parentHighlight=null}this.ghostPreview&&(this.ghostPreview.destroy(),this.ghostPreview=null),this.selectionBorder&&this.selectionBorder.destroy(),this.labelShape=null,this.removeHint();for(let t=0;t<this.sizers.length;t+=1)this.sizers[t].destroy();this.sizers=[];for(let t=0;t<this.customHandles.length;t+=1)this.customHandles[t].destroy();this.customHandles=[]}}class Translations{}Translations.resources={};Translations.extension=".txt";Translations.resourcesEncoded=!1;Translations.loadDefaultBundle=!0;Translations.loadSpecialBundle=!0;Translations.isLanguageSupported=n=>{const t=TranslationsConfig.getLanguages();return t?t.indexOf(n)>=0:!0};Translations.getDefaultBundle=(n,t)=>Translations.loadDefaultBundle||!Translations.isLanguageSupported(t)?n+Translations.extension:null;Translations.getSpecialBundle=(n,t)=>{if(!TranslationsConfig.getLanguages()||!Translations.isLanguageSupported(t)){const e=t.indexOf("-");e>0&&(t=t.substring(0,e))}return Translations.loadSpecialBundle&&Translations.isLanguageSupported(t)&&t!=TranslationsConfig.getDefaultLanguage()?`${n}_${t}${Translations.extension}`:null};Translations.add=(n,t=null,e=null)=>{var i;if(t??(t=((i=TranslationsConfig.getLanguage())==null?void 0:i.toLowerCase())??NONE),t!==NONE){const s=Translations.getDefaultBundle(n,t),l=Translations.getSpecialBundle(n,t),r=()=>{if(l!=null)if(e)get(l,o=>{Translations.parse(o.getText()),e()},()=>{e()});else try{const o=load(l);o.isReady()&&Translations.parse(o.getText())}catch{}else e!=null&&e()};if(s!=null)if(e)get(s,o=>{Translations.parse(o.getText()),r()},()=>{r()});else try{const o=load(s);o.isReady()&&Translations.parse(o.getText()),r()}catch{}else r()}};Translations.parse=n=>{if(n!=null){const t=n.split(`
`);for(let e=0;e<t.length;e+=1)if(t[e].charAt(0)!=="#"){const i=t[e].indexOf("=");if(i>0){const s=t[e].substring(0,i);let l=t[e].length;t[e].charCodeAt(l-1)===13&&l--;let r=t[e].substring(i+1,l);Translations.resourcesEncoded?(r=r.replace(/\\(?=u[a-fA-F\d]{4})/g,"%"),Translations.resources[s]=unescape(r)):Translations.resources[s]=r}}}};Translations.get=(n,t=null,e=null)=>{let i=Translations.resources[n];return i==null&&(i=e),i!=null&&t!=null&&(i=Translations.replacePlaceholders(i,t)),i};Translations.replacePlaceholders=(n,t)=>{const e=[];let i=null;for(let s=0;s<n.length;s+=1){const l=n.charAt(s);l==="{"?i="":i!=null&&l==="}"?(i=parseInt(i)-1,i>=0&&i<t.length&&e.push(t[i]),i=null):i!=null?i+=l:e.push(l)}return e.join("")};Translations.loadResources=n=>{Translations.add(`${Client.basePath}/resources/editor`,null,()=>{Translations.add(`${Client.basePath}/resources/graph`,null,n)})};class ElbowEdgeHandler extends EdgeHandler{constructor(t){super(t),this.flipEnabled=!0,this.doubleClickOrientationResource=TranslationsConfig.isEnabled()?"doubleClickOrientation":""}createBends(){const t=[];let e=this.createHandleShape(0);return this.initBend(e),e.setCursor(CURSOR.TERMINAL_HANDLE),t.push(e),t.push(this.createVirtualBend(i=>{!isConsumed(i)&&this.flipEnabled&&(this.graph.flipEdge(this.state.cell),InternalEvent.consume(i))})),this.points.push(new Point(0,0)),e=this.createHandleShape(2),this.initBend(e),e.setCursor(CURSOR.TERMINAL_HANDLE),t.push(e),t}createVirtualBend(t){const e=this.createHandleShape();return this.initBend(e,t),e.setCursor(this.getCursorForBend()),this.graph.isCellBendable(this.state.cell)||(e.node.style.display="none"),e}getCursorForBend(){return this.state.style.edgeStyle===EDGESTYLE.TOPTOBOTTOM||this.state.style.edgeStyle===EDGESTYLE.ELBOW&&this.state.style.elbow===ELBOW.VERTICAL?"row-resize":"col-resize"}getTooltipForNode(t){let e=null;return this.bends!=null&&this.bends[1]!=null&&(t===this.bends[1].node||t.parentNode===this.bends[1].node)&&(e=this.doubleClickOrientationResource,e=Translations.get(e)||e),e}convertPoint(t,e){const i=this.graph.getView().getScale(),s=this.graph.getView().getTranslate(),{origin:l}=this.state;return e&&(t.x=this.graph.snap(t.x),t.y=this.graph.snap(t.y)),t.x=Math.round(t.x/i-s.x-l.x),t.y=Math.round(t.y/i-s.y-l.y),t}redrawInnerBends(t,e){const i=this.state.cell.getGeometry(),s=this.state.absolutePoints;let l=null;s.length>1?(t=s[1],e=s[s.length-2]):i.points!=null&&i.points.length>0&&(l=s[0]),l==null?l=new Point(t.x+(e.x-t.x)/2,t.y+(e.y-t.y)/2):l=new Point(this.graph.getView().scale*(l.x+this.graph.getView().translate.x+this.state.origin.x),this.graph.getView().scale*(l.y+this.graph.getView().translate.y+this.state.origin.y));const r=this.bends[1].bounds;let o=r.width,h=r.height,a=new Rectangle(Math.round(l.x-o/2),Math.round(l.y-h/2),o,h);this.manageLabelHandle?this.checkLabelHandle(a):this.handleImage==null&&this.labelShape.visible&&this.labelShape.bounds&&intersects(a,this.labelShape.bounds)&&(o=HandleConfig.size+3,h=o,a=new Rectangle(Math.floor(l.x-o/2),Math.floor(l.y-h/2),o,h)),this.bends[1].bounds=a,this.bends[1].redraw(),this.manageLabelHandle&&this.checkLabelHandle(this.bends[1].bounds)}}class EdgeSegmentHandler extends ElbowEdgeHandler{constructor(t){super(t),this.points=[]}getCurrentPoints(){let t=this.state.absolutePoints;const e=Math.max(1,this.graph.view.scale);if(t.length===2&&t[0]&&t[1]||t.length===3&&t[0]&&t[1]&&t[2]&&(Math.abs(t[0].x-t[1].x)<e&&Math.abs(t[1].x-t[2].x)<e||Math.abs(t[0].y-t[1].y)<e&&Math.abs(t[1].y-t[2].y)<e)){const i=t[0].x+(t[t.length-1].x-t[0].x)/2,s=t[0].y+(t[t.length-1].y-t[0].y)/2;t=[t[0],new Point(i,s),new Point(i,s),t[t.length-1]]}return t}getPreviewPoints(t){if(this.isSource||this.isTarget)return super.getPreviewPoints(t);const e=this.getCurrentPoints();let i=this.convertPoint(e[0].clone(),!1);t=this.convertPoint(t.clone(),!1);let s=[];for(let l=1;l<e.length;l+=1){const r=this.convertPoint(e[l].clone(),!1);l===this.index&&(Math.round(i.x-r.x)===0&&(i.x=t.x,r.x=t.x),Math.round(i.y-r.y)===0&&(i.y=t.y,r.y=t.y)),l<e.length-1&&s.push(r),i=r}if(s.length===1){const l=this.state.getVisibleTerminalState(!0),r=this.state.getVisibleTerminalState(!1),o=this.state.view.getScale(),h=this.state.view.getTranslate(),a=s[0].x*o+h.x,d=s[0].y*o+h.y;(l!=null&&contains(l,a,d)||r!=null&&contains(r,a,d))&&(s=[t,t])}return s}updatePreviewState(t,e,i,s){if(super.updatePreviewState(t,e,i,s),!this.isSource&&!this.isTarget){e=this.convertPoint(e.clone(),!1);const l=t.absolutePoints;let r=l[0],o=l[1],h=[];for(let u=2;u<l.length;u+=1){const f=l[u];(Math.round(r.x-o.x)!==0||Math.round(o.x-f.x)!==0)&&(Math.round(r.y-o.y)!==0||Math.round(o.y-f.y)!==0)&&h.push(this.convertPoint(o.clone(),!1)),r=o,o=f}const a=this.state.getVisibleTerminalState(!0),d=this.state.getVisibleTerminalState(!1),c=this.state.absolutePoints,g=l[l.length-1];if(h.length===0&&l[0]&&g&&(Math.round(l[0].x-g.x)===0||Math.round(l[0].y-g.y)===0))h=[e,e];else if(l.length===5&&h.length===2&&a!=null&&d!=null&&c!=null&&Math.round(c[0].x-c[c.length-1].x)===0){const u=this.graph.getView(),f=u.getScale(),p=u.getTranslate();let E=u.getRoutingCenterY(a)/f-p.y;const C=this.graph.getConnectionConstraint(t,a,!0);if(C!=null){const v=this.graph.getConnectionPoint(a,C);v!=null&&(this.convertPoint(v,!1),E=v.y)}let y=u.getRoutingCenterY(d)/f-p.y;const w=this.graph.getConnectionConstraint(t,d,!1);if(w){const v=this.graph.getConnectionPoint(d,w);v!=null&&(this.convertPoint(v,!1),y=v.y)}h=[new Point(e.x,E),new Point(e.x,y)]}this.points=h,t.view.updateFixedTerminalPoints(t,a,d),t.view.updatePoints(t,this.points,a,d),t.view.updateFloatingTerminalPoints(t,a,d)}}connect(t,e,i,s,l){const r=this.graph.getDataModel();let o=t.getGeometry(),h=null;if(o!=null&&o.points!=null&&o.points.length>0){const a=this.abspoints;let d=a[0],c=a[1];h=[];for(let g=2;g<a.length;g+=1){const u=a[g];d&&c&&u&&(Math.round(d.x-c.x)!==0||Math.round(c.x-u.x)!==0)&&(Math.round(d.y-c.y)!==0||Math.round(c.y-u.y)!==0)&&h.push(this.convertPoint(c.clone(),!1)),d=c,c=u}}return this.graph.batchUpdate(()=>{h!=null&&(o=t.getGeometry(),o!=null&&(o=o.clone(),o.points=h,r.setGeometry(t,o))),t=super.connect(t,e,i,s,l)}),t}getTooltipForNode(t){return null}start(t,e,i){super.start(t,e,i),this.bends!=null&&this.bends[i]!=null&&!this.isSource&&!this.isTarget&&setOpacity(this.bends[i].node,100)}createBends(){const t=[];let e=this.createHandleShape(0);this.initBend(e),e.setCursor(CURSOR.TERMINAL_HANDLE),t.push(e);const i=this.getCurrentPoints();if(this.graph.isCellBendable(this.state.cell)){this.points==null&&(this.points=[]);for(let s=0;s<i.length-1;s+=1){e=this.createVirtualBend(),t.push(e);let l=Math.round(i[s].x-i[s+1].x)===0;Math.round(i[s].y-i[s+1].y)===0&&s<i.length-2&&(l=Math.round(i[s].x-i[s+2].x)===0),e.setCursor(l?"col-resize":"row-resize"),this.points.push(new Point(0,0))}}return e=this.createHandleShape(i.length),this.initBend(e),e.setCursor(CURSOR.TERMINAL_HANDLE),t.push(e),t}redraw(){this.refresh(),super.redraw()}redrawInnerBends(t,e){if(this.graph.isCellBendable(this.state.cell)){const i=this.getCurrentPoints();if(i!=null&&i.length>1){let s=!1;if(i.length===4&&i[0]&&i[1]&&i[2]&&i[3]&&Math.round(i[1].x-i[2].x)===0&&Math.round(i[1].y-i[2].y)===0)if(s=!0,Math.round(i[0].y-i[i.length-1].y)===0){const l=i[0].x+(i[i.length-1].x-i[0].x)/2;i[1]=new Point(l,i[1].y),i[2]=new Point(l,i[2].y)}else{const l=i[0].y+(i[i.length-1].y-i[0].y)/2;i[1]=new Point(i[1].x,l),i[2]=new Point(i[2].x,l)}for(let l=0;l<i.length-1;l+=1)if(this.bends[l+1]!=null){t=i[l],e=i[l+1];const r=new Point(t.x+(e.x-t.x)/2,t.y+(e.y-t.y)/2),o=this.bends[l+1].bounds;this.bends[l+1].bounds=new Rectangle(Math.floor(r.x-o.width/2),Math.floor(r.y-o.height/2),o.width,o.height),this.bends[l+1].redraw(),this.manageLabelHandle&&this.checkLabelHandle(this.bends[l+1].bounds)}s&&(setOpacity(this.bends[1].node,EdgeHandlerConfig.virtualBendOpacity),setOpacity(this.bends[3].node,EdgeHandlerConfig.virtualBendOpacity))}}}}class SelectionChange{constructor(t,e=[],i=[]){this.graph=t,this.added=e.slice(),this.removed=i.slice()}execute(){const t=this.graph.getSelectionModel();for(const e of this.removed)t.cellRemoved(e);for(const e of this.added)t.cellAdded(e);[this.added,this.removed]=[this.removed,this.added],t.fireEvent(new EventObject(InternalEvent.CHANGE,{added:this.added,removed:this.removed}))}}class GraphSelectionModel extends EventSource{constructor(t){super(),this.doneResource=TranslationsConfig.isEnabled()?"done":"",this.updatingSelectionResource=TranslationsConfig.isEnabled()?"updatingSelection":"",this.singleSelection=!1,this.graph=t,this.cells=[]}isSingleSelection(){return this.singleSelection}setSingleSelection(t){this.singleSelection=t}isSelected(t){return this.cells.indexOf(t)>=0}isEmpty(){return this.cells.length===0}clear(){this.changeSelection(null,this.cells)}setCell(t){this.setCells(t?[t]:[])}setCells(t){this.singleSelection&&(t=[this.getFirstSelectableCell(t)]);const e=[];for(let i=0;i<t.length;i+=1)this.graph.isCellSelectable(t[i])&&e.push(t[i]);this.changeSelection(e,this.cells)}getFirstSelectableCell(t){for(let e=0;e<t.length;e+=1)if(this.graph.isCellSelectable(t[e]))return t[e];return null}addCell(t){this.addCells([t])}addCells(t){let e=null;if(this.singleSelection){e=this.cells;const s=this.getFirstSelectableCell(t);t=s?[s]:[]}const i=[];for(let s=0;s<t.length;s+=1)!this.isSelected(t[s])&&this.graph.isCellSelectable(t[s])&&i.push(t[s]);this.changeSelection(i,e)}removeCell(t){this.removeCells([t])}removeCells(t){const e=[];for(let i=0;i<t.length;i+=1)this.isSelected(t[i])&&e.push(t[i]);this.changeSelection(null,e)}changeSelection(t=null,e=null){if(t&&t.length>0&&t[0]||e&&e.length>0&&e[0]){const i=new SelectionChange(this.graph,t||[],e||[]);i.execute();const s=new UndoableEdit(this.graph,!1);s.add(i),this.fireEvent(new EventObject(InternalEvent.UNDO,{edit:s}))}}cellAdded(t){this.isSelected(t)||this.cells.push(t)}cellRemoved(t){const e=this.cells.indexOf(t);e>=0&&this.cells.splice(e,1)}}class RhombusShape extends Shape{constructor(t,e,i,s=1){super(),this.bounds=t,this.fill=e,this.stroke=i,this.strokeWidth=s}isRoundable(){return!0}paintVertexShape(t,e,i,s,l){var a;const r=s/2,o=l/2,h=(((a=this.style)==null?void 0:a.arcSize)??LINE_ARCSIZE)/2;t.begin(),this.addPoints(t,[new Point(e+r,i),new Point(e+s,i+o),new Point(e+r,i+l),new Point(e,i+o)],this.isRounded,h,!0),t.fillAndStroke()}}class CylinderShape extends Shape{constructor(t,e,i,s=1){super(),this.maxHeight=40,this.svgStrokeTolerance=0,this.bounds=t,this.fill=e,this.stroke=i,this.strokeWidth=s}paintVertexShape(t,e,i,s,l){t.translate(e,i),t.begin(),this.redrawPath(t,e,i,s,l,!1),t.fillAndStroke(),(!this.outline||!this.style||!(this.style.backgroundOutline??!1))&&(t.setShadow(!1),t.begin(),this.redrawPath(t,e,i,s,l,!0),t.stroke())}getCylinderSize(t,e,i,s){return Math.min(this.maxHeight,Math.round(s/5))}redrawPath(t,e,i,s,l,r=!1){const o=this.getCylinderSize(e,i,s,l);(r&&this.fill!==NONE||!r&&this.fill===NONE)&&(t.moveTo(0,o),t.curveTo(0,2*o,s,2*o,s,o),r||(t.stroke(),t.begin())),r||(t.moveTo(0,o),t.curveTo(0,-o/3,s,-o/3,s,o),t.lineTo(s,l-o),t.curveTo(s,l+o/3,0,l+o/3,0,l-o),t.close())}}class ActorShape extends Shape{constructor(t=null,e=NONE,i=NONE,s=1){super(),this.bounds=t,this.fill=e,this.stroke=i,this.strokeWidth=s}paintVertexShape(t,e,i,s,l){t.translate(e,i),t.begin(),this.redrawPath(t,e,i,s,l),t.fillAndStroke()}redrawPath(t,e,i,s,l){const r=s/3;t.moveTo(0,l),t.curveTo(0,3*l/5,0,2*l/5,s/2,2*l/5),t.curveTo(s/2-r,2*l/5,s/2-r,0,s/2,0),t.curveTo(s/2+r,0,s/2+r,2*l/5,s/2,2*l/5),t.curveTo(s,2*l/5,s,3*l/5,s,l),t.close()}}class TriangleShape extends ActorShape{constructor(){super()}isRoundable(){return!0}redrawPath(t,e,i,s,l){var o;const r=(((o=this.style)==null?void 0:o.arcSize)??LINE_ARCSIZE)/2;this.addPoints(t,[new Point(0,0),new Point(s,.5*l),new Point(0,l)],this.isRounded,r,!0)}}class HexagonShape extends ActorShape{constructor(){super()}redrawPath(t,e,i,s,l){var o;const r=(((o=this.style)==null?void 0:o.arcSize)??LINE_ARCSIZE)/2;this.addPoints(t,[new Point(.25*s,0),new Point(.75*s,0),new Point(s,.5*l),new Point(.75*s,l),new Point(.25*s,l),new Point(0,.5*l)],this.isRounded,r,!0)}}class CloudShape extends ActorShape{constructor(t,e,i,s=1){super(),this.bounds=t,this.fill=e,this.stroke=i,this.strokeWidth=s}redrawPath(t,e,i,s,l){t.moveTo(.25*s,.25*l),t.curveTo(.05*s,.25*l,0,.5*l,.16*s,.55*l),t.curveTo(0,.66*l,.18*s,.9*l,.31*s,.8*l),t.curveTo(.4*s,l,.7*s,l,.8*s,.8*l),t.curveTo(s,.8*l,s,.6*l,.875*s,.5*l),t.curveTo(s,.3*l,.8*s,.1*l,.625*s,.2*l),t.curveTo(.5*s,.05*l,.3*s,.05*l,.25*s,.25*l),t.close()}}class LineShape extends Shape{constructor(t,e,i=1,s=!1){super(),this.bounds=t,this.stroke=e,this.strokeWidth=i,this.vertical=s}paintVertexShape(t,e,i,s,l){if(t.begin(),this.vertical){const r=e+s/2;t.moveTo(r,i),t.lineTo(r,i+l)}else{const r=i+l/2;t.moveTo(e,r),t.lineTo(e+s,r)}t.stroke()}}class ArrowShape extends Shape{constructor(t,e,i,s=1,l=ARROW_WIDTH,r=ARROW_SPACING,o=ARROW_SIZE){super(),this.points=t,this.fill=e,this.stroke=i,this.strokeWidth=s,this.arrowWidth=l,this.spacing=r,this.endSize=o}augmentBoundingBox(t){super.augmentBoundingBox(t);const e=Math.max(this.arrowWidth,this.endSize);t.grow((e/2+this.strokeWidth)*this.scale)}paintEdgeShape(t,e){const i=ARROW_SPACING,s=ARROW_WIDTH,l=ARROW_SIZE,r=e[0],o=e[e.length-1],h=o.x-r.x,a=o.y-r.y,d=Math.sqrt(h*h+a*a),c=d-2*i-l,g=h/d,u=a/d,f=c*g,p=c*u,E=s*u/3,C=-30*g/3,y=r.x-E/2+i*g,w=r.y-C/2+i*u,v=y+E,S=w+C,I=v+f,T=S+p,A=I+E,R=T+C,N=A-3*E,O=R-3*C;t.begin(),t.moveTo(y,w),t.lineTo(v,S),t.lineTo(I,T),t.lineTo(A,R),t.lineTo(o.x-i*g,o.y-i*u),t.lineTo(N,O),t.lineTo(N+E,O+C),t.close(),t.fillAndStroke()}}class ArrowConnectorShape extends Shape{constructor(t,e,i,s=1,l=ARROW_WIDTH,r=ARROW_SPACING,o=ARROW_SIZE/5){super(),this.useSvgBoundingBox=!0,this.points=t,this.fill=e,this.stroke=i,this.strokeWidth=s,this.arrowWidth=l,this.arrowSpacing=r,this.startSize=ARROW_SIZE/5,this.endSize=o}isRoundable(){return!0}resetStyles(){super.resetStyles(),this.arrowSpacing=ARROW_SPACING}apply(t){super.apply(t),this.style&&this.style.startSize!=null&&this.style.endSize!=null&&(this.startSize=this.style.startSize*3,this.endSize=this.style.endSize*3)}augmentBoundingBox(t){super.augmentBoundingBox(t);let e=this.getEdgeWidth();this.isMarkerStart()&&(e=Math.max(e,this.getStartArrowWidth())),this.isMarkerEnd()&&(e=Math.max(e,this.getEndArrowWidth())),t.grow((e/2+this.strokeWidth)*this.scale)}paintEdgeShape(t,e){var L;let i=this.strokeWidth;this.outline&&(i=Math.max(1,((L=this.style)==null?void 0:L.strokeWidth)??0));const s=this.getStartArrowWidth()+i,l=this.getEndArrowWidth()+i,r=this.outline?this.getEdgeWidth()+i:this.getEdgeWidth(),o=this.isOpenEnded(),h=this.isMarkerStart(),a=this.isMarkerEnd(),d=o?0:this.arrowSpacing+i/2,c=this.startSize+i,g=this.endSize+i,u=this.isArrowRounded(),f=e[e.length-1];let p=1;for(;p<e.length-1&&e[p].x===e[0].x&&e[p].y===e[0].y;)p++;const E=e[p].x-e[0].x,C=e[p].y-e[0].y,y=Math.sqrt(E*E+C*C);if(y===0)return;let w=E/y,v,S=w,I=C/y,T,A=I,R=r*I,N=-r*w;const O=[];u?t.setLineJoin("round"):e.length>2&&t.setMiterLimit(1.42),t.begin();const G=w,Y=I;if(h&&!o)this.paintMarker(t,e[0].x,e[0].y,w,I,c,s,r,d,!0);else{const M=e[0].x+R/2+d*w,P=e[0].y+N/2+d*I,H=e[0].x-R/2+d*w,V=e[0].y-N/2+d*I;o?(t.moveTo(M,P),O.push(()=>{t.lineTo(H,V)})):(t.moveTo(H,V),t.lineTo(M,P))}let Z=0,x=0,b=0;for(let M=0;M<e.length-2;M+=1){const P=relativeCcw(e[M].x,e[M].y,e[M+1].x,e[M+1].y,e[M+2].x,e[M+2].y);if(Z=e[M+2].x-e[M+1].x,x=e[M+2].y-e[M+1].y,b=Math.sqrt(Z*Z+x*x),b!==0){S=Z/b,A=x/b;const H=w*S+I*A,V=Math.max(Math.sqrt((H+1)/2),.04);v=w+S,T=I+A;const B=Math.sqrt(v*v+T*T);if(B!==0){v/=B,T/=B;const F=Math.max(V,Math.min(this.strokeWidth/200+.04,.35)),D=P!==0&&u?Math.max(.1,F):Math.max(V,.06),U=e[M+1].x+T*r/2/D,_=e[M+1].y-v*r/2/D,W=e[M+1].x-T*r/2/D,z=e[M+1].y+v*r/2/D;if(P===0||!u)t.lineTo(U,_),(($,K)=>{O.push(()=>{t.lineTo($,K)})})(W,z);else if(P===-1){const $=W+I*r,K=z-w*r,k=W+A*r,X=z-S*r;t.lineTo($,K),t.quadTo(U,_,k,X),((tt,q)=>{O.push(()=>{t.lineTo(tt,q)})})(W,z)}else t.lineTo(U,_),(($,K)=>{const k=U-I*r,X=_+w*r,tt=U-A*r,q=_+S*r;O.push(()=>{t.quadTo($,K,k,X)}),O.push(()=>{t.lineTo(tt,q)})})(W,z);w=S,I=A}}}if(R=r*A,N=-r*S,a&&!o)this.paintMarker(t,f.x,f.y,-w,-I,g,l,r,d,!1);else{t.lineTo(f.x-d*S+R/2,f.y-d*A+N/2);const M=f.x-d*S-R/2,P=f.y-d*A-N/2;o?(t.moveTo(M,P),O.splice(0,0,()=>{t.moveTo(M,P)})):t.lineTo(M,P)}for(let M=O.length-1;M>=0;M--)O[M]();o?(t.end(),t.stroke()):(t.close(),t.fillAndStroke()),t.setShadow(!1),t.setMiterLimit(4),u&&t.setLineJoin("flat"),e.length>2&&(t.setMiterLimit(4),h&&!o&&(t.begin(),this.paintMarker(t,e[0].x,e[0].y,G,Y,c,s,r,d,!0),t.stroke(),t.end()),a&&!o&&(t.begin(),this.paintMarker(t,f.x,f.y,-w,-I,g,l,r,d,!0),t.stroke(),t.end()))}paintMarker(t,e,i,s,l,r,o,h,a,d){const c=h/o,g=h*l/2,u=-h*s/2,f=(a+r)*s,p=(a+r)*l;d?t.moveTo(e-g+f,i-u+p):t.lineTo(e-g+f,i-u+p),t.lineTo(e-g/c+f,i-u/c+p),t.lineTo(e+a*s,i+a*l),t.lineTo(e+g/c+f,i+u/c+p),t.lineTo(e+g+f,i+u+p)}isArrowRounded(){return this.isRounded}getStartArrowWidth(){return ARROW_WIDTH}getEndArrowWidth(){return ARROW_WIDTH}getEdgeWidth(){return ARROW_WIDTH/3}isOpenEnded(){return!1}isMarkerStart(){var t;return(((t=this.style)==null?void 0:t.startArrow)??NONE)!==NONE}isMarkerEnd(){var t;return(((t=this.style)==null?void 0:t.endArrow)??NONE)!==NONE}}class DoubleEllipseShape extends Shape{constructor(t,e,i,s=1){super(),this.bounds=t,this.fill=e,this.stroke=i,this.strokeWidth=s}paintBackground(t,e,i,s,l){t.ellipse(e,i,s,l),t.fillAndStroke()}paintForeground(t,e,i,s,l){var r;if(!this.outline){const o=((r=this.style)==null?void 0:r.margin)??Math.min(3+this.strokeWidth,Math.min(s/5,l/5));e+=o,i+=o,s-=2*o,l-=2*o,s>0&&l>0&&t.ellipse(e,i,s,l),t.stroke()}}getLabelBounds(t){var i;const e=((i=this.style)==null?void 0:i.margin)??Math.min(3+this.strokeWidth,Math.min(t.width/5/this.scale,t.height/5/this.scale))*this.scale;return new Rectangle(t.x+e,t.y+e,t.width-2*e,t.height-2*e)}}class SwimlaneShape extends Shape{constructor(t,e,i,s=1){super(),this.imageSize=16,this.imageSrc=null,this.bounds=t,this.fill=e,this.stroke=i,this.strokeWidth=s}isRoundable(t,e,i,s,l){return!0}getTitleSize(){var t;return Math.max(0,((t=this.style)==null?void 0:t.startSize)??DEFAULT_STARTSIZE)}getLabelBounds(t){var c,g;const e=this.getTitleSize(),i=new Rectangle(t.x,t.y,t.width,t.height),s=this.isHorizontal(),l=((c=this.style)==null?void 0:c.flipH)??!1,r=((g=this.style)==null?void 0:g.flipV)??!1,o=this.direction===DIRECTION.NORTH||this.direction===DIRECTION.SOUTH,h=s==!o,a=!h&&l!==(this.direction===DIRECTION.SOUTH||this.direction===DIRECTION.WEST),d=h&&r!==(this.direction===DIRECTION.SOUTH||this.direction===DIRECTION.WEST);if(o){const u=Math.min(i.width,e*this.scale);(a||d)&&(i.x+=i.width-u),i.width=u}else{const u=Math.min(i.height,e*this.scale);(a||d)&&(i.y+=i.height-u),i.height=u}return i}getGradientBounds(t,e,i,s,l){let r=this.getTitleSize();return this.isHorizontal()?(r=Math.min(r,l),new Rectangle(e,i,s,r)):(r=Math.min(r,s),new Rectangle(e,i,r,l))}getSwimlaneArcSize(t,e,i){var l,r,o;if(((l=this.style)==null?void 0:l.absoluteArcSize)??!1)return Math.min(t/2,Math.min(e/2,((r=this.style)==null?void 0:r.arcSize)??LINE_ARCSIZE/2));const s=(((o=this.style)==null?void 0:o.arcSize)??RECTANGLE_ROUNDING_FACTOR*100)/100;return i*s*3}isHorizontal(){var t;return((t=this.style)==null?void 0:t.horizontal)??!0}paintVertexShape(t,e,i,s,l){var c,g,u;let r=this.getTitleSize();const o=((c=this.style)==null?void 0:c.swimlaneFillColor)??NONE,h=((g=this.style)==null?void 0:g.swimlaneLine)??!0;let a=0;this.isHorizontal()?r=Math.min(r,l):r=Math.min(r,s),t.translate(e,i),this.isRounded?(a=this.getSwimlaneArcSize(s,l,r),a=Math.min((this.isHorizontal()?l:s)-r,Math.min(r,a)),this.paintRoundedSwimlane(t,e,i,s,l,r,a,o,h)):this.paintSwimlane(t,e,i,s,l,r,o,h);const d=((u=this.style)==null?void 0:u.separatorColor)??NONE;if(this.paintSeparator(t,e,i,s,l,r,d),this.imageSrc){const f=this.getImageBounds(e,i,s,l);t.image(f.x-e,f.y-i,f.width,f.height,this.imageSrc,!1,!1,!1)}this.glass&&(t.setShadow(!1),this.paintGlassEffect(t,0,0,s,r,a))}paintSwimlane(t,e,i,s,l,r,o,h){t.begin();let a=!0;this.style&&this.style.pointerEvents!=null&&(a=this.style.pointerEvents),!a&&this.fill===NONE&&(t.pointerEvents=!1),this.isHorizontal()?(t.moveTo(0,r),t.lineTo(0,0),t.lineTo(s,0),t.lineTo(s,r),t.fillAndStroke(),r<l&&((o===NONE||!a)&&(t.pointerEvents=!1),o!==NONE&&t.setFillColor(o),t.begin(),t.moveTo(0,r),t.lineTo(0,l),t.lineTo(s,l),t.lineTo(s,r),o===NONE?t.stroke():t.fillAndStroke())):(t.moveTo(r,0),t.lineTo(0,0),t.lineTo(0,l),t.lineTo(r,l),t.fillAndStroke(),r<s&&((o===NONE||!a)&&(t.pointerEvents=!1),o!==NONE&&t.setFillColor(o),t.begin(),t.moveTo(r,0),t.lineTo(s,0),t.lineTo(s,l),t.lineTo(r,l),o===NONE?t.stroke():t.fillAndStroke())),h&&this.paintDivider(t,e,i,s,l,r,o===NONE)}paintRoundedSwimlane(t,e,i,s,l,r,o,h,a){t.begin();let d=!0;this.style&&this.style.pointerEvents!=null&&(d=this.style.pointerEvents),!d&&this.fill===NONE&&(t.pointerEvents=!1),this.isHorizontal()?(t.moveTo(s,r),t.lineTo(s,o),t.quadTo(s,0,s-Math.min(s/2,o),0),t.lineTo(Math.min(s/2,o),0),t.quadTo(0,0,0,o),t.lineTo(0,r),t.fillAndStroke(),r<l&&((h===NONE||!d)&&(t.pointerEvents=!1),h!==NONE&&t.setFillColor(h),t.begin(),t.moveTo(0,r),t.lineTo(0,l-o),t.quadTo(0,l,Math.min(s/2,o),l),t.lineTo(s-Math.min(s/2,o),l),t.quadTo(s,l,s,l-o),t.lineTo(s,r),h===NONE?t.stroke():t.fillAndStroke())):(t.moveTo(r,0),t.lineTo(o,0),t.quadTo(0,0,0,Math.min(l/2,o)),t.lineTo(0,l-Math.min(l/2,o)),t.quadTo(0,l,o,l),t.lineTo(r,l),t.fillAndStroke(),r<s&&((h===NONE||!d)&&(t.pointerEvents=!1),h!==NONE&&t.setFillColor(h),t.begin(),t.moveTo(r,l),t.lineTo(s-o,l),t.quadTo(s,l,s,l-Math.min(l/2,o)),t.lineTo(s,Math.min(l/2,o)),t.quadTo(s,0,s-o,0),t.lineTo(r,0),h===NONE?t.stroke():t.fillAndStroke())),a&&this.paintDivider(t,e,i,s,l,r,h===NONE)}paintDivider(t,e,i,s,l,r,o){o||t.setShadow(!1),t.begin(),this.isHorizontal()?(t.moveTo(0,r),t.lineTo(s,r)):(t.moveTo(r,0),t.lineTo(r,l)),t.stroke()}paintSeparator(t,e,i,s,l,r,o){o!==NONE&&(t.setStrokeColor(o),t.setDashed(!0),t.begin(),this.isHorizontal()?(t.moveTo(s,r),t.lineTo(s,l)):(t.moveTo(r,0),t.lineTo(s,0)),t.stroke(),t.setDashed(!1))}getImageBounds(t,e,i,s){return this.isHorizontal()?new Rectangle(t+i-this.imageSize,e,this.imageSize,this.imageSize):new Rectangle(t,e,this.imageSize,this.imageSize)}}class LabelShape extends RectangleShape{constructor(t,e,i,s){super(t,e,i,s),this.imageSize=DEFAULT_IMAGESIZE,this.imageSrc=null,this.spacing=2,this.indicatorSize=10,this.indicatorSpacing=2,this.indicatorImageSrc=null}init(t){super.init(t),this.indicatorShape&&(this.indicator=new this.indicatorShape,this.indicator.dialect=this.dialect,this.indicator.init(this.node))}redraw(){this.indicator&&(this.indicator.fill=this.indicatorColor,this.indicator.stroke=this.indicatorStrokeColor,this.indicator.gradient=this.indicatorGradientColor,this.indicator.direction=this.indicatorDirection,this.indicator.redraw()),super.redraw()}isHtmlAllowed(){return super.isHtmlAllowed()&&this.indicatorColor===NONE&&!!this.indicatorShape}paintForeground(t,e,i,s,l){this.paintImage(t,e,i,s,l),this.paintIndicator(t,e,i,s,l),super.paintForeground(t,e,i,s,l)}paintImage(t,e,i,s,l){if(this.imageSrc){const r=this.getImageBounds(e,i,s,l);t.image(r.x,r.y,r.width,r.height,this.imageSrc,!1,!1,!1)}}getImageBounds(t,e,i,s){var d,c,g,u,f;const l=((d=this.style)==null?void 0:d.imageAlign)??ALIGN.LEFT,r=((c=this.style)==null?void 0:c.verticalAlign)??ALIGN.MIDDLE,o=((g=this.style)==null?void 0:g.imageWidth)??DEFAULT_IMAGESIZE,h=((u=this.style)==null?void 0:u.imageHeight)??DEFAULT_IMAGESIZE,a=((f=this.style)==null?void 0:f.spacing)??this.spacing+5;return l===ALIGN.CENTER?t+=(i-o)/2:l===ALIGN.RIGHT?t+=i-o-a:t+=a,r===ALIGN.TOP?e+=a:r===ALIGN.BOTTOM?e+=s-h-a:e+=(s-h)/2,new Rectangle(t,e,o,h)}paintIndicator(t,e,i,s,l){if(this.indicator)this.indicator.bounds=this.getIndicatorBounds(e,i,s,l),this.indicator.paint(t);else if(this.indicatorImageSrc){const r=this.getIndicatorBounds(e,i,s,l);t.image(r.x,r.y,r.width,r.height,this.indicatorImageSrc,!1,!1,!1)}}getIndicatorBounds(t,e,i,s){var d,c,g,u;const l=((d=this.style)==null?void 0:d.imageAlign)??ALIGN.LEFT,r=((c=this.style)==null?void 0:c.verticalAlign)??ALIGN.MIDDLE,o=((g=this.style)==null?void 0:g.indicatorWidth)??this.indicatorSize,h=((u=this.style)==null?void 0:u.indicatorHeight)??this.indicatorSize,a=this.spacing+5;return l===ALIGN.RIGHT?t+=i-o-a:l===ALIGN.CENTER?t+=(i-o)/2:t+=a,r===ALIGN.BOTTOM?e+=s-h-a:r===ALIGN.TOP?e+=a:e+=(s-h)/2,new Rectangle(t,e,o,h)}redrawHtmlShape(){for(super.redrawHtmlShape();this.node.hasChildNodes();)this.node.removeChild(this.node.lastChild);if(this.imageSrc&&this.bounds){const t=document.createElement("img");t.style.position="relative",t.setAttribute("border","0");const e=this.getImageBounds(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height);e.x-=this.bounds.x,e.y-=this.bounds.y,t.style.left=`${Math.round(e.x)}px`,t.style.top=`${Math.round(e.y)}px`,t.style.width=`${Math.round(e.width)}px`,t.style.height=`${Math.round(e.height)}px`,t.src=this.imageSrc,this.node.appendChild(t)}}}let isDefaultElementsRegistered=!1;function registerDefaultShapes(){if(!isDefaultElementsRegistered){const n=[[SHAPE.ACTOR,ActorShape],[SHAPE.ARROW,ArrowShape],[SHAPE.ARROW_CONNECTOR,ArrowConnectorShape],[SHAPE.CONNECTOR,ConnectorShape],[SHAPE.CLOUD,CloudShape],[SHAPE.CYLINDER,CylinderShape],[SHAPE.DOUBLE_ELLIPSE,DoubleEllipseShape],[SHAPE.ELLIPSE,EllipseShape],[SHAPE.HEXAGON,HexagonShape],[SHAPE.IMAGE,ImageShape],[SHAPE.LABEL,LabelShape],[SHAPE.LINE,LineShape],[SHAPE.RECTANGLE,RectangleShape],[SHAPE.RHOMBUS,RhombusShape],[SHAPE.SWIMLANE,SwimlaneShape],[SHAPE.TRIANGLE,TriangleShape]];for(const[t,e]of n)CellRenderer.registerShape(t,e);isDefaultElementsRegistered=!0}}const EllipsePerimeter=(n,t,e,i=!1)=>{const{x:s}=n,{y:l}=n,r=n.width/2,o=n.height/2,h=s+r,a=l+o,d=e.x,c=e.y,g=parseInt(String(d-h)),u=parseInt(String(c-a));if(g===0&&u!==0)return new Point(h,a+o*u/Math.abs(u));if(g===0&&u===0)return new Point(d,c);if(i){if(c>=l&&c<=l+n.height){const G=c-a;let Y=Math.sqrt(r*r*(1-G*G/(o*o)))||0;return d<=s&&(Y=-Y),new Point(h+Y,c)}if(d>=s&&d<=s+n.width){const G=d-h;let Y=Math.sqrt(o*o*(1-G*G/(r*r)))||0;return c<=l&&(Y=-Y),new Point(d,a+Y)}}const f=u/g,p=a-f*h,E=r*r*f*f+o*o,C=-2*h*E,y=r*r*f*f*h*h+o*o*h*h-r*r*o*o,w=Math.sqrt(C*C-4*E*y),v=(-C+w)/(2*E),S=(-C-w)/(2*E),I=f*v+p,T=f*S+p,A=Math.sqrt(Math.pow(v-d,2)+Math.pow(I-c,2)),R=Math.sqrt(Math.pow(S-d,2)+Math.pow(T-c,2));let N=0,O=0;return A<R?(N=v,O=I):(N=S,O=T),new Point(N,O)},HexagonPerimeter=(n,t,e,i=!1)=>{var I;const{x:s}=n,{y:l}=n,r=n.width,o=n.height,h=n.getCenterX(),a=n.getCenterY(),d=e.x,c=e.y,g=d-h,u=c-a,f=-Math.atan2(u,g),p=Math.PI,E=Math.PI/2;let C=new Point(h,a);const y=((I=t==null?void 0:t.style)==null?void 0:I.direction)??DIRECTION.EAST,w=y===DIRECTION.NORTH||y===DIRECTION.SOUTH;let v=new Point,S=new Point;if((d<s&&c<l||d<s&&c>l+o||d>s+r&&c<l||d>s+r&&c>l+o)&&(i=!1),i){if(w){if(d===h){if(c<=l)return new Point(h,l);if(c>=l+o)return new Point(h,l+o)}else if(d<s){if(c===l+o/4)return new Point(s,l+o/4);if(c===l+3*o/4)return new Point(s,l+3*o/4)}else if(d>s+r){if(c===l+o/4)return new Point(s+r,l+o/4);if(c===l+3*o/4)return new Point(s+r,l+3*o/4)}else if(d===s){if(c<a)return new Point(s,l+o/4);if(c>a)return new Point(s,l+3*o/4)}else if(d===s+r){if(c<a)return new Point(s+r,l+o/4);if(c>a)return new Point(s+r,l+3*o/4)}if(c===l)return new Point(h,l);if(c===l+o)return new Point(h,l+o);d<h?c>l+o/4&&c<l+3*o/4?(v=new Point(s,l),S=new Point(s,l+o)):c<l+o/4?(v=new Point(s-Math.floor(.5*r),l+Math.floor(.5*o)),S=new Point(s+r,l-Math.floor(.25*o))):c>l+3*o/4&&(v=new Point(s-Math.floor(.5*r),l+Math.floor(.5*o)),S=new Point(s+r,l+Math.floor(1.25*o))):d>h&&(c>l+o/4&&c<l+3*o/4?(v=new Point(s+r,l),S=new Point(s+r,l+o)):c<l+o/4?(v=new Point(s,l-Math.floor(.25*o)),S=new Point(s+Math.floor(1.5*r),l+Math.floor(.5*o))):c>l+3*o/4&&(v=new Point(s+Math.floor(1.5*r),l+Math.floor(.5*o)),S=new Point(s,l+Math.floor(1.25*o))))}else{if(c===a){if(d<=s)return new Point(s,l+o/2);if(d>=s+r)return new Point(s+r,l+o/2)}else if(c<l){if(d===s+r/4)return new Point(s+r/4,l);if(d===s+3*r/4)return new Point(s+3*r/4,l)}else if(c>l+o){if(d===s+r/4)return new Point(s+r/4,l+o);if(d===s+3*r/4)return new Point(s+3*r/4,l+o)}else if(c===l){if(d<h)return new Point(s+r/4,l);if(d>h)return new Point(s+3*r/4,l)}else if(c===l+o){if(d<h)return new Point(s+r/4,l+o);if(c>a)return new Point(s+3*r/4,l+o)}if(d===s)return new Point(s,a);if(d===s+r)return new Point(s+r,a);c<a?d>s+r/4&&d<s+3*r/4?(v=new Point(s,l),S=new Point(s+r,l)):d<s+r/4?(v=new Point(s-Math.floor(.25*r),l+o),S=new Point(s+Math.floor(.5*r),l-Math.floor(.5*o))):d>s+3*r/4&&(v=new Point(s+Math.floor(.5*r),l-Math.floor(.5*o)),S=new Point(s+Math.floor(1.25*r),l+o)):c>a&&(d>s+r/4&&d<s+3*r/4?(v=new Point(s,l+o),S=new Point(s+r,l+o)):d<s+r/4?(v=new Point(s-Math.floor(.25*r),l),S=new Point(s+Math.floor(.5*r),l+Math.floor(1.5*o))):d>s+3*r/4&&(v=new Point(s+Math.floor(.5*r),l+Math.floor(1.5*o)),S=new Point(s+Math.floor(1.25*r),l)))}let T=h,A=a;d>=s&&d<=s+r?(T=d,c<a?A=l+o:A=l):c>=l&&c<=l+o&&(A=c,d<h?T=s+r:T=s),C=intersection(T,A,e.x,e.y,v.x,v.y,S.x,S.y)}else{if(w){const T=Math.atan2(o/4,r/2);if(f===T)return new Point(s+r,l+Math.floor(.25*o));if(f===E)return new Point(s+Math.floor(.5*r),l);if(f===p-T)return new Point(s,l+Math.floor(.25*o));if(f===-T)return new Point(s+r,l+Math.floor(.75*o));if(f===-E)return new Point(s+Math.floor(.5*r),l+o);if(f===-p+T)return new Point(s,l+Math.floor(.75*o));f<T&&f>-T?(v=new Point(s+r,l),S=new Point(s+r,l+o)):f>T&&f<E?(v=new Point(s,l-Math.floor(.25*o)),S=new Point(s+Math.floor(1.5*r),l+Math.floor(.5*o))):f>E&&f<p-T?(v=new Point(s-Math.floor(.5*r),l+Math.floor(.5*o)),S=new Point(s+r,l-Math.floor(.25*o))):f>p-T&&f<=p||f<-p+T&&f>=-p?(v=new Point(s,l),S=new Point(s,l+o)):f<-T&&f>-E?(v=new Point(s+Math.floor(1.5*r),l+Math.floor(.5*o)),S=new Point(s,l+Math.floor(1.25*o))):f<-E&&f>-p+T&&(v=new Point(s-Math.floor(.5*r),l+Math.floor(.5*o)),S=new Point(s+r,l+Math.floor(1.25*o)))}else{const T=Math.atan2(o/2,r/4);if(f===T)return new Point(s+Math.floor(.75*r),l);if(f===p-T)return new Point(s+Math.floor(.25*r),l);if(f===p||f===-p)return new Point(s,l+Math.floor(.5*o));if(f===0)return new Point(s+r,l+Math.floor(.5*o));if(f===-T)return new Point(s+Math.floor(.75*r),l+o);if(f===-p+T)return new Point(s+Math.floor(.25*r),l+o);f>0&&f<T?(v=new Point(s+Math.floor(.5*r),l-Math.floor(.5*o)),S=new Point(s+Math.floor(1.25*r),l+o)):f>T&&f<p-T?(v=new Point(s,l),S=new Point(s+r,l)):f>p-T&&f<p?(v=new Point(s-Math.floor(.25*r),l+o),S=new Point(s+Math.floor(.5*r),l-Math.floor(.5*o))):f<0&&f>-T?(v=new Point(s+Math.floor(.5*r),l+Math.floor(1.5*o)),S=new Point(s+Math.floor(1.25*r),l)):f<-T&&f>-p+T?(v=new Point(s,l+o),S=new Point(s+r,l+o)):f<-p+T&&f>-p&&(v=new Point(s-Math.floor(.25*r),l),S=new Point(s+Math.floor(.5*r),l+Math.floor(1.5*o)))}C=intersection(h,a,e.x,e.y,v.x,v.y,S.x,S.y)}return C??new Point(h,a)},RectanglePerimeter=(n,t,e,i=!1)=>{const s=n.getCenterX(),l=n.getCenterY(),r=e.x-s,o=e.y-l,h=Math.atan2(o,r),a=new Point(0,0),d=Math.PI,g=Math.PI/2-h,u=Math.atan2(n.height,n.width);return h<-d+u||h>d-u?(a.x=n.x,a.y=l-n.width*Math.tan(h)/2):h<-u?(a.y=n.y,a.x=s-n.height*Math.tan(g)/2):h<u?(a.x=n.x+n.width,a.y=l+n.width*Math.tan(h)/2):(a.y=n.y+n.height,a.x=s+n.height*Math.tan(g)/2),i&&(e.x>=n.x&&e.x<=n.x+n.width?a.x=e.x:e.y>=n.y&&e.y<=n.y+n.height&&(a.y=e.y),e.x<n.x?a.x=n.x:e.x>n.x+n.width&&(a.x=n.x+n.width),e.y<n.y?a.y=n.y:e.y>n.y+n.height&&(a.y=n.y+n.height)),a},RhombusPerimeter=(n,t,e,i=!1)=>{const{x:s}=n,{y:l}=n,r=n.width,o=n.height,h=s+r/2,a=l+o/2,d=e.x,c=e.y;if(h===d)return a>c?new Point(h,l):new Point(h,l+o);if(a===c)return h>d?new Point(s,a):new Point(s+r,a);let g=h,u=a;return i&&(d>=s&&d<=s+r?g=d:c>=l&&c<=l+o&&(u=c)),d<h?c<a?intersection(d,c,g,u,h,l,s,a):intersection(d,c,g,u,h,l+o,s,a):c<a?intersection(d,c,g,u,h,l,s+r,a):intersection(d,c,g,u,h,l+o,s+r,a)},TrianglePerimeter=(n,t,e,i=!1)=>{const s=t!=null?t.style.direction:null,l=s===DIRECTION.NORTH||s===DIRECTION.SOUTH,{x:r}=n,{y:o}=n,h=n.width,a=n.height;let d=r+h/2,c=o+a/2,g=new Point(r,o),u=new Point(r+h,c),f=new Point(r,o+a);s===DIRECTION.NORTH?(g=f,u=new Point(d,o),f=new Point(r+h,o+a)):s===DIRECTION.SOUTH?(u=new Point(d,o+a),f=new Point(r+h,o)):s===DIRECTION.WEST&&(g=new Point(r+h,o),u=new Point(r,c),f=new Point(r+h,o+a));let p=e.x-d,E=e.y-c;const C=l?Math.atan2(p,E):Math.atan2(E,p),y=l?Math.atan2(h,a):Math.atan2(a,h);let w=!1;s===DIRECTION.NORTH||s===DIRECTION.WEST?w=C>-y&&C<y:w=C<-Math.PI+y||C>Math.PI-y;let v=null;if(w)i&&(l&&e.x>=g.x&&e.x<=f.x||!l&&e.y>=g.y&&e.y<=f.y)?l?v=new Point(e.x,g.y):v=new Point(g.x,e.y):s===DIRECTION.NORTH?v=new Point(r+h/2+a*Math.tan(C)/2,o+a):s===DIRECTION.SOUTH?v=new Point(r+h/2-a*Math.tan(C)/2,o):s===DIRECTION.WEST?v=new Point(r+h,o+a/2+h*Math.tan(C)/2):v=new Point(r,o+a/2-h*Math.tan(C)/2);else{if(i){const S=new Point(d,c);e.y>=o&&e.y<=o+a?(S.x=l?d:s===DIRECTION.WEST?r+h:r,S.y=e.y):e.x>=r&&e.x<=r+h&&(S.x=e.x,S.y=l?s===DIRECTION.NORTH?o+a:o:c),p=e.x-S.x,E=e.y-S.y,d=S.x,c=S.y}l&&e.x<=r+h/2||!l&&e.y<=o+a/2?v=intersection(e.x,e.y,d,c,g.x,g.y,u.x,u.y):v=intersection(e.x,e.y,d,c,u.x,u.y,f.x,f.y)}return v==null&&(v=new Point(d,c)),v},Perimeter={RectanglePerimeter,EllipsePerimeter,RhombusPerimeter,TrianglePerimeter,HexagonPerimeter};let isDefaultsRegistered=!1;const registerDefaultStyleElements=()=>{isDefaultsRegistered||(StyleRegistry.putValue(EDGESTYLE.ELBOW,EdgeStyle.ElbowConnector),StyleRegistry.putValue(EDGESTYLE.ENTITY_RELATION,EdgeStyle.EntityRelation),StyleRegistry.putValue(EDGESTYLE.LOOP,EdgeStyle.Loop),StyleRegistry.putValue(EDGESTYLE.MANHATTAN,EdgeStyle.ManhattanConnector),StyleRegistry.putValue(EDGESTYLE.ORTHOGONAL,EdgeStyle.OrthConnector),StyleRegistry.putValue(EDGESTYLE.SEGMENT,EdgeStyle.SegmentConnector),StyleRegistry.putValue(EDGESTYLE.SIDETOSIDE,EdgeStyle.SideToSide),StyleRegistry.putValue(EDGESTYLE.TOPTOBOTTOM,EdgeStyle.TopToBottom),StyleRegistry.putValue(PERIMETER.ELLIPSE,Perimeter.EllipsePerimeter),StyleRegistry.putValue(PERIMETER.HEXAGON,Perimeter.HexagonPerimeter),StyleRegistry.putValue(PERIMETER.RECTANGLE,Perimeter.RectanglePerimeter),StyleRegistry.putValue(PERIMETER.RHOMBUS,Perimeter.RhombusPerimeter),StyleRegistry.putValue(PERIMETER.TRIANGLE,Perimeter.TrianglePerimeter),isDefaultsRegistered=!0)},CellsMixin={cellsResizable:!0,cellsBendable:!0,cellsSelectable:!0,cellsDisconnectable:!0,autoSizeCells:!1,autoSizeCellsOnAdd:!1,cellsLocked:!1,cellsCloneable:!0,cellsDeletable:!0,cellsMovable:!0,extendParents:!0,extendParentsOnAdd:!0,extendParentsOnMove:!1,getBoundingBox(n){let t=null;if(n.length>0){for(const e of n)if(e.isVertex()||e.isEdge()){const i=this.getView().getBoundingBox(this.getView().getState(e),!0);i&&(t?t.add(i):t=Rectangle.fromRectangle(i))}}return t},removeStateForCell(n){for(const t of n.getChildren())this.removeStateForCell(t);this.getView().invalidate(n,!1,!0),this.getView().removeState(n)},getCurrentCellStyle(n,t=!1){const e=t?null:this.getView().getState(n);return e?e.style:this.getCellStyle(n)},getCellStyle(n){const t=n.getStyle(),e=this.getStylesheet(),i=n.isEdge()?e.getDefaultEdgeStyle():e.getDefaultVertexStyle();return this.postProcessCellStyle(e.getCellStyle(t,i??{}))},postProcessCellStyle(n){if(!n.image)return n;const t=n.image;let e=this.getImageFromBundles(t);if(e?n.image=e:e=t,e&&e.substring(0,11)==="data:image/"){if(e.substring(0,20)==="data:image/svg+xml,<")e=e.substring(0,19)+encodeURIComponent(e.substring(19));else if(e.substring(0,22)!=="data:image/svg+xml,%3C"){const i=e.indexOf(",");i>0&&e.substring(i-7,i+1)!==";base64,"&&(e=`${e.substring(0,i)};base64,${e.substring(i+1)}`)}n.image=e}return n},setCellStyle(n,t){t=t??this.getSelectionCells(),this.batchUpdate(()=>{for(const e of t)this.getDataModel().setStyle(e,n)})},toggleCellStyle(n,t=!1,e){return e=e??this.getSelectionCell(),this.toggleCellStyles(n,t,[e])},toggleCellStyles(n,t=!1,e){let i=!1;return e=e??this.getSelectionCells(),e.length>0&&(i=!(this.getCurrentCellStyle(e[0])[n]??t),this.setCellStyles(n,i,e)),i},setCellStyles(n,t,e){e=e??this.getSelectionCells(),setCellStyles(this.getDataModel(),e,n,t)},toggleCellStyleFlags(n,t,e){e=e??this.getSelectionCells(),this.setCellStyleFlags(n,t,null,e)},setCellStyleFlags(n,t,e=null,i){i=i??this.getSelectionCells(),i.length>0&&(e===null&&(e=((this.getCurrentCellStyle(i[0])[n]||0)&t)!==t),setCellStyleFlags(this.getDataModel(),i,n,t,e))},alignCells(n,t,e=null){if(t=t??this.getSelectionCells(),t.length>1){if(e===null)for(const i of t){const s=this.getView().getState(i);if(s&&!i.isEdge())if(e===null)if(n===ALIGN.CENTER){e=s.x+s.width/2;break}else if(n===ALIGN.RIGHT)e=s.x+s.width;else if(n===ALIGN.TOP)e=s.y;else if(n===ALIGN.MIDDLE){e=s.y+s.height/2;break}else n===ALIGN.BOTTOM?e=s.y+s.height:e=s.x;else n===ALIGN.RIGHT?e=Math.max(e,s.x+s.width):n===ALIGN.TOP?e=Math.min(e,s.y):n===ALIGN.BOTTOM?e=Math.max(e,s.y+s.height):e=Math.min(e,s.x)}if(e!==null){const i=this.getView().scale;this.batchUpdate(()=>{const s=e;for(const l of t){const r=this.getView().getState(l);if(r!=null){let o=l.getGeometry();o!=null&&!l.isEdge()&&(o=o.clone(),n===ALIGN.CENTER?o.x+=(s-r.x-r.width/2)/i:n===ALIGN.RIGHT?o.x+=(s-r.x-r.width)/i:n===ALIGN.TOP?o.y+=(s-r.y)/i:n===ALIGN.MIDDLE?o.y+=(s-r.y-r.height/2)/i:n===ALIGN.BOTTOM?o.y+=(s-r.y-r.height)/i:o.x+=(s-r.x)/i,this.resizeCell(l,o))}}this.fireEvent(new EventObject(InternalEvent.ALIGN_CELLS,{align:n,cells:t}))})}}return t},cloneCell(n,t=!1,e={},i=!1){return this.cloneCells([n],t,e,i)[0]},cloneCells(n,t=!0,e={},i=!1){let s;const l=new Dictionary,r=[];for(const o of n)l.put(o,!0),r.push(o);if(r.length>0){const{scale:o}=this.getView(),h=this.getView().translate,a=[];s=cloneCells(n,!0,e);for(let d=0;d<n.length;d+=1){const c=n[d],g=s[d];if(!(!t&&g.isEdge()&&this.getEdgeValidationError(g,g.getTerminal(!0),g.getTerminal(!1))!==null)){a.push(g);const u=g.getGeometry();if(u){const f=this.getView().getState(c),p=c.getParent(),E=p?this.getView().getState(p):null;if(f&&E){const C=i?0:E.origin.x,y=i?0:E.origin.y;if(g.isEdge()){const w=f.absolutePoints;let v=c.getTerminal(!0);for(;v&&!l.get(v);)v=v.getParent();!v&&w[0]&&u.setTerminalPoint(new Point(w[0].x/o-h.x,w[0].y/o-h.y),!0);let S=c.getTerminal(!1);for(;S&&!l.get(S);)S=S.getParent();const I=w.length-1,T=w[I];!S&&T&&u.setTerminalPoint(new Point(T.x/o-h.x,T.y/o-h.y),!1);const{points:A}=u;if(A)for(const R of A)R.x+=C,R.y+=y}else u.translate(C,y)}}}}s=a}else s=[];return s},addCell(n,t=null,e=null,i=null,s=null){return this.addCells([n],t,e,i,s)[0]},addCells(n,t=null,e=null,i=null,s=null,l=!1){const r=t??this.getDefaultParent(),o=e??r.getChildCount();return this.batchUpdate(()=>{this.cellsAdded(n,r,o,i,s,l,!0),this.fireEvent(new EventObject(InternalEvent.ADD_CELLS,{cells:n,p:r,i:o,source:i,target:s}))}),n},cellsAdded(n,t,e,i=null,s=null,l=!1,r=!1,o=!0){this.batchUpdate(()=>{const h=l?this.getView().getState(t):null,a=h?h.origin:null,d=new Point(0,0);n.forEach((c,g)=>{const u=c.getParent();if(a&&c!==t&&t!==u){const f=u?this.getView().getState(u):null,p=f?f.origin:d;let E=c.getGeometry();if(E){const C=p.x-a.x,y=p.y-a.y;E=E.clone(),E.translate(C,y),!E.relative&&c.isVertex()&&!this.isAllowNegativeCoordinates()&&(E.x=Math.max(0,E.x),E.y=Math.max(0,E.y)),this.getDataModel().setGeometry(c,E)}}t===u&&e+g>t.getChildCount()&&e--,this.getDataModel().add(t,c,e+g),this.autoSizeCellsOnAdd&&this.autoSizeCell(c,!0),(!o||o)&&this.isExtendParentsOnAdd(c)&&this.isExtendParent(c)&&this.extendParent(c),(!r||r)&&this.constrainChild(c),i&&this.cellConnected(c,i,!0),s&&this.cellConnected(c,s,!1)}),this.fireEvent(new EventObject(InternalEvent.CELLS_ADDED,{cells:n,parent:t,index:e,source:i,target:s,absolute:l}))})},autoSizeCell(n,t=!0){if(t)for(const e of n.getChildren())this.autoSizeCell(e);n.isVertex()&&this.isAutoSizeCell(n)&&this.updateCellSize(n)},removeCells(n=null,t=!0){if(n||(n=this.getDeletableCells(this.getSelectionCells())),t)n=this.getDeletableCells(this.addAllEdges(n));else{n=n.slice();const e=this.getDeletableCells(this.getAllEdges(n)),i=new Dictionary;for(const s of n)i.put(s,!0);for(const s of e)!this.getView().getState(s)&&!i.get(s)&&(i.put(s,!0),n.push(s))}return this.batchUpdate(()=>{this.cellsRemoved(n),this.fireEvent(new EventObject(InternalEvent.REMOVE_CELLS,{cells:n,includeEdges:t}))}),n??[]},cellsRemoved(n){if(n.length>0){const{scale:t}=this.getView(),e=this.getView().translate;this.batchUpdate(()=>{const i=new Dictionary;for(const s of n)i.put(s,!0);for(const s of n){const l=this.getAllEdges([s]),r=(o,h)=>{let a=o.getGeometry();if(a){const d=o.getTerminal(h);let c=!1,g=d;for(;g;){if(s===g){c=!0;break}g=g.getParent()}if(c){a=a.clone();const u=this.getView().getState(o);if(u){const f=u.absolutePoints,p=h?0:f.length-1,E=f[p];a.setTerminalPoint(new Point(E.x/t-e.x-u.origin.x,E.y/t-e.y-u.origin.y),h)}else if(d){const f=this.getView().getState(d);f&&a.setTerminalPoint(new Point(f.getCenterX()/t-e.x,f.getCenterY()/t-e.y),h)}this.getDataModel().setGeometry(o,a),this.getDataModel().setTerminal(o,null,h)}}};for(const o of l)i.get(o)||(i.put(o,!0),r(o,!0),r(o,!1));this.getDataModel().remove(s)}this.fireEvent(new EventObject(InternalEvent.CELLS_REMOVED,{cells:n}))})}},toggleCells(n=!1,t,e=!0){return t=t??this.getSelectionCells(),e&&(t=this.addAllEdges(t)),this.batchUpdate(()=>{this.cellsToggled(t,n),this.fireEvent(new EventObject(InternalEvent.TOGGLE_CELLS,{show:n,cells:t,includeEdges:e}))}),t},cellsToggled(n,t=!1){n.length>0&&this.batchUpdate(()=>{for(const e of n)this.getDataModel().setVisible(e,t)})},updateCellSize(n,t=!1){return this.batchUpdate(()=>{this.cellSizeUpdated(n,t),this.fireEvent(new EventObject(InternalEvent.UPDATE_CELL_SIZE,{cell:n,ignoreChildren:t}))}),n},cellSizeUpdated(n,t=!1){this.batchUpdate(()=>{const e=this.getPreferredSizeForCell(n);let i=n.getGeometry();if(e&&i){const s=n.isCollapsed();if(i=i.clone(),this.isSwimlane(n)){const l=this.getCellStyle(n),r=n.getStyle();l.horizontal??!0?(r.startSize=e.height+8,s&&(i.height=e.height+8),i.width=e.width):(r.startSize=e.width+8,s&&(i.width=e.width+8),i.height=e.height),this.getDataModel().setStyle(n,r)}else{const l=this.getView().createState(n),r=l.style.align??ALIGN.CENTER;r===ALIGN.RIGHT?i.x+=i.width-e.width:r===ALIGN.CENTER&&(i.x+=Math.round((i.width-e.width)/2));const o=l.getVerticalAlign();o===ALIGN.BOTTOM?i.y+=i.height-e.height:o===ALIGN.MIDDLE&&(i.y+=Math.round((i.height-e.height)/2)),i.width=e.width,i.height=e.height}if(!t&&!s){const l=this.getView().getBounds(n.getChildren());if(l!=null){const r=this.getView().translate,{scale:o}=this.getView(),h=(l.x+l.width)/o-i.x-r.x,a=(l.y+l.height)/o-i.y-r.y;i.width=Math.max(i.width,h),i.height=Math.max(i.height,a)}}this.cellsResized([n],[i],!1)}})},getPreferredSizeForCell(n,t=null){let e=null;const i=this.getView().createState(n),{style:s}=i;if(!n.isEdge()){const l=s.fontSize||DEFAULT_FONTSIZE;let r=0,o=0;(i.getImageSrc()||s.image)&&s.shape===SHAPE.LABEL&&(s.verticalAlign===ALIGN.MIDDLE&&(r+=s.imageWidth||DEFAULT_IMAGESIZE),s.align!==ALIGN.CENTER&&(o+=s.imageHeight||DEFAULT_IMAGESIZE)),r+=2*(s.spacing||0),r+=s.spacingLeft||0,r+=s.spacingRight||0,o+=2*(s.spacing||0),o+=s.spacingTop||0,o+=s.spacingBottom||0;const h=this.getFoldingImage(i);h&&(r+=h.width+8);let a=this.getCellRenderer().getLabelValue(i);if(a&&a.length>0){this.isHtmlLabel(i.cell)||(a=htmlEntities(a,!1)),a=a.replace(/\n/g,"<br>");const d=getSizeForString(a,l,s.fontFamily,t,s.fontStyle);let c=d.width+r,g=d.height+o;if(!(s.horizontal??!0)){const u=g;g=c,c=u}this.isGridEnabled()&&(c=this.snap(c+this.getGridSize()/2),g=this.snap(g+this.getGridSize()/2)),e=new Rectangle(0,0,c,g)}else{const d=4*this.getGridSize();e=new Rectangle(0,0,d,d)}}return e},resizeCell(n,t,e=!1){return this.resizeCells([n],[t],e)[0]},resizeCells(n,t,e){return e=e??this.isRecursiveResize(),this.batchUpdate(()=>{const i=this.cellsResized(n,t,e);this.fireEvent(new EventObject(InternalEvent.RESIZE_CELLS,{cells:n,bounds:t,prev:i}))}),n},cellsResized(n,t,e=!1){const i=[];return n.length===t.length&&this.batchUpdate(()=>{n.forEach((s,l)=>{i.push(this.cellResized(s,t[l],!1,e)),this.isExtendParent(s)&&this.extendParent(s),this.constrainChild(s)}),this.isResetEdgesOnResize()&&this.resetEdges(n),this.fireEvent(new EventObject(InternalEvent.CELLS_RESIZED,{cells:n,bounds:t,prev:i}))}),i},cellResized(n,t,e=!1,i=!1){const s=n.getGeometry();if(s&&(s.x!==t.x||s.y!==t.y||s.width!==t.width||s.height!==t.height)){const l=s.clone();if(!e&&l.relative){const{offset:r}=l;r&&(r.x+=t.x-l.x,r.y+=t.y-l.y)}else l.x=t.x,l.y=t.y;l.width=t.width,l.height=t.height,!l.relative&&n.isVertex()&&!this.isAllowNegativeCoordinates()&&(l.x=Math.max(0,l.x),l.y=Math.max(0,l.y)),this.batchUpdate(()=>{i&&this.resizeChildCells(n,l),this.getDataModel().setGeometry(n,l),this.constrainChildCells(n)})}return s},resizeChildCells(n,t){const e=n.getGeometry();if(e){const i=e.width!==0?t.width/e.width:1,s=e.height!==0?t.height/e.height:1;for(const l of n.getChildren())this.scaleCell(l,i,s,!0)}},constrainChildCells(n){for(const t of n.getChildren())this.constrainChild(t)},scaleCell(n,t,e,i=!1){let s=n.getGeometry();if(s){const l=this.getCurrentCellStyle(n);s=s.clone();const{x:r}=s,{y:o}=s,h=s.width,a=s.height;s.scale(t,e,l.aspect==="fixed"),l.resizeWidth?s.width=h*t:l.resizeWidth||(s.width=h),l.resizeHeight?s.height=a*e:l.resizeHeight||(s.height=a),this.isCellMovable(n)||(s.x=r,s.y=o),this.isCellResizable(n)||(s.width=h,s.height=a),n.isVertex()?this.cellResized(n,s,!0,i):this.getDataModel().setGeometry(n,s)}},extendParent(n){const t=n.getParent();let e=t?t.getGeometry():null;if(t&&e&&!t.isCollapsed()){const i=n.getGeometry();i&&!i.relative&&(e.width<i.x+i.width||e.height<i.y+i.height)&&(e=e.clone(),e.width=Math.max(e.width,i.x+i.width),e.height=Math.max(e.height,i.y+i.height),this.cellsResized([t],[e],!1))}},importCells(n,t,e,i=null,s=null,l={}){return this.moveCells(n,t,e,!0,i,s,l)},moveCells(n,t=0,e=0,i=!1,s=null,l=null,r={}){if(t!==0||e!==0||i||s){n=getTopmostCells(n);const o=n;this.batchUpdate(()=>{const h=new Dictionary;for(const g of n)h.put(g,!0);const a=g=>{for(;g;){if(h.get(g))return!0;g=g.getParent()}return!1},d=[];for(const g of n){const u=g.getGeometry(),f=g.getParent();(!u||!u.relative||f&&!f.isEdge()||f&&!a(f.getTerminal(!0))&&!a(f.getTerminal(!1)))&&d.push(g)}n=d,i&&(n=this.cloneCells(n,this.isCloneInvalidEdges(),r),s||(s=this.getDefaultParent()));const c=this.isAllowNegativeCoordinates();if(s&&this.setAllowNegativeCoordinates(!0),this.cellsMoved(n,t,e,!i&&this.isDisconnectOnMove()&&this.isAllowDanglingEdges(),!s,this.isExtendParentsOnMove()&&!s),this.setAllowNegativeCoordinates(c),s){const g=s.getChildCount();this.cellsAdded(n,s,g,null,null,!0),i&&n.forEach((u,f)=>{const p=u.getGeometry(),E=o[f].getParent();p&&p.relative&&E&&E.isEdge()&&this.getDataModel().contains(E)&&this.getDataModel().add(E,u)})}this.fireEvent(new EventObject(InternalEvent.MOVE_CELLS,{cells:n,dx:t,dy:e,clone:i,target:s,event:l}))})}return n},cellsMoved(n,t,e,i=!1,s=!1,l=!1){(t!==0||e!==0)&&this.batchUpdate(()=>{i&&this.disconnectGraph(n);for(const r of n)this.translateCell(r,t,e),l&&this.isExtendParent(r)?this.extendParent(r):s&&this.constrainChild(r);this.isResetEdgesOnMove()&&this.resetEdges(n),this.fireEvent(new EventObject(InternalEvent.CELLS_MOVED,{cells:n,dx:t,dy:e,disconnect:i}))})},translateCell(n,t,e){let i=n.getGeometry();if(i){if(i=i.clone(),i.translate(t,e),!i.relative&&n.isVertex()&&!this.isAllowNegativeCoordinates()&&(i.x=Math.max(0,i.x),i.y=Math.max(0,i.y)),i.relative&&!n.isEdge()){const s=n.getParent();let l=0;if(s.isVertex()&&(l=this.getCurrentCellStyle(s).rotation??0),l!==0){const r=toRadians(-l),o=Math.cos(r),h=Math.sin(r),a=getRotatedPoint(new Point(t,e),o,h,new Point(0,0));t=a.x,e=a.y}i.offset?(i.offset.x=i.offset.x+t,i.offset.y=i.offset.y+e):i.offset=new Point(t,e)}this.getDataModel().setGeometry(n,i)}},getCellContainmentArea(n){if(!n.isEdge()){const t=n.getParent();if(t&&t!==this.getDefaultParent()){const e=t.getGeometry();if(e){let i=0,s=0,l=e.width,r=e.height;if(this.isSwimlane(t)){const o=this.getStartSize(t),h=this.getCurrentCellStyle(t),a=h.direction??DIRECTION.EAST,d=h.flipH??!1,c=h.flipV??!1;if(a===DIRECTION.SOUTH||a===DIRECTION.NORTH){const g=o.width;o.width=o.height,o.height=g}(a===DIRECTION.EAST&&!c||a===DIRECTION.NORTH&&!d||a===DIRECTION.WEST&&c||a===DIRECTION.SOUTH&&d)&&(i=o.width,s=o.height),l-=o.width,r-=o.height}return new Rectangle(i,s,l,r)}}}return null},constrainChild(n,t=!0){let e=n.getGeometry();if(e&&(this.isConstrainRelativeChildren()||!e.relative)){const i=n.getParent();let s=this.getMaximumGraphBounds();if(s&&i){const l=this.getBoundingBoxFromGeometry([i],!1);l&&(s=Rectangle.fromRectangle(s),s.x-=l.x,s.y-=l.y)}if(this.isConstrainChild(n)){let l=this.getCellContainmentArea(n);if(l){const r=this.getOverlap(n);r>0&&(l=Rectangle.fromRectangle(l),l.x-=l.width*r,l.y-=l.height*r,l.width+=2*l.width*r,l.height+=2*l.height*r),s?(s=Rectangle.fromRectangle(s),s.intersect(l)):s=l}}if(s){const l=[n];if(!n.isCollapsed()){const o=n.getDescendants();for(const h of o)h.isVisible()&&l.push(h)}const r=this.getBoundingBoxFromGeometry(l,!1);if(r){e=e.clone();let o=0;e.width>s.width&&(o=e.width-s.width,e.width-=o),r.x+r.width>s.x+s.width&&(o-=r.x+r.width-s.x-s.width-o);let h=0;e.height>s.height&&(h=e.height-s.height,e.height-=h),r.y+r.height>s.y+s.height&&(h-=r.y+r.height-s.y-s.height-h),r.x<s.x&&(o-=r.x-s.x),r.y<s.y&&(h-=r.y-s.y),(o!==0||h!==0)&&(e.relative?(e.offset||(e.offset=new Point),e.offset.x+=o,e.offset.y+=h):(e.x+=o,e.y+=h)),this.getDataModel().setGeometry(n,e)}}}},getChildCells(n,t=!1,e=!1){n=n??this.getDefaultParent();const i=n.getChildCells(t,e),s=[];for(const l of i)l.isVisible()&&s.push(l);return s},getCellAt(n,t,e=null,i=!0,s=!0,l=null){if(e||(e=this.getCurrentRoot(),e||(e=this.getDataModel().getRoot())),e){const r=e.getChildCount();for(let o=r-1;o>=0;o--){const h=e.getChildAt(o),a=this.getCellAt(n,t,h,i,s,l);if(a)return a;if(h.isVisible()&&(s&&h.isEdge()||i&&h.isVertex())){const d=this.getView().getState(h);if(d&&(!l||!l(d,n,t))&&this.intersects(d,n,t))return h}}}return null},getCells(n,t,e,i,s=null,l=[],r=null,o=null,h=!1){if(e>0||i>0||r){const a=this.getDataModel(),d=n+e,c=t+i;if(s||(s=this.getCurrentRoot(),s||(s=a.getRoot())),s)for(const g of s.getChildren()){const u=this.getView().getState(g);if(u&&g.isVisible()&&(!o||!o(u))){const f=u.style.rotation??0;let p=u;f!==0&&(p=getBoundingBox(p,f));const E=r&&g.isVertex()&&intersects(r,p)||!r&&(g.isEdge()||g.isVertex())&&p.x>=n&&p.y+p.height<=c&&p.y>=t&&p.x+p.width<=d;E&&l.push(g),(!E||h)&&this.getCells(n,t,e,i,g,l,r,o,h)}}}return l},getCellsBeyond(n,t,e=null,i=!1,s=!1){const l=[];if((i||s)&&(e||(e=this.getDefaultParent()),e))for(const r of e.getChildren()){const o=this.getView().getState(r);r.isVisible()&&o&&(!i||o.x>=n)&&(!s||o.y>=t)&&l.push(r)}return l},intersects(n,t,e){const i=n.absolutePoints;if(i.length>0){const s=this.getEventTolerance()*this.getEventTolerance();let l=i[0];for(let r=1;r<i.length;r+=1){const o=i[r];if(l&&o&&ptSegDistSq(l.x,l.y,o.x,o.y,t,e)<=s)return!0;l=o}}else{const s=toRadians(n.style.rotation??0);if(s!==0){const l=Math.cos(-s),r=Math.sin(-s),o=new Point(n.getCenterX(),n.getCenterY()),h=getRotatedPoint(new Point(t,e),l,r,o);t=h.x,e=h.y}if(contains(n,t,e))return!0}return!1},isValidAncestor(n,t,e=!1){return e?t.isAncestor(n):(n==null?void 0:n.getParent())===t},isCellLocked(n){const t=n.getGeometry();return this.isCellsLocked()||!!t&&n.isVertex()&&t.relative},isCellsLocked(){return this.cellsLocked},setCellsLocked(n){this.cellsLocked=n},getCloneableCells(n){return this.getDataModel().filterCells(n,t=>this.isCellCloneable(t))},isCellCloneable(n){return this.isCellsCloneable()&&(this.getCurrentCellStyle(n).cloneable??!0)},isCellsCloneable(){return this.cellsCloneable},setCellsCloneable(n){this.cellsCloneable=n},getExportableCells(n){return this.getDataModel().filterCells(n,t=>this.canExportCell(t))},canExportCell(n=null){return this.isExportEnabled()},getImportableCells(n){return this.getDataModel().filterCells(n,t=>this.canImportCell(t))},canImportCell(n=null){return this.isImportEnabled()},isCellSelectable(n){return this.isCellsSelectable()},isCellsSelectable(){return this.cellsSelectable},setCellsSelectable(n){this.cellsSelectable=n},getDeletableCells(n){return this.getDataModel().filterCells(n,t=>this.isCellDeletable(t))},isCellDeletable(n){return this.isCellsDeletable()&&(this.getCurrentCellStyle(n).deletable??!0)},isCellsDeletable(){return this.cellsDeletable},setCellsDeletable(n){this.cellsDeletable=n},isCellRotatable(n){return this.getCurrentCellStyle(n).rotatable??!0},getMovableCells(n){return this.getDataModel().filterCells(n,t=>this.isCellMovable(t))},isCellMovable(n){return this.isCellsMovable()&&!this.isCellLocked(n)&&(this.getCurrentCellStyle(n).movable??!0)},isCellsMovable(){return this.cellsMovable},setCellsMovable(n){this.cellsMovable=n},isCellResizable(n){return this.isCellsResizable()&&!this.isCellLocked(n)&&(this.getCurrentCellStyle(n).resizable??!0)},isCellsResizable(){return this.cellsResizable},setCellsResizable(n){this.cellsResizable=n},isCellBendable(n){return this.isCellsBendable()&&!this.isCellLocked(n)&&(this.getCurrentCellStyle(n).bendable??!0)},isCellsBendable(){return this.cellsBendable},setCellsBendable(n){this.cellsBendable=n},isAutoSizeCell(n){return this.isAutoSizeCells()||(this.getCurrentCellStyle(n).autoSize??!1)},isAutoSizeCells(){return this.autoSizeCells},setAutoSizeCells(n){this.autoSizeCells=n},isExtendParent(n){return!n.isEdge()&&this.isExtendParents()},isExtendParents(){return this.extendParents},setExtendParents(n){this.extendParents=n},isExtendParentsOnAdd(n){return this.extendParentsOnAdd},setExtendParentsOnAdd(n){this.extendParentsOnAdd=n},isExtendParentsOnMove(){return this.extendParentsOnMove},setExtendParentsOnMove(n){this.extendParentsOnMove=n},getCursorForCell(n){return null},getCellBounds(n,t=!1,e=!1){let i=[n];t&&(i=i.concat(n.getEdges()));let s=this.getView().getBounds(i);if(e)for(const l of n.getChildren()){const r=this.getCellBounds(l,t,!0);s&&r?s.add(r):s=r}return s},getBoundingBoxFromGeometry(n,t=!1){let e=null,i=null;for(const s of n)if(t||s.isVertex()){const l=s.getGeometry();if(l){let r=null;if(s.isEdge()){const o=a=>{a&&(i?i.add(new Rectangle(a.x,a.y,0,0)):i=new Rectangle(a.x,a.y,0,0))};s.getTerminal(!0)||o(l.getTerminalPoint(!0)),s.getTerminal(!1)||o(l.getTerminalPoint(!1));const h=l.points;if(h&&h.length>0){i=new Rectangle(h[0].x,h[0].y,0,0);for(let a=1;a<h.length;a++)o(h[a])}r=i}else{const o=s.getParent();l.relative&&o?o.isVertex()&&o!==this.getView().currentRoot&&(i=this.getBoundingBoxFromGeometry([o],!1),i&&(r=new Rectangle(l.x*i.width,l.y*i.height,l.width,l.height),n.indexOf(o)>=0&&(r.x+=i.x,r.y+=i.y))):(r=Rectangle.fromRectangle(l),o&&o.isVertex()&&n.indexOf(o)>=0&&(i=this.getBoundingBoxFromGeometry([o],!1),i&&(r.x+=i.x,r.y+=i.y))),r&&l.offset&&(r.x+=l.offset.x,r.y+=l.offset.y);const h=this.getCurrentCellStyle(s);if(r){const a=h.rotation??0;a!==0&&(r=getBoundingBox(r,a))}}r&&(e?e.add(r):e=Rectangle.fromRectangle(r))}}return e}},ConnectionsMixin={constrainChildren:!0,constrainRelativeChildren:!1,disconnectOnMove:!0,cellsDisconnectable:!0,getOutlineConstraint(n,t,e){if(t.shape){const i=this.getView().getPerimeterBounds(t),s=t.style.direction;if(s===DIRECTION.NORTH||s===DIRECTION.SOUTH){i.x+=i.width/2-i.height/2,i.y+=i.height/2-i.width/2;const g=i.width;i.width=i.height,i.height=g}const l=toRadians(t.shape.getShapeRotation());if(l!==0){const g=Math.cos(-l),u=Math.sin(-l),f=new Point(i.getCenterX(),i.getCenterY());n=getRotatedPoint(n,g,u,f)}let r=1,o=1,h=0,a=0;if(t.cell.isVertex()){let g=t.style.flipH,u=t.style.flipV;if(s===DIRECTION.NORTH||s===DIRECTION.SOUTH){const f=g;g=u,u=f}g&&(r=-1,h=-i.width),u&&(o=-1,a=-i.height)}n=new Point((n.x-i.x)*r-h+i.x,(n.y-i.y)*o-a+i.y);const d=i.width===0?0:Math.round((n.x-i.x)*1e3/i.width)/1e3,c=i.height===0?0:Math.round((n.y-i.y)*1e3/i.height)/1e3;return new ConnectionConstraint(new Point(d,c),!1)}return null},getAllConnectionConstraints(n,t){var e,i;return((i=(e=n==null?void 0:n.shape)==null?void 0:e.stencil)==null?void 0:i.constraints)??null},getConnectionConstraint(n,t,e=!1){let i=null;const s=n.style[e?"exitX":"entryX"];if(s!==void 0){const h=n.style[e?"exitY":"entryY"];h!==void 0&&(i=new Point(s,h))}let l=!1,r=0,o=0;return i&&(l=n.style[e?"exitPerimeter":"entryPerimeter"]||!1,r=n.style[e?"exitDx":"entryDx"],o=n.style[e?"exitDy":"entryDy"],r=Number.isFinite(r)?r:0,o=Number.isFinite(o)?o:0),new ConnectionConstraint(i,l,null,r,o)},setConnectionConstraint(n,t,e=!1,i=null){i&&this.batchUpdate(()=>{!i||!i.point?(this.setCellStyles(e?"exitX":"entryX",null,[n]),this.setCellStyles(e?"exitY":"entryY",null,[n]),this.setCellStyles(e?"exitDx":"entryDx",null,[n]),this.setCellStyles(e?"exitDy":"entryDy",null,[n]),this.setCellStyles(e?"exitPerimeter":"entryPerimeter",null,[n])):i.point&&(this.setCellStyles(e?"exitX":"entryX",i.point.x,[n]),this.setCellStyles(e?"exitY":"entryY",i.point.y,[n]),this.setCellStyles(e?"exitDx":"entryDx",i.dx,[n]),this.setCellStyles(e?"exitDy":"entryDy",i.dy,[n]),i.perimeter?this.setCellStyles(e?"exitPerimeter":"entryPerimeter",null,[n]):this.setCellStyles(e?"exitPerimeter":"entryPerimeter","0",[n]))})},getConnectionPoint(n,t,e=!0){let i=null;if(t.point){const s=this.getView().getPerimeterBounds(n),l=new Point(s.getCenterX(),s.getCenterY()),r=n.style.direction;let o=0;n.style.anchorPointDirection&&(r===DIRECTION.NORTH?o+=270:r===DIRECTION.WEST?o+=180:r===DIRECTION.SOUTH&&(o+=90),(r===DIRECTION.NORTH||r===DIRECTION.SOUTH)&&s.rotate90());const{scale:h}=this.getView();i=new Point(s.x+t.point.x*s.width+t.dx*h,s.y+t.point.y*s.height+t.dy*h);let a=n.style.rotation||0;if(t.perimeter){if(o!==0){let d=0,c=0;o===90?c=1:o===180?d=-1:o===270&&(c=-1),i=getRotatedPoint(i,d,c,l)}i=this.getView().getPerimeterPoint(n,i,!1)}else if(a+=o,n.cell.isVertex()){let d=n.style.flipH,c=n.style.flipV;if(r===DIRECTION.NORTH||r===DIRECTION.SOUTH){const g=d;d=c,c=g}d&&(i.x=2*s.getCenterX()-i.x),c&&(i.y=2*s.getCenterY()-i.y)}if(a!==0&&i){const d=toRadians(a),c=Math.cos(d),g=Math.sin(d);i=getRotatedPoint(i,c,g,l)}}return e&&i&&(i.x=Math.round(i.x),i.y=Math.round(i.y)),i},connectCell(n,t=null,e=!1,i=null){return this.batchUpdate(()=>{const s=n.getTerminal(e);this.cellConnected(n,t,e,i),this.fireEvent(new EventObject(InternalEvent.CONNECT_CELL,"edge",n,"terminal",t,"source",e,"previous",s))}),n},cellConnected(n,t,e=!1,i=null){this.batchUpdate(()=>{const s=n.getTerminal(e);if(this.setConnectionConstraint(n,t,e,i),this.isPortsEnabled()){let l=null;t&&this.isPort(t)&&(l=t.getId(),t=this.getTerminalForPort(t,e));const r=e?"sourcePort":"targetPort";this.setCellStyles(r,l,[n])}this.getDataModel().setTerminal(n,t,e),this.isResetEdgesOnConnect()&&this.resetEdge(n),this.fireEvent(new EventObject(InternalEvent.CELL_CONNECTED,"edge",n,"terminal",t,"source",e,"previous",s))})},disconnectGraph(n){this.batchUpdate(()=>{const{scale:t,translate:e}=this.getView(),i=new Dictionary;for(let s=0;s<n.length;s+=1)i.put(n[s],!0);for(const s of n)if(s.isEdge()){let l=s.getGeometry();if(l){const r=this.getView().getState(s),o=s.getParent(),h=o?this.getView().getState(o):null;if(r&&h){l=l.clone();const a=-h.origin.x,d=-h.origin.y,c=r.absolutePoints;let g=s.getTerminal(!0);if(g&&this.isCellDisconnectable(s,g,!0)){for(;g&&!i.get(g);)g=g.getParent();!g&&c[0]&&(l.setTerminalPoint(new Point(c[0].x/t-e.x+a,c[0].y/t-e.y+d),!0),this.getDataModel().setTerminal(s,null,!0))}let u=s.getTerminal(!1);if(u&&this.isCellDisconnectable(s,u,!1)){for(;u&&!i.get(u);)u=u.getParent();if(!u){const f=c.length-1,p=c[f];p&&(l.setTerminalPoint(new Point(p.x/t-e.x+a,p.y/t-e.y+d),!1),this.getDataModel().setTerminal(s,null,!1))}}this.getDataModel().setGeometry(s,l)}}}})},getConnections(n,t=null){return this.getEdges(n,t,!0,!0,!1)},isConstrainChild(n){return this.isConstrainChildren()&&!!n.getParent()&&!n.getParent().isEdge()},isConstrainChildren(){return this.constrainChildren},setConstrainChildren(n){this.constrainChildren=n},isConstrainRelativeChildren(){return this.constrainRelativeChildren},setConstrainRelativeChildren(n){this.constrainRelativeChildren=n},isDisconnectOnMove(){return this.disconnectOnMove},setDisconnectOnMove(n){this.disconnectOnMove=n},isCellDisconnectable(n,t=null,e=!1){return this.isCellsDisconnectable()&&!this.isCellLocked(n)},isCellsDisconnectable(){return this.cellsDisconnectable},setCellsDisconnectable(n){this.cellsDisconnectable=n},isValidSource(n){return n==null&&this.isAllowDanglingEdges()||n!=null&&(!n.isEdge()||this.isConnectableEdges())&&n.isConnectable()},isValidTarget(n){return this.isValidSource(n)},isValidConnection(n,t){return this.isValidSource(n)&&this.isValidTarget(t)},setConnectable(n){const t=this.getPlugin("ConnectionHandler");t==null||t.setEnabled(n)},isConnectable(){const n=this.getPlugin("ConnectionHandler");return(n==null?void 0:n.isEnabled())??!1}},DragDropMixin={dropEnabled:!1,splitEnabled:!0,autoScroll:!0,isAutoScroll(){return this.autoScroll},autoExtend:!0,isAutoExtend(){return this.autoExtend},isDropEnabled(){return this.dropEnabled},setDropEnabled(n){this.dropEnabled=n},isSplitEnabled(){return this.splitEnabled},setSplitEnabled(n){this.splitEnabled=n},isSplitTarget(n,t=[],e){if(n.isEdge()&&t.length===1&&t[0].isConnectable()&&!this.getEdgeValidationError(n,n.getTerminal(!0),t[0])){const i=n.getTerminal(!0),s=n.getTerminal(!1);return!t[0].isAncestor(i)&&!t[0].isAncestor(s)}return!1}},EdgeMixin={resetEdgesOnResize:!1,isResetEdgesOnResize(){return this.resetEdgesOnResize},resetEdgesOnMove:!1,isResetEdgesOnMove(){return this.resetEdgesOnMove},resetEdgesOnConnect:!0,isResetEdgesOnConnect(){return this.resetEdgesOnConnect},connectableEdges:!1,allowDanglingEdges:!0,cloneInvalidEdges:!1,alternateEdgeStyle:{},edgeLabelsMovable:!0,isEdgeLabelsMovable(){return this.edgeLabelsMovable},setEdgeLabelsMovable(n){this.edgeLabelsMovable=n},setAllowDanglingEdges(n){this.allowDanglingEdges=n},isAllowDanglingEdges(){return this.allowDanglingEdges},setConnectableEdges(n){this.connectableEdges=n},isConnectableEdges(){return this.connectableEdges},setCloneInvalidEdges(n){this.cloneInvalidEdges=n},isCloneInvalidEdges(){return this.cloneInvalidEdges},flipEdge(n){return this.alternateEdgeStyle&&this.batchUpdate(()=>{const t=n.getStyle();Object.keys(t).length?this.getDataModel().setStyle(n,this.alternateEdgeStyle):this.getDataModel().setStyle(n,{}),this.resetEdge(n),this.fireEvent(new EventObject(InternalEvent.FLIP_EDGE,{edge:n}))}),n},splitEdge(n,t,e,i=0,s=0,l,r,o=null){o=o??n.getParent();const h=n.getTerminal(!0);return this.batchUpdate(()=>{if(!e){e=this.cloneCell(n);const a=this.getView().getState(n);let d=e.getGeometry();if(d&&a){const c=this.getView().translate,g=this.getView().scale,u=findNearestSegment(a,(i+c.x)*g,(s+c.y)*g);d.points=d.points.slice(0,u),d=n.getGeometry(),d&&(d=d.clone(),d.points=d.points.slice(u),this.getDataModel().setGeometry(n,d))}}this.cellsMoved(t,i,s,!1,!1),this.cellsAdded(t,o,o?o.getChildCount():0,null,null,!0),this.cellsAdded([e],o,o?o.getChildCount():0,h,t[0],!1),this.cellConnected(n,t[0],!0),this.fireEvent(new EventObject(InternalEvent.SPLIT_EDGE,{edge:n,cells:t,newEdge:e,dx:i,dy:s}))}),e},insertEdge(...n){let t,e,i,s,l,r;if(n.length===1&&typeof n[0]=="object"){const h=n[0];t=h.parent,e=h.id,i=h.value,s=h.source,l=h.target,r=h.style}else[t,e,i,s,l,r]=n;const o=this.createEdge(t,e,i,s,l,r);return this.addEdge(o,t,s,l)},createEdge(n=null,t,e,i=null,s=null,l={}){const r=new Cell(e,new Geometry,l);return r.setId(t),r.setEdge(!0),r.geometry.relative=!0,r},addEdge(n,t=null,e=null,i=null,s=null){return this.addCell(n,t,s,e,i)},addAllEdges(n){const t=n.slice();return removeDuplicates(t.concat(this.getAllEdges(n)))},getAllEdges(n){let t=[];if(n)for(let e=0;e<n.length;e+=1){const i=n[e].getEdgeCount();for(let l=0;l<i;l++)t.push(n[e].getEdgeAt(l));const s=n[e].getChildren();t=t.concat(this.getAllEdges(s))}return t},getIncomingEdges(n,t=null){return this.getEdges(n,t,!0,!1,!1)},getOutgoingEdges(n,t=null){return this.getEdges(n,t,!1,!0,!1)},getEdges(n,t=null,e=!0,i=!0,s=!0,l=!1){let r=[];const o=n.isCollapsed(),h=n.getChildCount();for(let d=0;d<h;d+=1){const c=n.getChildAt(d);(o||!c.isVisible())&&(r=r.concat(c.getEdges(e,i)))}r=r.concat(n.getEdges(e,i));const a=[];for(let d=0;d<r.length;d+=1){const c=this.getView().getState(r[d]),g=c?c.getVisibleTerminal(!0):this.getView().getVisibleTerminal(r[d],!0),u=c?c.getVisibleTerminal(!1):this.getView().getVisibleTerminal(r[d],!1);(s&&g===u||g!==u&&(e&&u===n&&(!t||this.isValidAncestor(g,t,l))||i&&g===n&&(!t||this.isValidAncestor(u,t,l))))&&a.push(r[d])}return a},getChildEdges(n){return this.getChildCells(n,!1,!0)},getEdgesBetween(n,t,e=!1){const i=this.getEdges(n),s=[];for(let l=0;l<i.length;l+=1){const r=this.getView().getState(i[l]),o=r?r.getVisibleTerminal(!0):this.getView().getVisibleTerminal(i[l],!0),h=r?r.getVisibleTerminal(!1):this.getView().getVisibleTerminal(i[l],!1);(o===n&&h===t||!e&&o===t&&h===n)&&s.push(i[l])}return s},resetEdges(n){const t=new Dictionary;for(let e=0;e<n.length;e+=1)t.put(n[e],!0);this.batchUpdate(()=>{for(let e=0;e<n.length;e+=1){const i=n[e].getEdges();for(let s=0;s<i.length;s++){const l=this.getView().getState(i[s]),r=l?l.getVisibleTerminal(!0):this.getView().getVisibleTerminal(i[s],!0),o=l?l.getVisibleTerminal(!1):this.getView().getVisibleTerminal(i[s],!1);(!t.get(r)||!t.get(o))&&this.resetEdge(i[s])}this.resetEdges(n[e].getChildren())}})},resetEdge(n){let t=n.getGeometry();return t&&t.points&&t.points.length>0&&(t=t.clone(),t.points=[],this.getDataModel().setGeometry(n,t)),n}},EditingMixin={cellsEditable:!0,startEditing(n){this.startEditingAtCell(null,n)},startEditingAtCell(n=null,t){if(!t||!isMultiTouchEvent(t))if(!n)n=this.getSelectionCell(),n&&!this.isCellEditable(n)&&(n=null);else{this.fireEvent(new EventObject(InternalEvent.START_EDITING,{cell:n,event:t}));const e=this.getPlugin("CellEditorHandler");e==null||e.startEditing(n,t),this.fireEvent(new EventObject(InternalEvent.EDITING_STARTED,{cell:n,event:t}))}},getEditingValue(n,t){return this.convertValueToString(n)},stopEditing(n=!1){const t=this.getPlugin("CellEditorHandler");t==null||t.stopEditing(n),this.fireEvent(new EventObject(InternalEvent.EDITING_STOPPED,{cancel:n}))},labelChanged(n,t,e){return this.batchUpdate(()=>{const i=n.value;this.cellLabelChanged(n,t,this.isAutoSizeCell(n)),this.fireEvent(new EventObject(InternalEvent.LABEL_CHANGED,{cell:n,value:t,old:i,event:e}))}),n},cellLabelChanged(n,t,e=!1){this.batchUpdate(()=>{this.getDataModel().setValue(n,t),e&&this.cellSizeUpdated(n,!1)})},isEditing(n=null){const t=this.getPlugin("CellEditorHandler"),e=t==null?void 0:t.getEditingCell();return n?n===e:!!e},isCellEditable(n){return this.isCellsEditable()&&!this.isCellLocked(n)&&(this.getCurrentCellStyle(n).editable??!0)},isCellsEditable(){return this.cellsEditable},setCellsEditable(n){this.cellsEditable=n}},EventsMixin={lastTouchEvent:null,doubleClickCounter:0,lastTouchCell:null,fireDoubleClick:null,tapAndHoldThread:null,lastMouseX:null,lastMouseY:null,isMouseTrigger:null,ignoreMouseEvents:null,mouseMoveRedirect:null,mouseUpRedirect:null,lastEvent:null,escapeEnabled:!0,invokesStopCellEditing:!0,enterStopsCellEditing:!1,isMouseDown:!1,nativeDblClickEnabled:!0,doubleTapEnabled:!0,doubleTapTimeout:500,doubleTapTolerance:25,lastTouchX:0,lastTouchY:0,lastTouchTime:0,tapAndHoldEnabled:!0,tapAndHoldDelay:500,tapAndHoldInProgress:!1,tapAndHoldValid:!1,initialTouchX:0,initialTouchY:0,tolerance:4,isNativeDblClickEnabled(){return this.nativeDblClickEnabled},getEventTolerance(){return this.tolerance},setEventTolerance(n){this.tolerance=n},escape(n){this.fireEvent(new EventObject(InternalEvent.ESCAPE,{event:n}))},click(n){const t=n.getEvent();let e=n.getCell();const i=new EventObject(InternalEvent.CLICK,{event:t,cell:e});if(n.isConsumed()&&i.consume(),this.fireEvent(i),this.isEnabled()&&!isConsumed(t)&&!i.isConsumed()){if(e){if(this.isTransparentClickEvent(t)){let s=!1;const l=this.getCellAt(n.graphX,n.graphY,null,!1,!1,r=>{const o=this.isCellSelected(r.cell);return s=s||o,!s||o||r.cell!==e&&r.cell.isAncestor(e)});l&&(e=l)}}else if(this.isSwimlaneSelectionEnabled()&&(e=this.getSwimlaneAt(n.getGraphX(),n.getGraphY()),e!=null&&(!this.isToggleEvent(t)||!isAltDown(t)))){let s=e,l=[];for(;s!=null;){s=s.getParent();const r=this.getView().getState(s);this.isSwimlane(s)&&r!=null&&l.push(s)}if(l.length>0){l=l.reverse(),l.splice(0,0,e),l.push(e);for(let r=0;r<l.length-1;r+=1)this.isCellSelected(l[r])&&(e=l[this.isToggleEvent(t)?r:r+1])}}e?this.selectCellForEvent(e,t):this.isToggleEvent(t)||this.clearSelection()}return!1},dblClick(n,t=null){const e=new EventObject(InternalEvent.DOUBLE_CLICK,{event:n,cell:t});this.fireEvent(e),this.isEnabled()&&!isConsumed(n)&&!e.isConsumed()&&t&&this.isCellEditable(t)&&!this.isEditing(t)&&(this.startEditingAtCell(t,n),InternalEvent.consume(n))},tapAndHold(n){const t=n.getEvent(),e=new EventObject(InternalEvent.TAP_AND_HOLD,{event:t,cell:n.getCell()}),i=this.getPlugin("PanningHandler"),s=this.getPlugin("ConnectionHandler");if(this.fireEvent(e),e.isConsumed()&&i&&(i.panningTrigger=!1),this.isEnabled()&&!isConsumed(t)&&!e.isConsumed()&&s&&s.isEnabled()){const l=s.marker.getCell(n);if(l){const r=this.getView().getState(l);r&&(s.marker.currentColor=s.marker.validColor,s.marker.markedState=r,s.marker.mark(),s.first=new Point(n.getGraphX(),n.getGraphY()),s.edgeState=s.createEdgeState(n),s.previous=r,s.fireEvent(new EventObject(InternalEvent.START,{state:s.previous})))}}},addMouseListener(n){this.mouseListeners.push(n)},removeMouseListener(n){for(let t=0;t<this.mouseListeners.length;t+=1)if(this.mouseListeners[t]===n){this.mouseListeners.splice(t,1);break}},updateMouseEvent(n,t){const e=convertPoint(this.getContainer(),n.getX(),n.getY());if(n.graphX=e.x-this.getPanDx(),n.graphY=e.y-this.getPanDy(),!n.getCell()&&this.isMouseDown&&t===InternalEvent.MOUSE_MOVE){const i=this.getCellAt(e.x,e.y,null,!0,!0,s=>!s.shape||s.shape.paintBackground!==this.paintBackground||s.style.pointerEvents||s.shape.fill!==NONE);n.state=i?this.getView().getState(i):null}return n},getStateForTouchEvent(n){const t=getClientX(n),e=getClientY(n),i=convertPoint(this.getContainer(),t,e),s=this.getCellAt(i.x,i.y);return s?this.getView().getState(s):null},isEventIgnored(n,t,e){const i=isMouseEvent(t.getEvent());let s=!1;t.getEvent()===this.lastEvent?s=!0:this.lastEvent=t.getEvent();const l=this.getEventSource();return l&&n!==InternalEvent.MOUSE_MOVE?(InternalEvent.removeGestureListeners(l,null,this.mouseMoveRedirect,this.mouseUpRedirect),this.mouseMoveRedirect=null,this.mouseUpRedirect=null,this.setEventSource(null)):!Client.IS_GC&&l&&t.getSource()!==l?s=!0:l&&Client.IS_TOUCH&&n===InternalEvent.MOUSE_DOWN&&!i&&!isPenEvent(t.getEvent())&&(this.setEventSource(t.getSource()),this.mouseMoveRedirect=r=>{this.fireMouseEvent(InternalEvent.MOUSE_MOVE,new InternalMouseEvent(r,this.getStateForTouchEvent(r)))},this.mouseUpRedirect=r=>{this.fireMouseEvent(InternalEvent.MOUSE_UP,new InternalMouseEvent(r,this.getStateForTouchEvent(r)))},InternalEvent.addGestureListeners(l,null,this.mouseMoveRedirect,this.mouseUpRedirect)),this.isSyntheticEventIgnored(n,t,e)&&(s=!0),!isPopupTrigger(this.lastEvent)&&n!==InternalEvent.MOUSE_MOVE&&this.lastEvent.detail===2?!0:(n===InternalEvent.MOUSE_UP&&this.isMouseDown?this.isMouseDown=!1:n===InternalEvent.MOUSE_DOWN&&!this.isMouseDown?(this.isMouseDown=!0,this.isMouseTrigger=i):!s&&((!Client.IS_FF||n!==InternalEvent.MOUSE_MOVE)&&this.isMouseDown&&this.isMouseTrigger!==i||n===InternalEvent.MOUSE_DOWN&&this.isMouseDown||n===InternalEvent.MOUSE_UP&&!this.isMouseDown)&&(s=!0),!s&&n===InternalEvent.MOUSE_DOWN&&(this.lastMouseX=t.getX(),this.lastMouseY=t.getY()),s)},isSyntheticEventIgnored(n,t,e){let i=!1;const s=isMouseEvent(t.getEvent());return this.ignoreMouseEvents&&s&&n!==InternalEvent.MOUSE_MOVE?(this.ignoreMouseEvents=n!==InternalEvent.MOUSE_UP,i=!0):Client.IS_FF&&!s&&n===InternalEvent.MOUSE_UP&&(this.ignoreMouseEvents=!0),i},isEventSourceIgnored(n,t){const e=t.getSource();if(!e)return!0;const i=e.nodeName?e.nodeName.toLowerCase():"",s=!isMouseEvent(t.getEvent())||isLeftMouseButton(t.getEvent());return n===InternalEvent.MOUSE_DOWN&&s&&(i==="select"||i==="option"||i==="input"&&e.type!=="checkbox"&&e.type!=="radio"&&e.type!=="button"&&e.type!=="submit"&&e.type!=="file")},getEventState(n){return n},fireMouseEvent(n,t,e){if(e=e??this,this.isEventSourceIgnored(n,t)){const i=this.getPlugin("TooltipHandler");i&&i.hide();return}if(t=this.updateMouseEvent(t,n),!this.nativeDblClickEnabled&&!isPopupTrigger(t.getEvent())||this.doubleTapEnabled&&Client.IS_TOUCH&&(isTouchEvent(t.getEvent())||isPenEvent(t.getEvent()))){const i=new Date().getTime();if(n===InternalEvent.MOUSE_DOWN)if(this.lastTouchEvent&&this.lastTouchEvent!==t.getEvent()&&i-this.lastTouchTime<this.doubleTapTimeout&&Math.abs(this.lastTouchX-t.getX())<this.doubleTapTolerance&&Math.abs(this.lastTouchY-t.getY())<this.doubleTapTolerance&&this.doubleClickCounter<2){this.doubleClickCounter+=1;let s=!1;if(n===InternalEvent.MOUSE_UP){if(t.getCell()===this.lastTouchCell&&this.lastTouchCell){this.lastTouchTime=0;const l=this.lastTouchCell;this.lastTouchCell=null,this.dblClick(t.getEvent(),l),s=!0}}else this.fireDoubleClick=!0,this.lastTouchTime=0;if(s){InternalEvent.consume(t.getEvent());return}}else(!this.lastTouchEvent||this.lastTouchEvent!==t.getEvent())&&(this.lastTouchCell=t.getCell(),this.lastTouchX=t.getX(),this.lastTouchY=t.getY(),this.lastTouchTime=i,this.lastTouchEvent=t.getEvent(),this.doubleClickCounter=0);else if((this.isMouseDown||n===InternalEvent.MOUSE_UP)&&this.fireDoubleClick){this.fireDoubleClick=!1;const s=this.lastTouchCell;this.lastTouchCell=null,this.isMouseDown=!1,(s||(isTouchEvent(t.getEvent())||isPenEvent(t.getEvent()))&&(Client.IS_GC||Client.IS_SF))&&Math.abs(this.lastTouchX-t.getX())<this.doubleTapTolerance&&Math.abs(this.lastTouchY-t.getY())<this.doubleTapTolerance?this.dblClick(t.getEvent(),s):InternalEvent.consume(t.getEvent());return}}if(!this.isEventIgnored(n,t,e)){const i=t.getState();if(t.state=i?this.getEventState(i):null,this.fireEvent(new EventObject(InternalEvent.FIRE_MOUSE_EVENT,{eventName:n,event:t})),Client.IS_SF||Client.IS_GC||t.getEvent().target!==this.getContainer()){const l=this.getContainer();if(n===InternalEvent.MOUSE_MOVE&&this.isMouseDown&&this.isAutoScroll()&&!isMultiTouchEvent(t.getEvent()))this.scrollPointToVisible(t.getGraphX(),t.getGraphY(),this.isAutoExtend());else if(n===InternalEvent.MOUSE_UP&&this.isIgnoreScrollbars()&&this.isTranslateToScrollPosition()&&(l.scrollLeft!==0||l.scrollTop!==0)){const o=this.getView().scale,h=this.getView().translate;this.getView().setTranslate(h.x-l.scrollLeft/o,h.y-l.scrollTop/o),l.scrollLeft=0,l.scrollTop=0}const r=this.mouseListeners;t.getEvent().preventDefault||(t.getEvent().returnValue=!0);for(const o of r)n===InternalEvent.MOUSE_DOWN?o.mouseDown(e,t):n===InternalEvent.MOUSE_MOVE?o.mouseMove(e,t):n===InternalEvent.MOUSE_UP&&o.mouseUp(e,t);n===InternalEvent.MOUSE_UP&&this.click(t)}if((isTouchEvent(t.getEvent())||isPenEvent(t.getEvent()))&&n===InternalEvent.MOUSE_DOWN&&this.tapAndHoldEnabled&&!this.tapAndHoldInProgress){this.tapAndHoldInProgress=!0,this.initialTouchX=t.getGraphX(),this.initialTouchY=t.getGraphY();const l=()=>{this.tapAndHoldValid&&this.tapAndHold(t),this.tapAndHoldInProgress=!1,this.tapAndHoldValid=!1};this.tapAndHoldThread&&window.clearTimeout(this.tapAndHoldThread),this.tapAndHoldThread=window.setTimeout(l,this.tapAndHoldDelay),this.tapAndHoldValid=!0}else n===InternalEvent.MOUSE_UP?(this.tapAndHoldInProgress=!1,this.tapAndHoldValid=!1):this.tapAndHoldValid&&(this.tapAndHoldValid=Math.abs(this.initialTouchX-t.getGraphX())<this.tolerance&&Math.abs(this.initialTouchY-t.getGraphY())<this.tolerance);const s=this.getPlugin("CellEditorHandler");n===InternalEvent.MOUSE_DOWN&&this.isEditing()&&!(s!=null&&s.isEventSource(t.getEvent()))&&this.stopEditing(!this.isInvokesStopCellEditing()),this.consumeMouseEvent(n,t,e)}},consumeMouseEvent(n,t,e){n===InternalEvent.MOUSE_DOWN&&isTouchEvent(t.getEvent())&&t.consume(!1)},fireGestureEvent(n,t=null){this.lastTouchTime=0,this.fireEvent(new EventObject(InternalEvent.GESTURE,{event:n,cell:t}))},sizeDidChange(){const n=this.getGraphBounds(),t=this.getBorder();let e=Math.max(0,n.x)+n.width+2*t,i=Math.max(0,n.y)+n.height+2*t;const s=this.getMinimumContainerSize();if(s&&(e=Math.max(e,s.width),i=Math.max(i,s.height)),this.isResizeContainer()&&this.doResizeContainer(e,i),this.isPreferPageSize()||this.isPageVisible()){const o=this.getPreferredPageSize(n,Math.max(1,e),Math.max(1,i));e=o.width*this.getView().scale,i=o.height*this.getView().scale}const l=this.getMinimumGraphSize();l&&(e=Math.max(e,l.width*this.getView().scale),i=Math.max(i,l.height*this.getView().scale)),e=Math.ceil(e),i=Math.ceil(i);const r=this.getView().getDrawPane().ownerSVGElement;r&&(r.style.minWidth=`${Math.max(1,e)}px`,r.style.minHeight=`${Math.max(1,i)}px`,r.style.width="100%",r.style.height="100%"),this.updatePageBreaks(this.isPageBreaksVisible(),e,i),this.fireEvent(new EventObject(InternalEvent.SIZE,{bounds:n}))},isCloneEvent(n){return isControlDown(n)},isTransparentClickEvent(n){return!1},isToggleEvent(n){return Client.IS_MAC?isMetaDown(n):isControlDown(n)},isGridEnabledEvent(n){return!isAltDown(n)},isConstrainedEvent(n){return isShiftDown(n)},isIgnoreTerminalEvent(n){return!1},getPointForEvent(n,t=!0){const e=convertPoint(this.getContainer(),getClientX(n),getClientY(n)),i=this.getView().scale,s=this.getView().translate,l=t?this.getGridSize()/2:0;return e.x=this.snap(e.x/i-s.x-l),e.y=this.snap(e.y/i-s.y-l),e},isEscapeEnabled(){return this.escapeEnabled},setEscapeEnabled(n){this.escapeEnabled=n},isInvokesStopCellEditing(){return this.invokesStopCellEditing},setInvokesStopCellEditing(n){this.invokesStopCellEditing=n},isEnterStopsCellEditing(){return this.enterStopsCellEditing},setEnterStopsCellEditing(n){this.enterStopsCellEditing=n},getCursorForMouseEvent(n){const t=n.getCell();return t?this.getCursorForCell(t):null}},FoldingMixin={options:{foldingEnabled:!0,collapsedImage:new ImageBox(`${Client.imageBasePath}/collapsed.gif`,9,9),expandedImage:new ImageBox(`${Client.imageBasePath}/expanded.gif`,9,9),collapseToPreferredSize:!0},collapseExpandResource:TranslationsConfig.isEnabled()?"collapse-expand":"",getCollapseExpandResource(){return this.collapseExpandResource},isFoldingEnabled(){return this.options.foldingEnabled},getFoldableCells(n,t=!1){return this.getDataModel().filterCells(n,e=>this.isCellFoldable(e,t))},isCellFoldable(n,t){return n.getChildCount()>0&&(this.getCurrentCellStyle(n).foldable??!0)},getFoldingImage(n){if(n!=null&&this.isFoldingEnabled()&&!n.cell.isEdge()){const t=n.cell.isCollapsed();if(this.isCellFoldable(n.cell,!t))return t?this.options.collapsedImage:this.options.expandedImage}return null},foldCells(n=!1,t=!1,e=null,i=!1,s=null){return e==null&&(e=this.getFoldableCells(this.getSelectionCells(),n)),this.stopEditing(!1),this.batchUpdate(()=>{this.cellsFolded(e,n,t,i),this.fireEvent(new EventObject(InternalEvent.FOLD_CELLS,"collapse",n,"recurse",t,"cells",e))}),e},cellsFolded(n=null,t=!1,e=!1,i=!1){n!=null&&n.length>0&&this.batchUpdate(()=>{for(let s=0;s<n.length;s+=1)if((!i||this.isCellFoldable(n[s],t))&&t!==n[s].isCollapsed()){if(this.getDataModel().setCollapsed(n[s],t),this.swapBounds(n[s],t),this.isExtendParent(n[s])&&this.extendParent(n[s]),e){const l=n[s].getChildren();this.cellsFolded(l,t,e)}this.constrainChild(n[s])}this.fireEvent(new EventObject(InternalEvent.CELLS_FOLDED,{cells:n,collapse:t,recurse:e}))})},swapBounds(n,t=!1){let e=n.getGeometry();e!=null&&(e=e.clone(),this.updateAlternateBounds(n,e,t),e.swap(),this.getDataModel().setGeometry(n,e))},updateAlternateBounds(n=null,t=null,e=!1){if(n!=null&&t!=null){const i=this.getCurrentCellStyle(n);if(t.alternateBounds==null){let s=t;if(this.options.collapseToPreferredSize){const l=this.getPreferredSizeForCell(n);if(l!=null){s=l;const r=i.startSize??0;r>0&&(s.height=Math.max(s.height,r))}}t.alternateBounds=new Rectangle(0,0,s.width,s.height)}if(t.alternateBounds!=null){t.alternateBounds.x=t.x,t.alternateBounds.y=t.y;const s=toRadians(i.rotation||0);if(s!==0){const l=t.alternateBounds.getCenterX()-t.getCenterX(),r=t.alternateBounds.getCenterY()-t.getCenterY(),o=Math.cos(s),h=Math.sin(s),a=o*l-h*r,d=h*l+o*r;t.alternateBounds.x+=a-l,t.alternateBounds.y+=d-r}}}}},GroupingMixin={groupCells(n,t=0,e){e||(e=sortCells(this.getSelectionCells(),!0)),e||(e=this.getCellsForGroup(e)),n==null&&(n=this.createGroupCell(e));const i=this.getBoundsForGroup(n,e,t);if(e.length>1&&i!=null){let s=n.getParent();s==null&&(s=e[0].getParent()),this.batchUpdate(()=>{n.getGeometry()==null&&this.getDataModel().setGeometry(n,new Geometry);let l=s.getChildCount();this.cellsAdded([n],s,l,null,null,!1,!1,!1),l=n.getChildCount(),this.cellsAdded(e,n,l,null,null,!1,!1,!1),this.cellsMoved(e,-i.x,-i.y,!1,!1,!1),this.cellsResized([n],[i],!1),this.fireEvent(new EventObject(InternalEvent.GROUP_CELLS,{group:n,border:t,cells:e}))})}return n},getCellsForGroup(n){const t=[];if(n!=null&&n.length>0){const e=n[0].getParent();t.push(n[0]);for(let i=1;i<n.length;i+=1)n[i].getParent()===e&&t.push(n[i])}return t},getBoundsForGroup(n,t,e){const i=this.getBoundingBoxFromGeometry(t,!0);if(i!=null){if(this.isSwimlane(n)){const s=this.getStartSize(n);i.x-=s.width,i.y-=s.height,i.width+=s.width,i.height+=s.height}e!=null&&(i.x-=e,i.y-=e,i.width+=2*e,i.height+=2*e)}return i},createGroupCell(n){const t=new Cell("");return t.setVertex(!0),t.setConnectable(!1),t},ungroupCells(n){let t=[];return n==null&&(n=this.getCellsForUngroup()),n!=null&&n.length>0&&this.batchUpdate(()=>{const e=n;for(let i=0;i<e.length;i+=1){let s=e[i].getChildren();if(s!=null&&s.length>0){s=s.slice();const l=e[i].getParent(),r=l.getChildCount();this.cellsAdded(s,l,r,null,null,!0),t=t.concat(s);for(const o of s){const h=this.getView().getState(o);let a=o.getGeometry();h!=null&&a!=null&&a.relative&&(a=a.clone(),a.x=h.origin.x,a.y=h.origin.y,a.relative=!1,this.getDataModel().setGeometry(o,a))}}}this.removeCellsAfterUngroup(e),this.fireEvent(new EventObject(InternalEvent.UNGROUP_CELLS,{cells:n}))}),t},getCellsForUngroup(){const n=this.getSelectionCells(),t=[];for(let e=0;e<n.length;e+=1)n[e].isVertex()&&n[e].getChildCount()>0&&t.push(n[e]);return t},removeCellsAfterUngroup(n){this.cellsRemoved(this.addAllEdges(n))},removeCellsFromParent(n){return n==null&&(n=this.getSelectionCells()),this.batchUpdate(()=>{const t=this.getDefaultParent(),e=t.getChildCount();this.cellsAdded(n,t,e,null,null,!0),this.fireEvent(new EventObject(InternalEvent.REMOVE_CELLS_FROM_PARENT,{cells:n}))}),n},updateGroupBounds(n,t=0,e=!1,i=0,s=0,l=0,r=0){return n==null&&(n=this.getSelectionCells()),t=t??0,e=e??!1,i=i??0,s=s??0,l=l??0,r=r??0,this.batchUpdate(()=>{for(let o=n.length-1;o>=0;o--){let h=n[o].getGeometry();if(h==null)continue;const a=this.getChildCells(n[o]);if(a!=null&&a.length>0){const d=this.getBoundingBoxFromGeometry(a,!0);if(d!=null&&d.width>0&&d.height>0){const c=this.isSwimlane(n[o])?this.getActualStartSize(n[o],!0):new Rectangle;h=h.clone(),e&&(h.x=Math.round(h.x+d.x-t-c.x-r),h.y=Math.round(h.y+d.y-t-c.y-i)),h.width=Math.round(d.width+2*t+c.x+r+s+c.width),h.height=Math.round(d.height+2*t+c.y+i+l+c.height),this.getDataModel().setGeometry(n[o],h),this.moveCells(a,t+c.x-d.x+r,t+c.y-d.y+i)}}}}),n},enterGroup(n){n=n||this.getSelectionCell(),n!=null&&this.isValidRoot(n)&&(this.getView().setCurrentRoot(n),this.clearSelection())},exitGroup(){const n=this.getDataModel().getRoot(),t=this.getCurrentRoot();if(t!=null){let e=t.getParent();for(;e!==n&&!this.isValidRoot(e)&&e.getParent()!==n;)e=e.getParent();e===n||e.getParent()===n?this.getView().setCurrentRoot(null):this.getView().setCurrentRoot(e),this.getView().getState(t)!=null&&this.setSelectionCell(t)}}},ImageMixin={addImageBundle(n){this.imageBundles.push(n)},removeImageBundle(n){const t=[];for(let e=0;e<this.imageBundles.length;e+=1)this.imageBundles[e]!==n&&t.push(this.imageBundles[e]);this.imageBundles=t},getImageFromBundles(n){if(n)for(let t=0;t<this.imageBundles.length;t+=1){const e=this.imageBundles[t].getImage(n);if(e)return e}return null}},LabelMixin={getLabel(n){let t="";return this.isLabelsVisible()&&n!=null&&((this.getCurrentCellStyle(n).noLabel??!1)||(t=this.convertValueToString(n))),t},isHtmlLabel(n){return this.isHtmlLabels()},labelsVisible:!0,isLabelsVisible(){return this.labelsVisible},htmlLabels:!1,isHtmlLabels(){return this.htmlLabels},setHtmlLabels(n){this.htmlLabels=n},isWrapping(n){return this.getCurrentCellStyle(n).whiteSpace==="wrap"},isLabelClipped(n){return this.getCurrentCellStyle(n).overflow==="hidden"},isLabelMovable(n){return!this.isCellLocked(n)&&(n.isEdge()&&this.isEdgeLabelsMovable()||n.isVertex()&&this.isVertexLabelsMovable())}},OrderMixin={orderCells(n=!1,t){return t||(t=this.getSelectionCells()),t||(t=sortCells(this.getSelectionCells(),!0)),this.batchUpdate(()=>{this.cellsOrdered(t,n);const e=new EventObject(InternalEvent.ORDER_CELLS,"back",n,"cells",t);this.fireEvent(e)}),t},cellsOrdered(n,t=!1){this.batchUpdate(()=>{for(let e=0;e<n.length;e+=1){const i=n[e].getParent();t?this.getDataModel().add(i,n[e],e):this.getDataModel().add(i,n[e],i?i.getChildCount()-1:0)}this.fireEvent(new EventObject(InternalEvent.CELLS_ORDERED,{back:t,cells:n}))})}};class CellOverlay extends EventSource{constructor(t,e=null,i="right",s="bottom",l=new Point,r="help"){super(),this.align="right",this.verticalAlign="bottom",this.offset=new Point,this.cursor="help",this.defaultOverlap=.5,this.image=t,this.tooltip=e,this.align=i,this.verticalAlign=s,this.offset=l,this.cursor=r}getBounds(t){const e=t.cell.isEdge(),i=t.view.scale;let s=null;const l=this.image,r=l.width,o=l.height;if(e){const h=t.absolutePoints;if(h.length%2===1)s=h[Math.floor(h.length/2)];else{const a=h.length/2,d=h[a-1],c=h[a];s=new Point(d.x+(c.x-d.x)/2,d.y+(c.y-d.y)/2)}}else{if(s=new Point,this.align==="left")s.x=t.x;else if(this.align==="center")s.x=t.x+t.width/2;else if(this.align==="right")s.x=t.x+t.width;else throw new Error;if(this.verticalAlign==="top")s.y=t.y;else if(this.verticalAlign==="middle")s.y=t.y+t.height/2;else if(this.verticalAlign==="bottom")s.y=t.y+t.height;else throw new Error}return new Rectangle(Math.round(s.x-(r*this.defaultOverlap-this.offset.x)*i),Math.round(s.y-(o*this.defaultOverlap-this.offset.y)*i),r*i,o*i)}toString(){return this.tooltip}}const OverlaysMixin={addCellOverlay(n,t){n.overlays.push(t);const e=this.getView().getState(n);return e&&this.getCellRenderer().redraw(e),this.fireEvent(new EventObject(InternalEvent.ADD_OVERLAY,{cell:n,overlay:t})),t},getCellOverlays(n){return n.overlays},removeCellOverlay(n,t=null){if(!t)this.removeCellOverlays(n);else{const e=n.overlays.indexOf(t);if(e>=0){n.overlays.splice(e,1);const i=this.getView().getState(n);i&&this.getCellRenderer().redraw(i),this.fireEvent(new EventObject(InternalEvent.REMOVE_OVERLAY,{cell:n,overlay:t}))}else t=null}return t},removeCellOverlays(n){const{overlays:t}=n;n.overlays=[];const e=this.getView().getState(n);e&&this.getCellRenderer().redraw(e);for(let i=0;i<t.length;i+=1)this.fireEvent(new EventObject(InternalEvent.REMOVE_OVERLAY,"cell",n,"overlay",t[i]));return t},clearCellOverlays(n=null){if(n=n??this.getDataModel().getRoot(),!n)return;this.removeCellOverlays(n);const t=n.getChildCount();for(let e=0;e<t;e+=1){const i=n.getChildAt(e);this.clearCellOverlays(i)}},setCellWarning(n,t=null,e,i=!1){if(e=e??this.getWarningImage(),t&&t.length>0){const s=new CellOverlay(e,`<font color=red>${t}</font>`);return i&&s.addListener(InternalEvent.CLICK,(l,r)=>{this.isEnabled()&&this.setSelectionCell(n)}),this.addCellOverlay(n,s)}return this.removeCellOverlays(n),null}},PageBreaksMixin={horizontalPageBreaks:null,verticalPageBreaks:null,updatePageBreaks(n,t,e){const{scale:i,translate:s}=this.getView(),l=this.getPageFormat(),r=i*this.getPageScale(),o=new Rectangle(0,0,l.width*r,l.height*r),h=Rectangle.fromRectangle(this.getGraphBounds());h.width=Math.max(1,h.width),h.height=Math.max(1,h.height),o.x=Math.floor((h.x-s.x*i)/o.width)*o.width+s.x*i,o.y=Math.floor((h.y-s.y*i)/o.height)*o.height+s.y*i,h.width=Math.ceil((h.width+(h.x-o.x))/o.width)*o.width,h.height=Math.ceil((h.height+(h.y-o.y))/o.height)*o.height,n=n&&Math.min(o.width,o.height)>this.getMinPageBreakDist();const a=n?Math.ceil(h.height/o.height)+1:0,d=n?Math.ceil(h.width/o.width)+1:0,c=(d-1)*o.width,g=(a-1)*o.height;this.horizontalPageBreaks==null&&a>0&&(this.horizontalPageBreaks=[]),this.verticalPageBreaks==null&&d>0&&(this.verticalPageBreaks=[]);const u=f=>{if(f!=null){const p=f===this.horizontalPageBreaks?a:d;for(let E=0;E<=p;E+=1){const C=f===this.horizontalPageBreaks?[new Point(Math.round(o.x),Math.round(o.y+E*o.height)),new Point(Math.round(o.x+c),Math.round(o.y+E*o.height))]:[new Point(Math.round(o.x+E*o.width),Math.round(o.y)),new Point(Math.round(o.x+E*o.width),Math.round(o.y+g))];if(f[E]!=null)f[E].points=C,f[E].redraw();else{const y=new PolylineShape(C,this.getPageBreakColor());y.dialect=this.getDialect(),y.pointerEvents=!1,y.isDashed=this.isPageBreakDashed(),y.init(this.getView().backgroundPane),y.redraw(),f[E]=y}}for(let E=p;E<f.length;E+=1)f[E].destroy();f.splice(p,f.length-p)}};u(this.horizontalPageBreaks),u(this.verticalPageBreaks)}},PanningMixin={shiftPreview1:null,shiftPreview2:null,useScrollbarsForPanning:!0,isUseScrollbarsForPanning(){return this.useScrollbarsForPanning},timerAutoScroll:!1,isTimerAutoScroll(){return this.timerAutoScroll},allowAutoPanning:!1,isAllowAutoPanning(){return this.allowAutoPanning},panDx:0,getPanDx(){return this.panDx},setPanDx(n){this.panDx=n},panDy:0,getPanDy(){return this.panDy},setPanDy(n){this.panDy=n},panGraph(n,t){const e=this.getContainer();if(this.useScrollbarsForPanning&&hasScrollbars(e))e.scrollLeft=-n,e.scrollTop=-t;else{const i=this.getView().getCanvas();if(n===0&&t===0){if(i.removeAttribute("transform"),this.shiftPreview1){let s=this.shiftPreview1.firstChild;for(;s;){const r=s.nextSibling;e.appendChild(s),s=r}this.shiftPreview1.parentNode&&this.shiftPreview1.parentNode.removeChild(this.shiftPreview1),this.shiftPreview1=null,e.appendChild(i.parentNode);const l=this.shiftPreview2;for(s=l.firstChild;s;){const r=s.nextSibling;e.appendChild(s),s=r}l.parentNode&&l.parentNode.removeChild(l),this.shiftPreview2=null}}else{if(i.setAttribute("transform",`translate(${n},${t})`),!this.shiftPreview1){this.shiftPreview1=document.createElement("div"),this.shiftPreview1.style.position="absolute",this.shiftPreview1.style.overflow="visible",this.shiftPreview2=document.createElement("div"),this.shiftPreview2.style.position="absolute",this.shiftPreview2.style.overflow="visible";let s=this.shiftPreview1,l=e.firstChild;for(;l;){const r=l.nextSibling;l!==i.parentNode?s.appendChild(l):s=this.shiftPreview2,l=r}this.shiftPreview1.firstChild&&e.insertBefore(this.shiftPreview1,i.parentNode),this.shiftPreview2.firstChild&&e.appendChild(this.shiftPreview2)}this.shiftPreview1.style.left=`${n}px`,this.shiftPreview1.style.top=`${t}px`,this.shiftPreview2&&(this.shiftPreview2.style.left=`${n}px`,this.shiftPreview2.style.top=`${t}px`)}this.panDx=n,this.panDy=t,this.fireEvent(new EventObject(InternalEvent.PAN))}},scrollCellToVisible(n,t=!1){const e=-this.getView().translate.x,i=-this.getView().translate.y,s=this.getView().getState(n);if(s){const l=new Rectangle(e+s.x,i+s.y,s.width,s.height);if(t&&this.getContainer()){const o=this.getContainer().clientWidth,h=this.getContainer().clientHeight;l.x=l.getCenterX()-o/2,l.width=o,l.y=l.getCenterY()-h/2,l.height=h}const r=new Point(this.getView().translate.x,this.getView().translate.y);if(this.scrollRectToVisible(l)){const o=new Point(this.getView().translate.x,this.getView().translate.y);this.getView().translate.x=r.x,this.getView().translate.y=r.y,this.getView().setTranslate(o.x,o.y)}}},scrollRectToVisible(n){let t=!1;const e=this.getContainer(),i=e.offsetWidth,s=e.offsetHeight,l=Math.min(i,n.width),r=Math.min(s,n.height);if(hasScrollbars(e)){n.x+=this.getView().translate.x,n.y+=this.getView().translate.y;let o=e.scrollLeft-n.x;const h=Math.max(o-e.scrollLeft,0);o>0?e.scrollLeft-=o+2:(o=n.x+l-e.scrollLeft-e.clientWidth,o>0&&(e.scrollLeft+=o+2));let a=e.scrollTop-n.y;const d=Math.max(0,a-e.scrollTop);a>0?e.scrollTop-=a+2:(a=n.y+r-e.scrollTop-e.clientHeight,a>0&&(e.scrollTop+=a+2)),!this.useScrollbarsForPanning&&(h!=0||d!=0)&&this.getView().setTranslate(h,d)}else{const o=-this.getView().translate.x,h=-this.getView().translate.y,a=this.getView().scale;if(n.x+l>o+i&&(this.getView().translate.x-=(n.x+l-i-o)/a,t=!0),n.y+r>h+s&&(this.getView().translate.y-=(n.y+r-s-h)/a,t=!0),n.x<o&&(this.getView().translate.x+=(o-n.x)/a,t=!0),n.y<h&&(this.getView().translate.y+=(h-n.y)/a,t=!0),t){this.getView().refresh();const d=this.getPlugin("SelectionCellsHandler");d&&d.refresh()}}return t},setPanning(n){const t=this.getPlugin("PanningHandler");t&&(t.panningEnabled=n)}},PortsMixin={portsEnabled:!0,isPort(n){return!1},getTerminalForPort(n,t=!1){return n.getParent()},isPortsEnabled(){return this.portsEnabled},setPortsEnabled(n){this.portsEnabled=n}},SelectionMixin={selectionModel:null,getSelectionModel(){return this.selectionModel},setSelectionModel(n){this.selectionModel=n},isCellSelected(n){return this.selectionModel.isSelected(n)},isSelectionEmpty(){return this.selectionModel.isEmpty()},clearSelection(){this.selectionModel.clear()},getSelectionCount(){return this.selectionModel.cells.length},getSelectionCell(){return this.selectionModel.cells[0]},getSelectionCells(){return this.selectionModel.cells.slice()},setSelectionCell(n){this.selectionModel.setCell(n)},setSelectionCells(n){this.selectionModel.setCells(n)},addSelectionCell(n){this.selectionModel.addCell(n)},addSelectionCells(n){this.selectionModel.addCells(n)},removeSelectionCell(n){this.selectionModel.removeCell(n)},removeSelectionCells(n){this.selectionModel.removeCells(n)},selectRegion(n,t){const e=this.getCells(n.x,n.y,n.width,n.height);return this.selectCellsForEvent(e,t),e},selectNextCell(){this.selectCell(!0)},selectPreviousCell(){this.selectCell()},selectParentCell(){this.selectCell(!1,!0)},selectChildCell(){this.selectCell(!1,!1,!0)},selectCell(n=!1,t=!1,e=!1){const i=this.selectionModel.cells.length>0?this.selectionModel.cells[0]:null;this.selectionModel.cells.length>1&&this.selectionModel.clear();const s=i?i.getParent():this.getDefaultParent(),l=s.getChildCount();if(!i&&l>0){const r=s.getChildAt(0);this.setSelectionCell(r)}else if(s&&(!i||t)&&this.getView().getState(s)&&s.getGeometry())this.getCurrentRoot()!==s&&this.setSelectionCell(s);else if(i&&e){if(i.getChildCount()>0){const o=i.getChildAt(0);this.setSelectionCell(o)}}else if(l>0){let r=s.getIndex(i);if(n){r++;const o=s.getChildAt(r%l);this.setSelectionCell(o)}else{r--;const o=r<0?l-1:r,h=s.getChildAt(o);this.setSelectionCell(h)}}},selectAll(n,t=!1){n=n??this.getDefaultParent();const e=t?n.filterDescendants(i=>i!==n&&!!this.getView().getState(i)):n.getChildren();this.setSelectionCells(e)},selectVertices(n,t=!1){this.selectCells(!0,!1,n,t)},selectEdges(n){this.selectCells(!1,!0,n)},selectCells(n=!1,t=!1,e,i=!1){e=e??this.getDefaultParent();const s=r=>{const o=r.getParent();return!!this.getView().getState(r)&&((i||r.getChildCount()===0)&&r.isVertex()&&n&&o&&!o.isEdge()||r.isEdge()&&t)},l=e.filterDescendants(s);this.setSelectionCells(l)},selectCellForEvent(n,t){const e=this.isCellSelected(n);this.isToggleEvent(t)?e?this.removeSelectionCell(n):this.addSelectionCell(n):(!e||this.getSelectionCount()!==1)&&this.setSelectionCell(n)},selectCellsForEvent(n,t){this.isToggleEvent(t)?this.addSelectionCells(n):this.setSelectionCells(n)},isSiblingSelected(n){const t=n.getParent(),e=t.getChildCount();for(let i=0;i<e;i+=1){const s=t.getChildAt(i);if(n!==s&&this.isCellSelected(s))return!0}return!1},getSelectionCellsForChanges(n,t=null){const e=new Dictionary,i=[],s=l=>{if(!e.get(l)&&this.getDataModel().contains(l))if(l.isEdge()||l.isVertex())e.put(l,!0),i.push(l);else{const r=l.getChildCount();for(let o=0;o<r;o+=1)s(l.getChildAt(o))}};for(let l=0;l<n.length;l+=1){const r=n[l];if(r.constructor!==RootChange&&(!t||!t(r))){let o=null;r instanceof ChildChange?o=r.child:r.cell&&r.cell instanceof Cell&&(o=r.cell),o&&s(o)}}return i},updateSelection(){const n=this.getSelectionCells(),t=[];for(const e of n)if(!this.getDataModel().contains(e)||!e.isVisible())t.push(e);else{let i=e.getParent();for(;i&&i!==this.getView().currentRoot;){if(i.isCollapsed()||!i.isVisible()){t.push(e);break}i=i.getParent()}}this.removeSelectionCells(t)}},SnapMixin={snapTolerance:0,getSnapTolerance(){return this.snapTolerance},gridSize:10,gridEnabled:!0,snap(n){return this.gridEnabled&&(n=Math.round(n/this.gridSize)*this.gridSize),n},snapDelta(n,t,e=!1,i=!1,s=!1){const l=this.getView().translate,r=this.getView().scale;if(!e&&this.gridEnabled){const o=this.gridSize*r*.5;if(!i){const h=t.x-(this.snap(t.x/r-l.x)+l.x)*r;Math.abs(n.x-h)<o?n.x=0:n.x=this.snap(n.x/r)*r-h}if(!s){const h=t.y-(this.snap(t.y/r-l.y)+l.y)*r;Math.abs(n.y-h)<o?n.y=0:n.y=this.snap(n.y/r)*r-h}}else{const o=.5*r;if(!i){const h=t.x-(Math.round(t.x/r-l.x)+l.x)*r;Math.abs(n.x-h)<o?n.x=0:n.x=Math.round(n.x/r)*r-h}if(!s){const h=t.y-(Math.round(t.y/r-l.y)+l.y)*r;Math.abs(n.y-h)<o?n.y=0:n.y=Math.round(n.y/r)*r-h}}return n},isGridEnabled(){return this.gridEnabled},setGridEnabled(n){this.gridEnabled=n},getGridSize(){return this.gridSize},setGridSize(n){this.gridSize=n}},SwimlaneMixin={swimlaneSelectionEnabled:!0,swimlaneNesting:!0,swimlaneIndicatorColorAttribute:"fillColor",getSwimlane(n=null){for(;n&&!this.isSwimlane(n);)n=n.getParent();return n},getSwimlaneAt(n,t,e){if(e||(e=this.getCurrentRoot(),e||(e=this.getDataModel().getRoot())),e){const i=e.getChildCount();for(let s=0;s<i;s+=1){const l=e.getChildAt(s);if(l){const r=this.getSwimlaneAt(n,t,l);if(r!=null)return r;if(l.isVisible()&&this.isSwimlane(l)){const o=this.getView().getState(l);if(o&&this.intersects(o,n,t))return l}}}}return null},hitsSwimlaneContent(n,t,e){const i=this.getView().getState(n),s=this.getStartSize(n);if(i){const l=this.getView().getScale();if(t-=i.x,e-=i.y,s.width>0&&t>0&&t>s.width*l||s.height>0&&e>0&&e>s.height*l)return!0}return!1},getStartSize(n,t=!1){const e=new Rectangle,i=this.getCurrentCellStyle(n,t),s=i.startSize??DEFAULT_STARTSIZE;return i.horizontal??!0?e.height=s:e.width=s,e},getSwimlaneDirection(n){const t=n.direction??DIRECTION.EAST,e=n.flipH,i=n.flipV;let l=n.horizontal??!0?0:3;t===DIRECTION.NORTH?l--:t===DIRECTION.WEST?l+=2:t===DIRECTION.SOUTH&&(l+=1);const r=mod(l,2);return e&&r===1&&(l+=2),i&&r===0&&(l+=2),[DIRECTION.NORTH,DIRECTION.EAST,DIRECTION.SOUTH,DIRECTION.WEST][mod(l,4)]},getActualStartSize(n,t=!1){const e=new Rectangle;if(this.isSwimlane(n,t)){const i=this.getCurrentCellStyle(n,t),s=i.startSize??DEFAULT_STARTSIZE,l=this.getSwimlaneDirection(i);l===DIRECTION.NORTH?e.y=s:l===DIRECTION.WEST?e.x=s:l===DIRECTION.SOUTH?e.height=s:e.width=s}return e},isSwimlane(n,t=!1){return n&&n.getParent()!==this.getDataModel().getRoot()&&!n.isEdge()?this.getCurrentCellStyle(n,t).shape===SHAPE.SWIMLANE:!1},isValidDropTarget(n,t,e){return n&&(this.isSplitEnabled()&&this.isSplitTarget(n,t,e)||!n.isEdge()&&(this.isSwimlane(n)||n.getChildCount()>0&&!n.isCollapsed()))},getDropTarget(n,t,e=null,i=!1){if(!this.isSwimlaneNesting()){for(let o=0;o<n.length;o+=1)if(this.isSwimlane(n[o]))return null}const s=convertPoint(this.getContainer(),getClientX(t),getClientY(t));s.x-=this.getPanDx(),s.y-=this.getPanDy();const l=this.getSwimlaneAt(s.x,s.y);if(!e)e=l;else if(l){let o=l.getParent();for(;o&&this.isSwimlane(o)&&o!==e;)o=o.getParent();o===e&&(e=l)}for(;e&&!this.isValidDropTarget(e,n,t)&&!this.getDataModel().isLayer(e);)e=e.getParent();let r=e;if(!i)for(;r&&n.indexOf(r)<0;)r=r.getParent();return!this.getDataModel().isLayer(e)&&!r?e:null},isSwimlaneNesting(){return this.swimlaneNesting},setSwimlaneNesting(n){this.swimlaneNesting=n},isSwimlaneSelectionEnabled(){return this.swimlaneSelectionEnabled},setSwimlaneSelectionEnabled(n){this.swimlaneSelectionEnabled=n}},TerminalMixin={isTerminalPointMovable(n,t){return!0},getOpposites(n,t=null,e=!0,i=!0){const s=[],l=new Dictionary;for(let r=0;r<n.length;r+=1){const o=this.getView().getState(n[r]),h=o?o.getVisibleTerminal(!0):this.getView().getVisibleTerminal(n[r],!0),a=o?o.getVisibleTerminal(!1):this.getView().getVisibleTerminal(n[r],!1);h===t&&a&&a!==t&&i?l.get(a)||(l.put(a,!0),s.push(a)):a===t&&h&&h!==t&&e&&(l.get(h)||(l.put(h,!0),s.push(h)))}return s}},TooltipMixin={getTooltip(n,t,e,i){let s=null;if(n.control&&(t===n.control.node||t.parentNode===n.control.node)&&(s=this.getCollapseExpandResource(),s=htmlEntities(Translations.get(s)||s,!0).replace(/\\n/g,"<br>")),!s&&n.overlays&&n.overlays.visit((l,r)=>{!s&&(t===r.node||t.parentNode===r.node)&&(s=r.overlay?r.overlay.toString()??null:null)}),!s){const l=this.getPlugin("SelectionCellsHandler"),r=l==null?void 0:l.getHandler(n.cell);r&&"getTooltipForNode"in r&&typeof r.getTooltipForNode=="function"&&(s=r.getTooltipForNode(t))}return s||(s=this.getTooltipForCell(n.cell)),s},getTooltipForCell(n){let t=null;return n&&"getTooltip"in n?t=n.getTooltip():t=this.convertValueToString(n),t},setTooltips(n){const t=this.getPlugin("TooltipHandler");t==null||t.setEnabled(n)}},ValidationMixin={validationAlert(n){alert(n)},isEdgeValid(n,t,e){return!this.getEdgeValidationError(n,t,e)},getEdgeValidationError(n=null,t=null,e=null){if(n&&!this.isAllowDanglingEdges()&&(!t||!e))return"";if(n&&!n.getTerminal(!0)&&!n.getTerminal(!1))return null;if(!this.isAllowLoops()&&t===e&&t||!this.isValidConnection(t,e))return"";if(t&&e){let i="";if(!this.isMultigraph()){const o=this.getDataModel().getEdgesBetween(t,e,!0);(o.length>1||o.length===1&&o[0]!==n)&&(i+=`${Translations.get(this.getAlreadyConnectedResource())||this.getAlreadyConnectedResource()}
`)}const s=t.getDirectedEdgeCount(!0,n),l=e.getDirectedEdgeCount(!1,n);for(const o of this.multiplicities){const h=o.check(this,n,t,e,s,l);h!=null&&(i+=h)}const r=this.validateEdge(n,t,e);return r!=null&&(i+=r),i.length>0?i:null}return this.isAllowDanglingEdges()?null:""},validateEdge(n=null,t=null,e=null){return null},validateGraph(n=null,t){if(n=n??this.getDataModel().getRoot(),!n)return"The root does not exist!";t=t??{};let e=!0;const i=n.getChildCount();for(let r=0;r<i;r+=1){const o=n.getChildAt(r);let h=t;this.isValidRoot(o)&&(h={});const a=this.validateGraph(o,h);a?this.setCellWarning(o,a.replace(/\n/g,"<br>")):this.setCellWarning(o,null),e=e&&a==null}let s="";n&&n.isCollapsed()&&!e&&(s+=`${Translations.get(this.getContainsValidationErrorsResource())||this.getContainsValidationErrorsResource()}
`),n&&n.isEdge()?s+=this.getEdgeValidationError(n,n.getTerminal(!0),n.getTerminal(!1))||"":s+=this.getCellValidationError(n)||"";const l=this.validateCell(n,t);return l!=null&&(s+=l),n.getParent()==null&&this.getView().validate(),s.length>0||!e?s:null},getCellValidationError(n){const t=n.getDirectedEdgeCount(!0),e=n.getDirectedEdgeCount(!1),i=n.getValue();let s="";for(let l=0;l<this.multiplicities.length;l+=1){const r=this.multiplicities[l];r.source&&isNode(i,r.type,r.attr,r.value)&&(t>r.max||t<r.min)?s+=`${r.countError}
`:!r.source&&isNode(i,r.type,r.attr,r.value)&&(e>r.max||e<r.min)&&(s+=`${r.countError}
`)}return s.length>0?s:null},validateCell(n,t){return null}},VertexMixin={vertexLabelsMovable:!1,allowNegativeCoordinates:!0,isAllowNegativeCoordinates(){return this.allowNegativeCoordinates},setAllowNegativeCoordinates(n){this.allowNegativeCoordinates=n},insertVertex(...n){var g,u,f,p;let t,e,i,s,l,r,o,h,a,d;if(n.length===1&&typeof n[0]=="object"){const E=n[0];t=E.parent,e=E.id,i=E.value,s="x"in E?E.x:(g=E.position)==null?void 0:g[0],l="y"in E?E.y:(u=E.position)==null?void 0:u[1],r="width"in E?E.width:(f=E.size)==null?void 0:f[0],o="height"in E?E.height:(p=E.size)==null?void 0:p[1],h=E.style,a=E.relative,d=E.geometryClass}else[t,e,i,s,l,r,o,h,a,d]=n;const c=this.createVertex(t,e,i,s,l,r,o,h,a,d);return this.addCell(c,t)},createVertex(n,t,e,i,s,l,r,o,h=!1,a=Geometry){const d=new a(i,s,l,r);d.relative=h;const c=new Cell(e,d,o);return c.setId(t),c.setVertex(!0),c.setConnectable(!0),c},getChildVertices(n){return this.getChildCells(n,!0,!1)},isVertexLabelsMovable(){return this.vertexLabelsMovable},setVertexLabelsMovable(n){this.vertexLabelsMovable=n}},ZoomMixin={zoomFactor:1.2,keepSelectionVisibleOnZoom:!1,centerZoom:!0,zoomIn(){this.zoom(this.zoomFactor)},zoomOut(){this.zoom(1/this.zoomFactor)},zoomActual(){this.getView().scale===1?this.getView().setTranslate(0,0):(this.getView().translate.x=0,this.getView().translate.y=0,this.getView().setScale(1))},zoomTo(n,t=!1){this.zoom(n/this.getView().scale,t)},zoom(n,t){t=t??this.centerZoom;const e=Math.round(this.getView().scale*n*100)/100,i=this.getView().getState(this.getSelectionCell()),s=this.getContainer();if(n=e/this.getView().scale,this.keepSelectionVisibleOnZoom&&i!=null){const l=new Rectangle(i.x*n,i.y*n,i.width*n,i.height*n);this.getView().scale=e,this.scrollRectToVisible(l)||(this.getView().revalidate(),this.getView().setScale(e))}else{const l=hasScrollbars(this.getContainer());if(t&&!l){let r=s.offsetWidth,o=s.offsetHeight;if(n>1){const h=(n-1)/(e*2);r*=-h,o*=-h}else{const h=(1/n-1)/(this.getView().scale*2);r*=h,o*=h}this.getView().scaleAndTranslate(e,this.getView().translate.x+r,this.getView().translate.y+o)}else{const r=this.getView().translate.x,o=this.getView().translate.y,h=s.scrollLeft,a=s.scrollTop;if(this.getView().setScale(e),l){let d=0,c=0;t&&(d=s.offsetWidth*(n-1)/2,c=s.offsetHeight*(n-1)/2),s.scrollLeft=(this.getView().translate.x-r)*this.getView().scale+Math.round(h*n+d),s.scrollTop=(this.getView().translate.y-o)*this.getView().scale+Math.round(a*n+c)}}}},zoomToRect(n){const t=this.getContainer(),e=t.clientWidth/n.width,i=t.clientHeight/n.height,s=e/i;n.x=Math.max(0,n.x),n.y=Math.max(0,n.y);let l=Math.min(t.scrollWidth,n.x+n.width),r=Math.min(t.scrollHeight,n.y+n.height);if(n.width=l-n.x,n.height=r-n.y,s<1){const a=n.height/s,d=(a-n.height)/2;n.height=a;const c=Math.min(n.y,d);n.y-=c,r=Math.min(t.scrollHeight,n.y+n.height),n.height=r-n.y}else{const a=n.width*s,d=(a-n.width)/2;n.width=a;const c=Math.min(n.x,d);n.x-=c,l=Math.min(t.scrollWidth,n.x+n.width),n.width=l-n.x}const o=t.clientWidth/n.width,h=this.getView().scale*o;hasScrollbars(this.getContainer())?(this.getView().setScale(h),t.scrollLeft=Math.round(n.x*o),t.scrollTop=Math.round(n.y*o)):this.getView().scaleAndTranslate(h,this.getView().translate.x-n.x/this.getView().scale,this.getView().translate.y-n.y/this.getView().scale)}},applyGraphMixins=n=>{const t=mixInto(n);for(const e of[CellsMixin,ConnectionsMixin,DragDropMixin,EdgeMixin,EditingMixin,EventsMixin,FoldingMixin,GroupingMixin,ImageMixin,LabelMixin,OrderMixin,PageBreaksMixin,OverlaysMixin,PanningMixin,PortsMixin,SelectionMixin,SnapMixin,SwimlaneMixin,TerminalMixin,TooltipMixin,ValidationMixin,VertexMixin,ZoomMixin])t(e)};class CellEditorHandler{constructor(t){this.clearOnChange=!1,this.bounds=null,this.resizeThread=null,this.textDirection=null,this.textarea=null,this.editingCell=null,this.trigger=null,this.modified=!1,this.autoSize=!0,this.selectText=!0,this.emptyLabelText=Client.IS_FF?"<br>":"",this.escapeCancelsEditing=!0,this.textNode=null,this.zIndex=5,this.minResize=new Rectangle(0,20),this.wordWrapPadding=0,this.blurEnabled=!1,this.initialValue=null,this.align=null,this.graph=t,this.zoomHandler=()=>{this.graph.isEditing()&&this.resize()},this.changeHandler=e=>{this.editingCell&&!this.graph.getView().getState(this.editingCell,!1)&&this.stopEditing(!0)},this.graph.getView().addListener(InternalEvent.SCALE,this.zoomHandler),this.graph.getView().addListener(InternalEvent.SCALE_AND_TRANSLATE,this.zoomHandler),this.graph.getDataModel().addListener(InternalEvent.CHANGE,this.changeHandler)}init(){this.textarea=document.createElement("div"),this.textarea.className="mxCellEditor mxPlainTextEditor",this.textarea.contentEditable=String(!0),Client.IS_GC&&(this.textarea.style.minHeight="1em"),this.textarea.style.position="absolute",this.installListeners(this.textarea)}applyValue(t,e){this.graph.labelChanged(t.cell,e,this.trigger)}setAlign(t){this.textarea&&(this.textarea.style.textAlign=t),this.align=t,this.resize()}getInitialValue(t,e){let i=htmlEntities(this.graph.getEditingValue(t.cell,e),!1);return i=replaceTrailingNewlines(i,"<div><br></div>"),i.replace(/\n/g,"<br>")}getCurrentValue(t){return this.textarea?extractTextWithWhitespace(Array.from(this.textarea.childNodes)):null}isCancelEditingKeyEvent(t){return this.escapeCancelsEditing||isShiftDown(t)||isControlDown(t)||isMetaDown(t)}installListeners(t){InternalEvent.addListener(t,"dragstart",r=>{this.graph.stopEditing(!1),InternalEvent.consume(r)}),InternalEvent.addListener(t,"blur",r=>{this.blurEnabled&&this.focusLost()}),InternalEvent.addListener(t,"keydown",r=>{isConsumed(r)||(this.isStopEditingEvent(r)?(this.graph.stopEditing(!1),InternalEvent.consume(r)):r.keyCode===27&&(this.graph.stopEditing(this.isCancelEditingKeyEvent(r)),InternalEvent.consume(r)))});const e=r=>{this.editingCell!=null&&this.clearOnChange&&t.innerHTML===this.getEmptyLabelText()&&(!Client.IS_FF||r.keyCode!==8&&r.keyCode!==46)&&(this.clearOnChange=!1,t.innerHTML="")};InternalEvent.addListener(t,"keypress",e),InternalEvent.addListener(t,"paste",e);const i=r=>{if(this.editingCell!=null){const o=this.textarea;o.innerHTML.length===0||o.innerHTML==="<br>"?(o.innerHTML=this.getEmptyLabelText(),this.clearOnChange=o.innerHTML.length>0):this.clearOnChange=!1}};InternalEvent.addListener(t,"input",i),InternalEvent.addListener(t,"cut",i),InternalEvent.addListener(t,"paste",i);const s="input",l=r=>{this.editingCell!=null&&this.autoSize&&!isConsumed(r)&&(this.resizeThread!=null&&window.clearTimeout(this.resizeThread),this.resizeThread=window.setTimeout(()=>{this.resizeThread=null,this.resize()},0))};InternalEvent.addListener(t,s,l),InternalEvent.addListener(window,"resize",l),InternalEvent.addListener(t,"cut",l),InternalEvent.addListener(t,"paste",l)}isStopEditingEvent(t){return t.keyCode===113||this.graph.isEnterStopsCellEditing()&&t.keyCode===13&&!isControlDown(t)&&!isShiftDown(t)}isEventSource(t){return getSource(t)===this.textarea}resize(){const t=this.editingCell?this.graph.getView().getState(this.editingCell):null;if(!t)this.stopEditing(!0);else if(this.textarea!=null){const e=t.cell.isEdge(),{scale:i}=this.graph.getView();let s=null;if(!this.autoSize||t.style.overflow==="fill")this.bounds=this.getEditorBounds(t),this.textarea.style.width=`${Math.round(this.bounds.width/i)}px`,this.textarea.style.height=`${Math.round(this.bounds.height/i)}px`,this.textarea.style.left=`${Math.max(0,Math.round(this.bounds.x+1))}px`,this.textarea.style.top=`${Math.max(0,Math.round(this.bounds.y+1))}px`,this.graph.isWrapping(t.cell)&&(this.bounds.width>=2||this.bounds.height>=2)&&this.textarea.innerHTML!==this.getEmptyLabelText()?(this.textarea.style.wordWrap=WORD_WRAP,this.textarea.style.whiteSpace="normal",t.style.overflow!=="fill"&&(this.textarea.style.width=`${Math.round(this.bounds.width/i)+this.wordWrapPadding}px`)):(this.textarea.style.whiteSpace="nowrap",t.style.overflow!=="fill"&&(this.textarea.style.width=""));else{const l=t.style.labelWidth??null;if(s=t.text!=null&&this.align==null?t.text.margin:null,s==null&&(s=getAlignmentAsPoint(this.align??t.style.align??ALIGN.CENTER,t.style.verticalAlign??ALIGN.MIDDLE)),e){if(this.bounds=new Rectangle(t.absoluteOffset.x,t.absoluteOffset.y,0,0),l!=null){const r=(l+2)*i;this.bounds.width=r,this.bounds.x+=s.x*r}}else{let r=Rectangle.fromRectangle(t),o=t.style.labelPosition??ALIGN.CENTER,h=t.style.verticalLabelPosition??ALIGN.MIDDLE;if(r=t.shape!=null&&o==="center"&&h==="middle"?t.shape.getLabelBounds(r):r,l!=null&&(r.width=l*i),!t.view.graph.cellRenderer.legacySpacing||t.style.overflow!=="width"){const a=new TextShape,d=(t.style.spacing??2)*i,c=((t.style.spacingTop??0)+a.baseSpacingTop)*i+d,g=((t.style.spacingRight??0)+a.baseSpacingRight)*i+d,u=((t.style.spacingBottom??0)+a.baseSpacingBottom)*i+d,f=((t.style.spacingLeft??0)+a.baseSpacingLeft)*i+d;o=t.style.labelPosition!=null?t.style.labelPosition:"center",h=t.style.verticalLabelPosition!=null?t.style.verticalLabelPosition:"middle",r=new Rectangle(r.x+f,r.y+c,r.width-(o===ALIGN.CENTER&&l==null?f+g:0),r.height-(h===ALIGN.MIDDLE?c+u:0))}this.bounds=new Rectangle(r.x+t.absoluteOffset.x,r.y+t.absoluteOffset.y,r.width,r.height)}if(this.graph.isWrapping(t.cell)&&(this.bounds.width>=2||this.bounds.height>=2)&&this.textarea.innerHTML!==this.getEmptyLabelText()){this.textarea.style.wordWrap=WORD_WRAP,this.textarea.style.whiteSpace="normal";const r=Math.round(this.bounds.width/i)+this.wordWrapPadding;this.textarea.style.position!=="relative"?(this.textarea.style.width=`${r}px`,this.textarea.scrollWidth>r&&(this.textarea.style.width=`${this.textarea.scrollWidth}px`)):this.textarea.style.maxWidth=`${r}px`}else this.textarea.style.whiteSpace="nowrap",this.textarea.style.width="";this.textarea.scrollWidth,this.textarea.scrollHeight,this.textarea.style.left=`${Math.max(0,Math.round(this.bounds.x-s.x*(this.bounds.width-2))+1)}px`,this.textarea.style.top=`${Math.max(0,Math.round(this.bounds.y-s.y*(this.bounds.height-4)+(s.y===-1?3:0))+1)}px`}setPrefixedStyle(this.textarea.style,"transformOrigin","0px 0px"),setPrefixedStyle(this.textarea.style,"transform",`scale(${i},${i})${s==null?"":` translate(${s.x*100}%,${s.y*100}%)`}`)}}focusLost(){this.stopEditing(!this.graph.isInvokesStopCellEditing())}getBackgroundColor(t){return NONE}startEditing(t,e=null){this.stopEditing(!0),this.align=null,this.textarea==null&&this.init();const i=this.graph.getPlugin("TooltipHandler");i==null||i.hideTooltip();const s=this.graph.getView().getState(t);if(s){const{scale:l}=this.graph.getView(),r=s.style.fontSize??DEFAULT_FONTSIZE,o=s.style.fontFamily??DEFAULT_FONTFAMILY,h=s.style.fontColor??"black",a=s.style.align??ALIGN.LEFT,d=(s.style.fontStyle||0)&FONT.BOLD,c=(s.style.fontStyle||0)&FONT.ITALIC,g=[];(s.style.fontStyle||0)&FONT.UNDERLINE&&g.push("underline"),(s.style.fontStyle||0)&FONT.STRIKETHROUGH&&g.push("line-through");const u=this.textarea;u.style.lineHeight=String(LINE_HEIGHT),u.style.backgroundColor=this.getBackgroundColor(s)||"transparent",u.style.textDecoration=g.join(" "),u.style.fontWeight=d?"bold":"normal",u.style.fontStyle=c?"italic":"",u.style.fontSize=`${Math.round(r)}px`,u.style.zIndex=String(this.zIndex),u.style.fontFamily=o,u.style.textAlign=a,u.style.outline="none",u.style.color=h;let f=this.textDirection=s.style.textDirection??DEFAULT_TEXT_DIRECTION;f==="auto"&&s.text!==null&&s.text.dialect!==DIALECT.STRICTHTML&&!isNode(s.text.value)&&(f=s.text.getAutoDirection()),f==="ltr"||f==="rtl"?u.setAttribute("dir",f):u.removeAttribute("dir"),u.innerHTML=this.getInitialValue(s,e)||"",this.initialValue=u.innerHTML,u.innerHTML.length===0||u.innerHTML==="<br>"?(u.innerHTML=this.getEmptyLabelText(),this.clearOnChange=!0):this.clearOnChange=u.innerHTML===this.getEmptyLabelText(),this.graph.container.appendChild(u),this.editingCell=t,this.trigger=e,this.textNode=null,s.text!==null&&this.isHideLabel(s)&&(this.textNode=s.text.node,this.textNode.style.visibility="hidden"),this.autoSize&&(s.cell.isEdge()||s.style.overflow!=="fill")&&window.setTimeout(()=>{this.resize()},0),this.resize();try{u.focus(),this.isSelectText()&&u.innerHTML.length>0&&(u.innerHTML!==this.getEmptyLabelText()||!this.clearOnChange)&&document.execCommand("selectAll",!1)}catch{}}}isSelectText(){return this.selectText}stopEditing(t=!1){if(this.editingCell){this.textNode&&(this.textNode.style.visibility="visible",this.textNode=null);const e=t?null:this.graph.view.getState(this.editingCell),i=this.textarea,s=this.initialValue;if(this.initialValue=null,this.editingCell=null,this.bounds=null,i.blur(),clearSelection(),i.parentNode&&i.parentNode.removeChild(i),this.clearOnChange&&i.innerHTML===this.getEmptyLabelText()&&(i.innerHTML="",this.clearOnChange=!1),e&&(i.innerHTML!==s||this.align!==null)){this.prepareTextarea();const l=this.getCurrentValue(e);this.graph.batchUpdate(()=>{l!==null&&this.applyValue(e,l),this.align!==null&&this.graph.setCellStyles("align",this.align,[e.cell])})}this.trigger=null,this.textarea&&InternalEvent.release(this.textarea),this.textarea=null,this.align=null}}prepareTextarea(){const t=this.textarea;t.lastChild&&t.lastChild.nodeName==="BR"&&t.removeChild(t.lastChild)}isHideLabel(t=null){return!0}getMinimumSize(t){const{scale:e}=this.graph.getView(),i=this.textarea;return new Rectangle(0,0,t.text===null?30:t.text.size*e+20,i.style.textAlign==="left"?120:40)}getEditorBounds(t){const e=t.cell.isEdge(),{scale:i}=this.graph.getView(),s=this.getMinimumSize(t),l=s.width,r=s.height;let o=null;if(!e&&t.view.graph.cellRenderer.legacySpacing&&t.style.overflow==="fill")o=t.shape.getLabelBounds(Rectangle.fromRectangle(t));else{const h=new TextShape,a=(t.style.spacing??0)*i,d=((t.style.spacingTop??0)+h.baseSpacingTop)*i+a,c=((t.style.spacingRight??0)+h.baseSpacingRight)*i+a,g=((t.style.spacingBottom??0)+h.baseSpacingBottom)*i+a,u=((t.style.spacingLeft??0)+h.baseSpacingLeft)*i+a;o=new Rectangle(t.x,t.y,Math.max(l,t.width-u-c),Math.max(r,t.height-d-g));const f=t.style.labelPosition!=null?t.style.labelPosition:"center",p=t.style.verticalLabelPosition!=null?t.style.verticalLabelPosition:"middle";if(o=t.shape!=null&&f==="center"&&p==="middle"?t.shape.getLabelBounds(o):o,e?(o.x=t.absoluteOffset.x,o.y=t.absoluteOffset.y,t.text!=null&&t.text.boundingBox!=null&&(t.text.boundingBox.x>0&&(o.x=t.text.boundingBox.x),t.text.boundingBox.y>0&&(o.y=t.text.boundingBox.y))):t.text!=null&&t.text.boundingBox!=null&&(o.x=Math.min(o.x,t.text.boundingBox.x),o.y=Math.min(o.y,t.text.boundingBox.y)),o.x+=u,o.y+=d,t.text!=null&&t.text.boundingBox!=null&&(e?(o.width=Math.max(l,t.text.boundingBox.width),o.height=Math.max(r,t.text.boundingBox.height)):(o.width=Math.max(o.width,t.text.boundingBox.width),o.height=Math.max(o.height,t.text.boundingBox.height))),t.cell.isVertex()){const E=t.style.labelPosition??ALIGN.CENTER;E==="left"?o.x-=t.width:E==="right"&&(o.x+=t.width);const C=t.style.verticalLabelPosition!=null?t.style.verticalLabelPosition:"middle";C==="top"?o.y-=t.height:C==="bottom"&&(o.y+=t.height)}}return new Rectangle(Math.round(o.x),Math.round(o.y),Math.round(o.width),Math.round(o.height))}getEmptyLabelText(t=null){return this.emptyLabelText??""}getEditingCell(){return this.editingCell}onDestroy(){this.textarea&&(InternalEvent.release(this.textarea),this.textarea.parentNode&&this.textarea.parentNode.removeChild(this.textarea),this.textarea=null),this.graph.getDataModel().removeListener(this.changeHandler),this.graph.getView().removeListener(this.zoomHandler)}}CellEditorHandler.pluginId="CellEditorHandler";class TooltipHandler{init(){document.body&&(this.div=document.createElement("div"),this.div.className="mxTooltip",this.div.style.visibility="hidden",document.body.appendChild(this.div),InternalEvent.addGestureListeners(this.div,t=>{const e=getSource(t);e&&e.nodeName!=="A"&&this.hideTooltip()}),InternalEvent.addListener(this.graph.getContainer(),"mouseleave",t=>{this.div!==t.relatedTarget&&this.hide()}))}constructor(t){this.zIndex=10005,this.delay=500,this.ignoreTouchEvents=!0,this.hideOnHover=!1,this.destroyed=!1,this.lastX=0,this.lastY=0,this.state=null,this.stateSource=!1,this.thread=null,this.enabled=!1,this.graph=t,this.graph.addMouseListener(this)}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}isHideOnHover(){return this.hideOnHover}setHideOnHover(t){this.hideOnHover=t}getStateForEvent(t){return t.getState()}mouseDown(t,e){this.reset(e,!1),this.hideTooltip()}mouseMove(t,e){if(e.getX()!==this.lastX||e.getY()!==this.lastY){this.reset(e,!0);const i=this.getStateForEvent(e);(this.isHideOnHover()||i!==this.state||e.getSource()!==this.node&&(!this.stateSource||i!=null&&this.stateSource===(e.isSource(i.shape)||!e.isSource(i.text))))&&this.hideTooltip()}this.lastX=e.getX(),this.lastY=e.getY()}mouseUp(t,e){this.reset(e,!0),this.hideTooltip()}resetTimer(){this.thread&&(window.clearTimeout(this.thread),this.thread=null)}reset(t,e,i=null){if((!this.ignoreTouchEvents||isMouseEvent(t.getEvent()))&&(this.resetTimer(),i=i??this.getStateForEvent(t),e&&this.isEnabled()&&i&&(!this.div||this.div.style.visibility=="hidden"))){const s=t.getSource(),l=t.getX(),r=t.getY(),o=t.isSource(i.shape)||t.isSource(i.text),h=this.graph.getPlugin("PopupMenuHandler");this.thread=window.setTimeout(()=>{if(i&&s&&!this.graph.isEditing()&&h&&!h.isMenuShowing()&&!this.graph.isMouseDown){const a=this.graph.getTooltip(i,s,l,r);this.show(a,l,r),this.state=i,this.node=s,this.stateSource=o}},this.delay)}}hide(){this.resetTimer(),this.hideTooltip()}hideTooltip(){this.div&&(this.div.style.visibility="hidden",this.div.innerHTML="")}show(t,e,i){if(!this.destroyed&&t&&t!==""){const s=getScrollOrigin();this.div||this.init(),this.div.style.zIndex=String(this.zIndex),this.div.style.left=`${e+s.x}px`,this.div.style.top=`${i+TOOLTIP_VERTICAL_OFFSET+s.y}px`,isNode(t)?(this.div.innerHTML="",this.div.appendChild(t)):this.div.innerHTML=t.replace(/\n/g,"<br>"),this.div.style.visibility="",fit(this.div)}}onDestroy(){var t;this.destroyed||(this.resetTimer(),this.graph.removeMouseListener(this),this.div&&InternalEvent.release(this.div),(t=this.div)!=null&&t.parentNode&&this.div.parentNode.removeChild(this.div),this.destroyed=!0,this.div=null)}}TooltipHandler.pluginId="TooltipHandler";class SelectionCellsHandler extends EventSource{constructor(t){super(),this.enabled=!0,this.maxHandlers=100,this.graph=t,this.handlers=new Dictionary,this.graph.addMouseListener(this),this.refreshHandler=(e,i)=>{this.isEnabled()&&this.refresh()},this.graph.getSelectionModel().addListener(InternalEvent.CHANGE,this.refreshHandler),this.graph.getDataModel().addListener(InternalEvent.CHANGE,this.refreshHandler),this.graph.getView().addListener(InternalEvent.SCALE,this.refreshHandler),this.graph.getView().addListener(InternalEvent.TRANSLATE,this.refreshHandler),this.graph.getView().addListener(InternalEvent.SCALE_AND_TRANSLATE,this.refreshHandler),this.graph.getView().addListener(InternalEvent.DOWN,this.refreshHandler),this.graph.getView().addListener(InternalEvent.UP,this.refreshHandler)}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}getHandler(t){return this.handlers.get(t)}isHandled(t){return!!this.getHandler(t)}reset(){this.handlers.visit((t,e)=>{e.reset.apply(e)})}getHandledSelectionCells(){return this.graph.getSelectionCells()}refresh(){const t=this.handlers;this.handlers=new Dictionary;const e=sortCells(this.getHandledSelectionCells(),!1);for(let i=0;i<e.length;i+=1){const s=this.graph.view.getState(e[i]);if(s){let l=t.remove(e[i]);l&&(l.state!==s?(l.onDestroy(),l=null):this.isHandlerActive(l)||(l.refresh&&l.refresh(),l.redraw())),l&&this.handlers.put(e[i],l)}}t.visit((i,s)=>{this.fireEvent(new EventObject(InternalEvent.REMOVE,{state:s.state})),s.onDestroy()});for(let i=0;i<e.length;i+=1){const s=this.graph.view.getState(e[i]);if(s){let l=this.handlers.get(e[i]);l?l.updateParentHighlight():(l=this.graph.createHandler(s),this.fireEvent(new EventObject(InternalEvent.ADD,{state:s})),this.handlers.put(e[i],l))}}}isHandlerActive(t){return t.index!==null}updateHandler(t){let e=this.handlers.remove(t.cell);if(e){const{index:i}=e,s=e.startX,l=e.startY;e.onDestroy(),e=this.graph.createHandler(t),e&&(this.handlers.put(t.cell,e),i!==null&&e.start(s,l,i))}}mouseDown(t,e){this.graph.isEnabled()&&this.isEnabled()&&this.handlers.visit((i,s)=>{s.mouseDown(t,e)})}mouseMove(t,e){this.graph.isEnabled()&&this.isEnabled()&&this.handlers.visit((i,s)=>{s.mouseMove(t,e)})}mouseUp(t,e){this.graph.isEnabled()&&this.isEnabled()&&this.handlers.visit((i,s)=>{s.mouseUp(t,e)})}onDestroy(){this.graph.removeMouseListener(this),this.graph.removeListener(this.refreshHandler),this.graph.getDataModel().removeListener(this.refreshHandler),this.graph.getView().removeListener(this.refreshHandler)}}SelectionCellsHandler.pluginId="SelectionCellsHandler";class MaxPopupMenu extends EventSource{constructor(t){super(),this.activeRow=null,this.eventReceiver=null,this.submenuImage=`${Client.imageBasePath}/submenu.gif`,this.zIndex=10006,this.useLeftButtonForPopup=!1,this.enabled=!0,this.itemCount=0,this.autoExpand=!1,this.smartSeparators=!1,this.labels=!0,this.willAddSeparator=!1,this.containsItems=!1,t&&(this.factoryMethod=t),this.table=document.createElement("table"),this.table.className="mxPopupMenu",this.tbody=document.createElement("tbody"),this.table.appendChild(this.tbody),this.div=document.createElement("div"),this.div.className="mxPopupMenu",this.div.style.display="inline",this.div.style.zIndex=String(this.zIndex),this.div.appendChild(this.table),InternalEvent.disableContextMenu(this.div)}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}isPopupTrigger(t){return t.isPopupTrigger()||this.useLeftButtonForPopup&&isLeftMouseButton(t.getEvent())}addItem(t,e,i,s=null,l=null,r=!0,o=!0,h=!1){var c;s=s??this,this.itemCount++,s.willAddSeparator&&(s.containsItems&&this.addSeparator(s,!0),s.willAddSeparator=!1),s.containsItems=!0;const a=document.createElement("tr");a.className="mxPopupMenuItem";const d=document.createElement("td");if(d.className="mxPopupMenuIcon",e){const g=document.createElement("img");g.src=e,d.appendChild(g)}else if(l){const g=document.createElement("div");g.className=l,d.appendChild(g)}if(a.appendChild(d),this.labels){const g=document.createElement("td");g.className=`mxPopupMenuItem${r?"":" mxDisabled"}`,write(g,t),g.align="left",a.appendChild(g);const u=document.createElement("td");u.className=`mxPopupMenuItem${r?"":" mxDisabled"}`,u.style.paddingRight="6px",u.style.textAlign="right",a.appendChild(u),s.div==null&&this.createSubmenu(s)}return(c=s.tbody)==null||c.appendChild(a),o&&r&&(InternalEvent.addGestureListeners(a,g=>{this.eventReceiver=a,s&&s.activeRow!=a&&s.activeRow!=s&&(s.activeRow&&s.activeRow.div.parentNode&&this.hideSubmenu(s),a.div&&(this.showSubmenu(s,a),s.activeRow=a)),InternalEvent.consume(g)},g=>{s&&s.activeRow!=a&&s.activeRow!=s&&(s.activeRow&&s.activeRow.div.parentNode&&this.hideSubmenu(s),this.autoExpand&&a.div&&(this.showSubmenu(s,a),s.activeRow=a)),h||(a.className="mxPopupMenuItemHover")},g=>{this.eventReceiver==a&&(s&&s.activeRow!=a&&this.hideMenu(),i==null||i(g)),this.eventReceiver=null,InternalEvent.consume(g)}),h||InternalEvent.addListener(a,"mouseout",g=>{a.className="mxPopupMenuItem"})),a}addCheckmark(t,e){if(t.firstChild){const i=t.firstChild.nextSibling;i.style.backgroundImage=`url('${e}')`,i.style.backgroundRepeat="no-repeat",i.style.backgroundPosition="2px 50%"}}createSubmenu(t){var i,s;t.table=document.createElement("table"),t.table.className="mxPopupMenu",t.tbody=document.createElement("tbody"),t.table.appendChild(t.tbody),t.div=document.createElement("div"),t.div.className="mxPopupMenu",t.div.style.position="absolute",t.div.style.display="inline",t.div.style.zIndex=String(this.zIndex),t.div.appendChild(t.table);const e=document.createElement("img");e.setAttribute("src",this.submenuImage),(s=(i=t.firstChild)==null?void 0:i.nextSibling)!=null&&s.nextSibling&&t.firstChild.nextSibling.nextSibling.appendChild(e)}showSubmenu(t,e){if(e.div){e.div.style.left=`${t.div.offsetLeft+e.offsetLeft+e.offsetWidth-1}px`,e.div.style.top=`${t.div.offsetTop+e.offsetTop}px`,document.body.appendChild(e.div);const i=e.div.offsetLeft,s=e.div.offsetWidth,l=getDocumentScrollOrigin(document),r=document.body,o=document.documentElement,h=l.x+(r.clientWidth||o.clientWidth);i+s>h&&(e.div.style.left=`${Math.max(0,t.div.offsetLeft-s-6)}px`),fit(e.div)}}addSeparator(t=null,e=!1){if(t=t||this,this.smartSeparators&&!e)t.willAddSeparator=!0;else if(t.tbody){t.willAddSeparator=!1;const i=document.createElement("tr"),s=document.createElement("td");s.className="mxPopupMenuIcon",s.style.padding="0 0 0 0px",i.appendChild(s);const l=document.createElement("td");l.style.padding="0 0 0 0px",l.setAttribute("colSpan","2");const r=document.createElement("hr");r.setAttribute("size","1"),l.appendChild(r),i.appendChild(l),t.tbody.appendChild(i)}}popup(t,e,i,s){if(this.div&&this.tbody&&this.factoryMethod){for(this.div.style.left=`${t}px`,this.div.style.top=`${e}px`;this.tbody.firstChild;)InternalEvent.release(this.tbody.firstChild),this.tbody.removeChild(this.tbody.firstChild);this.itemCount=0,this.factoryMethod(this,i,s),this.itemCount>0&&(this.showMenu(),this.fireEvent(new EventObject(InternalEvent.SHOW)))}}isMenuShowing(){return this.div&&this.div.parentNode==document.body}showMenu(){document.body.appendChild(this.div),fit(this.div)}hideMenu(){var t;this.div&&((t=this.div.parentNode)==null||t.removeChild(this.div),this.hideSubmenu(this),this.containsItems=!1,this.fireEvent(new EventObject(InternalEvent.HIDE)))}hideSubmenu(t){var e;t.activeRow&&(this.hideSubmenu(t.activeRow),(e=t.activeRow.div.parentNode)==null||e.removeChild(t.activeRow.div),t.activeRow=null)}destroy(){var t;this.div&&(InternalEvent.release(this.div),(t=this.div.parentNode)==null||t.removeChild(this.div))}}class PopupMenuHandler extends MaxPopupMenu{constructor(t){super(),this.inTolerance=!1,this.popupTrigger=!1,this.selectOnPopup=!0,this.clearSelectionOnBackground=!0,this.triggerX=null,this.triggerY=null,this.screenX=null,this.screenY=null,this.graph=t,this.graph.addMouseListener(this),this.gestureHandler=(e,i)=>{this.inTolerance=!1},this.graph.addListener(InternalEvent.GESTURE,this.gestureHandler),this.init()}init(){InternalEvent.addGestureListeners(this.div,t=>{const e=this.graph.getPlugin("TooltipHandler");e==null||e.hide()})}isSelectOnPopup(t){return this.selectOnPopup}mouseDown(t,e){this.isEnabled()&&!isMultiTouchEvent(e.getEvent())&&(this.hideMenu(),this.triggerX=e.getGraphX(),this.triggerY=e.getGraphY(),this.screenX=getMainEvent(e.getEvent()).screenX,this.screenY=getMainEvent(e.getEvent()).screenY,this.popupTrigger=this.isPopupTrigger(e),this.inTolerance=!0)}mouseMove(t,e){this.inTolerance&&this.screenX!=null&&this.screenY!=null&&(Math.abs(getMainEvent(e.getEvent()).screenX-this.screenX)>this.graph.getEventTolerance()||Math.abs(getMainEvent(e.getEvent()).screenY-this.screenY)>this.graph.getEventTolerance())&&(this.inTolerance=!1)}mouseUp(t,e){if(this.popupTrigger&&this.inTolerance&&this.triggerX!=null&&this.triggerY!=null){const i=this.getCellForPopupEvent(e);this.graph.isEnabled()&&this.isSelectOnPopup(e)&&i!=null&&!this.graph.isCellSelected(i)?this.graph.setSelectionCell(i):this.clearSelectionOnBackground&&i==null&&this.graph.clearSelection();const s=this.graph.getPlugin("TooltipHandler");s==null||s.hide();const l=getScrollOrigin();this.popup(e.getX()+l.x+1,e.getY()+l.y+1,i,e.getEvent()),e.consume()}this.popupTrigger=!1,this.inTolerance=!1}getCellForPopupEvent(t){return t.getCell()}onDestroy(){this.graph.removeMouseListener(this),this.graph.removeListener(this.gestureHandler),super.destroy()}}PopupMenuHandler.pluginId="PopupMenuHandler";class ConnectionHandler extends EventSource{constructor(t,e=null){super(),this.previous=null,this.iconState=null,this.icons=[],this.cell=null,this.currentPoint=null,this.sourceConstraint=null,this.shape=null,this.icon=null,this.originalPoint=null,this.currentState=null,this.selectedIcon=null,this.waypoints=[],this.factoryMethod=null,this.moveIconFront=!1,this.moveIconBack=!1,this.connectImage=null,this.targetConnectImage=!1,this.enabled=!1,this.select=!0,this.createTarget=!1,this.error=null,this.waypointsEnabled=!1,this.ignoreMouseDown=!1,this.first=null,this.connectIconOffset=new Point(0,TOOLTIP_VERTICAL_OFFSET),this.edgeState=null,this.mouseDownCounter=0,this.movePreviewAway=!1,this.outlineConnect=!1,this.livePreview=!1,this.cursor=null,this.insertBeforeSource=!1,this.graph=t,this.factoryMethod=e,this.graph.addMouseListener(this),this.marker=this.createMarker(),this.constraintHandler=new ConstraintHandler(this.graph),this.changeHandler=i=>{this.iconState&&(this.iconState=this.graph.getView().getState(this.iconState.cell)),this.iconState?(this.redrawIcons(this.icons,this.iconState),this.constraintHandler.reset()):this.previous&&!this.graph.view.getState(this.previous.cell)&&this.reset()},this.graph.getDataModel().addListener(InternalEvent.CHANGE,this.changeHandler),this.graph.getView().addListener(InternalEvent.SCALE,this.changeHandler),this.graph.getView().addListener(InternalEvent.TRANSLATE,this.changeHandler),this.graph.getView().addListener(InternalEvent.SCALE_AND_TRANSLATE,this.changeHandler),this.drillHandler=i=>{this.reset()},this.graph.addListener(InternalEvent.START_EDITING,this.drillHandler),this.graph.getView().addListener(InternalEvent.DOWN,this.drillHandler),this.graph.getView().addListener(InternalEvent.UP,this.drillHandler),this.escapeHandler=()=>{this.reset()},this.graph.addListener(InternalEvent.ESCAPE,this.escapeHandler)}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}isInsertBefore(t,e,i,s,l){return this.insertBeforeSource&&e!==i}isCreateTarget(t){return this.createTarget}setCreateTarget(t){this.createTarget=t}createShape(){const t=this.livePreview&&this.edgeState?this.graph.cellRenderer.createShape(this.edgeState):new PolylineShape([],INVALID_COLOR);return t&&t.node&&(t.dialect=DIALECT.SVG,t.scale=this.graph.view.scale,t.pointerEvents=!1,t.isDashed=!0,t.init(this.graph.getView().getOverlayPane()),InternalEvent.redirectMouseEvents(t.node,this.graph,null)),t}isConnectableCell(t){return!0}createMarker(){return new ConnectionHandlerCellMarker(this.graph,this)}start(t,e,i,s){this.previous=t,this.first=new Point(e,i),this.edgeState=s??this.createEdgeState(),this.marker.currentColor=this.marker.validColor,this.marker.markedState=t,this.marker.mark(),this.fireEvent(new EventObject(InternalEvent.START,{state:this.previous}))}isConnecting(){return!!this.first&&!!this.shape}isValidSource(t,e){return this.graph.isValidSource(t)}isValidTarget(t){return!0}validateConnection(t,e){return this.isValidTarget(e)?this.graph.getEdgeValidationError(null,t,e):""}getConnectImage(t){return this.connectImage}isMoveIconToFrontForState(t){return t.text&&t.text.node.parentNode===this.graph.container?!0:this.moveIconFront}createIcons(t){const e=this.getConnectImage(t);if(e){this.iconState=t;const i=[],s=new Rectangle(0,0,e.width,e.height),l=new ImageShape(s,e.src,void 0,void 0,0);l.preserveImageAspect=!1,this.isMoveIconToFrontForState(t)?(l.dialect=DIALECT.STRICTHTML,l.init(this.graph.container)):(l.dialect=DIALECT.SVG,l.init(this.graph.getView().getOverlayPane()),this.moveIconBack&&l.node.parentNode&&l.node.previousSibling&&l.node.parentNode.insertBefore(l.node,l.node.parentNode.firstChild)),l.node.style.cursor=CURSOR.CONNECT;const r=()=>this.currentState??t,o=h=>{isConsumed(h)||(this.icon=l,this.graph.fireMouseEvent(InternalEvent.MOUSE_DOWN,new InternalMouseEvent(h,r())))};return InternalEvent.redirectMouseEvents(l.node,this.graph,r,o),i.push(l),this.redrawIcons(i,this.iconState),i}return[]}redrawIcons(t,e){if(t[0]&&t[0].bounds){const i=this.getIconPosition(t[0],e);t[0].bounds.x=i.x,t[0].bounds.y=i.y,t[0].redraw()}}getIconPosition(t,e){const{scale:i}=this.graph.getView();let s=e.getCenterX(),l=e.getCenterY();if(this.graph.isSwimlane(e.cell)){const r=this.graph.getStartSize(e.cell);s=r.width!==0?e.x+r.width*i/2:s,l=r.height!==0?e.y+r.height*i/2:l;const o=toRadians(e.style.rotation??0);if(o!==0){const h=Math.cos(o),a=Math.sin(o),d=new Point(e.getCenterX(),e.getCenterY()),c=getRotatedPoint(new Point(s,l),h,a,d);s=c.x,l=c.y}}return new Point(s-t.bounds.width/2,l-t.bounds.height/2)}destroyIcons(){for(let t=0;t<this.icons.length;t+=1)this.icons[t].destroy();this.icons=[],this.icon=null,this.selectedIcon=null,this.iconState=null}isStartEvent(t){return this.constraintHandler.currentFocus!==null&&this.constraintHandler.currentConstraint!==null||this.previous!==null&&this.error===null&&(this.icons.length===0||this.icon!==null)}mouseDown(t,e){if(this.mouseDownCounter+=1,this.isEnabled()&&this.graph.isEnabled()&&!e.isConsumed()&&!this.isConnecting()&&this.isStartEvent(e)){if(this.constraintHandler.currentConstraint&&this.constraintHandler.currentFocus&&this.constraintHandler.currentPoint?(this.sourceConstraint=this.constraintHandler.currentConstraint,this.previous=this.constraintHandler.currentFocus,this.first=this.constraintHandler.currentPoint.clone()):this.first=new Point(e.getGraphX(),e.getGraphY()),this.edgeState=this.createEdgeState(e),this.mouseDownCounter=1,this.waypointsEnabled&&!this.shape&&(this.waypoints=[],this.shape=this.createShape(),this.edgeState&&this.shape.apply(this.edgeState)),!this.previous&&this.edgeState&&this.edgeState.cell.geometry){const i=this.graph.getPointForEvent(e.getEvent());this.edgeState.cell.geometry.setTerminalPoint(i,!0)}this.fireEvent(new EventObject(InternalEvent.START,{state:this.previous})),e.consume()}this.selectedIcon=this.icon,this.icon=null}isImmediateConnectSource(t){return!this.graph.isCellMovable(t.cell)}createEdgeState(t){return null}isOutlineConnectEvent(t){if(!this.currentPoint)return!1;const e=getOffset(this.graph.container),i=t.getEvent(),s=getClientX(i),l=getClientY(i),r=document.documentElement,o=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),h=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),a=this.currentPoint.x-this.graph.container.scrollLeft+e.x-o,d=this.currentPoint.y-this.graph.container.scrollTop+e.y-h;return this.outlineConnect&&!isShiftDown(t.getEvent())&&(t.isSource(this.marker.highlight.shape)||isAltDown(t.getEvent())&&t.getState()!=null||this.marker.highlight.isHighlightAt(s,l)||(a!==s||d!==l)&&t.getState()==null&&this.marker.highlight.isHighlightAt(a,d))}updateCurrentState(t,e){if(this.constraintHandler.update(t,!this.first,!1,!this.first||t.isSource(this.marker.highlight.shape)?null:e),this.constraintHandler.currentFocus!=null&&this.constraintHandler.currentConstraint!=null)this.marker.highlight&&this.marker.highlight.state&&this.marker.highlight.state.cell===this.constraintHandler.currentFocus.cell&&this.marker.highlight.shape?this.marker.highlight.shape.stroke!=="transparent"&&(this.marker.highlight.shape.stroke="transparent",this.marker.highlight.repaint()):this.marker.markCell(this.constraintHandler.currentFocus.cell,"transparent"),this.previous&&(this.error=this.validateConnection(this.previous.cell,this.constraintHandler.currentFocus.cell),this.error||(this.currentState=this.constraintHandler.currentFocus),(this.error||this.currentState&&!this.isCellEnabled(this.currentState.cell))&&this.constraintHandler.reset());else{this.graph.isIgnoreTerminalEvent(t.getEvent())?(this.marker.reset(),this.currentState=null):(this.marker.process(t),this.currentState=this.marker.getValidState()),this.currentState!=null&&!this.isCellEnabled(this.currentState.cell)&&(this.constraintHandler.reset(),this.marker.reset(),this.currentState=null);const i=this.isOutlineConnectEvent(t);if(this.currentState!=null&&i){t.isSource(this.marker.highlight.shape)&&(e=new Point(t.getGraphX(),t.getGraphY()));const s=this.graph.getOutlineConstraint(e,this.currentState,t);this.constraintHandler.setFocus(t,this.currentState,!1),this.constraintHandler.currentConstraint=s,this.constraintHandler.currentPoint=e}if(this.outlineConnect&&this.marker.highlight!=null&&this.marker.highlight.shape!=null){const s=this.graph.view.scale;if(this.constraintHandler.currentConstraint!=null&&this.constraintHandler.currentFocus!=null)this.marker.highlight.shape.stroke=OUTLINE_HIGHLIGHT_COLOR,this.marker.highlight.shape.strokeWidth=OUTLINE_HIGHLIGHT_STROKEWIDTH/s/s,this.marker.highlight.repaint();else if(this.marker.hasValidState()){const l=t.getCell();l&&l.isConnectable()&&this.marker.getValidState()!==t.getState()?(this.marker.highlight.shape.stroke="transparent",this.currentState=null):this.marker.highlight.shape.stroke=DEFAULT_VALID_COLOR,this.marker.highlight.shape.strokeWidth=HIGHLIGHT_STROKEWIDTH/s/s,this.marker.highlight.repaint()}}}}isCellEnabled(t){return!0}convertWaypoint(t){const e=this.graph.getView().getScale(),i=this.graph.getView().getTranslate();t.x=t.x/e-i.x,t.y=t.y/e-i.y}snapToPreview(t,e){if(!isAltDown(t.getEvent())&&this.previous){const i=this.graph.getGridSize()*this.graph.view.scale/2,s=this.sourceConstraint&&this.first?this.first:new Point(this.previous.getCenterX(),this.previous.getCenterY());Math.abs(s.x-t.getGraphX())<i&&(e.x=s.x),Math.abs(s.y-t.getGraphY())<i&&(e.y=s.y)}}mouseMove(t,e){if(!e.isConsumed()&&(this.ignoreMouseDown||this.first||!this.graph.isMouseDown)){!this.isEnabled()&&this.currentState&&(this.destroyIcons(),this.currentState=null);const i=this.graph.getView(),{scale:s}=i,l=i.translate;let r=new Point(e.getGraphX(),e.getGraphY());if(this.error=null,this.graph.isGridEnabledEvent(e.getEvent())&&(r=new Point((this.graph.snap(r.x/s-l.x)+l.x)*s,(this.graph.snap(r.y/s-l.y)+l.y)*s)),this.snapToPreview(e,r),this.currentPoint=r,(this.first||this.isEnabled()&&this.graph.isEnabled())&&(this.shape||!this.first||Math.abs(e.getGraphX()-this.first.x)>this.graph.getEventTolerance()||Math.abs(e.getGraphY()-this.first.y)>this.graph.getEventTolerance())&&this.updateCurrentState(e,r),this.first){let o=null,h=r;this.constraintHandler.currentConstraint&&this.constraintHandler.currentFocus&&this.constraintHandler.currentPoint?(o=this.constraintHandler.currentConstraint,h=this.constraintHandler.currentPoint.clone()):this.previous&&!this.graph.isIgnoreTerminalEvent(e.getEvent())&&isShiftDown(e.getEvent())&&(Math.abs(this.previous.getCenterX()-r.x)<Math.abs(this.previous.getCenterY()-r.y)?r.x=this.previous.getCenterX():r.y=this.previous.getCenterY());let a=this.first;if(this.selectedIcon&&this.selectedIcon.bounds){const d=this.selectedIcon.bounds.width,c=this.selectedIcon.bounds.height;if(this.currentState&&this.targetConnectImage){const g=this.getIconPosition(this.selectedIcon,this.currentState);this.selectedIcon.bounds.x=g.x,this.selectedIcon.bounds.y=g.y}else{const g=new Rectangle(e.getGraphX()+this.connectIconOffset.x,e.getGraphY()+this.connectIconOffset.y,d,c);this.selectedIcon.bounds=g}this.selectedIcon.redraw()}if(this.edgeState)this.updateEdgeState(h,o),h=this.edgeState.absolutePoints[this.edgeState.absolutePoints.length-1],a=this.edgeState.absolutePoints[0];else{if(this.currentState&&!this.constraintHandler.currentConstraint){const d=this.getTargetPerimeterPoint(this.currentState,e);d!=null&&(h=d)}if(!this.sourceConstraint&&this.previous){const d=this.waypoints.length>0?this.waypoints[0]:h,c=this.getSourcePerimeterPoint(this.previous,d,e);c&&(a=c)}}if(!this.currentState&&this.movePreviewAway&&h){let d=a;if(this.edgeState&&this.edgeState.absolutePoints.length>=2){const c=this.edgeState.absolutePoints[this.edgeState.absolutePoints.length-2];c&&(d=c)}if(d){const c=h.x-d.x,g=h.y-d.y,u=Math.sqrt(c*c+g*g);if(u===0)return;this.originalPoint=h.clone(),h.x-=c*4/u,h.y-=g*4/u}}else this.originalPoint=null;if(!this.shape){const d=Math.abs(e.getGraphX()-this.first.x),c=Math.abs(e.getGraphY()-this.first.y);(d>this.graph.getEventTolerance()||c>this.graph.getEventTolerance())&&(this.shape=this.createShape(),this.edgeState&&this.shape.apply(this.edgeState),this.updateCurrentState(e,r))}if(this.shape){if(this.edgeState)this.shape.points=this.edgeState.absolutePoints;else{let d=[a];this.waypoints.length>0&&(d=d.concat(this.waypoints)),d.push(h),this.shape.points=d}this.drawPreview()}this.cursor&&(this.graph.container.style.cursor=this.cursor),InternalEvent.consume(e.getEvent()),e.consume()}else!this.isEnabled()||!this.graph.isEnabled()?this.constraintHandler.reset():this.previous!==this.currentState&&!this.edgeState?(this.destroyIcons(),this.currentState&&!this.error&&!this.constraintHandler.currentConstraint&&(this.icons=this.createIcons(this.currentState),this.icons.length===0&&(this.currentState.setCursor(CURSOR.CONNECT),e.consume())),this.previous=this.currentState):this.previous===this.currentState&&this.currentState!=null&&this.icons.length===0&&!this.graph.isMouseDown&&e.consume();if(!this.graph.isMouseDown&&this.currentState!=null&&this.icons!=null){let o=!1;const h=e.getSource();for(let a=0;a<this.icons.length&&!o;a+=1)o=h===this.icons[a].node||!!h&&h.parentNode===this.icons[a].node;o||this.updateIcons(this.currentState,this.icons,e)}}else this.constraintHandler.reset()}updateEdgeState(t,e){if(!this.edgeState)return;this.sourceConstraint&&this.sourceConstraint.point&&(this.edgeState.style.exitX=this.sourceConstraint.point.x,this.edgeState.style.exitY=this.sourceConstraint.point.y),e&&e.point?(this.edgeState.style.entryX=e.point.x,this.edgeState.style.entryY=e.point.y):(this.edgeState.style.entryX=0,this.edgeState.style.entryY=0),this.edgeState.absolutePoints=[null,this.currentState!=null?null:t],this.sourceConstraint&&this.graph.view.updateFixedTerminalPoint(this.edgeState,this.previous,!0,this.sourceConstraint),this.currentState!=null&&(e==null&&(e=this.graph.getConnectionConstraint(this.edgeState,this.previous,!1)),this.edgeState.setAbsoluteTerminalPoint(null,!1),this.graph.view.updateFixedTerminalPoint(this.edgeState,this.currentState,!1,e));const i=[];for(let s=0;s<this.waypoints.length;s+=1){const l=this.waypoints[s].clone();this.convertWaypoint(l),i[s]=l}this.graph.view.updatePoints(this.edgeState,i,this.previous,this.currentState),this.graph.view.updateFloatingTerminalPoints(this.edgeState,this.previous,this.currentState)}getTargetPerimeterPoint(t,e){let i=null;const{view:s}=t,l=s.getPerimeterFunction(t);if(l&&this.previous&&this.edgeState){const r=this.waypoints.length>0?this.waypoints[this.waypoints.length-1]:new Point(this.previous.getCenterX(),this.previous.getCenterY()),o=l(s.getPerimeterBounds(t),this.edgeState,r,!1);o&&(i=o)}else i=new Point(t.getCenterX(),t.getCenterY());return i}getSourcePerimeterPoint(t,e,i){let s=null;const{view:l}=t,r=l.getPerimeterFunction(t),o=new Point(t.getCenterX(),t.getCenterY());if(r){const h=t.style.rotation??0,a=-h*(Math.PI/180);h!==0&&(e=getRotatedPoint(new Point(e.x,e.y),Math.cos(a),Math.sin(a),o));let d=r(l.getPerimeterBounds(t),t,e,!1);d&&(h!==0&&(d=getRotatedPoint(new Point(d.x,d.y),Math.cos(-a),Math.sin(-a),o)),s=d)}else s=o;return s}updateIcons(t,e,i){}isStopEvent(t){return!!t.getState()}addWaypointForEvent(t){if(!this.first)return;let e=convertPoint(this.graph.container,t.getX(),t.getY());const i=Math.abs(e.x-this.first.x),s=Math.abs(e.y-this.first.y);if(this.waypoints.length>0||this.mouseDownCounter>1&&(i>this.graph.getEventTolerance()||s>this.graph.getEventTolerance())){const{scale:r}=this.graph.view;e=new Point(this.graph.snap(t.getGraphX()/r)*r,this.graph.snap(t.getGraphY()/r)*r),this.waypoints.push(e)}}checkConstraints(t,e){return!t||!e||!t.point||!e.point||!t.point.equals(e.point)||t.dx!==e.dx||t.dy!==e.dy||t.perimeter!==e.perimeter}mouseUp(t,e){if(!e.isConsumed()&&this.isConnecting()){if(this.waypointsEnabled&&!this.isStopEvent(e)){this.addWaypointForEvent(e),e.consume();return}const i=this.sourceConstraint,s=this.constraintHandler.currentConstraint,l=this.previous?this.previous.cell:null;let r=null;this.constraintHandler.currentConstraint&&this.constraintHandler.currentFocus&&(r=this.constraintHandler.currentFocus.cell),!r&&this.currentState&&(r=this.currentState.cell),!this.error&&(!l||!r||l!==r||this.checkConstraints(i,s))?this.connect(l,r,e.getEvent(),e.getCell()):(this.previous!=null&&this.marker.validState!=null&&this.previous.cell===this.marker.validState.cell&&this.graph.selectCellForEvent(this.marker.validState.cell,e.getEvent()),this.error!=null&&this.error.length>0&&this.graph.validationAlert(this.error)),this.destroyIcons(),e.consume()}this.first!=null&&this.reset()}reset(){this.shape!=null&&(this.shape.destroy(),this.shape=null),this.cursor!=null&&this.graph.container!=null&&(this.graph.container.style.cursor=""),this.destroyIcons(),this.marker.reset(),this.constraintHandler.reset(),this.originalPoint=null,this.currentPoint=null,this.edgeState=null,this.previous=null,this.error=null,this.sourceConstraint=null,this.mouseDownCounter=0,this.first=null,this.fireEvent(new EventObject(InternalEvent.RESET))}drawPreview(){this.updatePreview(this.error===null),this.shape&&this.shape.redraw()}updatePreview(t){this.shape&&(this.shape.strokeWidth=this.getEdgeWidth(t),this.shape.stroke=this.getEdgeColor(t))}getEdgeColor(t){return t?VALID_COLOR:INVALID_COLOR}getEdgeWidth(t){return t?3:1}connect(t,e,i,s=null){var l,r,o,h;if(e||this.isCreateTarget(i)||this.graph.isAllowDanglingEdges()){const a=this.graph.getDataModel();let d=!1,c=null;a.beginUpdate();try{if(t&&!e&&!this.graph.isIgnoreTerminalEvent(i)&&this.isCreateTarget(i)&&(e=this.createTargetVertex(i,t),e)){if(s=this.graph.getDropTarget([e],i,s),d=!0,s==null||!s.isEdge()){const p=s?this.graph.getView().getState(s):null;if(p){const E=e.getGeometry();E&&(E.x-=p.origin.x,E.y-=p.origin.y)}}else s=this.graph.getDefaultParent();this.graph.addCell(e,s)}let g=this.graph.getDefaultParent();t&&e&&t.getParent()===e.getParent()&&((l=t.getParent())==null?void 0:l.getParent())!==a.getRoot()&&(g=t.getParent(),t.geometry&&t.geometry.relative&&e.geometry&&e.geometry.relative&&(g=g.getParent()));let u=null,f={};if((r=this.edgeState)!=null&&r.cell&&(u=this.edgeState.cell.value,f=this.edgeState.cell.style??{}),c=this.insertEdge(g,"",u,t,e,f),c&&t){if(this.graph.setConnectionConstraint(c,t,!0,this.sourceConstraint),this.graph.setConnectionConstraint(c,e,!1,this.constraintHandler.currentConstraint),(h=(o=this.edgeState)==null?void 0:o.cell)!=null&&h.geometry&&a.setGeometry(c,this.edgeState.cell.geometry),g=t.getParent(),this.isInsertBefore(c,t,e,i,s)){let C=t;for(;C&&C.parent!=null&&C.geometry!=null&&C.geometry.relative&&C.parent!==c.parent;)C=C.getParent();C!=null&&C.parent!=null&&C.parent===c.parent&&a.add(g,c,C.parent.getIndex(C))}let p=c.getGeometry();if(p==null&&(p=new Geometry,p.relative=!0,a.setGeometry(c,p)),this.waypoints.length>0){const E=this.graph.view.scale,C=this.graph.view.translate;p.points=[];for(let y=0;y<this.waypoints.length;y+=1){const w=this.waypoints[y];p.points.push(new Point(w.x/E-C.x,w.y/E-C.y))}}if(!e&&this.currentPoint){const E=this.graph.view.translate,C=this.graph.view.scale,y=this.originalPoint!=null?new Point(this.originalPoint.x/C-E.x,this.originalPoint.y/C-E.y):new Point(this.currentPoint.x/C-E.x,this.currentPoint.y/C-E.y);y.x-=this.graph.getPanDx()/this.graph.view.scale,y.y-=this.graph.getPanDy()/this.graph.view.scale,p.setTerminalPoint(y,!1)}this.fireEvent(new EventObject(InternalEvent.CONNECT,"cell",c,"terminal",e,"event",i,"target",s,"terminalInserted",d))}}catch(g){GlobalConfig.logger.show();const u=`Error in ConnectionHandler: ${g instanceof Error?g.message+`
`+g.stack:"unknown cause"}`;GlobalConfig.logger.debug(u)}finally{a.endUpdate()}this.select&&this.selectCells(c,d?e:null)}}selectCells(t,e){this.graph.setSelectionCell(t)}insertEdge(t,e,i,s,l,r){if(!this.factoryMethod)return this.graph.insertEdge(t,e,i,s,l,r);let o=this.createEdge(i,s,l,r);return o=this.graph.addEdge(o,t,s,l),o}createTargetVertex(t,e){let i=e.getGeometry();for(;i&&i.relative;)e=e.getParent(),i=e.getGeometry();const s=this.graph.cloneCell(e);if(i=s.getGeometry(),i&&this.currentPoint){const l=this.graph.view.translate,r=this.graph.view.scale,o=new Point(this.currentPoint.x/r-l.x,this.currentPoint.y/r-l.y);i.x=Math.round(o.x-i.width/2-this.graph.getPanDx()/r),i.y=Math.round(o.y-i.height/2-this.graph.getPanDy()/r);const h=this.getAlignmentTolerance();if(h>0){const a=this.graph.view.getState(e);if(a!=null){const d=a.x/r-l.x,c=a.y/r-l.y;Math.abs(d-i.x)<=h&&(i.x=Math.round(d)),Math.abs(c-i.y)<=h&&(i.y=Math.round(c))}}}return s}getAlignmentTolerance(t){return this.graph.isGridEnabled()?this.graph.getGridSize()/2:this.graph.getSnapTolerance()}createEdge(t,e,i,s={}){let l=null;if(this.factoryMethod!=null&&(l=this.factoryMethod(e,i,s)),l==null){l=new Cell(t||""),l.setEdge(!0),l.setStyle(s);const r=new Geometry;r.relative=!0,l.setGeometry(r)}return l}onDestroy(){this.graph.removeMouseListener(this),this.shape&&(this.shape.destroy(),this.shape=null),this.marker&&(this.marker.destroy(),this.marker=null),this.constraintHandler&&this.constraintHandler.onDestroy(),this.changeHandler&&(this.graph.getDataModel().removeListener(this.changeHandler),this.graph.getView().removeListener(this.changeHandler)),this.drillHandler&&(this.graph.removeListener(this.drillHandler),this.graph.getView().removeListener(this.drillHandler)),this.escapeHandler&&this.graph.removeListener(this.escapeHandler)}}ConnectionHandler.pluginId="ConnectionHandler";class ConnectionHandlerCellMarker extends CellMarker{constructor(t,e,i=DEFAULT_VALID_COLOR,s=DEFAULT_INVALID_COLOR,l=DEFAULT_HOTSPOT){super(t,i,s,l),this.hotspotEnabled=!0,this.connectionHandler=e}getCell(t){let e=super.getCell(t);if(this.connectionHandler.error=null,!e&&this.connectionHandler.currentPoint&&(e=this.connectionHandler.graph.getCellAt(this.connectionHandler.currentPoint.x,this.connectionHandler.currentPoint.y)),e&&!e.isConnectable()&&this.connectionHandler.cell){const i=this.connectionHandler.cell.getParent();i&&i.isVertex()&&i.isConnectable()&&(e=i)}return e&&(this.connectionHandler.graph.isSwimlane(e)&&this.connectionHandler.currentPoint!=null&&this.connectionHandler.graph.hitsSwimlaneContent(e,this.connectionHandler.currentPoint.x,this.connectionHandler.currentPoint.y)||!this.connectionHandler.isConnectableCell(e))&&(e=null),e?this.connectionHandler.isConnecting()?this.connectionHandler.previous&&(this.connectionHandler.error=this.connectionHandler.validateConnection(this.connectionHandler.previous.cell,e),this.connectionHandler.error!==null&&this.connectionHandler.error.length===0&&(e=null,this.connectionHandler.isCreateTarget(t.getEvent())&&(this.connectionHandler.error=null))):this.connectionHandler.isValidSource(e,t)||(e=null):this.connectionHandler.isConnecting()&&!this.connectionHandler.isCreateTarget(t.getEvent())&&!this.connectionHandler.graph.isAllowDanglingEdges()&&(this.connectionHandler.error=""),e}isValidState(t){return this.connectionHandler.isConnecting()?!this.connectionHandler.error:super.isValidState(t)}getMarkerColor(t,e,i){return!this.connectionHandler.connectImage||this.connectionHandler.isConnecting()?super.getMarkerColor(t,e,i):NONE}intersects(t,e){return this.connectionHandler.connectImage||this.connectionHandler.isConnecting()?!0:super.intersects(t,e)}}class Guide{constructor(t,e){this.states=[],this.horizontal=!0,this.vertical=!0,this.guideX=null,this.guideY=null,this.rounded=!1,this.tolerance=2,this.graph=t,this.setStates(e)}setStates(t){this.states=t}isEnabledForEvent(t){return!0}getGuideTolerance(t=!1){return t&&this.graph.isGridEnabled()?this.graph.getGridSize()/2:this.tolerance}createGuideShape(t=!1){const e=new PolylineShape([],GUIDE_COLOR,GUIDE_STROKEWIDTH);return e.isDashed=!0,e}isStateIgnored(t){return!1}move(t=null,e,i=!1,s=!1){if((this.horizontal||this.vertical)&&t){const{scale:l}=this.graph.getView(),r=this.getGuideTolerance(i)*l,o=t.clone();o.x+=e.x,o.y+=e.y;let h=!1,a=null,d=null,c=!1,g=null,u=null,f=r,p=r;const E=o.x,C=o.x+o.width,y=o.getCenterX(),w=o.y,v=o.y+o.height,S=o.getCenterY(),I=(R,N,O)=>{let G=!1;O&&Math.abs(R-y)<f?(e.x=R-t.getCenterX(),f=Math.abs(R-y),G=!0):O||(Math.abs(R-E)<f?(e.x=R-t.x,f=Math.abs(R-E),G=!0):Math.abs(R-C)<f&&(e.x=R-t.x-t.width,f=Math.abs(R-C),G=!0)),G&&(a=N,d=R,this.guideX||(this.guideX=this.createGuideShape(!0),this.guideX.dialect=DIALECT.SVG,this.guideX.pointerEvents=!1,this.guideX.init(this.graph.getView().getOverlayPane()))),h=h||G},T=(R,N,O)=>{let G=!1;O&&Math.abs(R-S)<p?(e.y=R-t.getCenterY(),p=Math.abs(R-S),G=!0):O||(Math.abs(R-w)<p?(e.y=R-t.y,p=Math.abs(R-w),G=!0):Math.abs(R-v)<p&&(e.y=R-t.y-t.height,p=Math.abs(R-v),G=!0)),G&&(g=N,u=R,this.guideY||(this.guideY=this.createGuideShape(!1),this.guideY.dialect=DIALECT.SVG,this.guideY.pointerEvents=!1,this.guideY.init(this.graph.getView().getOverlayPane()))),c=c||G};for(let R=0;R<this.states.length;R+=1){const N=this.states[R];N&&!this.isStateIgnored(N)&&(this.horizontal&&(I(N.getCenterX(),N,!0),I(N.x,N,!1),I(N.x+N.width,N,!1),N.cell||I(N.getCenterX(),N,!1)),this.vertical&&(T(N.getCenterY(),N,!0),T(N.y,N,!1),T(N.y+N.height,N,!1),N.cell||T(N.getCenterY(),N,!1)))}this.graph.snapDelta(e,t,!i,h,c),e=this.getDelta(t,a,e.x,g,e.y);const A=this.graph.container;if(!h&&this.guideX)this.guideX.node.style.visibility="hidden";else if(this.guideX){let R=null,N=null;a&&(R=Math.min(t.y+e.y-this.graph.getPanDy(),a.y),N=Math.max(t.y+t.height+e.y-this.graph.getPanDy(),a.y+a.height)),R!==null&&N!==null?this.guideX.points=[new Point(d,R),new Point(d,N)]:this.guideX.points=[new Point(d,-this.graph.getPanDy()),new Point(d,A.scrollHeight-3-this.graph.getPanDy())],this.guideX.stroke=this.getGuideColor(a,!0),this.guideX.node.style.visibility="visible",this.guideX.redraw()}if(!c&&this.guideY!=null)this.guideY.node.style.visibility="hidden";else if(this.guideY!=null){let R=null,N=null;g!=null&&t!=null&&(R=Math.min(t.x+e.x-this.graph.getPanDx(),g.x),N=Math.max(t.x+t.width+e.x-this.graph.getPanDx(),g.x+g.width)),R!=null&&N!=null&&u!==null?this.guideY.points=[new Point(R,u),new Point(N,u)]:u!==null&&(this.guideY.points=[new Point(-this.graph.getPanDx(),u),new Point(A.scrollWidth-3-this.graph.getPanDx(),u)]),this.guideY.stroke=this.getGuideColor(g,!1),this.guideY.node.style.visibility="visible",this.guideY.redraw()}}return e}getDelta(t,e=null,i,s=null,l){const r=this.graph.view.scale;return(this.rounded||e!=null&&e.cell==null)&&(i=Math.round((t.x+i)/r)*r-t.x),(this.rounded||s!=null&&s.cell==null)&&(l=Math.round((t.y+l)/r)*r-t.y),new Point(i,l)}getGuideColor(t,e){return GUIDE_COLOR}hide(){this.setVisible(!1)}setVisible(t){this.guideX&&(this.guideX.node.style.visibility=t?"visible":"hidden"),this.guideY&&(this.guideY.node.style.visibility=t?"visible":"hidden")}destroy(){this.guideX&&(this.guideX.destroy(),this.guideX=null),this.guideY&&(this.guideY.destroy(),this.guideY=null)}}class SelectionHandler{constructor(t){this.refreshThread=null,this.maxCells=50,this.enabled=!0,this.highlightEnabled=!0,this.cloneEnabled=!0,this.moveEnabled=!0,this.guidesEnabled=!1,this.handlesVisible=!0,this.guide=null,this.currentDx=0,this.currentDy=0,this.updateCursor=!0,this.selectEnabled=!0,this.removeCellsFromParent=!0,this.removeEmptyParents=!1,this.connectOnDrop=!1,this.scrollOnMove=!0,this.minimumSize=6,this.previewColor="black",this.htmlPreview=!1,this.shape=null,this.scaleGrid=!1,this.rotationEnabled=!0,this.maxLivePreview=0,this.allowLivePreview=Client.IS_SVG,this.cell=null,this.delayedSelection=!1,this.first=null,this.cells=null,this.bounds=null,this.pBounds=null,this.allCells=new Dictionary,this.cellWasClicked=!1,this.cloning=!1,this.cellCount=0,this.target=null,this.suspended=!1,this.livePreviewActive=!1,this.livePreviewUsed=!1,this.highlight=null,this.graph=t,this.graph.addMouseListener(this),this.panHandler=()=>{this.suspended||(this.updatePreview(),this.updateHint())},this.graph.addListener(InternalEvent.PAN,this.panHandler),this.escapeHandler=(e,i)=>{this.reset()},this.graph.addListener(InternalEvent.ESCAPE,this.escapeHandler),this.refreshHandler=(e,i)=>{this.refreshThread&&window.clearTimeout(this.refreshThread),this.refreshThread=window.setTimeout(()=>{if(this.refreshThread=null,this.first&&!this.suspended&&this.cells){const s=this.currentDx,l=this.currentDy;if(this.currentDx=0,this.currentDy=0,this.updatePreview(),this.bounds=this.graph.getView().getBounds(this.cells),this.pBounds=this.getPreviewBounds(this.cells),this.pBounds==null&&!this.livePreviewUsed)this.reset();else if(this.currentDx=s,this.currentDy=l,this.updatePreview(),this.updateHint(),this.livePreviewUsed){const r=this.graph.getPlugin("SelectionCellsHandler");this.setHandlesVisibleForCells((r==null?void 0:r.getHandledSelectionCells())??[],!1,!0),this.updatePreview()}}},0)},this.graph.getDataModel().addListener(InternalEvent.CHANGE,this.refreshHandler),this.graph.addListener(InternalEvent.REFRESH,this.refreshHandler),this.keyHandler=e=>{if(this.graph.container!=null&&this.graph.container.style.visibility!=="hidden"&&this.first!=null&&!this.suspended){const i=this.graph.isCloneEvent(e)&&this.graph.isCellsCloneable()&&this.isCloneEnabled();i!==this.cloning&&(this.cloning=i,this.checkPreview(),this.updatePreview())}},typeof document<"u"&&(InternalEvent.addListener(document,"keydown",this.keyHandler),InternalEvent.addListener(document,"keyup",this.keyHandler))}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}isCloneEnabled(){return this.cloneEnabled}setCloneEnabled(t){this.cloneEnabled=t}isMoveEnabled(){return this.moveEnabled}setMoveEnabled(t){this.moveEnabled=t}isSelectEnabled(){return this.selectEnabled}setSelectEnabled(t){this.selectEnabled=t}isRemoveCellsFromParent(){return this.removeCellsFromParent}setRemoveCellsFromParent(t){this.removeCellsFromParent=t}isPropagateSelectionCell(t,e,i){const s=t.getParent();if(e){const l=t.isEdge()?null:t.getGeometry();return!this.graph.isSiblingSelected(t)&&l&&l.relative||!this.graph.isSwimlane(s)}return(!this.graph.isToggleEvent(i.getEvent())||!this.graph.isSiblingSelected(t)&&!this.graph.isCellSelected(t)&&!this.graph.isSwimlane(s)||this.graph.isCellSelected(s))&&(this.graph.isToggleEvent(i.getEvent())||!this.graph.isCellSelected(s))}getInitialCellForEvent(t){let e=t.getState();if((!this.graph.isToggleEvent(t.getEvent())||!isAltDown(t.getEvent()))&&e&&!this.graph.isCellSelected(e.cell)){let i=e.cell.getParent(),s=i?this.graph.view.getState(i):null;for(;s&&!this.graph.isCellSelected(s.cell)&&(s.cell.isVertex()||s.cell.isEdge())&&this.isPropagateSelectionCell(e.cell,!0,t);)e=s,i=e.cell.getParent(),s=i?this.graph.view.getState(i):null}return e?e.cell:null}isDelayedSelection(t,e){let i=t;const s=this.graph.getPlugin("SelectionCellsHandler");if(!this.graph.isToggleEvent(e.getEvent())||!isAltDown(e.getEvent()))for(;i;){if(s!=null&&s.isHandled(i)){const l=this.graph.getPlugin("CellEditorHandler");return(l==null?void 0:l.getEditingCell())!==i}i=i.getParent()}return this.graph.isToggleEvent(e.getEvent())&&!isAltDown(e.getEvent())}selectDelayed(t){const e=this.graph.getPlugin("PopupMenuHandler");if(!e||!e.isPopupTrigger(t)){let i=t.getCell();i===null&&(i=this.cell),i&&this.selectCellForEvent(i,t)}}selectCellForEvent(t,e){const i=this.graph.view.getState(t);if(i)if(e.isSource(i.control))this.graph.selectCellForEvent(t,e.getEvent());else{if(!this.graph.isToggleEvent(e.getEvent())||!isAltDown(e.getEvent())){let s=t.getParent();for(;s&&this.graph.view.getState(s)&&(s.isVertex()||s.isEdge())&&this.isPropagateSelectionCell(t,!1,e);)t=s,s=t.getParent()}this.graph.selectCellForEvent(t,e.getEvent())}return t}consumeMouseEvent(t,e){e.consume()}mouseDown(t,e){if(!e.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&e.getState()&&!isMultiTouchEvent(e.getEvent())){const i=this.getInitialCellForEvent(e);if(i&&(this.delayedSelection=this.isDelayedSelection(i,e),this.cell=null,this.isSelectEnabled()&&!this.delayedSelection&&this.graph.selectCellForEvent(i,e.getEvent()),this.isMoveEnabled())){const s=i.getGeometry();s&&this.graph.isCellMovable(i)&&(!i.isEdge()||this.graph.getSelectionCount()>1||s.points&&s.points.length>0||!i.getTerminal(!0)||!i.getTerminal(!1)||this.graph.isAllowDanglingEdges()||this.graph.isCloneEvent(e.getEvent())&&this.graph.isCellsCloneable())?this.start(i,e.getX(),e.getY()):this.delayedSelection&&(this.cell=i),this.cellWasClicked=!0,this.consumeMouseEvent(InternalEvent.MOUSE_DOWN,e)}}}getGuideStates(){const t=this.graph.getDefaultParent(),e=i=>{const s=i.getGeometry();return!!this.graph.view.getState(i)&&i.isVertex()&&!!s&&!s.relative};return this.graph.view.getCellStates(t.filterDescendants(e))}getCells(t){return!this.delayedSelection&&this.graph.isCellMovable(t)?[t]:this.graph.getMovableCells(this.graph.getSelectionCells())}getPreviewBounds(t){const e=this.getBoundingBox(t);if(e){if(e.width=Math.max(0,e.width-1),e.height=Math.max(0,e.height-1),e.width<this.minimumSize){const i=this.minimumSize-e.width;e.x-=i/2,e.width=this.minimumSize}else e.x=Math.round(e.x),e.width=Math.ceil(e.width);if(e.height<this.minimumSize){const i=this.minimumSize-e.height;e.y-=i/2,e.height=this.minimumSize}else e.y=Math.round(e.y),e.height=Math.ceil(e.height)}return e}getBoundingBox(t){let e=null;if(t.length>0){for(let i=0;i<t.length;i+=1)if(t[i].isVertex()||t[i].isEdge()){const s=this.graph.view.getState(t[i]);if(s){let l=null;t[i].isVertex()&&s.shape&&s.shape.boundingBox&&(l=s.shape.boundingBox),l&&(e?e.add(l):e=Rectangle.fromRectangle(l))}}}return e}createPreviewShape(t){const e=new RectangleShape(t,NONE,this.previewColor);return e.isDashed=!0,this.htmlPreview?(e.dialect=DIALECT.STRICTHTML,e.init(this.graph.container)):(e.dialect=DIALECT.SVG,e.init(this.graph.getView().getOverlayPane()),e.pointerEvents=!1,Client.IS_IOS&&(e.getSvgScreenOffset=()=>0)),e}createGuide(){return new Guide(this.graph,this.getGuideStates())}start(t,e,i,s){this.cell=t,this.first=convertPoint(this.graph.container,e,i),this.cells=s||this.getCells(this.cell),this.bounds=this.graph.getView().getBounds(this.cells),this.pBounds=this.getPreviewBounds(this.cells),this.cloning=!1,this.cellCount=0;for(let l=0;l<this.cells.length;l+=1)this.cellCount+=this.addStates(this.cells[l],this.allCells);if(this.guidesEnabled){this.guide=this.createGuide();const l=t.getParent(),r=l.getChildCount()<2,o=new Dictionary,h=this.graph.getOpposites(this.graph.getEdges(this.cell),this.cell);for(let a=0;a<h.length;a+=1){const d=this.graph.view.getState(h[a]);d&&!o.get(d)&&o.put(d,!0)}this.guide.isStateIgnored=a=>{const d=a.cell.getParent();return!!a.cell&&(!this.cloning&&!!this.isCellMoving(a.cell)||a.cell!==(this.target||l)&&!r&&!o.get(a)&&(!this.target||this.target.getChildCount()>=2)&&d!==(this.target||l))}}}addStates(t,e){const i=this.graph.view.getState(t);let s=0;if(i&&!e.get(t)){e.put(t,i),s++;const l=t.getChildCount();for(let r=0;r<l;r+=1)s+=this.addStates(t.getChildAt(r),e)}return s}isCellMoving(t){return this.allCells.get(t)}useGuidesForEvent(t){return this.guide?this.guide.isEnabledForEvent(t.getEvent())&&!this.graph.isConstrainedEvent(t.getEvent()):!0}snap(t){const e=this.scaleGrid?this.graph.view.scale:1;return t.x=this.graph.snap(t.x/e)*e,t.y=this.graph.snap(t.y/e)*e,t}getDelta(t){const e=convertPoint(this.graph.container,t.getX(),t.getY());return this.first?new Point(e.x-this.first.x-this.graph.getPanDx(),e.y-this.first.y-this.graph.getPanDy()):new Point}updateHint(t){}removeHint(){}roundLength(t){return Math.round(t*100)/100}isValidDropTarget(t,e){return this.cell?this.cell.getParent()!==t:!1}checkPreview(){this.livePreviewActive&&this.cloning?(this.resetLivePreview(),this.livePreviewActive=!1):this.maxLivePreview>=this.cellCount&&!this.livePreviewActive&&this.allowLivePreview?(!this.cloning||!this.livePreviewActive)&&(this.livePreviewActive=!0,this.livePreviewUsed=!0):!this.livePreviewUsed&&!this.shape&&this.bounds&&(this.shape=this.createPreviewShape(this.bounds))}mouseMove(t,e){const{graph:i}=this;if(!e.isConsumed()&&i.isMouseDown&&this.cell&&this.first&&this.bounds&&!this.suspended){if(isMultiTouchEvent(e.getEvent())){this.reset();return}let s=this.getDelta(e);const l=i.getEventTolerance();if(this.shape||this.livePreviewActive||Math.abs(s.x)>l||Math.abs(s.y)>l){this.highlight||(this.highlight=new CellHighlight(this.graph,DROP_TARGET_COLOR,3));const r=i.isCloneEvent(e.getEvent())&&i.isCellsCloneable()&&this.isCloneEnabled(),o=i.isGridEnabledEvent(e.getEvent()),h=e.getCell();let a=!0,d=null;this.cloning=r,i.isDropEnabled()&&this.highlightEnabled&&this.cells&&(d=i.getDropTarget(this.cells,e.getEvent(),h,r));let c=d?i.getView().getState(d):null,g=!1;if(c&&(r||d&&this.isValidDropTarget(d,e)))this.target!==d&&(this.target=d,this.setHighlightColor(DROP_TARGET_COLOR)),g=!0;else if(this.target=null,this.connectOnDrop&&h&&this.cells&&this.cells.length===1&&h.isVertex()&&h.isConnectable()&&(c=i.getView().getState(h),c)){const f=i.getEdgeValidationError(null,this.cell,h)===null?VALID_COLOR:INVALID_CONNECT_TARGET_COLOR;this.setHighlightColor(f),g=!0}c&&g?this.highlight.highlight(c):this.highlight.hide(),this.guide&&this.useGuidesForEvent(e)?(s=this.guide.move(this.bounds,s,o,r),a=!1):s=this.graph.snapDelta(s,this.bounds,!o,!1,!1),this.guide&&a&&this.guide.hide(),i.isConstrainedEvent(e.getEvent())&&(Math.abs(s.x)>Math.abs(s.y)?s.y=0:s.x=0),this.checkPreview(),(this.currentDx!==s.x||this.currentDy!==s.y)&&(this.currentDx=s.x,this.currentDy=s.y,this.updatePreview())}this.updateHint(e),this.consumeMouseEvent(InternalEvent.MOUSE_MOVE,e),InternalEvent.consume(e.getEvent())}else if((this.isMoveEnabled()||this.isCloneEnabled())&&this.updateCursor&&!e.isConsumed()&&(e.getState()||e.sourceState)&&!i.isMouseDown){let s=i.getCursorForMouseEvent(e);const l=e.getCell();!s&&l&&i.isEnabled()&&i.isCellMovable(l)&&(l.isEdge()?s=CURSOR.MOVABLE_EDGE:s=CURSOR.MOVABLE_VERTEX),s&&e.sourceState&&e.sourceState.setCursor(s)}}updatePreview(t=!1){if(this.livePreviewUsed&&!t){if(this.cells){const e=this.graph.getPlugin("SelectionCellsHandler");this.setHandlesVisibleForCells((e==null?void 0:e.getHandledSelectionCells())??[],!1),this.updateLivePreview(this.currentDx,this.currentDy)}}else this.updatePreviewShape()}updatePreviewShape(){this.shape&&this.pBounds&&(this.shape.bounds=new Rectangle(Math.round(this.pBounds.x+this.currentDx),Math.round(this.pBounds.y+this.currentDy),this.pBounds.width,this.pBounds.height),this.shape.redraw())}updateLivePreview(t,e){if(!this.suspended){const i=[];if(this.allCells&&this.allCells.visit((s,l)=>{const r=l?this.graph.view.getState(l.cell):null;if(r!==l&&l&&(l.destroy(),r?this.allCells.put(l.cell,r):this.allCells.remove(l.cell),l=r),l){const o=l.clone();i.push([l,o]),l.shape&&(l.shape.originalPointerEvents===null&&(l.shape.originalPointerEvents=l.shape.pointerEvents),l.shape.pointerEvents=!1,l.text&&(l.text.originalPointerEvents===null&&(l.text.originalPointerEvents=l.text.pointerEvents),l.text.pointerEvents=!1)),l.cell.isVertex()&&(l.x+=t,l.y+=e,this.cloning?l.text&&(l.text.updateBoundingBox(),l.text.boundingBox&&(l.text.boundingBox.x+=t,l.text.boundingBox.y+=e),l.text.unrotatedBoundingBox&&(l.text.unrotatedBoundingBox.x+=t,l.text.unrotatedBoundingBox.y+=e)):(l.view.graph.cellRenderer.redraw(l,!0),l.view.invalidate(l.cell),l.invalid=!1,l.control&&l.control.node&&(l.control.node.style.visibility="hidden")))}}),i.length===0)this.reset();else{const s=this.graph.view.scale;for(let l=0;l<i.length;l+=1){const r=i[l][0];if(r.cell.isEdge()){const o=r.cell.getGeometry(),h=[];if(o&&o.points)for(let g=0;g<o.points.length;g++)o.points[g]&&h.push(new Point(o.points[g].x+t/s,o.points[g].y+e/s));let a=r.visibleSourceState,d=r.visibleTargetState;const c=i[l][1].absolutePoints;if(a==null||!this.isCellMoving(a.cell)){const g=c[0];g&&(r.setAbsoluteTerminalPoint(new Point(g.x+t,g.y+e),!0),a=null)}else r.view.updateFixedTerminalPoint(r,a,!0,this.graph.getConnectionConstraint(r,a,!0));if(d==null||!this.isCellMoving(d.cell)){const g=c[c.length-1];g&&(r.setAbsoluteTerminalPoint(new Point(g.x+t,g.y+e),!1),d=null)}else r.view.updateFixedTerminalPoint(r,d,!1,this.graph.getConnectionConstraint(r,d,!1));r.view.updatePoints(r,h,a,d),r.view.updateFloatingTerminalPoints(r,a,d),r.view.updateEdgeLabelOffset(r),r.invalid=!1,this.cloning||r.view.graph.cellRenderer.redraw(r,!0)}}this.graph.view.validate(),this.redrawHandles(i),this.resetPreviewStates(i)}}}redrawHandles(t){const e=this.graph.getPlugin("SelectionCellsHandler");for(let i=0;i<t.length;i+=1){const s=e==null?void 0:e.getHandler(t[i][0].cell);s==null||s.redraw(!0)}}resetPreviewStates(t){for(let e=0;e<t.length;e+=1)t[e][0].setState(t[e][1])}suspend(){this.suspended||(this.livePreviewUsed&&this.updateLivePreview(0,0),this.shape&&(this.shape.node.style.visibility="hidden"),this.guide&&this.guide.setVisible(!1),this.suspended=!0)}resume(){this.suspended&&(this.suspended=!1,this.livePreviewUsed&&(this.livePreviewActive=!0),this.shape&&(this.shape.node.style.visibility="visible"),this.guide&&this.guide.setVisible(!0))}resetLivePreview(){this.allCells.visit((t,e)=>{e.shape&&e.shape.originalPointerEvents!==null&&(e.shape.pointerEvents=e.shape.originalPointerEvents,e.shape.originalPointerEvents=null,e.shape.bounds=null,e.text&&e.text.originalPointerEvents!==null&&(e.text.pointerEvents=e.text.originalPointerEvents,e.text.originalPointerEvents=null)),e.control&&e.control.node&&e.control.node.style.visibility==="hidden"&&(e.control.node.style.visibility=""),this.cloning||e.text&&e.text.updateBoundingBox(),e.view.invalidate(e.cell)}),this.graph.view.validate()}setHandlesVisibleForCells(t,e,i=!1){if(i||this.handlesVisible!==e){this.handlesVisible=e;const s=this.graph.getPlugin("SelectionCellsHandler");for(let l=0;l<t.length;l+=1){const r=s==null?void 0:s.getHandler(t[l]);r&&(r.setHandlesVisible(e),e&&r.redraw())}}}setHighlightColor(t){this.highlight&&this.highlight.setHighlightColor(t)}mouseUp(t,e){if(!e.isConsumed())if(this.livePreviewUsed&&this.resetLivePreview(),this.cell&&this.first&&(this.shape||this.livePreviewUsed)&&isNumeric(this.currentDx)&&isNumeric(this.currentDy)){const{graph:i}=this,s=e.getCell();if(this.connectOnDrop&&!this.target&&s&&s.isVertex()&&s.isConnectable()&&i.isEdgeValid(null,this.cell,s)){const l=i.getPlugin("ConnectionHandler");l==null||l.connect(this.cell,s,e.getEvent())}else{const l=i.isCloneEvent(e.getEvent())&&i.isCellsCloneable()&&this.isCloneEnabled(),{scale:r}=i.getView(),o=this.roundLength(this.currentDx/r),h=this.roundLength(this.currentDy/r),a=this.target;a&&i.isSplitEnabled()&&this.cells&&i.isSplitTarget(a,this.cells,e.getEvent())?i.splitEdge(a,this.cells,null,o,h,e.getGraphX(),e.getGraphY()):this.cells&&this.moveCells(this.cells,o,h,l,this.target,e.getEvent())}}else this.isSelectEnabled()&&this.delayedSelection&&this.cell!=null&&this.selectDelayed(e);this.cellWasClicked&&this.consumeMouseEvent(InternalEvent.MOUSE_UP,e),this.reset()}reset(){if(this.livePreviewUsed){this.resetLivePreview();const t=this.graph.getPlugin("SelectionCellsHandler");this.setHandlesVisibleForCells((t==null?void 0:t.getHandledSelectionCells())??[],!0)}this.destroyShapes(),this.removeHint(),this.delayedSelection=!1,this.livePreviewActive=!1,this.livePreviewUsed=!1,this.cellWasClicked=!1,this.suspended=!1,this.currentDx=0,this.currentDy=0,this.cellCount=0,this.cloning=!1,this.allCells.clear(),this.pBounds=null,this.target=null,this.first=null,this.cells=null,this.cell=null}shouldRemoveCellsFromParent(t,e,i){if(t.isVertex()){const s=this.graph.getView().getState(t);if(s){let l=convertPoint(this.graph.container,getClientX(i),getClientY(i));const r=toRadians(s.style.rotation??0);if(r!==0){const o=Math.cos(-r),h=Math.sin(-r),a=new Point(s.getCenterX(),s.getCenterY());l=getRotatedPoint(l,o,h,a)}return!contains(s,l.x,l.y)}}return!1}moveCells(t,e,i,s,l,r){if(!this.cell)return;s&&(t=this.graph.getCloneableCells(t));const o=this.cell.getParent();!l&&o&&this.isRemoveCellsFromParent()&&this.shouldRemoveCellsFromParent(o,t,r)&&(l=this.graph.getDefaultParent()),s=!!s&&!this.graph.isCellLocked(l||this.graph.getDefaultParent()),this.graph.batchUpdate(()=>{const h=[];if(!s&&l&&this.removeEmptyParents){const d=new Dictionary;for(let c=0;c<t.length;c+=1)d.put(t[c],!0);for(let c=0;c<t.length;c+=1){const g=t[c].getParent();g&&!d.get(g)&&(d.put(g,!0),h.push(g))}}t=this.graph.moveCells(t,e,i,s,l,r);const a=[];for(let d=0;d<h.length;d+=1)this.shouldRemoveParent(h[d])&&a.push(h[d]);this.graph.removeCells(a,!1)}),s&&this.graph.setSelectionCells(t),this.isSelectEnabled()&&this.scrollOnMove&&this.graph.scrollCellToVisible(t[0])}shouldRemoveParent(t){const e=this.graph.view.getState(t);return e!=null&&(e.cell.isEdge()||e.cell.isVertex())&&this.graph.isCellDeletable(e.cell)&&e.cell.getChildCount()===0&&e.isTransparentState()}destroyShapes(){this.shape&&(this.shape.destroy(),this.shape=null),this.guide&&(this.guide.destroy(),this.guide=null),this.highlight&&(this.highlight.destroy(),this.highlight=null)}onDestroy(){this.graph.removeMouseListener(this),this.graph.removeListener(this.panHandler),this.graph.removeListener(this.escapeHandler),this.graph.getDataModel().removeListener(this.refreshHandler),this.graph.removeListener(this.refreshHandler),InternalEvent.removeListener(document,"keydown",this.keyHandler),InternalEvent.removeListener(document,"keyup",this.keyHandler),this.destroyShapes(),this.removeHint()}}SelectionHandler.pluginId="SelectionHandler";class PanningManager{constructor(t){this.damper=1/6,this.delay=10,this.handleMouseOut=!0,this.border=0,this.thread=null,this.active=!1,this.tdx=0,this.tdy=0,this.t0x=0,this.t0y=0,this.dx=0,this.dy=0,this.scrollbars=!1,this.scrollLeft=0,this.scrollTop=0,this.thread=null,this.active=!1,this.tdx=0,this.tdy=0,this.t0x=0,this.t0y=0,this.dx=0,this.dy=0,this.scrollbars=!1,this.scrollLeft=0,this.scrollTop=0,this.mouseListener={mouseDown:(i,s)=>{},mouseMove:(i,s)=>{},mouseUp:(i,s)=>{this.active&&this.stop()}},t.addMouseListener(this.mouseListener),this.mouseUpListener=()=>{this.active&&this.stop()},InternalEvent.addListener(document,"mouseup",this.mouseUpListener);const e=()=>(this.scrollbars=hasScrollbars(t.container),this.scrollLeft=t.container.scrollLeft,this.scrollTop=t.container.scrollTop,window.setInterval(()=>{if(this.tdx-=this.dx,this.tdy-=this.dy,this.scrollbars){const i=-t.container.scrollLeft-Math.ceil(this.dx),s=-t.container.scrollTop-Math.ceil(this.dy);t.panGraph(i,s),t.setPanDx(this.scrollLeft-t.container.scrollLeft),t.setPanDy(this.scrollTop-t.container.scrollTop),t.fireEvent(new EventObject(InternalEvent.PAN))}else t.panGraph(this.getDx(),this.getDy())},this.delay));this.isActive=()=>this.active,this.getDx=()=>Math.round(this.tdx),this.getDy=()=>Math.round(this.tdy),this.start=()=>{this.t0x=t.view.translate.x,this.t0y=t.view.translate.y,this.active=!0},this.panTo=(i,s,l=0,r=0)=>{this.active||this.start(),this.scrollLeft=t.container.scrollLeft,this.scrollTop=t.container.scrollTop;const o=t.container;this.dx=i+l-o.scrollLeft-o.clientWidth,this.dx<0&&Math.abs(this.dx)<this.border?this.dx=this.border+this.dx:this.handleMouseOut?this.dx=Math.max(this.dx,0):this.dx=0,this.dx==0&&(this.dx=i-o.scrollLeft,this.dx>0&&this.dx<this.border?this.dx-=this.border:this.handleMouseOut?this.dx=Math.min(0,this.dx):this.dx=0),this.dy=s+r-o.scrollTop-o.clientHeight,this.dy<0&&Math.abs(this.dy)<this.border?this.dy=this.border+this.dy:this.handleMouseOut?this.dy=Math.max(this.dy,0):this.dy=0,this.dy==0&&(this.dy=s-o.scrollTop,this.dy>0&&this.dy<this.border?this.dy-=this.border:this.handleMouseOut?this.dy=Math.min(0,this.dy):this.dy=0),this.dx!=0||this.dy!=0?(this.dx*=this.damper,this.dy*=this.damper,this.thread==null&&(this.thread=e())):this.thread!=null&&(window.clearInterval(this.thread),this.thread=null)},this.stop=()=>{if(this.active)if(this.active=!1,this.thread!=null&&(window.clearInterval(this.thread),this.thread=null),this.tdx=0,this.tdy=0,this.scrollbars)t.setPanDx(0),t.setPanDy(0),t.fireEvent(new EventObject(InternalEvent.PAN));else{const i=t.getPanDx(),s=t.getPanDy();(i!=0||s!=0)&&(t.panGraph(0,0),t.view.setTranslate(this.t0x+i/t.view.scale,this.t0y+s/t.view.scale))}},this.destroy=()=>{t.removeMouseListener(this.mouseListener),InternalEvent.removeListener(document,"mouseup",this.mouseUpListener)}}}class PanningHandler extends EventSource{constructor(t){super(),this.getPanningManager=()=>this.panningManager,this.useLeftButtonForPanning=!1,this.usePopupTrigger=!0,this.ignoreCell=!1,this.previewEnabled=!0,this.useGrid=!1,this.panningEnabled=!1,this.pinchEnabled=!0,this.initialScale=0,this.maxScale=8,this.minScale=.01,this.dx=0,this.dy=0,this.startX=0,this.startY=0,this.dx0=0,this.dy0=0,this.panningTrigger=!1,this.active=!1,this.mouseDownEvent=null,this.graph=t,this.graph.addMouseListener(this),this.forcePanningHandler=(e,i)=>{const s=i.getProperty("eventName"),l=i.getProperty("event");s===InternalEvent.MOUSE_DOWN&&this.isForcePanningEvent(l)&&(this.start(l),this.active=!0,this.fireEvent(new EventObject(InternalEvent.PAN_START,{event:l})),l.consume())},this.graph.addListener(InternalEvent.FIRE_MOUSE_EVENT,this.forcePanningHandler),this.gestureHandler=(e,i)=>{if(this.isPinchEnabled()){const s=i.getProperty("event");!isConsumed(s)&&s.type==="gesturestart"?(this.initialScale=this.graph.view.scale,!this.active&&this.mouseDownEvent&&(this.start(this.mouseDownEvent),this.mouseDownEvent=null)):s.type==="gestureend"&&this.initialScale!==0&&(this.initialScale=0),this.initialScale!==0&&this.zoomGraph(s)}},this.graph.addListener(InternalEvent.GESTURE,this.gestureHandler),this.mouseUpListener=()=>{this.active&&this.reset()},InternalEvent.addListener(document,"mouseup",this.mouseUpListener),this.panningManager=new PanningManager(t)}isActive(){return this.active||this.initialScale!==null}isPanningEnabled(){return this.panningEnabled}setPanningEnabled(t){this.panningEnabled=t}isPinchEnabled(){return this.pinchEnabled}setPinchEnabled(t){this.pinchEnabled=t}isPanningTrigger(t){const e=t.getEvent();return this.useLeftButtonForPanning&&!t.getState()&&isLeftMouseButton(e)||isControlDown(e)&&isShiftDown(e)||this.usePopupTrigger&&isPopupTrigger(e)}isForcePanningEvent(t){return this.ignoreCell||isMultiTouchEvent(t.getEvent())}mouseDown(t,e){this.mouseDownEvent=e,!e.isConsumed()&&this.isPanningEnabled()&&!this.active&&this.isPanningTrigger(e)&&(this.start(e),this.consumePanningTrigger(e))}start(t){this.dx0=-this.graph.container.scrollLeft,this.dy0=-this.graph.container.scrollTop,this.startX=t.getX(),this.startY=t.getY(),this.dx=0,this.dy=0,this.panningTrigger=!0}consumePanningTrigger(t){t.consume()}mouseMove(t,e){if(this.dx=e.getX()-this.startX,this.dy=e.getY()-this.startY,this.active)this.previewEnabled&&(this.useGrid&&(this.dx=this.graph.snap(this.dx),this.dy=this.graph.snap(this.dy)),this.graph.panGraph(this.dx+this.dx0,this.dy+this.dy0)),this.fireEvent(new EventObject(InternalEvent.PAN,{event:e}));else if(this.panningTrigger){const i=this.active;this.active=Math.abs(this.dx)>this.graph.getSnapTolerance()||Math.abs(this.dy)>this.graph.getSnapTolerance(),!i&&this.active&&this.fireEvent(new EventObject(InternalEvent.PAN_START,{event:e}))}(this.active||this.panningTrigger)&&e.consume()}mouseUp(t,e){if(this.active){if(this.dx!==0&&this.dy!==0){if(!this.graph.isUseScrollbarsForPanning()||!hasScrollbars(this.graph.container)){const{scale:i}=this.graph.getView(),s=this.graph.getView().translate;this.graph.panGraph(0,0),this.panGraph(s.x+this.dx/i,s.y+this.dy/i)}e.consume()}this.fireEvent(new EventObject(InternalEvent.PAN_END,{event:e}))}this.reset()}zoomGraph(t){let e=Math.round(this.initialScale*t.scale*100)/100;e=Math.max(this.minScale,e),e=Math.min(this.maxScale,e),this.graph.view.scale!==e&&(this.graph.zoomTo(e),InternalEvent.consume(t))}reset(){this.panningTrigger=!1,this.mouseDownEvent=null,this.active=!1,this.dx=0,this.dy=0}panGraph(t,e){this.graph.getView().setTranslate(t,e)}onDestroy(){this.graph.removeMouseListener(this),this.graph.removeListener(this.forcePanningHandler),this.graph.removeListener(this.gestureHandler),InternalEvent.removeListener(document,"mouseup",this.mouseUpListener)}}PanningHandler.pluginId="PanningHandler";const getDefaultPlugins=()=>[CellEditorHandler,TooltipHandler,SelectionCellsHandler,PopupMenuHandler,ConnectionHandler,SelectionHandler,PanningHandler];class Graph extends EventSource{createCellRenderer(){return new CellRenderer}createEdgeHandlerInstance(t){return new EdgeHandler(t)}createEdgeSegmentHandler(t){return new EdgeSegmentHandler(t)}createElbowEdgeHandler(t){return new ElbowEdgeHandler(t)}createGraphDataModel(){return new GraphDataModel}createGraphView(){return new GraphView(this)}createSelectionModel(){return new GraphSelectionModel(this)}createStylesheet(){return new Stylesheet}createVertexHandler(t){return new VertexHandler(t)}registerDefaults(){registerDefaultShapes(),registerDefaultStyleElements(),registerDefaultEdgeMarkers()}constructor(t,e,i=getDefaultPlugins(),s=null){super(),this.destroyed=!1,this.graphModelChangeListener=null,this.paintBackground=null,this.isConstrainedMoving=!1,this.cells=[],this.imageBundles=[],this.mouseListeners=[],this.multiplicities=[],this.plugins={},this.renderHint=null,this.dialect="svg",this.defaultOverlap=.5,this.defaultParent=null,this.backgroundImage=null,this.pageVisible=!1,this.pageBreaksVisible=!1,this.pageBreakColor="gray",this.pageBreakDashed=!0,this.minPageBreakDist=20,this.preferPageSize=!1,this.pageFormat=new Rectangle(...PAGE_FORMAT_A4_PORTRAIT),this.pageScale=1.5,this.enabled=!0,this.exportEnabled=!0,this.importEnabled=!0,this.ignoreScrollbars=!1,this.translateToScrollPosition=!1,this.maximumGraphBounds=null,this.minimumGraphSize=null,this.minimumContainerSize=null,this.maximumContainerSize=null,this.resizeContainer=!1,this.border=0,this.keepEdgesInForeground=!1,this.keepEdgesInBackground=!1,this.recursiveResize=!1,this.resetViewOnRootChange=!0,this.allowLoops=!1,this.defaultLoopStyle=EdgeStyle.Loop,this.multigraph=!0,this.minFitScale=.1,this.maxFitScale=8,this.warningImage=new ImageBox(`${Client.imageBasePath}/warning${Client.IS_MAC?".png":".gif"}`,16,16),this.alreadyConnectedResource=TranslationsConfig.isEnabled()?"alreadyConnected":"",this.containsValidationErrorsResource=TranslationsConfig.isEnabled()?"containsValidationErrors":"",this.getContainer=()=>this.container,this.getPlugin=l=>this.plugins[l],this.getCellRenderer=()=>this.cellRenderer,this.getDialect=()=>this.dialect,this.isPageVisible=()=>this.pageVisible,this.isPageBreaksVisible=()=>this.pageBreaksVisible,this.getPageBreakColor=()=>this.pageBreakColor,this.isPageBreakDashed=()=>this.pageBreakDashed,this.getMinPageBreakDist=()=>this.minPageBreakDist,this.isPreferPageSize=()=>this.preferPageSize,this.getPageFormat=()=>this.pageFormat,this.getPageScale=()=>this.pageScale,this.isExportEnabled=()=>this.exportEnabled,this.isImportEnabled=()=>this.importEnabled,this.isIgnoreScrollbars=()=>this.ignoreScrollbars,this.isTranslateToScrollPosition=()=>this.translateToScrollPosition,this.getMinimumGraphSize=()=>this.minimumGraphSize,this.setMinimumGraphSize=l=>this.minimumGraphSize=l,this.getMinimumContainerSize=()=>this.minimumContainerSize,this.setMinimumContainerSize=l=>this.minimumContainerSize=l,this.getAlreadyConnectedResource=()=>this.alreadyConnectedResource,this.getContainsValidationErrorsResource=()=>this.containsValidationErrorsResource,this.registerDefaults(),this.container=t??document.createElement("div"),this.model=e??this.createGraphDataModel(),this.cellRenderer=this.createCellRenderer(),this.setStylesheet(s??this.createStylesheet()),this.view=this.createGraphView(),this.graphModelChangeListener=(l,r)=>{this.graphModelChanged(r.getProperty("edit").changes)},this.getDataModel().addListener(InternalEvent.CHANGE,this.graphModelChangeListener),this.view.init(),this.sizeDidChange(),this.setSelectionModel(this.createSelectionModel()),i.forEach(l=>this.plugins[l.pluginId]=new l(this)),this.view.revalidate()}getWarningImage(){return this.warningImage}batchUpdate(t){this.getDataModel().batchUpdate(t)}getDataModel(){return this.model}getView(){return this.view}getStylesheet(){return this.stylesheet}setStylesheet(t){this.stylesheet=t}graphModelChanged(t){for(const e of t)this.processChange(e);this.updateSelection(),this.view.validate(),this.sizeDidChange()}processChange(t){if(t instanceof RootChange)this.clearSelection(),this.setDefaultParent(null),t.previous&&this.removeStateForCell(t.previous),this.resetViewOnRootChange&&(this.view.scale=1,this.view.translate.x=0,this.view.translate.y=0),this.fireEvent(new EventObject(InternalEvent.ROOT));else if(t instanceof ChildChange){const e=t.child.getParent();this.view.invalidate(t.child,!0,!0),(!e||!this.getDataModel().contains(e)||e.isCollapsed())&&(this.view.invalidate(t.child,!0,!0),this.removeStateForCell(t.child),this.view.currentRoot==t.child&&this.home()),e!=t.previous&&(e!=null&&this.view.invalidate(e,!1,!1),t.previous!=null&&this.view.invalidate(t.previous,!1,!1))}else if(t instanceof TerminalChange||t instanceof GeometryChange)(t instanceof TerminalChange||t.previous==null&&t.geometry!=null||t.previous!=null&&!t.previous.equals(t.geometry))&&this.view.invalidate(t.cell);else if(t instanceof ValueChange)this.view.invalidate(t.cell,!1,!1);else if(t instanceof StyleChange){this.view.invalidate(t.cell,!0,!0);const e=this.view.getState(t.cell);e!=null&&(e.invalidStyle=!0)}else t.cell!=null&&t.cell instanceof Cell&&this.removeStateForCell(t.cell)}scrollPointToVisible(t,e,i=!1,s=20){const l=this.getPlugin("PanningHandler");if(!this.isTimerAutoScroll()&&(this.ignoreScrollbars||hasScrollbars(this.container))){const r=this.container;if(t>=r.scrollLeft&&e>=r.scrollTop&&t<=r.scrollLeft+r.clientWidth&&e<=r.scrollTop+r.clientHeight){let o=r.scrollLeft+r.clientWidth-t;if(o<s){const a=r.scrollLeft;if(r.scrollLeft+=s-o,i&&a===r.scrollLeft){const d=this.view.getDrawPane().ownerSVGElement,c=r.scrollWidth+s-o;d.style.width=`${c}px`,r.scrollLeft+=s-o}}else o=t-r.scrollLeft,o<s&&(r.scrollLeft-=s-o);let h=r.scrollTop+r.clientHeight-e;if(h<s){const a=r.scrollTop;if(r.scrollTop+=s-h,a==r.scrollTop&&i){const d=this.view.getDrawPane().ownerSVGElement,c=r.scrollHeight+s-h;d.style.height=`${c}px`,r.scrollTop+=s-h}}else h=e-r.scrollTop,h<s&&(r.scrollTop-=s-h)}}else this.isAllowAutoPanning()&&l&&!l.isActive()&&l.getPanningManager().panTo(t+this.getPanDx(),e+this.getPanDy())}getBorderSizes(){const t=getCurrentStyle(this.container);return new Rectangle(parseCssNumber(t.paddingLeft)+(t.borderLeftStyle!="none"?parseCssNumber(t.borderLeftWidth):0),parseCssNumber(t.paddingTop)+(t.borderTopStyle!="none"?parseCssNumber(t.borderTopWidth):0),parseCssNumber(t.paddingRight)+(t.borderRightStyle!="none"?parseCssNumber(t.borderRightWidth):0),parseCssNumber(t.paddingBottom)+(t.borderBottomStyle!="none"?parseCssNumber(t.borderBottomWidth):0))}getPreferredPageSize(t,e,i){const s=this.view.translate,l=this.pageFormat,r=this.pageScale,o=new Rectangle(0,0,Math.ceil(l.width*r),Math.ceil(l.height*r)),h=this.pageBreaksVisible?Math.ceil(e/o.width):1,a=this.pageBreaksVisible?Math.ceil(i/o.height):1;return new Rectangle(0,0,h*o.width+2+s.x,a*o.height+2+s.y)}fit(t=this.getBorder(),e=!1,i=0,s=!0,l=!1,r=!1,o=null){if(this.container!=null){const h=this.getBorderSizes();let a=this.container.offsetWidth-h.x-h.width-1,d=o??this.container.offsetHeight-h.y-h.height-1,c=this.view.getGraphBounds();if(c.width>0&&c.height>0){e&&c.x!=null&&c.y!=null&&(c=c.clone(),c.width+=c.x,c.height+=c.y,c.x=0,c.y=0);const g=this.view.scale;let u=c.width/g,f=c.height/g;this.backgroundImage!=null&&(u=Math.max(u,this.backgroundImage.width-c.x/g),f=Math.max(f,this.backgroundImage.height-c.y/g));const p=(e?t:2*t)+i+1;a-=p,d-=p;let E=l?d/f:r?a/u:Math.min(a/u,d/f);if(this.minFitScale!=null&&(E=Math.max(E,this.minFitScale)),this.maxFitScale!=null&&(E=Math.min(E,this.maxFitScale)),s)if(e)this.view.scale!=E&&this.view.setScale(E);else if(hasScrollbars(this.container)){this.view.setScale(E);const C=this.getGraphBounds();C.x!=null&&(this.container.scrollLeft=C.x),C.y!=null&&(this.container.scrollTop=C.y)}else{const C=c.x!=null?Math.floor(this.view.translate.x-c.x/g+t/E+i/2):t,y=c.y!=null?Math.floor(this.view.translate.y-c.y/g+t/E+i/2):t;this.view.scaleAndTranslate(E,C,y)}else return E}}return this.view.scale}doResizeContainer(t,e){this.maximumContainerSize!=null&&(t=Math.min(this.maximumContainerSize.width,t),e=Math.min(this.maximumContainerSize.height,e));const i=this.container;i.style.width=`${Math.ceil(t)}px`,i.style.height=`${Math.ceil(e)}px`}createHandler(t){let e=null;if(t.cell.isEdge()){const i=t.getVisibleTerminalState(!0),s=t.getVisibleTerminalState(!1),l=t.cell.getGeometry(),r=this.getView().getEdgeStyle(t,l&&l.points||void 0,i,s);e=this.createEdgeHandler(t,r)}else e=this.createVertexHandler(t);return e}createEdgeHandler(t,e){let i=null;return e==EdgeStyle.Loop||e==EdgeStyle.ElbowConnector||e==EdgeStyle.SideToSide||e==EdgeStyle.TopToBottom?i=this.createElbowEdgeHandler(t):e==EdgeStyle.SegmentConnector||e==EdgeStyle.OrthConnector?i=this.createEdgeSegmentHandler(t):i=this.createEdgeHandlerInstance(t),i}getCurrentRoot(){return this.view.currentRoot}getTranslateForRoot(t){return null}getChildOffsetForCell(t){return null}home(){const t=this.getCurrentRoot();t!=null&&(this.view.setCurrentRoot(null),this.view.getState(t)!=null&&this.setSelectionCell(t))}isValidRoot(t){return!!t}getGraphBounds(){return this.view.getGraphBounds()}getMaximumGraphBounds(){return this.maximumGraphBounds}refresh(t=null){t?this.view.clear(t,!1):this.view.clear(void 0,!0),this.view.validate(),this.sizeDidChange(),this.fireEvent(new EventObject(InternalEvent.REFRESH))}center(t=!0,e=!0,i=.5,s=.5){const l=this.container,r=hasScrollbars(this.container),o=2*this.getBorder(),h=l.clientWidth-o,a=l.clientHeight-o,d=this.getGraphBounds(),c=this.view.translate,g=this.view.scale;let u=t?h-d.width:0,f=e?a-d.height:0;if(!r)this.view.setTranslate(t?Math.floor(c.x-d.x/g+u*i/g):c.x,e?Math.floor(c.y-d.y/g+f*s/g):c.y);else{d.x-=c.x,d.y-=c.y;const p=l.scrollWidth,E=l.scrollHeight;p>h&&(u=0),E>a&&(f=0),this.view.setTranslate(Math.floor(u/2-d.x),Math.floor(f/2-d.y)),l.scrollLeft=(p-h)/2,l.scrollTop=(E-a)/2}}isOrthogonal(t){const e=t.style.orthogonal;if(e!=null)return e;const i=this.view.getEdgeStyle(t);return i===EdgeStyle.SegmentConnector||i===EdgeStyle.ElbowConnector||i===EdgeStyle.SideToSide||i===EdgeStyle.TopToBottom||i===EdgeStyle.EntityRelation||i===EdgeStyle.OrthConnector}getBackgroundImage(){return this.backgroundImage}setBackgroundImage(t){this.backgroundImage=t}convertValueToString(t){const e=t.getValue();if(e!=null){if(isNode(e))return e.nodeName;if(typeof e.toString=="function")return e.toString()}return""}getLinkForCell(t){return null}getBorder(){return this.border}setBorder(t){this.border=t}isResizeContainer(){return this.resizeContainer}setResizeContainer(t){this.resizeContainer=t}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}isMultigraph(){return this.multigraph}setMultigraph(t){this.multigraph=t}isAllowLoops(){return this.allowLoops}setAllowLoops(t){this.allowLoops=t}isRecursiveResize(t=null){return this.recursiveResize}setRecursiveResize(t){this.recursiveResize=t}getOverlap(t){return this.isAllowOverlapParent(t)?this.defaultOverlap:0}isAllowOverlapParent(t){return!1}getDefaultParent(){let t=this.getCurrentRoot();return t||(t=this.defaultParent,t||(t=this.getDataModel().getRoot().getChildAt(0))),t}setDefaultParent(t){this.defaultParent=t}destroy(){this.destroyed||(this.destroyed=!0,Object.values(this.plugins).forEach(t=>t.onDestroy()),this.view.destroy(),this.model&&this.graphModelChangeListener&&(this.getDataModel().removeListener(this.graphModelChangeListener),this.graphModelChangeListener=null))}}applyGraphMixins(Graph);class CellCodec extends ObjectCodec{constructor(){super(new Cell,["children","edges","overlays","mxTransient"],["parent","source","target"]),this.setName("Cell")}isCellCodec(){return!0}isNumericAttribute(t,e,i){return e.nodeName!=="value"&&super.isNumericAttribute(t,e,i)}isExcluded(t,e,i,s){return super.isExcluded(t,e,i,s)||s&&e==="value"&&i.nodeType===NODETYPE.ELEMENT}afterEncode(t,e,i){if(e.value!=null&&e.value.nodeType===NODETYPE.ELEMENT){const s=i;i=importNode(t.document,e.value,!0),i.appendChild(s);const l=s.getAttribute("id");i.setAttribute("id",String(l)),s.removeAttribute("id")}return i}beforeDecode(t,e,i){let s=e.cloneNode(!0);const l=this.getName();if(e.nodeName!==l){const r=e.getElementsByTagName(l)[0];r!=null&&r.parentNode===e?(removeWhitespace(r,!0),removeWhitespace(r,!1),r.parentNode.removeChild(r),s=r):s=null,i.value=e.cloneNode(!0);const o=i.value.getAttribute("id");o!=null&&(i.setId(o),i.value.removeAttribute("id"))}else i.setId(e.getAttribute("id"));if(s!=null)for(let r=0;r<this.idrefs.length;r+=1){const o=this.idrefs[r],h=s.getAttribute(o);if(h!=null){s.removeAttribute(o);let a=t.objects[h]||t.lookup(h);if(a==null){const d=t.getElementById(h);d!=null&&(a=(CodecRegistry.codecs[d.nodeName]||this).decode(t,d))}i[o]=a}}return s}}class ModelCodec extends ObjectCodec{constructor(){super(new GraphDataModel),this.setName("GraphDataModel")}encodeObject(t,e,i){const s=t.document.createElement("root");t.encodeCell(e.getRoot(),s),i.appendChild(s)}decodeChild(t,e,i){e.nodeName==="root"?this.decodeRoot(t,e,i):this.decodeChild.apply(this,[t,e,i])}decodeRoot(t,e,i){let s=null,l=e.firstChild;for(;l!=null;){const r=t.decodeCell(l);r!=null&&r.getParent()==null&&(s=r),l=l.nextSibling}s!=null&&i.setRoot(s)}}const fieldMapping=new Map([["autosize","autoSize"]]);function convertStyleFromString(n){const t={};n.startsWith(";")&&(t.ignoreDefaultStyle=!0);const e=n.split(";").filter(([i])=>i);for(const i of e)if(!i.includes("="))!t.baseStyleNames&&(t.baseStyleNames=[]),t.baseStyleNames.push(i);else{const[s,l]=i.split("=");t[fieldMapping.get(s)??s]=convertToNumericIfNeeded(l)}return t}function convertToNumericIfNeeded(n){if(!isNumeric(n))return n;let t=parseFloat(n);return(Number.isNaN(t)||!Number.isFinite(t))&&(t=0),t}class mxCellCodec extends CellCodec{getName(){return"mxCell"}decodeAttribute(t,e,i){const s=e.nodeName;i&&s=="style"?i.style=convertStyleFromString(e.value):super.decodeAttribute(t,e,i)}}class mxGeometryCodec extends ObjectCodec{getName(){return"mxGeometry"}constructor(){super(new Geometry)}afterDecode(t,e,i){const s=i.points;if(s){const l=[];for(const r of s){const o=r;l.push(new Point(o.x,o.y))}i.points=l}return i}}let isBaseCodecsRegistered=!1;const registerBaseCodecs=(n=!1)=>{(!isBaseCodecsRegistered||n)&&(CodecRegistry.register(new ObjectCodec({})),CodecRegistry.register(new ObjectCodec([])),isBaseCodecsRegistered=!0)},createObjectCodec=(n,t)=>{const e=new ObjectCodec(n);return e.setName(t),e};let isModelCodecsRegistered=!1;const registerModelCodecs=(n=!1)=>{(!isModelCodecsRegistered||n)&&(CodecRegistry.register(new CellCodec),CodecRegistry.register(new ModelCodec),CodecRegistry.register(createObjectCodec(new Geometry,"Geometry")),CodecRegistry.register(createObjectCodec(new Point,"Point")),registerBaseCodecs(n),CodecRegistry.addAlias("mxGraphModel","GraphDataModel"),CodecRegistry.addAlias("mxPoint","Point"),CodecRegistry.register(new mxCellCodec,!1),CodecRegistry.register(new mxGeometryCodec,!1),isModelCodecsRegistered=!0)};class ModelXmlSerializer{constructor(t){this.dataModel=t,this.registerCodecs()}import(t){const e=typeof t=="string"?parseXml(t):t.ownerDocument;new Codec(e).decode(e.documentElement,this.dataModel)}export(t){const e=new Codec().encode(this.dataModel);return(t==null?void 0:t.pretty)??!0?getPrettyXml(e):getXml(e)}registerCodecs(){registerModelCodecs()}}export{Client as C,EventSource as E,Graph as G,InternalEvent as I,ModelXmlSerializer as M,Point as P,Rectangle as R,SelectionCellsHandler as S,VertexHandlerConfig as V,GraphDataModel as a,EventObject as b,getScrollOrigin as c,isMultiTouchEvent as d,clearSelection as e,setPrefixedStyle as f,getOffset as g,convertPoint as h,isAltDown as i,InternalMouseEvent as j,CellEditorHandler as k,SelectionHandler as l,PanningHandler as m,getClientY as n,getClientX as o,setOpacity as s};
