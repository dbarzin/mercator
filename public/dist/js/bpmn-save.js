import{a as T,O as X,b as D,G as p,c as E,d as N,P as C,f as m,g as I,h as G,C as w,j as O,k as P,l as x,m as B,r as y,n as $,p as F,o as R,q as L,s as v}from"./bpmn-edit.js";class k{constructor(e,t=null,s="POST",n=!0,i=null,r=null){this.binary=!1,this.withCredentials=!1,this.request=null,this.decodeSimulateValues=!1,this.url=e,this.params=t,this.method=s||"POST",this.async=n,this.username=i,this.password=r}isBinary(){return this.binary}setBinary(e){this.binary=e}getText(){return this.request.responseText}isReady(){return this.request.readyState===4}getDocumentElement(){const e=this.getXml();return e!=null?e.documentElement:null}getXml(){let e=this.request.responseXML;return(e==null||e.documentElement==null)&&(e=new DOMParser().parseFromString(this.request.responseText,"text/xml")),e}getStatus(){return this.request?.status}create(){const e=new XMLHttpRequest;return this.isBinary()&&e.overrideMimeType&&e.overrideMimeType("text/plain; charset=x-user-defined"),e}send(e=null,t=null,s=null,n=null){this.request=this.create(),this.request!=null&&(e!=null&&(this.request.onreadystatechange=()=>{this.isReady()&&(e(this),this.request.onreadystatechange=null)}),this.request.open(this.method,this.url,this.async,this.username,this.password),this.setRequestHeaders(this.request,this.params),window.XMLHttpRequest&&this.withCredentials&&(this.request.withCredentials="true"),window.XMLHttpRequest&&s!=null&&n!=null&&(this.request.timeout=s,this.request.ontimeout=n),this.request.send(this.params))}setRequestHeaders(e,t){t!=null&&e.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}simulate(e,t=null){e=e||document;let s=null;e===document&&(s=window.onbeforeunload,window.onbeforeunload=null);const n=e.createElement("form");n.setAttribute("method",this.method),n.setAttribute("action",this.url),t!=null&&n.setAttribute("target",t),n.style.display="none",n.style.visibility="hidden";const i=this.params,r=i.indexOf("&")>0?i.split("&"):i.split(" ");for(let u=0;u<r.length;u+=1){const a=r[u].indexOf("=");if(a>0){const h=r[u].substring(0,a);let c=r[u].substring(a+1);this.decodeSimulateValues&&(c=decodeURIComponent(c));const f=e.createElement("textarea");f.setAttribute("wrap","off"),f.setAttribute("name",h),T(f,c),n.appendChild(f)}}e.body.appendChild(n),n.submit(),n.parentNode!=null&&n.parentNode.removeChild(n),s!=null&&(window.onbeforeunload=s)}}const H=l=>{const e=new k(l,null,"GET",!1);return e.send(),e},V=["_x","_y","_width","_height"],z=["_x","_y"];class d{constructor(e,t=[],s=[],n={}){this.template=e,this.exclude=t,this.idrefs=s,this.mapping=n,this.reverse={};for(const i in this.mapping)this.reverse[this.mapping[i]]=i}getName(){return this.name??this.template.constructor.name}setName(e){this.name=e}cloneTemplate(){return new this.template.constructor}getFieldName(e){if(e!=null){const t=this.reverse[e];t!=null&&(e=t)}return e}getAttributeName(e){if(e!=null){const t=this.mapping[e];t!=null&&(e=t)}return e}isExcluded(e,t,s,n){return t==X.FIELD_NAME||this.exclude.indexOf(t)>=0}isReference(e,t,s,n){return t==null?!1:this.idrefs.includes(t)}encode(e,t){const s=e.document.createElement(this.getName());return t=this.beforeEncode(e,t,s),this.encodeObject(e,t,s),this.afterEncode(e,t,s)}encodeObject(e,t,s){e.setAttribute(s,"id",e.getId(t));for(const n in t){let i=n;const r=t[i];r!=null&&!this.isExcluded(t,i,r,!0)&&(D(i)&&(i=null),this.encodeValue(e,t,i,r,s))}}encodeValue(e,t,s,n,i){if(n!=null){if(this.isReference(t,s,n,!0)){const r=e.getId(n);if(r==null){p.logger.warn(`ObjectCodec.encode: No ID for ${this.getName()}.${s}=${n}`);return}n=r}(s==null||e.encodeDefaults||this.template[s]!=n)&&(s=this.getAttributeName(s),this.writeAttribute(e,t,s,n,i))}}writeAttribute(e,t,s,n,i){typeof n!="object"?this.writePrimitiveAttribute(e,t,s,n,i):this.writeComplexAttribute(e,t,s,n,i)}writePrimitiveAttribute(e,t,s,n,i){if(n=this.convertAttributeToXml(e,t,s,n,i),s==null){const r=e.document.createElement("add");typeof n=="function"?r.appendChild(e.document.createTextNode(n)):e.setAttribute(r,"value",n),i.appendChild(r)}else typeof n!="function"&&e.setAttribute(i,s,n)}writeComplexAttribute(e,t,s,n,i){const r=e.encode(n);r!=null?(s!=null&&r.setAttribute("as",s),i.appendChild(r)):p.logger.warn(`ObjectCodec.encode: No node for ${this.getName()}.${s}: ${n}`)}convertAttributeToXml(e,t,s,n,i){return this.isBooleanAttribute(e,t,s,n)&&(n=n==!0?"1":"0"),n}isBooleanAttribute(e,t,s,n){return typeof n.length>"u"&&(n==!0||n==!1)}convertAttributeFromXml(e,t,s){let{value:n}=t;return this.isNumericAttribute(e,t,s)&&(n=parseFloat(n),(Number.isNaN(n)||!Number.isFinite(n))&&(n=0)),n}isNumericAttribute(e,t,s){return s instanceof N&&V.includes(t.name)||s instanceof C&&z.includes(t.name)||E(t.value)}beforeEncode(e,t,s){return t}afterEncode(e,t,s){return s}decode(e,t,s){const n=t.getAttribute("id");let i=e.objects[n];i==null&&(i=s||this.cloneTemplate(),n!=null&&e.putObject(n,i));const r=this.beforeDecode(e,t,i);return this.decodeNode(e,r,i),this.afterDecode(e,r,i)}decodeNode(e,t,s){t!=null&&(this.decodeAttributes(e,t,s),this.decodeChildren(e,t,s))}decodeAttributes(e,t,s){const n=t.attributes;if(n!=null)for(let i=0;i<n.length;i+=1)this.decodeAttribute(e,n[i],s)}isIgnoredAttribute(e,t,s){return t.nodeName==="as"||t.nodeName==="id"}decodeAttribute(e,t,s){if(!this.isIgnoredAttribute(e,t,s)){const n=t.nodeName;let i=this.convertAttributeFromXml(e,t,s);const r=this.getFieldName(n);if(this.isReference(s,r,i,!1)){const u=e.getObject(i);if(u==null){p.logger.warn(`ObjectCodec.decode: No object for ${this.getName()}.${n}=${i}`);return}i=u}this.isExcluded(s,n,i,!1)||(s[n]=i)}}decodeChildren(e,t,s){let n=t.firstChild;for(;n;){const i=n.nextSibling;m(n)&&!this.processInclude(e,n,s)&&this.decodeChild(e,n,s),n=i}}decodeChild(e,t,s){const n=this.getFieldName(t.getAttribute("as"));if(n==null||!this.isExcluded(s,n,t,!1)){const i=this.getFieldTemplate(s,n,t);let r=null;t.nodeName==="add"?(r=t.getAttribute("value"),r==null&&d.allowEval&&(r=I(G(t)))):r=e.decode(t,i);try{this.addObjectValue(s,n,r,i)}catch(u){throw new Error(`${u.message} for ${t.nodeName}`)}}}getFieldTemplate(e,t,s){let n=e[t];return n instanceof Array&&n.length>0&&(n=null),n}addObjectValue(e,t,s,n){s!=null&&s!==n&&(t!=null&&t.length>0?e[t]=s:e.push?.(s))}processInclude(e,t,s){if(t.nodeName==="include"){const n=t.getAttribute("name");if(n!=null)try{const i=H(n).getDocumentElement();i!=null&&e.decode(i,s)}catch{}return!0}return!1}beforeDecode(e,t,s){return t}afterDecode(e,t,s){return s}}d.allowEval=!1;class o{static register(e,t=!0){if(e!=null){const s=e.getName();o.codecs[s]=e;const n=e.template.constructor.name;t&&n!==s&&o.addAlias(n,s)}return e}static addAlias(e,t){o.aliases[e]=t}static getCodec(e){if(e==null)return null;let t=null,s=typeof e=="string"?e:e.name;const n=o.aliases[s];if(n!=null&&(s=n),t=o.codecs[s]??null,t==null)try{t=new d(new e),o.register(t)}catch{}return t}static getCodecByName(e){let t=o.codecs[e];if(!t){const s=o.aliases[e];s&&(t=o.codecs[s])}return t??null}}o.codecs={};o.aliases={};const U=()=>document.implementation.createDocument("","",null);class A{constructor(e=U()){this.elements={},this.encodeDefaults=!1,this.document=e,this.objects={}}putObject(e,t){return this.objects[e]=t,t}getObject(e){let t=null;if(e!=null&&(t=this.objects[e],t==null&&(t=this.lookup(e),t==null))){const s=this.getElementById(e);s!=null&&(t=this.decode(s))}return t}lookup(e){return null}getElementById(e){return this.updateElements(),this.elements[e]}updateElements(){Object.keys(this.elements).length===0&&this.document.documentElement!=null&&this.addElement(this.document.documentElement)}addElement(e){if(m(e)){const s=e.getAttribute("id");if(s!=null){if(this.elements[s]==null)this.elements[s]=e;else if(this.elements[s]!==e)throw new Error(`${s}: Duplicate ID`)}}let t=e.firstChild;for(;t!=null;)this.addElement(t),t=t.nextSibling}getId(e){let t=null;return e!=null&&(t=this.reference(e),t==null&&e instanceof w&&(t=e.getId(),t==null&&(t=O.create(e),t.length===0&&(t="root")))),t}reference(e){return null}encode(e){let t=null;if(e!=null&&e.constructor!=null){const s=o.getCodec(e.constructor);s!=null?t=s.encode(this,e):P(e)?t=x(this.document,e,!0):p.logger.warn(`Codec.encode: No codec for ${B(e.constructor)}`)}return t}decode(e,t){this.updateElements();let s=null;if(m(e)){const n=o.getCodecByName(e.nodeName);n!=null?s=n.decode(this,e,t):(p.logger.warn(`Codec.decode: No codec found for node '${e.nodeName}', so the node won't be decoded, the original XML Element is returned instead.`),s=e.cloneNode(!0),s.removeAttribute("as"))}return s}encodeCell(e,t,s){const n=this.encode(e);if(n&&t.appendChild(n),s==null||s){const i=e.getChildCount();for(let r=0;r<i;r+=1)this.encodeCell(e.getChildAt(r),t)}}isCellCodec(e){return e&&"isCellCodec"in e&&typeof e.isCellCodec=="function"?e.isCellCodec():!1}decodeCell(e,t=!0){if(!m(e))return null;let s=o.getCodec(e.nodeName);if(!this.isCellCodec(s)){let i=e.firstChild;for(;i!=null&&!this.isCellCodec(s);)s=o.getCodec(i.nodeName),i=i.nextSibling}this.isCellCodec(s)||(s=o.getCodec(w));const n=s?.decode(this,e);return t&&this.insertIntoGraph(n),n}insertIntoGraph(e){const{parent:t}=e,s=e.getTerminal(!0),n=e.getTerminal(!1);if(e.setTerminal(null,!1),e.setTerminal(null,!0),e.parent=null,t!=null){if(t===e)throw new Error(`${t.id}: Self Reference`);t.insert(e)}s?.insertEdge(e,!0),n?.insertEdge(e,!1)}setAttribute(e,t,s){t!=null&&s!=null&&e.setAttribute(t,s)}}class q extends d{constructor(){super(new w,["children","edges","overlays","mxTransient"],["parent","source","target"]),this.setName("Cell")}isCellCodec(){return!0}isNumericAttribute(e,t,s){return t.nodeName!=="value"&&super.isNumericAttribute(e,t,s)}isExcluded(e,t,s,n){return super.isExcluded(e,t,s,n)||n&&t==="value"&&m(s)}afterEncode(e,t,s){if(m(t.value)){const n=s;s=x(e.document,t.value,!0),s.appendChild(n);const i=n.getAttribute("id");s.setAttribute("id",String(i)),n.removeAttribute("id")}return s}beforeDecode(e,t,s){let n=t.cloneNode(!0);const i=this.getName();if(t.nodeName!==i){const r=t.getElementsByTagName(i)[0];r!=null&&r.parentNode===t?(y(r,!0),y(r,!1),r.parentNode.removeChild(r),n=r):n=null,s.value=t.cloneNode(!0);const u=s.value.getAttribute("id");u!=null&&(s.setId(u),s.value.removeAttribute("id"))}else s.setId(t.getAttribute("id"));if(n!=null)for(let r=0;r<this.idrefs.length;r+=1){const u=this.idrefs[r],a=n.getAttribute(u);if(a!=null){n.removeAttribute(u);let h=e.objects[a]||e.lookup(a);if(h==null){const c=e.getElementById(a);c!=null&&(h=(o.codecs[c.nodeName]||this).decode(e,c))}s[u]=h}}return n}}class W extends d{constructor(){super(new $),this.setName("GraphDataModel")}encodeObject(e,t,s){const n=e.document.createElement("root");e.encodeCell(t.getRoot(),n),s.appendChild(n)}decodeChild(e,t,s){t.nodeName==="root"?this.decodeRoot(e,t,s):super.decodeChild(e,t,s)}decodeRoot(e,t,s){let n=null,i=t.firstChild;for(;i!=null;){const r=e.decodeCell(i);r!=null&&r.getParent()==null&&(n=r),i=i.nextSibling}n!=null&&s.setRoot(n)}}const J=new Map([["autosize","autoSize"]]);function K(l){const e={};l.startsWith(";")&&(e.ignoreDefaultStyle=!0);const t=l.split(";").filter(([s])=>s);for(const s of t)if(!s.includes("="))!e.baseStyleNames&&(e.baseStyleNames=[]),e.baseStyleNames.push(s);else{const[n,i]=s.split("=");e[J.get(n)??n]=j(i)}return e}function j(l){if(!E(l))return l;let e=parseFloat(l);return(Number.isNaN(e)||!Number.isFinite(e))&&(e=0),e}class Q extends q{getName(){return"mxCell"}decodeAttribute(e,t,s){const n=t.nodeName;s&&n=="style"?s.style=K(t.value):super.decodeAttribute(e,t,s)}}class Y extends d{getName(){return"mxGeometry"}constructor(){super(new N)}afterDecode(e,t,s){const n=s.points;if(n){const i=[];for(const r of n){const u=r;i.push(new C(u.x,u.y))}s.points=i}return s}}const g={base:!1,model:!1},Z=(l=!1)=>{(!g.base||l)&&(o.register(b({},"Object")),o.register(b([],"Array")),g.base=!0)},b=(l,e)=>{const t=new d(l);return t.setName(e),t},_=(l=!1)=>{(!g.model||l)&&(o.register(new q),o.register(new W),o.register(b(new N,"Geometry")),o.register(b(new C,"Point")),Z(l),o.addAlias("mxGraphModel","GraphDataModel"),o.addAlias("mxPoint","Point"),o.register(new Q,!1),o.register(new Y,!1),g.model=!0)};class M{constructor(e){this.dataModel=e,this.registerCodecs()}import(e){const t=typeof e=="string"?F(e):e.ownerDocument;new A(t).decode(t.documentElement,this.dataModel)}export(e){const t=new A().encode(this.dataModel);return e?.pretty??!0?R(t):L(t)}registerCodecs(){_()}}function ee(l,e){new M(l.model).import(e)}function S(l){console.log("ðŸ’¾ GÃ©nÃ©ration du XML BPMN mis Ã  jour");const e=new M(l.model).export();return console.log("âœ… XML BPMN gÃ©nÃ©rÃ©"),e}async function te(l,e,t,s){console.log("saveGraphToDatabase:",l,"name:",e);try{const n=await fetch(`/admin/bpmn/${l}`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":window.document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({_method:"PUT",id:l,name:e,type:t,content:s})});if(console.log("rÃ©ponse :",n.status),n.status!==200){let i="Erreur lors de la sauvegarde du graphe.";try{i=(await n.json()).message||i}catch{}throw new Error(i)}v("âœ“ Graphe sauvegardÃ©",2e3)}catch(n){console.error("Erreur lors de la sauvegarde :",n),alert("Erreur lors de la sauvegarde du graphe.")}}function ne(l,e="save-btn"){const t=document.getElementById(e);if(!t){console.warn(`#${e} introuvable, bouton de sauvegarde non cÃ¢blÃ©`);return}t.addEventListener("click",()=>{const s=Number(window.document.querySelector("#id")?.value),n=window.document.querySelector("#name")?.value??"",i=window.document.querySelector("#type")?.value??"",r=S(l);if(!r){v("âœ— Impossible de gÃ©nÃ©rer le BPMN",3e3);return}te(s,n,i,r).then(()=>console.log("Graphe sauvegardÃ© avec succÃ¨s"))}),console.log("ðŸ’¾ Bouton de sauvegarde cÃ¢blÃ©")}function ie(l){window.loadGraph=e=>ee(l,e),window.getXMLGraph=()=>S(l)}export{ne as b,ie as e};
//# sourceMappingURL=bpmn-save.js.map
