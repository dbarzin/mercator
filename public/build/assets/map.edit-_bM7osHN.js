import{E as W,b,I as y,P as L,c as Z,R as B,O as G,G as ee,a as te,C as ne,S as se,d as ie,e as le,V as H,s as oe,f as re,g as ae,h as ce}from"./Graph-Cv-_2TnX.js";import{R as de}from"./RubberBandHandler-Cu1jhjEu.js";import{M as P}from"./ModelXmlSerializer-B5ogpWyY.js";class he extends W{constructor(e=100){super(),this.size=100,this.history=[],this.indexOfNextAdd=0,this.size=e,this.clear()}isEmpty(){return this.history.length==0}clear(){this.history=[],this.indexOfNextAdd=0,this.fireEvent(new b(y.CLEAR))}canUndo(){return this.indexOfNextAdd>0}undo(){for(;this.indexOfNextAdd>0;){const e=this.history[--this.indexOfNextAdd];if(e.undo(),e.isSignificant()){this.fireEvent(new b(y.UNDO,{edit:e}));break}}}canRedo(){return this.indexOfNextAdd<this.history.length}redo(){const e=this.history.length;for(;this.indexOfNextAdd<e;){const t=this.history[this.indexOfNextAdd++];if(t.redo(),t.isSignificant()){this.fireEvent(new b(y.REDO,{edit:t}));break}}}undoableEditHappened(e){this.trim(),this.size>0&&this.size==this.history.length&&this.history.shift(),this.history.push(e),this.indexOfNextAdd=this.history.length,this.fireEvent(new b(y.ADD,{edit:e}))}trim(){if(this.history.length>this.indexOfNextAdd){const e=this.history.splice(this.indexOfNextAdd,this.history.length-this.indexOfNextAdd);for(let t=0;t<e.length;t+=1)e[t].die()}}}class ue{constructor(e){this.useBoundingBox=!0,this.parent=null,this.graph=e}moveCell(e,t,n){}resizeCell(e,t,n){}execute(e){}getGraph(){return this.graph}getConstraint(e,t,n,l){return this.graph.getCurrentCellStyle(t)[e]}traverse({vertex:e,directed:t,func:n,edge:l,visited:s}){if(n!=null&&e!=null&&(t=t??!0,s=s||new Map,!s.get(e))){s.set(e,!0);const r=n(e,l);if(r==null||r){const a=e.getEdgeCount();if(a>0)for(let c=0;c<a;c+=1){const d=e.getEdgeAt(c),h=d.getTerminal(!0)===e;if(!t||h){const g=this.graph.view.getVisibleTerminal(d,!h);this.traverse({vertex:g,directed:t,func:n,edge:d,visited:s})}}}}}isAncestor(e,t,n){if(!n)return t.getParent()===e;if(t===e)return!1;for(;t!=null&&t!==e;)t=t.getParent();return t===e}isVertexMovable(e){return this.graph.isCellMovable(e)}isVertexIgnored(e){return!e.isVertex()||!e.isVisible()}isEdgeIgnored(e){return!e.isEdge()||!e.isVisible()||e.getTerminal(!0)==null||e.getTerminal(!1)==null}setEdgeStyleEnabled(e,t){this.graph.setCellStyles("noEdgeStyle",t?"0":"1",[e])}setOrthogonalEdge(e,t){this.graph.setCellStyles("orthogonal",t?"1":"0",[e])}getParentOffset(e){const t=new L;if(e!=null&&e!==this.parent&&(this.graph.getDataModel(),this.parent&&this.parent.isAncestor(e))){let n=e.getGeometry();for(;e!==this.parent;)t.x+=n.x,t.y+=n.y,e=e.getParent(),n=e.getGeometry()}return t}setEdgePoints(e,t){if(e!=null){const{model:n}=this.graph;let l=e.getGeometry();if(l==null?(l=new Z,l.setRelative(!0)):l=l.clone(),this.parent!=null&&t!=null){const s=e.getParent(),r=this.getParentOffset(s);for(let a=0;a<t.length;a+=1)t[a].x=t[a].x-r.x,t[a].y=t[a].y-r.y}l.points=t,n.setGeometry(e,l)}}setVertexLocation(e,t,n){const l=this.graph.getDataModel();let s=e.getGeometry(),r=null;if(s!=null){if(r=new B(t,n,s.width,s.height),this.useBoundingBox){const a=this.graph.getView().getState(e);if(a!=null&&a.text!=null&&a.text.boundingBox!=null){const{scale:c}=this.graph.getView(),d=a.text.boundingBox;a.text.boundingBox.x<a.x&&(t+=(a.x-d.x)/c,r.width=d.width),a.text.boundingBox.y<a.y&&(n+=(a.y-d.y)/c,r.height=d.height)}}if(this.parent!=null){const a=e.getParent();if(a!=null&&a!==this.parent){const c=this.getParentOffset(a);t-=c.x,n-=c.y}}(s.x!==t||s.y!==n)&&(s=s.clone(),s.x=t,s.y=n,l.setGeometry(e,s))}return r}getVertexBounds(e){let t=e.getGeometry();if(this.useBoundingBox){const n=this.graph.getView().getState(e);if(n!=null&&n.text!=null&&n.text.boundingBox!=null){const{scale:l}=this.graph.getView(),s=n.text.boundingBox,r=Math.max(n.x-s.x,0)/l,a=Math.max(n.y-s.y,0)/l,c=Math.max(s.x+s.width-(n.x+n.width),0)/l,d=Math.max(s.y+s.height-(n.y+n.height),0)/l;t=new B(t.x-r,t.y-a,t.width+r+c,t.height+a+d)}}if(this.parent!=null){const n=e.getParent();if(t=t.clone(),n!=null&&n!==this.parent){const l=this.getParentOffset(n);t.x+=l.x,t.y+=l.y}}return new B(t.x,t.y,t.width,t.height)}arrangeGroups(e,t,n,l,s,r){return this.graph.updateGroupBounds(e,t,!0,n,l,s,r)}}class ge extends ue{constructor(e){super(e),this.useInputOrigin=!0,this.resetEdges=!0,this.disableEdgeStyle=!0,this.forceConstant=50,this.forceConstantSquared=0,this.minDistanceLimit=2,this.maxDistanceLimit=500,this.minDistanceLimitSquared=4,this.initialTemp=200,this.temperature=0,this.maxIterations=0,this.iteration=0,this.vertexArray=[],this.dispX=[],this.dispY=[],this.cellLocation=[],this.radius=[],this.radiusSquared=[],this.isMoveable=[],this.neighbours={},this.indices={},this.allowedToRun=!0}isVertexIgnored(e){return super.isVertexIgnored(e)||this.graph.getConnections(e).length===0}execute(e){this.vertexArray=[];let t=this.graph.getChildVertices(e);for(let s=0;s<t.length;s+=1)this.isVertexIgnored(t[s])||this.vertexArray.push(t[s]);const n=this.useInputOrigin?this.graph.getBoundingBoxFromGeometry(this.vertexArray):null,l=this.vertexArray.length;this.indices={},this.dispX=[],this.dispY=[],this.cellLocation=[],this.isMoveable=[],this.neighbours={},this.radius=[],this.radiusSquared=[],this.forceConstant<.001&&(this.forceConstant=.001),this.forceConstantSquared=this.forceConstant*this.forceConstant;for(let s=0;s<this.vertexArray.length;s+=1){const r=this.vertexArray[s];this.cellLocation[s]=[];const a=G.get(r);this.indices[a]=s;const c=this.getVertexBounds(r),{width:d}=c,{height:h}=c,{x:g}=c,{y:x}=c;this.cellLocation[s][0]=g+d/2,this.cellLocation[s][1]=x+h/2,this.radius[s]=Math.min(d,h),this.radiusSquared[s]=this.radius[s]*this.radius[s]}this.graph.batchUpdate(()=>{for(let d=0;d<l;d+=1){this.dispX[d]=0,this.dispY[d]=0,this.isMoveable[d]=this.isVertexMovable(this.vertexArray[d]);const h=this.graph.getConnections(this.vertexArray[d],e);t=this.graph.getOpposites(h,this.vertexArray[d]),this.neighbours[d]=[];for(let g=0;g<t.length;g+=1){this.resetEdges&&this.graph.resetEdge(h[g]),this.disableEdgeStyle&&this.setEdgeStyleEnabled(h[g],!1);const x=G.get(t[g]),S=this.indices[x];S!=null?this.neighbours[d][g]=S:this.neighbours[d][g]=d}}for(this.temperature=this.initialTemp,this.maxIterations===0&&(this.maxIterations=20*Math.sqrt(l)),this.iteration=0;this.iteration<this.maxIterations;this.iteration+=1){if(!this.allowedToRun)return;this.calcRepulsion(),this.calcAttraction(),this.calcPositions(),this.reduceTemperature()}let s=null,r=null;for(let d=0;d<this.vertexArray.length;d+=1){const h=this.vertexArray[d];if(this.isVertexMovable(h)){const g=this.getVertexBounds(h);if(g!=null){this.cellLocation[d][0]-=g.width/2,this.cellLocation[d][1]-=g.height/2;const x=this.graph.snap(Math.round(this.cellLocation[d][0])),S=this.graph.snap(Math.round(this.cellLocation[d][1]));this.setVertexLocation(h,x,S),s==null?s=x:s=Math.min(s,x),r==null?r=S:r=Math.min(r,S)}}}let a=-(s||0)+1,c=-(r||0)+1;n!=null&&(a+=n.x,c+=n.y),this.graph.moveCells(this.vertexArray,a,c)})}calcPositions(){for(let e=0;e<this.vertexArray.length;e+=1)if(this.isMoveable[e]){let t=Math.sqrt(this.dispX[e]*this.dispX[e]+this.dispY[e]*this.dispY[e]);t<.001&&(t=.001);const n=this.dispX[e]/t*Math.min(t,this.temperature),l=this.dispY[e]/t*Math.min(t,this.temperature);this.dispX[e]=0,this.dispY[e]=0,this.cellLocation[e][0]+=n,this.cellLocation[e][1]+=l}}calcAttraction(){for(let e=0;e<this.vertexArray.length;e+=1)for(let t=0;t<this.neighbours[e].length;t+=1){const n=this.neighbours[e][t];if(e!==n&&this.isMoveable[e]&&this.isMoveable[n]){const l=this.cellLocation[e][0]-this.cellLocation[n][0],s=this.cellLocation[e][1]-this.cellLocation[n][1];let r=l*l+s*s-this.radiusSquared[e]-this.radiusSquared[n];r<this.minDistanceLimitSquared&&(r=this.minDistanceLimitSquared);const a=Math.sqrt(r),c=r/this.forceConstant,d=l/a*c,h=s/a*c;this.dispX[e]-=d,this.dispY[e]-=h,this.dispX[n]+=d,this.dispY[n]+=h}}}calcRepulsion(){const e=this.vertexArray.length;for(let t=0;t<e;t+=1)for(let n=t;n<e;n+=1){if(!this.allowedToRun)return;if(n!==t&&this.isMoveable[t]&&this.isMoveable[n]){let l=this.cellLocation[t][0]-this.cellLocation[n][0],s=this.cellLocation[t][1]-this.cellLocation[n][1];l===0&&(l=.01+Math.random()),s===0&&(s=.01+Math.random());const r=Math.sqrt(l*l+s*s);let a=r-this.radius[t]-this.radius[n];if(a>this.maxDistanceLimit)continue;a<this.minDistanceLimit&&(a=this.minDistanceLimit);const c=this.forceConstantSquared/a,d=l/r*c,h=s/r*c;this.dispX[t]+=d,this.dispY[t]+=h,this.dispX[n]-=d,this.dispY[n]-=h}}}reduceTemperature(){this.temperature=this.initialTemp*(1-this.iteration/this.maxIterations)}}class fe extends W{constructor(e=20){super(),this.thread=null,this.delay=e}isRunning(){return this.thread!=null}startAnimation(){this.thread==null&&(this.thread=window.setInterval(this.updateAnimation.bind(this),this.delay))}updateAnimation(){this.fireEvent(new b(y.EXECUTE))}stopAnimation(){this.thread!=null&&(window.clearInterval(this.thread),this.thread=null,this.fireEvent(new b(y.DONE)))}}class pe{constructor(e){this.count=0,this.deltas=new Map,this.graph=e}isEmpty(){return this.count===0}moveState(e,t,n,l=!0,s=!0){let r=this.deltas.get(e.cell);return r==null?(r={point:new L(t,n),state:e},this.deltas.set(e.cell,r),this.count++):l?(r.point.x+=t,r.point.y+=n):(r.point.x=t,r.point.y=n),s&&this.addEdges(e),r.point}show(e=null){this.deltas.forEach(t=>{this.translateState(t.state,t.point.x,t.point.y)}),this.deltas.forEach(t=>{this.revalidateState(t.state,t.point.x,t.point.y,e)})}translateState(e,t,n){if(e!=null){if(e.cell.isVertex()){e.view.updateCellState(e);const l=e.cell.getGeometry();(t!==0||n!==0)&&l!=null&&(!l.relative||this.deltas.get(e.cell)!=null)&&(e.x+=t,e.y+=n)}for(const l of e.cell.getChildren())this.translateState(e.view.getState(l),t,n)}}revalidateState(e,t,n,l=null){e.cell.isEdge()&&e.view.updateCellState(e);const s=e.cell.getGeometry(),r=e.view.getState(e.cell.getParent());(t!==0||n!==0)&&s!=null&&s.relative&&e.cell.isVertex()&&(r==null||r.cell.isVertex()||this.deltas.get(e.cell)!=null)&&(e.x+=t,e.y+=n),this.graph.cellRenderer.redraw(e),l!=null&&l(e);for(const a of e.cell.getChildren())this.revalidateState(this.graph.view.getState(a),t,n,l)}addEdges(e){const t=e.cell.getEdgeCount();for(let n=0;n<t;n+=1){const l=e.view.getState(e.cell.getEdgeAt(n));l!=null&&this.moveState(l,0,0)}}}class ye extends fe{constructor(e,t=6,n=1.5,l){super(l),this.step=0,this.cells=null,this.graph=e,this.steps=t,this.ease=n}updateAnimation(){super.updateAnimation();const e=new pe(this.graph);if(this.cells!=null)for(const t of this.cells)this.animateCell(t,e,!1);else this.animateCell(this.graph.getDataModel().getRoot(),e,!0);this.show(e),(e.isEmpty()||this.step++>=this.steps)&&this.stopAnimation()}show(e){e.show()}animateCell(e,t,n=!1){const l=this.graph.getView().getState(e);let s=null;if(l!=null&&(s=this.getDelta(l),e.isVertex()&&(s.x!=0||s.y!=0))){const r=this.graph.view.getTranslate(),a=this.graph.view.getScale();s.x+=r.x*a,s.y+=r.y*a,t.moveState(l,-s.x/this.ease,-s.y/this.ease)}if(n&&!this.stopRecursion(l,s)){const r=e.getChildCount();for(let a=0;a<r;a+=1)this.animateCell(e.getChildAt(a),t,n)}}stopRecursion(e=null,t=null){return t!=null&&(t.x!=0||t.y!=0)}getDelta(e){const t=this.getOriginForCell(e.cell),n=this.graph.getView().getTranslate(),l=this.graph.getView().getScale(),s=e.x/l-n.x,r=e.y/l-n.y;return new L((t.x-s)*l,(t.y-r)*l)}getOriginForCell(e=null){let t=null;if(e!=null){const n=e.getParent(),l=e.getGeometry();if(t=this.getOriginForCell(n),l!=null&&n!=null)if(l.relative){const s=n.getGeometry();s!=null&&(t.x+=l.x*s.width,t.y+=l.y*s.height)}else t.x+=l.x,t.y+=l.y}if(t==null){const n=this.graph.view.getTranslate();t=new L(-n.x,-n.y)}return t}}const me=[ne,se,ie,le,de],f=document.getElementById("graph-container");document.createElement("div");const o=new ee(f,new te,me),E=o.getDataModel();var C=o.getStylesheet().getDefaultEdgeStyle();C.labelBackgroundColor="#FFFFFF";C.strokeWidth=2;C.rounded=!0;C.entryPerimeter=!1;C.edgeStyle="manhattanEdgeStyle";o.getFoldingImage=()=>null;H.selectionColor="#00a8ff";H.selectionStrokeWidth=2;const m=new he,_=(i,e)=>{m.undoableEditHappened(e.getProperty("edit"))};E.addListener(y.UNDO,_);o.getView().addListener(y.UNDO,_);const xe=document.getElementById("undoButton"),ve=document.getElementById("redoButton");xe.addEventListener("click",()=>{m.canUndo()&&m.undo()});ve.addEventListener("click",()=>{m.canRedo()&&m.redo()});document.addEventListener("keydown",i=>{i.ctrlKey&&i.key==="z"?(i.preventDefault(),m.canUndo()&&m.undo()):i.ctrlKey&&i.key==="y"&&(i.preventDefault(),m.canRedo()&&m.redo())});const p=document.getElementById("edge-context-menu"),D=document.getElementById("edge-color-select"),A=document.getElementById("edge-thickness-select"),v=document.getElementById("text-context-menu"),K=document.getElementById("text-font-select"),J=document.getElementById("text-color-select"),Q=document.getElementById("text-size-select"),k=document.getElementById("text-bold-select"),M=document.getElementById("text-italic-select"),O=document.getElementById("text-underline-select");let u=null;o.container.addEventListener("contextmenu",i=>{i.preventDefault();const e=o.getCellAt(i.offsetX,i.offsetY);if(e!=null)if(e.isEdge()){u=e;const t=f.getBoundingClientRect(),n=i.clientX-t.left,l=i.clientY-t.top;p.style.display="block",p.style.left=`${n+75}px`,p.style.top=`${l+100}px`;const s=o.getCellStyle(e);D.value=s.strokeColor||"#000000",A.value=s.strokeWidth||"1"}else if(e.isVertex()){if(e.value!=null&&e.value!=""){u=e;const t=f.getBoundingClientRect(),n=i.clientX-t.left,l=i.clientY-t.top;v.style.display="block",v.style.left=`${n+75}px`,v.style.top=`${l+100}px`;const s=o.getCellStyle(e);J.value=s.fontColor||"#000000",K.value=s.fontFamily||"Arial",Q.value=s.fontSize||"12",u.style.fontStyle&1?k.classList.add("selected"):k.classList.remove("selected"),u.style.fontStyle&2?M.classList.add("selected"):M.classList.remove("selected"),u.style.fontStyle&4?O.classList.add("selected"):O.classList.remove("selected")}else if(e.style.image==null&&e.children.length==0){u=e;const t=f.getBoundingClientRect(),n=i.clientX-t.left,l=i.clientY-t.top;p.style.display="block",p.style.left=`${n+75}px`,p.style.top=`${l+100}px`;const s=o.getCellStyle(e);D.value=s.strokeColor||"#000000",A.value=s.strokeWidth||"1"}}else v.style.display="none",p.style.display="none"});var F;(F=document.getElementById("apply-edge-style"))==null||F.addEventListener("click",i=>{i.preventDefault(),u&&o.batchUpdate(()=>{o.getCellStyle(u),u.isEdge()?(u.style.strokeColor=D.value,u.style.strokeWidth=parseInt(A.value,10)):(u.style.fillColor=D.value,u.style.strokeWidth=parseInt(A.value,10)),o.refresh(u)}),p.style.display="none"});var U;(U=document.getElementById("apply-text-style"))==null||U.addEventListener("click",i=>{i.preventDefault(),u&&o.batchUpdate(()=>{u.style.fontFamily=K.value,u.style.fontColor=J.value,u.style.fontSize=parseInt(Q.value,10);var e=0;e=e|(k.classList.contains("selected")?1:0),e=e|(M.classList.contains("selected")?2:0),e=e|(O.classList.contains("selected")?4:0),u.style.fontStyle=e,o.refresh(u)}),v.style.display="none"});var X;(X=document.querySelectorAll(".button"))==null||X.forEach(i=>{i.addEventListener("click",()=>{Ee(i)})});function Ee(i){i.classList.toggle("selected")}document.addEventListener("click",i=>{v.contains(i.target)||(v.style.display="none"),p.contains(i.target)||(p.style.display="none")});o.setGridEnabled(!0);o.setGridSize(10);f.style.backgroundImage=`
  linear-gradient(to right, #e0e0e0 1px, transparent 1px),
  linear-gradient(to bottom, #e0e0e0 1px, transparent 1px)
`;f.style.backgroundSize="10px 10px";o.setPanning(!0);o.allowAutoPanning=!0;o.useScrollbarsForPanning=!0;function Se(i){new P(E).import(i)}window.loadGraph=Se;async function be(i,e,t,n){console.log("saveGraphToDatabase:"+i+" name:"+e);try{const l=await fetch(`/admin/graphs/${i}`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({_method:"PUT",id:i,name:e,type:t,content:n})});if(console.log("réponse :",l.status),l.status!=200){const s=await l.json();throw new Error(s.message||"Erreur lors de la sauvegarde du graphe.")}console.log("Graphe sauvegardé avec succès")}catch(l){console.error("Erreur lors de la sauvegarde :",l),alert("Erreur lors de la sauvegarde du graphe.")}}function Ce(){return new P(E).export()}window.getXMLGraph=Ce;function we(){const i=new P(E).export();be(document.querySelector("#id").value,document.querySelector("#name").value,document.querySelector("#type").value,i)}var z;(z=document.getElementById("saveButton"))==null||z.addEventListener("click",we);var q;(q=document.getElementById("font-btn"))==null||q.addEventListener("dragstart",i=>{i.dataTransfer.setData("node-type","text-node")});f.addEventListener("dragover",i=>{i.preventDefault()});o.autoSizeCells=!0;function T(i,e){var c;if(typeof i.getPointForEvent=="function")return i.getPointForEvent(e);const t=i.view??((c=i.getView)==null?void 0:c.call(i)),n=re(i.container,ce(e),ae(e)),l=t.translate??{x:0,y:0},s=t.scale??1,r=i.panDx??0,a=i.panDy??0;return[(n.x-r)/s-l.x-20,(n.y-a)/s-l.y-20]}o.enterStopsCellEditing=!0;f.addEventListener("drop",i=>{if(i.preventDefault(),i.dataTransfer.getData("node-type")=="text-node"){const e=T(o,i);o.batchUpdate(()=>{const t=o.getDefaultParent();o.insertVertex({parent:t,value:"Text",position:[e.x,e.y],size:[150,30],style:{fillColor:"none",strokeColor:"none",fontColor:"#000000",fontSize:14,align:"left",verticalAlign:"middle"}})})}});const Le=document.getElementById("square-btn");Le.addEventListener("dragstart",i=>{i.dataTransfer.setData("node-type","square-node")});f.addEventListener("dragover",i=>{i.preventDefault()});f.addEventListener("drop",i=>{if(i.preventDefault(),i.dataTransfer.getData("node-type")=="square-node"){const e=T(o,i);o.batchUpdate(()=>{const t=o.getDefaultParent();console.log([e.x,e.y]);const n=o.insertVertex({parent:t,value:"",position:[e.x,e.y],size:[150,120],style:{fillColor:"#fffacd",strokeColor:"#000000",strokeWidth:1,rounded:2}});o.orderCells(!0,[n])})}});const V=document.getElementById("nodeImage"),I=document.getElementById("node");V.addEventListener("dragstart",i=>{i.dataTransfer.setData("node-type","icon-node")});f.addEventListener("dragover",i=>{i.preventDefault()});f.addEventListener("drop",i=>{if(i.preventDefault(),i.dataTransfer.getData("node-type")=="icon-node"&&V.src!=""){const e=T(o,i);o.batchUpdate(()=>{const t=o.getDefaultParent(),n=E.getCell(I.value);if(n!=null)o.setSelectionCells(n);else{const l=_nodes.get(I.value),s=o.insertVertex({parent:t,id:I.value,value:l.label,position:[e.x-16,e.y-16],size:[32,32],style:{shape:"image",image:V.src,editable:!1,resizable:!0,verticalLabelPosition:"bottom",spacingTop:-15}});l.edges.forEach(function(r){const a=E.getCell(r.attachedNodeId);a!=null&&o.insertEdge({parent:t,value:"",source:s,target:a,style:{editable:!1,strokeColor:"#ff0000",strokeWidth:1,startArrow:"none",endArrow:"none"}})})}})}});const De=document.getElementById("zoom-in-btn"),Ae=document.getElementById("zoom-out-btn");De.addEventListener("click",()=>{o.zoomIn()});Ae.addEventListener("click",()=>{o.zoomOut()});document.addEventListener("keydown",i=>{if(i.key==="Delete"||i.key==="Backspace"){const e=o.getSelectionCells();e.length>0&&o.removeCells(e)}});$("body").keydown(function(i){i.ctrlKey&&i.keyCode==65&&(i.preventDefault(),i.stopPropagation(),o.selectAll())});o.setConnectable(!1);o.isCellDisconnectable=function(){return!1};const Be=document.getElementById("group-btn"),Ie=document.getElementById("ungroup-btn");Be.addEventListener("click",()=>{const i=o.getSelectionCells();if(i.length>1){const e=o.getDefaultParent(),t=o.insertVertex({parent:e,style:{fillColor:"none",strokeColor:"none"}});o.addCell(t),o.groupCells(t,5,i)}});Ie.addEventListener("click",()=>{const i=o.getSelectionCells();i.length==1&&(o.ungroupCells(i),o.setSelectionCells(i))});function w(i,e,t){const n=i.getSelectionCell();n&&n.isVertex()&&i.batchUpdate(()=>{const l=n.getGeometry();l&&(l.translate(e,t),i.refresh())})}document.addEventListener("keydown",i=>{switch(i.key){case"ArrowUp":w(o,0,-1);break;case"ArrowDown":w(o,0,1);break;case"ArrowLeft":w(o,-1,0);break;case"ArrowRight":w(o,1,0);break}});function ke(i,e,t){const n=[],l=2*Math.PI/t;for(let s=0;s<t;s++){const r=s*l,a=i.x+e*Math.cos(r),c=i.y+e*Math.sin(r);n.push({x:a,y:c})}return n}function Me(){let i=[];for(let e of document.getElementById("filters").options)e.selected&&i.push(e.value);return i}function Oe(i,e,t){if(i==null||e==null)return!1;let n=!1;return o.getEdges(i).forEach(s=>{if(s.target==e&&(t==null||s.value==t)){n=!0;return}}),n||o.getEdges(e).forEach(r=>{if(r.target==i&&(t==null||r.value==t)){n=!0;return}}),n}o.addListener(y.DOUBLE_CLICK,(i,e)=>{const t=e.getProperty("cell");if(t&&t.isVertex()&&t.style.shape=="image"){const n=_nodes.get(t.id);if(n==null)return;o.batchUpdate(()=>{let l=[];const s=o.getDefaultParent(),r=Me();n.edges.forEach(function(c){let d=_nodes.get(c.attachedNodeId);if(d!=null){const h=E.getCell(c.attachedNodeId);h==null&&!l.some(g=>g.attachedNodeId==c.attachedNodeId)?(r.length==0||r.includes(d.vue)||r.includes("8")&&c.edgeType==="CABLE"||r.includes("9")&&c.edgeType==="FLUX")&&l.push(c):Oe(t,h,c.name)||o.insertEdge({parent:s,value:c.name,source:t,target:h,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:c.edgeType=="FLUX"&&(c.bidirectional||c.edgeDirection=="FROM")?"classic":"none",endArrow:c.edgeType=="FLUX"&&(c.bidirectional||c.edgeDirection=="TO")?"classic":"none"}})}}),f.getBoundingClientRect();const a=ke({x:t.getGeometry().x,y:t.getGeometry().y},80,l.length);for(let c=0;c<a.length;c++){const d=l[c],h=_nodes.get(d.attachedNodeId),g=o.insertVertex({parent:s,id:h.id,value:h.label,position:[a[c].x,a[c].y],size:[32,32],style:{shape:"image",image:h.image,editable:!1,resizable:!0,verticalLabelPosition:"bottom",spacingTop:-15}});o.insertEdge({parent:s,value:l[c].name,source:t,target:g,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:d.edgeType=="FLUX"&&(d.bidirectional||d.edgeDirection=="FROM")?"classic":"none",endArrow:d.edgeType=="FLUX"&&(d.bidirectional||d.edgeDirection=="TO")?"classic":"none"}})}})}});var N;(N=document.getElementById("update-btn"))==null||N.addEventListener("click",()=>{o.batchUpdate(()=>{o.getChildCells().forEach(e=>{if(!e.isEdge()){if(e.style.image!=null){const t=_nodes.get(e.id);t==null?o.removeCells([e],!0):(e.value=t.label,oe(o.getDataModel(),[e],{image:t.image}))}}}),o.refresh()})});const R=o.container.querySelector("svg");function Ve(i){i.querySelectorAll("image").forEach(t=>{const n=t.getAttribute("xlink:href");fetch(n).then(l=>l.blob()).then(l=>{const s=new FileReader;s.onloadend=()=>{t.setAttribute("xlink:href",s.result)},s.readAsDataURL(l)})})}function Pe(){Ve(R),setTimeout(()=>{const e=new XMLSerializer().serializeToString(R),t=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),n=URL.createObjectURL(t),l=document.createElement("a");l.href=n;const s=new Date,r=s.getFullYear()+String(s.getMonth()+1).padStart(2,"0")+String(s.getDate()).padStart(2,"0")+String(s.getHours()).padStart(2,"0")+String(s.getMinutes()).padStart(2,"0");l.download=`graph-${r}.svg`,l.click(),URL.revokeObjectURL(n)},1e3)}var Y;(Y=document.getElementById("download-btn"))==null||Y.addEventListener("click",Pe);function Te(){const i=o.getDefaultParent(),e=o.getChildVertices(i);if(!e||e.length===0)return;const t=new ge(o);t.forceConstant=60,t.disableEdgeStyle=!1,o.getDataModel().beginUpdate();try{t.execute(i,e)}finally{const n=new ye(o);n.addListener(y.DONE,()=>o.getDataModel().endUpdate()),n.startAnimation()}}var j;(j=document.getElementById("layout-btn"))==null||j.addEventListener("click",Te);
