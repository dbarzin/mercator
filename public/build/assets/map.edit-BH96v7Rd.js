import{I as f,g as I,b as B,i as ne,c as re,P as w,C as k,d as le,s as oe,R as D,e as ae,f as K,h as he,E as J,j as S,k as de,O as F,G as ce,a as ue,l as ge,S as fe,m as pe,n as ye,V as Q,o as me,M as G,p as xe,q as ve}from"./ModelXmlSerializer-B1iToIRA.js";class Z{constructor(e){this.first=null,this.destroyed=!1,this.dragHandler=null,this.dropHandler=null,this.x=0,this.y=0,this.width=0,this.height=0,this.defaultOpacity=20,this.enabled=!0,this.div=null,this.sharedDiv=null,this.currentX=0,this.currentY=0,this.fadeOut=!1,this.graph=e,this.graph.addMouseListener(this),this.forceRubberbandHandler=(t,s)=>{const n=s.getProperty("eventName"),i=s.getProperty("event");if(n===f.MOUSE_DOWN&&this.isForceRubberbandEvent(i)){const l=I(this.graph.container),a=B(this.graph.container);a.x-=l.x,a.y-=l.y,this.start(i.getX()+a.x,i.getY()+a.y),i.consume(!1)}},this.graph.addListener(f.FIRE_MOUSE_EVENT,this.forceRubberbandHandler),this.panHandler=()=>{this.repaint()},this.graph.addListener(f.PAN,this.panHandler),this.gestureHandler=(t,s)=>{this.first&&this.reset()},this.graph.addListener(f.GESTURE,this.gestureHandler)}isEnabled(){return this.enabled}setEnabled(e){this.enabled=e}isForceRubberbandEvent(e){return ne(e.getEvent())}mouseDown(e,t){if(!t.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&!t.getState()&&!re(t.getEvent())){const s=I(this.graph.container),n=B(this.graph.container);n.x-=s.x,n.y-=s.y,this.start(t.getX()+n.x,t.getY()+n.y),t.consume(!1)}}start(e,t){this.first=new w(e,t);const{container:s}=this.graph;function n(i){const l=new he(i),a=K(s,l.getX(),l.getY());return l.graphX=a.x,l.graphY=a.y,l}this.dragHandler=i=>{this.mouseMove(this.graph,n(i))},this.dropHandler=i=>{this.mouseUp(this.graph,n(i))},k.IS_FF&&f.addGestureListeners(document,null,this.dragHandler,this.dropHandler)}mouseMove(e,t){if(!t.isConsumed()&&this.first){const s=B(this.graph.container),n=I(this.graph.container);s.x-=n.x,s.y-=n.y;const i=t.getX()+s.x,l=t.getY()+s.y,a=this.first.x-i,h=this.first.y-l,d=this.graph.getEventTolerance();(this.div||Math.abs(a)>d||Math.abs(h)>d)&&(this.div||(this.div=this.createShape()),le(),this.update(i,l),t.consume())}}createShape(){this.sharedDiv||(this.sharedDiv=document.createElement("div"),this.sharedDiv.className="mxRubberband",oe(this.sharedDiv,this.defaultOpacity)),this.graph.container.appendChild(this.sharedDiv);const e=this.sharedDiv;return k.IS_SVG&&this.fadeOut&&(this.sharedDiv=null),e}isActive(e,t){return this.div&&this.div.style.display!=="none"}mouseUp(e,t){const s=this.isActive();this.reset(),s&&(this.execute(t.getEvent()),t.consume())}execute(e){const t=new D(this.x,this.y,this.width,this.height);this.graph.selectRegion(t,e)}reset(){if(this.div)if(k.IS_SVG&&this.fadeOut){const e=this.div;ae(e.style,"transition","all 0.2s linear"),e.style.pointerEvents="none",e.style.opacity=String(0),window.setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},200)}else this.div.parentNode&&this.div.parentNode.removeChild(this.div);f.removeGestureListeners(document,null,this.dragHandler,this.dropHandler),this.dragHandler=null,this.dropHandler=null,this.currentX=0,this.currentY=0,this.first=null,this.div=null}update(e,t){this.currentX=e,this.currentY=t,this.repaint()}repaint(){if(this.div&&this.first){const e=this.currentX-this.graph.getPanDx(),t=this.currentY-this.graph.getPanDy();this.x=Math.min(this.first.x,e),this.y=Math.min(this.first.y,t),this.width=Math.max(this.first.x,e)-this.x,this.height=Math.max(this.first.y,t)-this.y;const s=0,n=0;this.div.style.left=`${this.x+s}px`,this.div.style.top=`${this.y+n}px`,this.div.style.width=`${Math.max(1,this.width)}px`,this.div.style.height=`${Math.max(1,this.height)}px`}}onDestroy(){this.destroyed||(this.destroyed=!0,this.graph.removeMouseListener(this),this.graph.removeListener(this.forceRubberbandHandler),this.graph.removeListener(this.panHandler),this.reset(),this.sharedDiv&&(this.sharedDiv=null))}}Z.pluginId="RubberBandHandler";class Ee extends J{constructor(e=100){super(),this.size=100,this.history=[],this.indexOfNextAdd=0,this.size=e,this.clear()}isEmpty(){return this.history.length==0}clear(){this.history=[],this.indexOfNextAdd=0,this.fireEvent(new S(f.CLEAR))}canUndo(){return this.indexOfNextAdd>0}undo(){for(;this.indexOfNextAdd>0;){const e=this.history[--this.indexOfNextAdd];if(e.undo(),e.isSignificant()){this.fireEvent(new S(f.UNDO,{edit:e}));break}}}canRedo(){return this.indexOfNextAdd<this.history.length}redo(){const e=this.history.length;for(;this.indexOfNextAdd<e;){const t=this.history[this.indexOfNextAdd++];if(t.redo(),t.isSignificant()){this.fireEvent(new S(f.REDO,{edit:t}));break}}}undoableEditHappened(e){this.trim(),this.size>0&&this.size==this.history.length&&this.history.shift(),this.history.push(e),this.indexOfNextAdd=this.history.length,this.fireEvent(new S(f.ADD,{edit:e}))}trim(){if(this.history.length>this.indexOfNextAdd){const e=this.history.splice(this.indexOfNextAdd,this.history.length-this.indexOfNextAdd);for(let t=0;t<e.length;t+=1)e[t].die()}}}class be{constructor(e){this.useBoundingBox=!0,this.parent=null,this.graph=e}moveCell(e,t,s){}resizeCell(e,t,s){}execute(e){}getGraph(){return this.graph}getConstraint(e,t,s,n){return this.graph.getCurrentCellStyle(t)[e]}traverse({vertex:e,directed:t,func:s,edge:n,visited:i}){if(s!=null&&e!=null&&(t=t??!0,i=i||new Map,!i.get(e))){i.set(e,!0);const l=s(e,n);if(l==null||l){const a=e.getEdgeCount();if(a>0)for(let h=0;h<a;h+=1){const d=e.getEdgeAt(h),c=d.getTerminal(!0)===e;if(!t||c){const g=this.graph.view.getVisibleTerminal(d,!c);this.traverse({vertex:g,directed:t,func:s,edge:d,visited:i})}}}}}isAncestor(e,t,s){if(!s)return t.getParent()===e;if(t===e)return!1;for(;t!=null&&t!==e;)t=t.getParent();return t===e}isVertexMovable(e){return this.graph.isCellMovable(e)}isVertexIgnored(e){return!e.isVertex()||!e.isVisible()}isEdgeIgnored(e){return!e.isEdge()||!e.isVisible()||e.getTerminal(!0)==null||e.getTerminal(!1)==null}setEdgeStyleEnabled(e,t){this.graph.setCellStyles("noEdgeStyle",t?"0":"1",[e])}setOrthogonalEdge(e,t){this.graph.setCellStyles("orthogonal",t?"1":"0",[e])}getParentOffset(e){const t=new w;if(e!=null&&e!==this.parent&&(this.graph.getDataModel(),this.parent&&this.parent.isAncestor(e))){let s=e.getGeometry();for(;e!==this.parent;)t.x+=s.x,t.y+=s.y,e=e.getParent(),s=e.getGeometry()}return t}setEdgePoints(e,t){if(e!=null){const{model:s}=this.graph;let n=e.getGeometry();if(n==null?(n=new de,n.setRelative(!0)):n=n.clone(),this.parent!=null&&t!=null){const i=e.getParent(),l=this.getParentOffset(i);for(let a=0;a<t.length;a+=1)t[a].x=t[a].x-l.x,t[a].y=t[a].y-l.y}n.points=t,s.setGeometry(e,n)}}setVertexLocation(e,t,s){const n=this.graph.getDataModel();let i=e.getGeometry(),l=null;if(i!=null){if(l=new D(t,s,i.width,i.height),this.useBoundingBox){const a=this.graph.getView().getState(e);if(a!=null&&a.text!=null&&a.text.boundingBox!=null){const{scale:h}=this.graph.getView(),d=a.text.boundingBox;a.text.boundingBox.x<a.x&&(t+=(a.x-d.x)/h,l.width=d.width),a.text.boundingBox.y<a.y&&(s+=(a.y-d.y)/h,l.height=d.height)}}if(this.parent!=null){const a=e.getParent();if(a!=null&&a!==this.parent){const h=this.getParentOffset(a);t-=h.x,s-=h.y}}(i.x!==t||i.y!==s)&&(i=i.clone(),i.x=t,i.y=s,n.setGeometry(e,i))}return l}getVertexBounds(e){let t=e.getGeometry();if(this.useBoundingBox){const s=this.graph.getView().getState(e);if(s!=null&&s.text!=null&&s.text.boundingBox!=null){const{scale:n}=this.graph.getView(),i=s.text.boundingBox,l=Math.max(s.x-i.x,0)/n,a=Math.max(s.y-i.y,0)/n,h=Math.max(i.x+i.width-(s.x+s.width),0)/n,d=Math.max(i.y+i.height-(s.y+s.height),0)/n;t=new D(t.x-l,t.y-a,t.width+l+h,t.height+a+d)}}if(this.parent!=null){const s=e.getParent();if(t=t.clone(),s!=null&&s!==this.parent){const n=this.getParentOffset(s);t.x+=n.x,t.y+=n.y}}return new D(t.x,t.y,t.width,t.height)}arrangeGroups(e,t,s,n,i,l){return this.graph.updateGroupBounds(e,t,!0,s,n,i,l)}}class Se extends be{constructor(e){super(e),this.useInputOrigin=!0,this.resetEdges=!0,this.disableEdgeStyle=!0,this.forceConstant=50,this.forceConstantSquared=0,this.minDistanceLimit=2,this.maxDistanceLimit=500,this.minDistanceLimitSquared=4,this.initialTemp=200,this.temperature=0,this.maxIterations=0,this.iteration=0,this.vertexArray=[],this.dispX=[],this.dispY=[],this.cellLocation=[],this.radius=[],this.radiusSquared=[],this.isMoveable=[],this.neighbours={},this.indices={},this.allowedToRun=!0}isVertexIgnored(e){return super.isVertexIgnored(e)||this.graph.getConnections(e).length===0}execute(e){this.vertexArray=[];let t=this.graph.getChildVertices(e);for(let i=0;i<t.length;i+=1)this.isVertexIgnored(t[i])||this.vertexArray.push(t[i]);const s=this.useInputOrigin?this.graph.getBoundingBoxFromGeometry(this.vertexArray):null,n=this.vertexArray.length;this.indices={},this.dispX=[],this.dispY=[],this.cellLocation=[],this.isMoveable=[],this.neighbours={},this.radius=[],this.radiusSquared=[],this.forceConstant<.001&&(this.forceConstant=.001),this.forceConstantSquared=this.forceConstant*this.forceConstant;for(let i=0;i<this.vertexArray.length;i+=1){const l=this.vertexArray[i];this.cellLocation[i]=[];const a=F.get(l);this.indices[a]=i;const h=this.getVertexBounds(l),{width:d}=h,{height:c}=h,{x:g}=h,{y:x}=h;this.cellLocation[i][0]=g+d/2,this.cellLocation[i][1]=x+c/2,this.radius[i]=Math.min(d,c),this.radiusSquared[i]=this.radius[i]*this.radius[i]}this.graph.batchUpdate(()=>{for(let d=0;d<n;d+=1){this.dispX[d]=0,this.dispY[d]=0,this.isMoveable[d]=this.isVertexMovable(this.vertexArray[d]);const c=this.graph.getConnections(this.vertexArray[d],e);t=this.graph.getOpposites(c,this.vertexArray[d]),this.neighbours[d]=[];for(let g=0;g<t.length;g+=1){this.resetEdges&&this.graph.resetEdge(c[g]),this.disableEdgeStyle&&this.setEdgeStyleEnabled(c[g],!1);const x=F.get(t[g]),b=this.indices[x];b!=null?this.neighbours[d][g]=b:this.neighbours[d][g]=d}}for(this.temperature=this.initialTemp,this.maxIterations===0&&(this.maxIterations=20*Math.sqrt(n)),this.iteration=0;this.iteration<this.maxIterations;this.iteration+=1){if(!this.allowedToRun)return;this.calcRepulsion(),this.calcAttraction(),this.calcPositions(),this.reduceTemperature()}let i=null,l=null;for(let d=0;d<this.vertexArray.length;d+=1){const c=this.vertexArray[d];if(this.isVertexMovable(c)){const g=this.getVertexBounds(c);if(g!=null){this.cellLocation[d][0]-=g.width/2,this.cellLocation[d][1]-=g.height/2;const x=this.graph.snap(Math.round(this.cellLocation[d][0])),b=this.graph.snap(Math.round(this.cellLocation[d][1]));this.setVertexLocation(c,x,b),i==null?i=x:i=Math.min(i,x),l==null?l=b:l=Math.min(l,b)}}}let a=-(i||0)+1,h=-(l||0)+1;s!=null&&(a+=s.x,h+=s.y),this.graph.moveCells(this.vertexArray,a,h)})}calcPositions(){for(let e=0;e<this.vertexArray.length;e+=1)if(this.isMoveable[e]){let t=Math.sqrt(this.dispX[e]*this.dispX[e]+this.dispY[e]*this.dispY[e]);t<.001&&(t=.001);const s=this.dispX[e]/t*Math.min(t,this.temperature),n=this.dispY[e]/t*Math.min(t,this.temperature);this.dispX[e]=0,this.dispY[e]=0,this.cellLocation[e][0]+=s,this.cellLocation[e][1]+=n}}calcAttraction(){for(let e=0;e<this.vertexArray.length;e+=1)for(let t=0;t<this.neighbours[e].length;t+=1){const s=this.neighbours[e][t];if(e!==s&&this.isMoveable[e]&&this.isMoveable[s]){const n=this.cellLocation[e][0]-this.cellLocation[s][0],i=this.cellLocation[e][1]-this.cellLocation[s][1];let l=n*n+i*i-this.radiusSquared[e]-this.radiusSquared[s];l<this.minDistanceLimitSquared&&(l=this.minDistanceLimitSquared);const a=Math.sqrt(l),h=l/this.forceConstant,d=n/a*h,c=i/a*h;this.dispX[e]-=d,this.dispY[e]-=c,this.dispX[s]+=d,this.dispY[s]+=c}}}calcRepulsion(){const e=this.vertexArray.length;for(let t=0;t<e;t+=1)for(let s=t;s<e;s+=1){if(!this.allowedToRun)return;if(s!==t&&this.isMoveable[t]&&this.isMoveable[s]){let n=this.cellLocation[t][0]-this.cellLocation[s][0],i=this.cellLocation[t][1]-this.cellLocation[s][1];n===0&&(n=.01+Math.random()),i===0&&(i=.01+Math.random());const l=Math.sqrt(n*n+i*i);let a=l-this.radius[t]-this.radius[s];if(a>this.maxDistanceLimit)continue;a<this.minDistanceLimit&&(a=this.minDistanceLimit);const h=this.forceConstantSquared/a,d=n/l*h,c=i/l*h;this.dispX[t]+=d,this.dispY[t]+=c,this.dispX[s]-=d,this.dispY[s]-=c}}}reduceTemperature(){this.temperature=this.initialTemp*(1-this.iteration/this.maxIterations)}}class we extends J{constructor(e=20){super(),this.thread=null,this.delay=e}isRunning(){return this.thread!=null}startAnimation(){this.thread==null&&(this.thread=window.setInterval(this.updateAnimation.bind(this),this.delay))}updateAnimation(){this.fireEvent(new S(f.EXECUTE))}stopAnimation(){this.thread!=null&&(window.clearInterval(this.thread),this.thread=null,this.fireEvent(new S(f.DONE)))}}class Ce{constructor(e){this.count=0,this.deltas=new Map,this.graph=e}isEmpty(){return this.count===0}moveState(e,t,s,n=!0,i=!0){let l=this.deltas.get(e.cell);return l==null?(l={point:new w(t,s),state:e},this.deltas.set(e.cell,l),this.count++):n?(l.point.x+=t,l.point.y+=s):(l.point.x=t,l.point.y=s),i&&this.addEdges(e),l.point}show(e=null){this.deltas.forEach(t=>{this.translateState(t.state,t.point.x,t.point.y)}),this.deltas.forEach(t=>{this.revalidateState(t.state,t.point.x,t.point.y,e)})}translateState(e,t,s){if(e!=null){if(e.cell.isVertex()){e.view.updateCellState(e);const n=e.cell.getGeometry();(t!==0||s!==0)&&n!=null&&(!n.relative||this.deltas.get(e.cell)!=null)&&(e.x+=t,e.y+=s)}for(const n of e.cell.getChildren())this.translateState(e.view.getState(n),t,s)}}revalidateState(e,t,s,n=null){e.cell.isEdge()&&e.view.updateCellState(e);const i=e.cell.getGeometry(),l=e.view.getState(e.cell.getParent());(t!==0||s!==0)&&i!=null&&i.relative&&e.cell.isVertex()&&(l==null||l.cell.isVertex()||this.deltas.get(e.cell)!=null)&&(e.x+=t,e.y+=s),this.graph.cellRenderer.redraw(e),n!=null&&n(e);for(const a of e.cell.getChildren())this.revalidateState(this.graph.view.getState(a),t,s,n)}addEdges(e){const t=e.cell.getEdgeCount();for(let s=0;s<t;s+=1){const n=e.view.getState(e.cell.getEdgeAt(s));n!=null&&this.moveState(n,0,0)}}}class Le extends we{constructor(e,t=6,s=1.5,n){super(n),this.step=0,this.cells=null,this.graph=e,this.steps=t,this.ease=s}updateAnimation(){super.updateAnimation();const e=new Ce(this.graph);if(this.cells!=null)for(const t of this.cells)this.animateCell(t,e,!1);else this.animateCell(this.graph.getDataModel().getRoot(),e,!0);this.show(e),(e.isEmpty()||this.step++>=this.steps)&&this.stopAnimation()}show(e){e.show()}animateCell(e,t,s=!1){const n=this.graph.getView().getState(e);let i=null;if(n!=null&&(i=this.getDelta(n),e.isVertex()&&(i.x!=0||i.y!=0))){const l=this.graph.view.getTranslate(),a=this.graph.view.getScale();i.x+=l.x*a,i.y+=l.y*a,t.moveState(n,-i.x/this.ease,-i.y/this.ease)}if(s&&!this.stopRecursion(n,i)){const l=e.getChildCount();for(let a=0;a<l;a+=1)this.animateCell(e.getChildAt(a),t,s)}}stopRecursion(e=null,t=null){return t!=null&&(t.x!=0||t.y!=0)}getDelta(e){const t=this.getOriginForCell(e.cell),s=this.graph.getView().getTranslate(),n=this.graph.getView().getScale(),i=e.x/n-s.x,l=e.y/n-s.y;return new w((t.x-i)*n,(t.y-l)*n)}getOriginForCell(e=null){let t=null;if(e!=null){const s=e.getParent(),n=e.getGeometry();if(t=this.getOriginForCell(s),n!=null&&s!=null)if(n.relative){const i=s.getGeometry();i!=null&&(t.x+=n.x*i.width,t.y+=n.y*i.height)}else t.x+=n.x,t.y+=n.y}if(t==null){const s=this.graph.view.getTranslate();t=new w(-s.x,-s.y)}return t}}const De=[ge,fe,pe,ye,Z],p=document.getElementById("graph-container");document.createElement("div");const o=new ce(p,new ue,De),E=o.getDataModel();var C=o.getStylesheet().getDefaultEdgeStyle();C.labelBackgroundColor="#FFFFFF";C.strokeWidth=2;C.rounded=!0;C.entryPerimeter=!1;C.edgeStyle="manhattanEdgeStyle";o.getFoldingImage=()=>null;Q.selectionColor="#00a8ff";Q.selectionStrokeWidth=2;const m=new Ee,ee=(r,e)=>{m.undoableEditHappened(e.getProperty("edit"))};E.addListener(f.UNDO,ee);o.getView().addListener(f.UNDO,ee);const Me=document.getElementById("undoButton"),Ae=document.getElementById("redoButton");Me.addEventListener("click",()=>{m.canUndo()&&m.undo()});Ae.addEventListener("click",()=>{m.canRedo()&&m.redo()});document.addEventListener("keydown",r=>{r.ctrlKey&&r.key==="z"?(r.preventDefault(),m.canUndo()&&m.undo()):r.ctrlKey&&r.key==="y"&&(r.preventDefault(),m.canRedo()&&m.redo())});const y=document.getElementById("edge-context-menu"),M=document.getElementById("edge-color-select"),A=document.getElementById("edge-thickness-select"),v=document.getElementById("text-context-menu"),te=document.getElementById("text-font-select"),se=document.getElementById("text-color-select"),ie=document.getElementById("text-size-select"),P=document.getElementById("text-bold-select"),V=document.getElementById("text-italic-select"),R=document.getElementById("text-underline-select");let u=null;o.container.addEventListener("contextmenu",r=>{r.preventDefault();const e=o.getCellAt(r.offsetX,r.offsetY);if(e!=null)if(e.isEdge()){u=e;const t=p.getBoundingClientRect(),s=r.clientX-t.left,n=r.clientY-t.top;y.style.display="block",y.style.left=`${s+75}px`,y.style.top=`${n+100}px`;const i=o.getCellStyle(e);M.value=i.strokeColor||"#000000",A.value=i.strokeWidth||"1"}else if(e.isVertex()){if(e.value!=null&&e.value!=""){u=e;const t=p.getBoundingClientRect(),s=r.clientX-t.left,n=r.clientY-t.top;v.style.display="block",v.style.left=`${s+75}px`,v.style.top=`${n+100}px`;const i=o.getCellStyle(e);se.value=i.fontColor||"#000000",te.value=i.fontFamily||"Arial",ie.value=i.fontSize||"12",u.style.fontStyle&1?P.classList.add("selected"):P.classList.remove("selected"),u.style.fontStyle&2?V.classList.add("selected"):V.classList.remove("selected"),u.style.fontStyle&4?R.classList.add("selected"):R.classList.remove("selected")}else if(e.style.image==null&&e.children.length==0){u=e;const t=p.getBoundingClientRect(),s=r.clientX-t.left,n=r.clientY-t.top;y.style.display="block",y.style.left=`${s+75}px`,y.style.top=`${n+100}px`;const i=o.getCellStyle(e);M.value=i.strokeColor||"#000000",A.value=i.strokeWidth||"1"}}else v.style.display="none",y.style.display="none"});var U;(U=document.getElementById("apply-edge-style"))==null||U.addEventListener("click",r=>{r.preventDefault(),u&&o.batchUpdate(()=>{o.getCellStyle(u),u.isEdge()?(u.style.strokeColor=M.value,u.style.strokeWidth=parseInt(A.value,10)):(u.style.fillColor=M.value,u.style.strokeWidth=parseInt(A.value,10)),o.refresh(u)}),y.style.display="none"});var z;(z=document.getElementById("apply-text-style"))==null||z.addEventListener("click",r=>{r.preventDefault(),u&&o.batchUpdate(()=>{u.style.fontFamily=te.value,u.style.fontColor=se.value,u.style.fontSize=parseInt(ie.value,10);var e=0;e=e|(P.classList.contains("selected")?1:0),e=e|(V.classList.contains("selected")?2:0),e=e|(R.classList.contains("selected")?4:0),u.style.fontStyle=e,o.refresh(u)}),v.style.display="none"});var q;(q=document.querySelectorAll(".button"))==null||q.forEach(r=>{r.addEventListener("click",()=>{Ie(r)})});function Ie(r){r.classList.toggle("selected")}document.addEventListener("click",r=>{v.contains(r.target)||(v.style.display="none"),y.contains(r.target)||(y.style.display="none")});o.setGridEnabled(!0);o.setGridSize(10);p.style.backgroundImage=`
  linear-gradient(to right, #e0e0e0 1px, transparent 1px),
  linear-gradient(to bottom, #e0e0e0 1px, transparent 1px)
`;p.style.backgroundSize="10px 10px";o.setPanning(!0);o.allowAutoPanning=!0;o.useScrollbarsForPanning=!0;function Be(r){new G(E).import(r)}window.loadGraph=Be;async function ke(r,e,t,s){console.log("saveGraphToDatabase:"+r+" name:"+e);try{const n=await fetch(`/admin/graphs/${r}`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({_method:"PUT",id:r,name:e,type:t,content:s})});if(console.log("réponse :",n.status),n.status!=200){const i=await n.json();throw new Error(i.message||"Erreur lors de la sauvegarde du graphe.")}console.log("Graphe sauvegardé avec succès")}catch(n){console.error("Erreur lors de la sauvegarde :",n),alert("Erreur lors de la sauvegarde du graphe.")}}function Oe(){return new G(E).export()}window.getXMLGraph=Oe;function Pe(){const r=new G(E).export();ke(document.querySelector("#id").value,document.querySelector("#name").value,document.querySelector("#type").value,r)}var Y;(Y=document.getElementById("saveButton"))==null||Y.addEventListener("click",Pe);var H;(H=document.getElementById("font-btn"))==null||H.addEventListener("dragstart",r=>{r.dataTransfer.setData("node-type","text-node")});p.addEventListener("dragover",r=>{r.preventDefault()});o.autoSizeCells=!0;function X(r,e){var h;if(typeof r.getPointForEvent=="function")return r.getPointForEvent(e);const t=r.view??((h=r.getView)==null?void 0:h.call(r)),s=K(r.container,ve(e),xe(e)),n=t.translate??{x:0,y:0},i=t.scale??1,l=r.panDx??0,a=r.panDy??0;return[(s.x-l)/i-n.x-20,(s.y-a)/i-n.y-20]}o.enterStopsCellEditing=!0;p.addEventListener("drop",r=>{if(r.preventDefault(),r.dataTransfer.getData("node-type")=="text-node"){const e=X(o,r);o.batchUpdate(()=>{const t=o.getDefaultParent();o.insertVertex({parent:t,value:"Text",position:[e.x,e.y],size:[150,30],style:{fillColor:"none",strokeColor:"none",fontColor:"#000000",fontSize:14,align:"left",verticalAlign:"middle"}})})}});const Ve=document.getElementById("square-btn");Ve.addEventListener("dragstart",r=>{r.dataTransfer.setData("node-type","square-node")});p.addEventListener("dragover",r=>{r.preventDefault()});p.addEventListener("drop",r=>{if(r.preventDefault(),r.dataTransfer.getData("node-type")=="square-node"){const e=X(o,r);o.batchUpdate(()=>{const t=o.getDefaultParent();console.log([e.x,e.y]);const s=o.insertVertex({parent:t,value:"",position:[e.x,e.y],size:[150,120],style:{fillColor:"#fffacd",strokeColor:"#000000",strokeWidth:1,rounded:2}});o.orderCells(!0,[s])})}});const T=document.getElementById("nodeImage"),O=document.getElementById("node");T.addEventListener("dragstart",r=>{r.dataTransfer.setData("node-type","icon-node")});p.addEventListener("dragover",r=>{r.preventDefault()});p.addEventListener("drop",r=>{if(r.preventDefault(),r.dataTransfer.getData("node-type")=="icon-node"&&T.src!=""){const e=X(o,r);o.batchUpdate(()=>{const t=o.getDefaultParent(),s=E.getCell(O.value);if(s!=null)o.setSelectionCells(s);else{const n=_nodes.get(O.value),i=o.insertVertex({parent:t,id:O.value,value:n.label,position:[e.x-16,e.y-16],size:[32,32],style:{shape:"image",image:T.src,editable:!1,resizable:!0,verticalLabelPosition:"bottom",spacingTop:-15}});n.edges.forEach(function(l){const a=E.getCell(l.attachedNodeId);a!=null&&o.insertEdge({parent:t,value:"",source:i,target:a,style:{editable:!1,strokeColor:"#ff0000",strokeWidth:1,startArrow:"none",endArrow:"none"}})})}})}});const Re=document.getElementById("zoom-in-btn"),Te=document.getElementById("zoom-out-btn");Re.addEventListener("click",()=>{o.zoomIn()});Te.addEventListener("click",()=>{o.zoomOut()});document.addEventListener("keydown",r=>{if(r.key==="Delete"||r.key==="Backspace"){const e=o.getSelectionCells();e.length>0&&o.removeCells(e)}});$("body").keydown(function(r){r.ctrlKey&&r.keyCode==65&&(r.preventDefault(),r.stopPropagation(),o.selectAll())});o.setConnectable(!1);o.isCellDisconnectable=function(){return!1};const Ge=document.getElementById("group-btn"),Xe=document.getElementById("ungroup-btn");Ge.addEventListener("click",()=>{const r=o.getSelectionCells();if(r.length>1){const e=o.getDefaultParent(),t=o.insertVertex({parent:e,style:{fillColor:"none",strokeColor:"none"}});o.addCell(t),o.groupCells(t,5,r)}});Xe.addEventListener("click",()=>{const r=o.getSelectionCells();r.length==1&&(o.ungroupCells(r),o.setSelectionCells(r))});function L(r,e,t){const s=r.getSelectionCell();s&&s.isVertex()&&r.batchUpdate(()=>{const n=s.getGeometry();n&&(n.translate(e,t),r.refresh())})}document.addEventListener("keydown",r=>{switch(r.key){case"ArrowUp":L(o,0,-1);break;case"ArrowDown":L(o,0,1);break;case"ArrowLeft":L(o,-1,0);break;case"ArrowRight":L(o,1,0);break}});function Fe(r,e,t){const s=[],n=2*Math.PI/t;for(let i=0;i<t;i++){const l=i*n,a=r.x+e*Math.cos(l),h=r.y+e*Math.sin(l);s.push({x:a,y:h})}return s}function Ne(){let r=[];for(let e of document.getElementById("filters").options)e.selected&&r.push(e.value);return r}function Ue(r,e,t){if(r==null||e==null)return!1;let s=!1;return o.getEdges(r).forEach(i=>{if(i.target==e&&(t==null||i.value==t)){s=!0;return}}),s||o.getEdges(e).forEach(l=>{if(l.target==r&&(t==null||l.value==t)){s=!0;return}}),s}o.addListener(f.DOUBLE_CLICK,(r,e)=>{const t=e.getProperty("cell");if(t&&t.isVertex()&&t.style.shape=="image"){const s=_nodes.get(t.id);if(s==null)return;o.batchUpdate(()=>{let n=[];const i=o.getDefaultParent(),l=Ne();s.edges.forEach(function(h){let d=_nodes.get(h.attachedNodeId);if(d!=null){const c=E.getCell(h.attachedNodeId);c==null&&!n.some(g=>g.attachedNodeId==h.attachedNodeId)?(l.length==0||l.includes(d.vue)||l.includes("8")&&h.edgeType==="CABLE"||l.includes("9")&&h.edgeType==="FLUX")&&n.push(h):Ue(t,c,h.name)||o.insertEdge({parent:i,value:h.name,source:t,target:c,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:h.edgeType=="FLUX"&&(h.bidirectional||h.edgeDirection=="FROM")?"classic":"none",endArrow:h.edgeType=="FLUX"&&(h.bidirectional||h.edgeDirection=="TO")?"classic":"none"}})}}),p.getBoundingClientRect();const a=Fe({x:t.getGeometry().x,y:t.getGeometry().y},80,n.length);for(let h=0;h<a.length;h++){const d=n[h],c=_nodes.get(d.attachedNodeId),g=o.insertVertex({parent:i,id:c.id,value:c.label,position:[a[h].x,a[h].y],size:[32,32],style:{shape:"image",image:c.image,editable:!1,resizable:!0,verticalLabelPosition:"bottom",spacingTop:-15}});o.insertEdge({parent:i,value:n[h].name,source:t,target:g,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:d.edgeType=="FLUX"&&(d.bidirectional||d.edgeDirection=="FROM")?"classic":"none",endArrow:d.edgeType=="FLUX"&&(d.bidirectional||d.edgeDirection=="TO")?"classic":"none"}})}})}});var _;(_=document.getElementById("update-btn"))==null||_.addEventListener("click",()=>{o.batchUpdate(()=>{o.getChildCells().forEach(e=>{if(!e.isEdge()){if(e.style.image!=null){const t=_nodes.get(e.id);t==null?o.removeCells([e],!0):(e.value=t.label,me(o.getDataModel(),[e],{image:t.image}))}}}),o.refresh()})});const N=o.container.querySelector("svg");function ze(r){r.querySelectorAll("image").forEach(t=>{const s=t.getAttribute("xlink:href");fetch(s).then(n=>n.blob()).then(n=>{const i=new FileReader;i.onloadend=()=>{t.setAttribute("xlink:href",i.result)},i.readAsDataURL(n)})})}function qe(){ze(N),setTimeout(()=>{const e=new XMLSerializer().serializeToString(N),t=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s;const i=new Date,l=i.getFullYear()+String(i.getMonth()+1).padStart(2,"0")+String(i.getDate()).padStart(2,"0")+String(i.getHours()).padStart(2,"0")+String(i.getMinutes()).padStart(2,"0");n.download=`graph-${l}.svg`,n.click(),URL.revokeObjectURL(s)},1e3)}var j;(j=document.getElementById("download-btn"))==null||j.addEventListener("click",qe);function Ye(){const r=o.getDefaultParent(),e=o.getChildVertices(r);if(!e||e.length===0)return;const t=new Se(o);t.forceConstant=60,t.disableEdgeStyle=!1,o.getDataModel().beginUpdate();try{t.execute(r,e)}finally{const s=new Le(o);s.addListener(f.DONE,()=>o.getDataModel().endUpdate()),s.startAnimation()}}var W;(W=document.getElementById("layout-btn"))==null||W.addEventListener("click",Ye);
